---
title: "Explore NPP"
author: "Juliette"
date: "10/26/2020"
output: html_document
---

This is the script but in markdown forma nd adjusted to what we want

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(data.table)
library(tidyverse)
library(rgdal)
library(gdalUtils)
library(here)

source(here("_workflow/common.R"))
source(here("_workflow/common_spatial.R"))

```

```{r}
#raster_list <- list.files(file.path(raw, "MODIS_NPP_for_Juliette/NPP/IndividualTiles/TIF_2012"), pattern = ".tif", full = TRUE)

raster_df <- data.frame(x = NA, y = NA, value = NA) %>%  as_tibble()

for(year in 2013:2014){
  
  raster_list <- list.files(paste0(raw, "MODIS_NPP_for_Juliette/NPP/IndividualTiles/TIF_", year, sep = ""), pattern = ".tif", full = TRUE)

for(raster_tile in raster_list) {
  
 # raster_tile <- raster_list[1]
  
  rast_df <- raster(raster_tile) %>% 
    as.data.frame(xy= TRUE) %>% 
    as_tibble()
  
  colnames(rast_df) <- c("x", "y", "value")
  
  raster_df<- rbind(raster_df, rast_df) %>% na.omit()
  
  write_csv(raster_df, file.path(paste(prep, "animal_farm/disturbance/raster_df_", year, ".csv", sep = "")))
  
} }


```
Create a raster for each year, currently we only ahve 2010, 2011 and 2014 because Dave gave us 2012 and 2013

These files have a scaling factor of 0.0001, so we will multiply each cell by 10,000

```{r}

##2010
raster_2010 <-  rasterFromXYZ(read_csv(file.path(prep, "animal_farm/disturbance/raster_df_2010.csv")), crs = '+proj=sinu +lon_0=0 +x_0=0 +y_0=0 +R=6371007.181 +units=m +no_defs')
hist(raster_2010)

# raster_2010[raster_2010 > 5] <- 0
# plot(raster_2010)

cellStats(raster_2010, 'sum')

writeRaster(raster_2010, file.path(prep, ("animal_farm/disturbance/npp_2010_2014_rasters/npp_2010.tif"), sep = ""), format = "GTiff", overwrite = TRUE ) 

##2011
raster_2011 <-  rasterFromXYZ(read_csv(file.path(prep, "animal_farm/disturbance/raster_df_2011.csv")), crs = '+proj=sinu +lon_0=0 +x_0=0 +y_0=0 +R=6371007.181 +units=m +no_defs')

# raster_2010[raster_2010 > 5] <- 0
# plot(raster_2010)

writeRaster(raster_2011, file.path(prep, ("animal_farm/disturbance/npp_2010_2014_rasters/npp_2011.tif"), sep = ""), format = "GTiff", overwrite = TRUE ) 

## 2012
raster_2012 <-  raster(file.path(raw, "MODIS_NPP_for_Juliette/NPP/Global/NPP_Global_2012.tif"))
writeRaster(raster_2012, file.path(prep, ("animal_farm/disturbance/npp_2010_2014_rasters/npp_2012.tif"), sep = ""), format = "GTiff", overwrite = TRUE ) 

## 2013
raster_2013 <-  raster(file.path(raw, "MODIS_NPP_for_Juliette/NPP/Global/NPP_Global_2013.tif"))
writeRaster(raster_2012, file.path(prep, ("animal_farm/disturbance/npp_2010_2014_rasters/npp_2012.tif"), sep = ""), format = "GTiff", overwrite = TRUE ) 


```

 61945047 kg c npp is what we get from ours. seems wrong

Total global terrestrial NPP should be 48.0 to 69.0 Pg (= Petagrams or 10^15 g) C yr-1"

```{r}
raster_2010 <-  raster(file.path(prep, ("animal_farm/disturbance/npp_2010_2014_rasters/npp_2010.tif")))

raster_2010[raster_2010 == 6.5535 |
            raster_2010 == 6.5534 |
            raster_2010 == 6.5533 |
            raster_2010 == 6.5532 |
            raster_2010 == 6.5531 |
            raster_2010 == 6.5530 |
            raster_2010 == 6.5529] <- 0

plot(raster_2010)

cellStats(raster_2010, 'sum')

test <- raster(here("animal_farm/disturbance/npp_Vasc_All_fine_geo.tif"))
plot(test)
```
 

check these other tiffs
they are in gC/m2/day

```{r}

list_2015 <- list.files(path = file.path(raw, "MODIS_NPP_for_Juliette/NPP/check_npp_tiffs/2015/"), pattern = ".tiff", full.names = TRUE)

stack <- stack(lapply(list_2015, raster))

mean_npp_2015 <- mean(stack)
mean_npp_2015[mean_npp_2015 > 99999] <- NA
mean_npp_2015[mean_npp_2015 < 99999] <- NA


plot(mean_npp_2015)

mean_npp_2015_resample <- resample(mean_npp_2015, food_rgns_tif)
plot(mean_npp_2015_resample)

```



Issues to talk with mel about:
-the weird cut off top portion in some months
- the "not to be used for serious science" caveat like 3 clicks away. might not be referening this particular data set
- resolution is 0.1 and ours is 0.083










Create a blank raster for mosaicing
```{r}
 e <- extent(-20015109, -18903159, 0, 1111951 )
 template <- raster(e)
 proj4string(template) <- CRS('+proj=sinu +lon_0=0 +x_0=0 +y_0=0 +R=6371007.181 +units=m +no_defs')
 writeRaster(template, file = file.path(prep, "animal_farm/disturbance/npp_2010.tif"), format="GTiff", overwrite= TRUE)

```


List files 

```{r}
raster_list2012 <- list.files(file.path(raw, "MODIS_NPP_for_Juliette/NPP/IndividualTiles/TIF_2012"), pattern = ".tif", full = TRUE)

mosaic_rasters(gdalfile = raster_list2012,
               dst_dataset = file.path(prep, "animal_farm/disturbance/npp_2010.tif"), of="GTiff")

gdalinfo(file.path(prep, "animal_farm/disturbance/npp_2010.tif"))

test <- raster(file.path(prep, "animal_farm/disturbance/npp_2010_2014_rasters/npp_2010.tif"))
par(mar=c(1,1,1,1))
plot(test)

## test the rasters as a data.table and then convert back to raster with fasterize?

rast_1 <- raster(raster_list2012[3])
rast_2 <- raster(raster_list2012[2])
plot(rast_1)

df_test <- as.data.frame(rast_1, xy= TRUE)
df_test2 <- as.data.frame(rast_2, xy= TRUE)

df_test
df_test2
```

Make one giant data table with the tifs and then rerasterize

```{r}
raster_list2012 <- list.files(file.path(raw, "MODIS_NPP_for_Juliette/NPP/IndividualTiles/TIF_2012"), pattern = ".tif", full = TRUE)

raster_df_2012 <- data.frame(x = NA, y = NA, value = NA) %>%  as_tibble()

for(raster_tile in raster_list2012) {

  
 # raster_tile <- raster_list2012[1]
  
  rast_df <- raster(raster_tile) %>% 
    as.data.frame(xy= TRUE) %>% 
    as_tibble()
  
  colnames(rast_df) <- c("x", "y", "value")
  
  raster_df_2012<- rbind(raster_df_2012, rast_df) %>% na.omit()
  
  write_csv(raster_df_2012, file.path(prep, "animal_farm/disturbance/raster_df_2012.csv"))
  
}

raster_df_2012 <- read_csv(here("animal_farm/distrubance/data/raster_df_2012.csv"))

raster_2012 <- rasterFromXYZ(raster_df_2012, crs = '+proj=sinu +lon_0=0 +x_0=0 +y_0=0 +R=6371007.181 +units=m +no_defs')

```



```{r}
#raster_list <- list.files(file.path(raw, "MODIS_NPP_for_Juliette/NPP/IndividualTiles/TIF_2012"), pattern = ".tif", full = TRUE)

raster_df <- data.frame(x = NA, y = NA, value = NA) %>%  as_tibble()

for(year in 2010:2014){
  
  raster_list <- list.files(paste0(raw, "MODIS_NPP_for_Juliette/NPP/IndividualTiles/TIF_", year, sep = ""), pattern = ".tif", full = TRUE)

for(raster_tile in raster_list) {
  
 # raster_tile <- raster_list[1]
  
  rast_df <- raster(raster_tile) %>% 
    as.data.frame(xy= TRUE) %>% 
    as_tibble()
  
  colnames(rast_df) <- c("x", "y", "value")
  
  raster_df<- rbind(raster_df, rast_df) %>% na.omit()
  
  write_csv(raster_df, file.path(paste(prep, "animal_farm/disturbance/raster_df", year, ".csv", sep = "")))
  
} }


raster_df_2010 <-  read_csv(file.path(prep, "animal_farm/disturbance/raster_df_2010.csv"))
raster_2010 <- rasterFromXYZ(raster_df_2010, crs = '+proj=sinu +lon_0=0 +x_0=0 +y_0=0 +R=6371007.181 +units=m +no_defs')

raster_df_2011 <-  read_csv(file.path(prep, "animal_farm/disturbance/raster_df_2011.csv"))
raster_2011 <- rasterFromXYZ(raster_df_2011, crs = '+proj=sinu +lon_0=0 +x_0=0 +y_0=0 +R=6371007.181 +units=m +no_defs')

raster_df_2012 <-  read_csv(file.path(prep, "animal_farm/disturbance/raster_df_2012.csv"))
raster_2012 <- rasterFromXYZ(raster_df_2012, crs = '+proj=sinu +lon_0=0 +x_0=0 +y_0=0 +R=6371007.181 +units=m +no_defs')

raster_df_2013 <-  read_csv(file.path(prep, "animal_farm/disturbance/raster_df_2013.csv"))
raster_2013 <- rasterFromXYZ(raster_df_2013, crs = '+proj=sinu +lon_0=0 +x_0=0 +y_0=0 +R=6371007.181 +units=m +no_defs')

raster_df_2014 <-  read_csv(file.path(prep, "animal_farm/disturbance/raster_df_2014.csv"))
raster_2014 <- rasterFromXYZ(raster_df_2014, crs = '+proj=sinu +lon_0=0 +x_0=0 +y_0=0 +R=6371007.181 +units=m +no_defs')

```

```{r }


library(here)

source(here("_workflow/common.R"))
source(here("_workflow/common_spatial.R"))

## look at whats in the zip file
list <- unzip("/home/shares/food-systems/Food_footprint/_raw_data/MODIS_NPP_for_Juliette/NPP.zip",  list = TRUE)

## look at just one
test <- unzip("/home/shares/food-systems/Food_footprint/_raw_data/MODIS_NPP_for_Juliette/NPP.zip",  file = "NPP/MeanNPP_2010_2014.tif")

raster_test <- raster(test)
plot(raster_test)

test2 <- unzip("/home/shares/food-systems/Food_footprint/_raw_data/MODIS_NPP_for_Juliette/NPP.zip",  file = "NPP/Global/NPP_Global_2010.tif")
raster_test2 <- raster(test2)
plot(raster_test2)

test3 <- unzip("/home/shares/food-systems/Food_footprint/_raw_data/MODIS_NPP_for_Juliette/NPP.zip",  file = "NPP/Global/NPP_Global_2013_wgs84.tif")
## this file is corrupt -> and it seems like the files after that might also be


```