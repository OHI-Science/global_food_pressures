---
title: "Checking out grazed animals vs total pasture land"
author: "Juliette"
date: "10/1/2020"
output: html_document
---

In this markdown we explore:
1. Total LSU for all our grazed animals from the grazed animal maps we created
2. FAO "area under permanent pasture/meadow" and "area under temporary permanent and meadow"
3. Plot our total LSU by country to the total perm pasture area by country
4. Plot our GLEAM grazed LSU by country to the total perm pasture area by country
5. Compare the gridded LSP of pasture land to the area grazed FAO reports
6. Compare the area of the cells we say have grazed animals with the fao grazed area data
7. Using the HYDE grazing area data as a check

## Setup
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(here)
library(plotly)
library(countrycode)
library(hrbrthemes)
library(gt)

source(here("_workflow/common.R"))
source(here("_workflow/common_spatial.R"))
source(here("_spatial/template_raster.R"))

lsu <- read_csv(here("animal_farm/disturbance/data/lsu_gf.csv"))

```

1. Calculate the total LSU for all our grazed animals from the grazed animal maps we created
```{r}

lsu_calcs <- tibble(iso3c = NA, lsu = NA)

animal_list <- c("cows", "buffaloes", "goats", "sheep")
product_list <- c("meat", "milk")

for(animal_OI in animal_list) {
  for(product_OI in product_list) {
  
  
  animal_OI <- "cows"
   product_OI <- "meat"
  
  counts <- read_csv(file.path(paste0(prep, "animal_farm/farm/rgn_df/region_counts_", animal_OI, "_grassland_", product_OI, ".csv", sep = "")))
  
  to_lsu <- left_join(counts, lsu, by = c("iso3c", "animal")) %>% 
    mutate(lsu = rgn_count*lsu_value) %>% 
    select(iso3c, lsu)
  
  lsu_calcs <- rbind (lsu_calcs, to_lsu) %>% 
    na.omit() %>% 
    group_by(iso3c) %>% 
    dplyr::summarise(lsu = sum(lsu)) %>% 
    ungroup()
  
  write_csv(lsu_calcs, here("animal_farm/disturbance/data/lsu_calcs.csv"))

}}
```

2. Wrangle the FAO "area under permanent pasture/meadow" and "area under temporary permanent and meadow"
grazed land area should be the permanent pasture
```{r}
graze_land <- read_csv(here("animal_farm/disturbance/data/graze_land_FAO.csv"))  %>% 
  filter(Area != "China") %>% 
  mutate(Area = ifelse(Area == "Eswatini", "Swaziland", Area),
         Area = ifelse(Area == "Netherlands Antilles (former)", "Bonaire, Sint Eustatius and Saba", Area),
         Area = ifelse(Area == "French Guyana", "French Guiana", Area),
         Area = ifelse(Area == "China, mainland", "China", Area),
         iso3c = countrycode(Area, origin="country.name", destination = "iso3c")) 

graze_perm <- graze_land %>%  
  filter(Item == "Land under perm. meadows and pastures") %>% 
  select(country = Area, iso3c, ha_1000 = Value)

graze_all <- graze_land %>%  
  select(country = Area, iso3c, ha_1000 = Value)
```

3. Plot our total LSU by country to the total perm pasture area by country
```{r}
lsu_calcs <- read_csv(here("animal_farm/disturbance/data/lsu_calcs.csv"))

plot_df_perm <- left_join(lsu_calcs, graze_perm)
plot_df_all <- left_join(lsu_calcs, graze_all)

plot <- ggplot(plot_df_perm) +
      geom_point(aes(x = ha_1000, y = lsu, color = country)) + 
      labs(title = "LSU vs grazed area (Our Counts)") +
      theme_ipsum_es() +
      theme(legend.position = "none") 

ggsave(here("animal_farm/disturbance/compare_ours.jpg"), dpi=300)


ggplotly(plot)

## not really a difference between just perm and perm + temp pasture
```

4. Now we want to see if the total number of grazed animals according to GLEAM fits better than the total LSU we have (fingers crossed not) and plot that against what FAO reports as perm pasture area
```{r}
gleam_raw <- read_csv(here("animal_farm/farm/data/ruminants_GLEAMi_v2.csv"))

gleam <- gleam_raw %>% 
  filter(Production_system == "Grassland systems",
         Variable == "HERD: total number of animals",
         Herd_type == "Whole herd") %>% 
  mutate(animal = tolower(Species),
         animal = ifelse(animal == "cattle", "cows",
                         ifelse(animal == "buffalo", "buffaloes", animal))) %>% 
  select(country = Country, iso3c, animal, count = Value)

gleam_lsu <- left_join(gleam, lsu, by = c("iso3c", "animal")) %>% 
  mutate(lsu = lsu_value*count) %>% 
  group_by(iso3c) %>% 
  dplyr::summarise(lsu = sum(lsu)) %>% 
  ungroup()

```

Plot with GLEAM
```{r}
plot_df_perm_gleam <- left_join(gleam_lsu, graze_perm)
plot_df_all_gleam <- left_join(gleam_lsu, graze_all)

plot <- ggplot(plot_df_perm_gleam) +
      geom_point(aes(x = ha_1000, y = lsu, color = country)) + 
      labs(title = "LSU vs grazed area (GLEAM)") +
      theme_ipsum_es() +
      theme(legend.position = "none") 

ggsave(here("animal_farm/disturbance/compare_gleam.jpg"), dpi=300)

ggplotly(plot)

## it doesn't seem better
```

5. Now we want to compare the gridded LSP of pasture land to the area grazed FAO reports
```{r}
lps_raster <- raster(file.path(raw, "FAO_livestock_maps/d2019/ruminant_production_systems/no_landless_production_maps/2_GlobalRuminantLPS_GIS/glps_gleam_61113_10km.tif"))
      ## the extent is a little bit off, so we will use the raster_df function. It might make things a little off, unsure how much that will influence the allocation of mixed vs grassland critters

lps_raster[lps_raster <= 4] <- 1
lps_raster[lps_raster > 4] <- 0

plot(lps_raster)

## the extent is a little off so lets go fix it
lps_area <- area(lps_raster) %>% 
  raster_df() %>% 
  select(x,y, area = layer) %>% 
  rasterFromXYZ(crs = food_crs)

pasture_data <- zonal(lps_area, food_rgns_tif, fun="sum", progress="text", na.rm=TRUE) %>% 
  as_tibble() %>%  
  rename(ID_0 = zone) %>%
  left_join(food_rgns, by="ID_0") %>% 
  rename(km2_lps = sum) %>%
  select(-ID_0)

```


Plot
```{r}
graze_perm_km2 <-graze_perm %>% 
  mutate(km2_fao = ha_1000*1000*0.01) %>% 
  select(iso3c, km2_fao)

compare_graze_area <- left_join(pasture_data,graze_perm_km2, by = "iso3c")
 
graze_area_plot <- ggplot(compare_graze_area) +
      geom_point(aes(x = km2_fao, y = km2_lps, color = Country)) + 
      labs(title = "Compare Gridded to Stat", 
      subtitle = "km2 FAO grazing vs km2 pasture land lsp raster") +
      theme_ipsum_es() +
      theme(legend.position = "none") +
    geom_abline(intercept=0, slope=1, color="blue")

ggsave(here("animal_farm/disturbance/graze_area_plot.jpg"), dpi=300)
 
```

6. Compare the area of the cells we say have grazed animals with the fao grazed area data
Seems like the LSP system raster IDs more grassland. this isn't surprising because just because it's grassland and itd be possible to graze there, doens't mean that isis 100% happening. So Lets grab the cells that we assign grazing animals to and do the same analysis

```{r}

file_list <- list.files(path = file.path(prep, "animal_farm/farm/location_tifs"), pattern = "grassland", full.names = TRUE)

  stack <- stack(lapply(file_list, raster))
  
  grassland_animal_present <- sum(stack) 
  
  grassland_animal_present[grassland_animal_present > 0] <- 1
      names(grassland_animal_present) <- "grazed"
  plot(grassland_animal_present)
  
  grassland_animal_area <- area(grassland_animal_present)
      
  grazed_data <- zonal(grassland_animal_area, food_rgns_tif, fun="sum", progress="text", na.rm=TRUE) %>% 
  as_tibble() %>%  
  rename(ID_0 = zone) %>%
  left_join(food_rgns, by="ID_0") %>% 
  rename(km2_our_graze = sum) %>%
  select(-ID_0)

```

```{r}
compare_graze_area2 <- left_join(grazed_data,graze_perm_km2, by = "iso3c")
 
graze_area_plot <- ggplot(compare_graze_area2) +
      geom_point(aes(x = km2_fao, y = km2_our_graze, color = Country)) + 
      labs(title = "Compare our graze to Stat", 
      subtitle = "km2 FAO grazing vs km2 cells we have grazed in") +
      theme_ipsum_es() +
      theme(legend.position = "none") +
    geom_abline(intercept=0, slope=1, color="blue")

ggsave(here("animal_farm/disturbance/graze_area_plot_2.jpg"), dpi=300)
```

7. Using the HYDE grazing area data as a check

```{r}
graze <- raster(file.path(raw, "HYDE/baseline/2017AD_lu/grazing2017AD.asc"), crs = food_crs)
plot(graze)
```

Do some zonal stats to compare the total grazing land from HYDE to what FAO reports and to what the gridded reports

```{r}
hyde_summary_stats <- zonal(graze, food_rgns_tif, fun="sum", progress="text", na.rm=TRUE) %>% 
  as_tibble() %>%  
  rename(ID_0 = zone) %>%
  left_join(food_rgns, by="ID_0") %>% 
  rename(km2_hyde_graze = sum) %>%
  select(-ID_0)
```


```{r}

hyde_fao <- left_join(hyde_summary_stats, graze_perm_km2)
graze_area_plot <- ggplot(hyde_fao) +
      geom_point(aes(x = km2_hyde_graze, y = km2_fao, color = Country)) + 
      labs(title = "Compare hyde graze to fao graze")+ 
      theme_ipsum_es() +
      theme(legend.position = "none") +
    geom_abline(intercept=0, slope=1, color="blue")

ggsave(here("animal_farm/disturbance/plots/hyde_to_fao_graze.jpg"), dpi=300)

hyde_gridded <-  left_join(hyde_summary_stats, pasture_data)
graze_area_plot <- ggplot(hyde_gridded) +
      geom_point(aes(x = km2_hyde_graze, y = km2_lps, color = Country)) + 
      labs(title = "Compare hyde graze to pastureland cells")+ 
      theme_ipsum_es() +
      theme(legend.position = "none") +
    geom_abline(intercept=0, slope=1, color="blue")

ggsave(here("animal_farm/disturbance/plots/hyde_to_gridded.jpg"), dpi=300)
  
  

```

8. Compare the gridded lsp map grassland area with the cells where HYDE IDs grazed area
```{r}

lps_raster <- raster(file.path(raw, "FAO_livestock_maps/d2019/ruminant_production_systems/no_landless_production_maps/2_GlobalRuminantLPS_GIS/glps_gleam_61113_10km.tif"), crs = food_crs)

## must be a better way! 
## grassland
lps_raster[lps_raster == 1] <- 1
lps_raster[lps_raster == 2] <- 1
lps_raster[lps_raster == 3] <- 1
lps_raster[lps_raster == 4] <- 1

## mixed
lps_raster[lps_raster == 5] <- 2
lps_raster[lps_raster == 6] <- 2
lps_raster[lps_raster == 7] <- 2
lps_raster[lps_raster == 8] <- 2
lps_raster[lps_raster == 9] <- 2
lps_raster[lps_raster == 10] <- 2
lps_raster[lps_raster == 11] <- 2
lps_raster[lps_raster == 12] <- 2

## neither
lps_raster[lps_raster == 13] <- 3
lps_raster[lps_raster == 14] <- 3
lps_raster[lps_raster == 15] <- 3

plot(lps_raster)

## extents are weird/not matching so back and forth from raster_df (better way to do this maybe?)
lps_rast <- lps_raster %>% 
  raster_df() %>% 
  select(x,y, Value) %>% 
  rasterFromXYZ(crs = food_crs)

## grab the hyde data and wrangle to waht we need
hyde <- graze
hyde[hyde > 0] <- 3

plot(hyde)

hyde_rast <- hyde %>% 
  raster_df() %>% 
  select(x,y, Value = grazing2017AD) %>% 
  rasterFromXYZ(crs = food_crs)

hyde_rast_area <- graze/area(graze)
hyde_rast_area[hyde_rast_area >= 0.5] <- 3
hyde_rast_area[hyde_rast_area < 0.5] <- 0

```

Overlay the gridded and the pasture

```{r}
compare_grazed_rasters <- sum(lps_rast, hyde_rast, na.rm = TRUE)

plot(compare_grazed_rasters)

summary_compare <- compare_grazed_rasters %>% 
  raster_df() %>% 
  select(layer) %>% 
  na.omit() %>% 
  count(layer) %>% 
  mutate(description = case_when(layer == 4 ~ "gridded pasture & hyde graze",
                           layer == 1 ~ "gridded pasture & hyde no graze",
                           layer == 5 ~ "gridded mixed & hyde graze",
                           layer == 2 ~ "gridded mixed & hyde no graze",
                           layer == 6 ~ "gridded other & hyde graze",
                           layer == 3 ~ "gridded other & hyde no graze")) %>% 
  mutate(percent = n/sum(n)) %>% 
  select(description, number_cells = n, percent)

table <- summary_compare %>% 
  arrange(desc(percent)) %>% 
  gt()


```

Same table summary but with >50% area of hyde grazing land being a grazing cell


```{r}
compare_grazed_rasters2 <- lps_rast + hyde_rast_area

plot(compare_grazed_rasters2)

summary_compare2 <- compare_grazed_rasters2 %>% 
  raster_df() %>% 
  select(layer) %>% 
  na.omit() %>% 
  count(layer) %>% 
  mutate(description = case_when(layer == 4 ~ "gridded pasture & hyde graze",
                           layer == 1 ~ "gridded pasture & hyde no graze",
                           layer == 5 ~ "gridded mixed & hyde graze",
                           layer == 2 ~ "gridded mixed & hyde no graze",
                           layer == 6 ~ "gridded other & hyde graze",
                           layer == 3 ~ "gridded other & hyde no graze")) %>% 
  mutate(percent = n/sum(n)) %>% 
  select(description, number_cells = n, percent)

table <- summary_compare2 %>% 
  arrange(desc(percent)) %>% 
  gt()

```

