---
title: "FAO manure emissions data for all livestock"
date: "7/1/2020"
output: html_document
---

PROBABLY DELETE

Author: Juliette Verstaen

Objectives: We want to calculate an CO2-eq emissions factor for each animal/product combination for the 3 sources of emissions from manure.

Inputs: Here we use manure CO2-eq data from FAOStat (Manure Management, Manure applied to Soils, Manure left on Pasture). This data provide gigigrams of CO2-eq from manure managed, applied to soils, and left on pasture.

Outputs: csv file with the emissions factors. Missing regions will be gapfilled by median of UNGeopolitical regions

## Setup
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(here)
source(here("_workflow/common.R"))
```

## Methods
Read in all three data sets for the sources of emissions from manure (management, applied to crop fields, left on pastures)
```{r}
manage_raw <- read_csv(file.path(raw, "FAO_data/v2020/manure_data/FAO_livestock_manure_managed.csv"))
applied_raw <- read_csv(file.path(raw, "FAO_data/v2020/manure_data/FAO_livestock_manure_applied_soil.csv"))
left_raw <- read_csv(file.path(raw, "FAO_data/v2020/manure_data/FAO_livestock_manure_left_pasture.csv"))

## checked with setdiff() that all the countries are the same in the three data sets, they are
```

FAO reports cows as dairy and non-dairy (meat). However in the end we are going to want a specific emissions rate for each animal, product, system combination. To this we can use the GLEAM proportions calculated for each country for the 

we dont have FAO counts for backyard chickens, so just use the same 



Wrangle the separate emissions sources
```{r}
heads <-  manage_raw %>% 
  filter(Year == 2016) %>% 
  filter(Element == "Stocks") %>% 
  rename(number_heads = Value) %>% 
  select(country = Area, Item, number_heads) 

manage <- manage_raw %>% 
  filter(Year == 2016) %>% 
  filter(Element == "Emissions (CO2eq) (Manure management)") %>% 
  mutate(source = "manure management",
         co2_eq_tonnes = Value*1000) %>% 
  select(country = Area, Item, source, co2_eq_tonnes) 

applied <- applied_raw %>% 
  filter(Year == 2016) %>% 
  filter(Element == "Emissions (CO2eq) (Manure applied)")  %>% 
  mutate(source = "manure applied to soils",
         co2_eq_tonnes = Value*1000) %>% 
  select(country = Area, Item, source, co2_eq_tonnes) 

left <- left_raw %>% 
  filter(Year == 2016) %>% 
  filter(Element == "Emissions (CO2eq) (Manure on pasture)") %>% 
  mutate(source = "manure left on pasture",
         co2_eq_tonnes = Value*1000) %>% 
  select(country = Area, Item, source, co2_eq_tonnes) 

all_manure_int <- rbind(manage, applied, left) %>% 
  left_join(heads, by = c("country", "Item"))
```

Combine the pigs data
```{r}
pigs_combine <- all_manure_int %>% 
  filter(Item %in% c("Swine, breeding", "Swine, market")) %>% 
  group_by(country, source) %>% 
  mutate(co2_eq_tonnes = sum(co2_eq_tonnes),
         number_heads = sum(number_heads),
         animal = "pigs",
         product = "meat") %>% 
  select(-Item) %>% 
  unique() %>% 
  ungroup()
```

Add back in the pigs data, add in our project animal and project names
```{r}
all_manure <- all_manure_int %>% 
  filter(Item != "Swine, breeding",
         Item != "Swine, market") %>% 
   mutate(animal = case_when(Item == "Cattle, dairy" ~ "cattle",
                            Item == "Cattle, non-dairy" ~ "cattle",
                            Item == "Chickens, broilers" ~ "chickens",
                            Item == "Chickens, layers" ~ "chickens",
                            Item == "Goats" ~ "goats",
                            Item == "Sheep" ~ "sheep"),
  
         product = case_when(Item == "Cattle, dairy" ~ "milk",
                            Item == "Cattle, non-dairy" ~ "meat",
                            Item == "Chickens, broilers" ~ "meat",
                            Item == "Chickens, layers" ~ "eggs",
                            Item == "Goats" ~ "meat and milk",
                            Item == "Sheep" ~ "meat and milk"))%>% 
  select(-Item) %>% 
  rbind(pigs_combine) 
```

Do some country and iso3c wrangling and calculate emission rate per animal+source/year
```{r}
all_manure <- all_manure %>% 
  ## country names and iso3c wrangle
  filter(country != "China") %>% 
  mutate(country = ifelse(country == "Eswatini", "Swaziland", country),
         country = ifelse(country == "Netherlands Antilles (former)", "Bonaire, Sint Eustatius and Saba", country),
         country = ifelse(country == "French Guyana", "French Guiana", country),
         country = ifelse(country == "China, mainland", "China", country),
         iso3c = countrycode(country, origin="country.name", destination = "iso3c")) %>% 
## calculate emissions rate
  rowwise() %>% 
  mutate(co2eq_tonnes_per_head = co2_eq_tonnes/number_heads,
        co2eq_tonnes_per_head = ifelse(co2_eq_tonnes == 0 & number_heads == 0, 0, co2eq_tonnes_per_head)) %>% 
  rename(fao_country = country)
```

Now we want to gapfil missing regions with UN geopolitical regions
```{r}
un <- read_csv(here("_spatial/_output/UNSD_Methodology.csv")) %>% 
  dplyr::select(iso3c, Global_Name, Region_Name, Sub_region_Name, Intermediate_Region_Name, Region_Name)
```
*NOTE:* in the chickens there were a few countries where FAO reports 0 for emissions, but we have head counts for in our maps. So we went back to this stage and changed the 0 emissions rate to NA and gap filled. When going back over this when maps are finalized and gap filled, make sure to check for this discrepancy

For the regions that are missing information we will gapfill all the possible animal+product combinations. Most of these missing regions are small and unlikely to have all the animals, but when that is the case it will not matter when emissions factors are multiplied by the distribution maps.
```{r}
all_manure_gf_int <- food_rgns %>% 
  left_join(all_manure, by = "iso3c")

missing <- all_manure_gf_int %>%  filter(is.na(co2eq_tonnes_per_head)) %>% 
  select(iso3c) %>%
  as.vector() %>% 
  cbind(source = rep(c("manure management", "manure left on pasture", "manure applied to soils"), times = 28),
        animal_prod = rep(c("cattle milk", "cattle meat", "chickens meat", "chickens eggs", "goats", "sheep", "pigs meat"), each = 84)) %>% 
  left_join(food_rgns, by = "iso3c") %>% 
  mutate(fao_country = NA, co2_eq_tonnes = NA, number_heads = NA, co2eq_tonnes_per_head = NA) %>% 
  separate(animal_prod, c("animal", "product"), sep = " ") %>% 
  mutate(product = ifelse(is.na(product), "meat and milk", product))

all_manure_gf <- all_manure_gf_int %>% 
  filter(!is.na(co2eq_tonnes_per_head)) %>% 
  rbind(missing) %>% 
  mutate(gapfilled = ifelse(is.na(co2eq_tonnes_per_head), "gf with UN regions, a value here does not imply presence of livestock", NA)) %>% 
  left_join(un, by = c("iso3c")) %>% 
  group_by(Intermediate_Region_Name, source, animal, product) %>% 
  mutate(co2eq_tonnes_per_head = ifelse(is.na(co2eq_tonnes_per_head), mean(co2eq_tonnes_per_head, na.rm = TRUE), co2eq_tonnes_per_head)) %>% 
  ungroup() %>% 
  group_by(Sub_region_Name, source, animal, product) %>% 
  mutate(co2eq_tonnes_per_head = ifelse(is.na(co2eq_tonnes_per_head), mean(co2eq_tonnes_per_head, na.rm = TRUE), co2eq_tonnes_per_head)) %>% 
  ungroup() %>% 
  group_by(Region_Name, source, animal, product) %>% 
  mutate(co2eq_tonnes_per_head = ifelse(is.na(co2eq_tonnes_per_head), mean(co2eq_tonnes_per_head, na.rm = TRUE), co2eq_tonnes_per_head)) %>% 
  ungroup() 

write_csv(all_manure_gf, here("animal_farm/ghg/data/livestock_manure_emissions_gf.csv"))
```





