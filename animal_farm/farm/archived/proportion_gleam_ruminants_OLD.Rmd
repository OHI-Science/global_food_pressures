---
title: "Calculating and creating various data sets of proportions using the GLEAM data"
author: "Juliette"
date: "7/9/2020"
output: html_document
---

This markdown creates 2 data sets:

1. allocated the total number of goats and sheep in each system+product combination based off of GLEAM proportions
* This data set is going to need a lot of gapfilling after calculating current animal numbers. some places were gleam has numbers and fao does not and vice versa which end up with an NA for total count. will probably need to gapfil the same way we did for chickens.

2. proportion of goats, sheep, and cows in each of the respective production systems (does not include products) using GLEAM data

3. proportion of goats, sheep, and cows in milk/meat based off of production system. Also using GLEAM data


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(here)
library(countrycode)
library(readxl)

source(here("_workflow/common.R"))

gleam_ruminant_raw <- read_csv(here("animal_farm/farm/data/ruminants_GLEAMi_v2.csv"))

check_feedlots <-gleam_ruminant_raw %>% 
  filter(Production_system == "Feedlot operations",
         Variable == "HERD: total number of animals",
         Value > 0)


fao <- read_csv(here("animal_farm/farm/data/fao_livestock_headcount.csv")) 

fao_sheep_goat <-fao %>% 
  filter(animal == "sheep" | animal == "goats") %>% 
  rename(fao_rgn_animal_headcount = fao_headcount,
         fao_product = product)

fao_cows <- fao %>% 
   filter(animal == "cows") %>% 
   rename(fao_rgn_animal_headcount = fao_headcount)

fao_total_cows <- fao_cows %>% dplyr::summarise(total = sum(fao_rgn_animal_headcount))
# 1,488,964,581	total global cows

## un 
un <- read_csv(here("_spatial/_output/UNSD_Methodology.csv")) %>% 
  dplyr::select(iso3c, Global_Name, Region_Name, Sub_region_Name, Intermediate_Region_Name, Region_Name)
```

We are going to assume that animals classified as non-dairy are meat designated ruminants (except for buffalo). It's likely that some of the non-dairy cows are work cows and not raised solely for meat. However, we don't have that distinction in this data, so we will use the total values as is.

```{r}

gleam_ruminant_wrangle <- gleam_ruminant_raw %>% 
  
  ## fix the animal names
  mutate(Species = tolower(Species),
         Species = ifelse(Species == "cattle", "cows", Species)) %>% 
  rename(animal = Species) %>% 
  
  ## grab the data we are interested in
  filter(Variable == "HERD: total number of animals",
         Production_system != "All systems",
         animal != "buffalo") %>% 
  
  ## mixed and grassland have 3 herd types: whole, dairy and non dairy, while feedlot systems only have whole for herd type. 
  mutate(system = case_when(Production_system =="Grassland systems" ~ "grassland",
                            Production_system =="Mixed systems" ~ "mixed",
                            Production_system == "Feedlot operations" ~ "feedlot"),
         
         product = case_when(Herd_type == "Non-dairy" ~ "milk",
                             Herd_type == "Dairy" ~ "meat"),
         product = ifelse(system == "feedlot", "meat", product)) %>% 
  
  ## these NAs are a product of grass or mixed system with a herd type of "whole herd", so we need to get rid of them to avoid double counting
  filter(!is.na(product)) %>% 
  select(iso3c, country = Country, animal, system, product, headcount = Value)

```

Sheep and Goats
calculate proportions
```{r}
## Calculate proportions of total animal for each product and system combination
  gleam_ruminant_small <- gleam_ruminant_wrangle %>% 
  filter(animal == "sheep" | animal == "goats") %>% 
    group_by(iso3c, animal) %>% 
    mutate(gleam_rgn_animal_headcount = sum(headcount)) %>% 
    ungroup() %>% 
    rowwise() %>% 
    mutate(gleam_prop = headcount/gleam_rgn_animal_headcount,
           gleam_prop = ifelse(headcount ==0 & gleam_rgn_animal_headcount == 0, 0, gleam_prop)) %>% 
  right_join(food_rgns, by = "iso3c") %>% 
  select(-country)

length(unique(gleam_ruminant_small$iso3c))

```

Gapfill

We are missing 11 countries, and there are a bunch more countries the GLEAM says have 0 and FAO reports counts. We will gapfil proportions for these countries by 1) asuming a 50/50 split for milk/meat 2) calculate the percentage of livestock that fall in mixed/grassland based off of overlaying the lsp maps and gridded

Production system map df
```{r}
      
      lps_raster <- raster(file.path(raw, "FAO_livestock_maps/d2019/ruminant_production_systems/no_landless_production_maps/2_GlobalRuminantLPS_GIS/glps_gleam_61113_10km.tif"))
      ## the extent is a little bit off, so we will use the raster_df function. It might make things a little off, but shouldn't be too bad
      source(here("_spatial/template_raster.R"))
      
      lps_df <- lps_raster %>% 
        raster_df() %>% 
        select(x,y, cellindex, CLASSNAME) %>% 
        rename(glps_name = CLASSNAME) %>% 
        mutate(system = ifelse(glps_name == "LGA" | glps_name == "LGH" | glps_name =="LGT" | glps_name =="LGY", "grassland",
                               ifelse(glps_name == "MRY" | glps_name =="MIY" | glps_name =="MRA" | glps_name =="MIA"
               | glps_name =="MRT" | glps_name =="MRH" | glps_name =="MIT" | glps_name =="MIH",  "mixed", NA))) %>% 
        mutate(system = ifelse(is.na(glps_name), NA, system)) %>% 
        select(cellindex, system) %>% 
        left_join(food_rgns_xy, by = "cellindex") %>% 
        select(-x,-y)
  
```

```{r}
sheep_syst_prop <- raster(file.path(raw, "FAO_livestock_maps/d2019/sheep/5_Sh_2010_Da.tif")) %>% 
  raster_df() %>% 
  rename(cell_count_sh = 'X5_Sh_2010_Da') %>% 
  left_join(lps_df, by = "cellindex") %>% 
  group_by(iso3c, system) %>% 
  dplyr::summarise(system_total = sum(cell_count_sh, na.rm = TRUE)) %>% 
  ungroup() %>% 
  filter(!is.na(system)) %>% 
  group_by(iso3c) %>% 
  mutate(rgn_total = sum(system_total, na.rm = TRUE)) %>% 
  ungroup() %>% 
  rowwise() %>% 
  mutate(system_prop = system_total/rgn_total,
         animal = "sheep") %>% 
  ungroup() %>% 
  mutate(system_prop = ifelse(system_total == 0 & rgn_total == 0, 0, system_prop))

goat_syst_prop <- raster(file.path(raw, "FAO_livestock_maps/d2019/goats/5_Gt_2010_Da.tif")) %>% 
        raster_df() %>% 
  rename(cell_count_sh = 'X5_Gt_2010_Da') %>% 
  left_join(lps_df, by = "cellindex") %>% 
  group_by(iso3c, system) %>% 
  dplyr::summarise(system_total = sum(cell_count_sh, na.rm = TRUE)) %>% 
  ungroup() %>% 
  filter(!is.na(system)) %>% 
  group_by(iso3c) %>% 
  mutate(rgn_total = sum(system_total, na.rm = TRUE)) %>% 
  ungroup() %>% 
  rowwise() %>% 
  mutate(system_prop = system_total/rgn_total,
         animal = "goats") %>% 
  ungroup() %>% 
  mutate(system_prop = ifelse(system_total == 0 & rgn_total == 0, 0, system_prop))

small_rum_prop <- rbind (sheep_syst_prop, goat_syst_prop)
```



Gapfill
```{r}

add_category <- filter(gleam_ruminant_small, is.na(gleam_rgn_animal_headcount))%>% 
  ungroup() %>% 
  slice(rep(1:n(), each =2)) %>% 
  mutate(animal = rep(c("goats", "sheep"), times = 11)) %>% 
  slice(rep(1:n(), each = 2)) %>% 
  mutate(system = rep(c("grassland", "mixed"), times = 22))%>% 
  slice(rep(1:n(), each = 2)) %>% 
  mutate(product = rep(c("milk", "meat"), times = 44)) 

gf_prop <- gleam_ruminant_small %>% 
  filter(gleam_rgn_animal_headcount == 0 ) %>% 
  rbind(add_category) %>% 
  ungroup() %>% 
  mutate(product_prop = 0.5) %>% 
  left_join(small_rum_prop, by = c("iso3c", "animal", "system")) %>% 
  mutate(gf_prop = system_prop*product_prop,
         gf_prop = ifelse(is.na(gf_prop), 0, gf_prop)) %>% 
  select(iso3c, animal, system, product, gf_prop)

check <- gf_prop %>% 
  group_by(iso3c, animal) %>% 
  dplyr::summarise(check = sum(gf_prop, na.rm = TRUE))
## cool its all either 0 or 1

gf_list <- c(gf_prop$iso3c)

gleam_ruminant_small_gf <- gleam_ruminant_small %>% 
  left_join(gf_prop, by = c("iso3c", "animal", "system", "product")) %>% 
  mutate(gleam_prop = ifelse(iso3c %in% gf_list, gf_prop, gleam_prop))

```



Allocate the total count FAO data
```{r}
## use the proportions to allocate out total FAO data save the small ruminant data  
  gleam_sheep_goat <- gleam_ruminant_small_gf %>% 
    left_join(fao_sheep_goat, by = c("iso3c", "animal")) %>% 
    mutate(fao_allocated_headcount = fao_rgn_animal_headcount*gleam_prop) %>% 
    mutate(fao_allocated_headcount = ifelse(headcount == 0 & is.na(fao_rgn_animal_headcount), 0, fao_allocated_headcount)) # we can assume that if gleam reports 0 and there is no fao data that there are 0 animals, not NA
  
write_csv(gleam_sheep_goat, here("animal_farm/farm/data/fao_allocations_goat_sheep.csv")) 
    
##check
totals <- gleam_sheep_goat %>% 
  group_by(animal) %>% 
  dplyr::summarise(gleam = sum(headcount, na.rm = TRUE),
                   fao = sum(fao_allocated_headcount, na.rm = TRUE)) %>% 
  mutate(dif = fao - gleam)
```

Cows
calculate proportions
```{r}
## Calculate proportions of total animal for each product and system combination
  gleam_ruminant_large <- gleam_ruminant_wrangle %>% 
  filter(animal == "cows") %>% 
    group_by(iso3c, animal, product) %>% 
    mutate(gleam_rgn_animal_headcount = sum(headcount)) %>% 
    ungroup() %>% 
    rowwise() %>% 
    mutate(gleam_prop = headcount/gleam_rgn_animal_headcount,
           gleam_prop = ifelse(headcount == 0 & gleam_rgn_animal_headcount == 0, 0, gleam_prop)) %>% 
  ungroup()

total_gleam_headcount <- gleam_ruminant_large %>% dplyr::summarise(sum(headcount))
# 1,449,259,881; this is 39,704,700 less cows than FAO reports in 2016
```


Gapfill
```{r}

missing_list_cow <- setdiff(food_rgns$iso3c, gleam_ruminant_large$iso3c)

missing_cow <- as_tibble(missing_list_cow) %>% 
  rename(iso3c = value) %>% 
  mutate(animal = "cows") %>% 
  slice(rep(1:n(), each = 3)) %>% 
  mutate(system = rep(c("grassland", "mixed", "feedlot"), times = 11)) %>% 
  slice(rep(1:n(), each = 2)) %>% 
  mutate(product = rep(c("milk", "meat"), times = 33)) %>% 
  filter(system != "feedlot" | product != "milk") %>% 
  left_join(food_rgns, by = "iso3c") %>% 
  rename(country = Country) %>% 
  select(-ID_0) %>% 
  mutate(headcount = NA,
         gleam_rgn_animal_headcount = NA,
         gleam_prop = NA)

gleam_ruminant_large_gf <- rbind(gleam_ruminant_large, missing_cow) %>% 
  left_join(un, by = "iso3c") %>% 
  group_by(Intermediate_Region_Name, animal, system, product) %>% 
  mutate(gleam_prop = ifelse(is.na(gleam_prop), median(gleam_prop, na.rm = TRUE), gleam_prop)) %>% 
  ungroup() %>% 
  select(-Global_Name, -Region_Name, -Sub_region_Name, -Intermediate_Region_Name)

```

Allocate the total count FAO data
```{r}
## use the proportions to allocate out total FAO data save the small ruminant data  
gleam_cows <- gleam_ruminant_large_gf %>% 
  left_join(fao_cows, by = c("iso3c", "animal", "product")) %>% 
  rowwise() %>% 
  mutate(fao_allocated_headcount = fao_rgn_animal_headcount*gleam_prop) %>% 
  mutate(fao_allocated_headcount = ifelse(headcount == 0 & is.na(fao_rgn_animal_headcount), 0, fao_allocated_headcount)) %>%  # we can assume that if gleam reports 0 and there is no fao data that there are 0 animals, not NA
  ungroup()
  
fao_total <- gleam_cows %>% dplyr::summarise(sum = sum(fao_allocated_headcount, na.rm = TRUE))
# 1,416,691,759	
## we have 72,272,822 less cows now then we started with (fao data). This is loosing 4.9% of our global cows. 

## checking if there are countries where gleam has 0 cows and fao reports some, which would result in 0gleamcellprop*faoheadcount and then just make those cows disappear
check <- gleam_cows %>% 
  select(iso3c, animal, product, headcount) %>% 
  group_by(iso3c, animal, product) %>% 
  dplyr::summarise(gleam_headcount = sum(headcount)) %>% 
  ungroup() %>% 
  left_join(fao_cows, by = c("iso3c", "animal", "product"))

test <- check %>% 
  filter(gleam_headcount == 0 & fao_rgn_animal_headcount >0) %>% 
  dplyr::summarise(total_missing = sum(fao_rgn_animal_headcount))
# 72,125,754

## Okay I think I figured out where the cows are running off to. We will fix this when gapfilling later down the line. since its not exact it looks like GLEAM will have some cows in countries where FAO doesn't report them

write_csv(gleam_cows, here("animal_farm/farm/data/fao_allocations_cows.csv")) 
```

the totals sugest that we FAO has 3 million less cows in 2016 than gleam reports in 2010...  need to check this. looking like FAO data is consistently less than the GLEAM. look into the faostat meta dta again to check what they include in cows/cattle


Calculate the proportions by system only
```{r}
system_proportions <- gleam_ruminant_wrangle %>% 
  select(-product) %>% 
  group_by(iso3c, country, animal, system) %>% 
  dplyr::summarise(headcount_system = sum(headcount)) %>% 
  ungroup() %>% 
  group_by(iso3c, country, animal) %>% 
  mutate(headcount_total = sum(headcount_system)) %>% 
  ungroup() %>% 
  rowwise() %>% 
  mutate(system_prop = headcount_system/headcount_total,
         system_prop = ifelse(headcount_total== 0 & headcount_system == 0, 0, system_prop))


## gapfill

system_missing <- setdiff(food_rgns$iso3c, system_proportions$iso3c)

missing_sys <- as_tibble(system_missing) %>% 
  rename(iso3c = value) %>% 
  slice(rep(1:n(), each =3)) %>% 
  mutate(animal = rep(c("goats", "sheep", "cows"), times = 11)) %>% 
  slice(rep(1:n(), each = 2)) %>% 
  mutate(system = rep(c("grassland", "mixed"), times = 33))

missing_feedlot <- as_tibble(system_missing) %>% 
  rename(iso3c = value) %>% 
  mutate(animal = "cows",
         system = "feedlot")

missing_sys <- rbind(missing_sys, missing_feedlot) %>% 
  left_join(food_rgns, by = "iso3c") %>% 
  rename(country = Country) %>% 
  select(-ID_0) %>% 
  mutate(headcount_system = NA,
         headcount_total = NA,
         system_prop = NA)

system_proportions_gf <- rbind(system_proportions, missing_sys) %>% 
  left_join(un, by = "iso3c") %>% 
  group_by(Intermediate_Region_Name, animal, system) %>% 
  mutate(system_prop = ifelse(is.na(system_prop), median(system_prop, na.rm = TRUE), system_prop)) %>% 
  ungroup() %>% 
  select(-Global_Name, -Region_Name, -Sub_region_Name, -Intermediate_Region_Name)

write_csv(system_proportions, here("animal_farm/farm/data/ruminant_gleam_system_proportions.csv")) 
```









