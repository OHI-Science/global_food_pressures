---
title: "Calculating and creating various data sets of proportions using the GLEAM data"
author: "Juliette"
date: "7/9/2020"
output: html_document
---

This markdown creates a data sets of the  proportion of goats, sheep, and cows in milk/meat based off of production system using GLEAM data.


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(here)
library(countrycode)
library(readxl)

source(here("_workflow/common.R"))

gleam_ruminant_raw <- read_csv(here("animal_farm/farm/data/ruminants_GLEAMi_v2.csv"))

check_feedlots <-gleam_ruminant_raw %>% 
  filter(Production_system == "Feedlot operations",
         Variable == "HERD: total number of animals",
         Value > 0)

## un 
un <- read_csv(here("_spatial/_output/UNSD_Methodology.csv")) %>% 
  dplyr::select(iso3c, Region_Name)
```

We are going to assume that animals classified as non-dairy are meat designated ruminants (except for buffalo). It's likely that some of the non-dairy cows are work cows and not raised solely for meat. However, we don't have that distinction in this data, so we will use the total values as is.

```{r}

gleam_ruminant_wrangle <- gleam_ruminant_raw %>% 
  
  ## fix the animal names
  mutate(Species = tolower(Species),
         Species = ifelse(Species == "cattle", "cows", Species)) %>% 
  rename(animal = Species) %>% 
  
  ## grab the data we are interested in
  filter(Variable == "HERD: total number of animals",
         Production_system != "All systems",
         animal != "buffalo") %>% 
  
  ## mixed and grassland have 3 herd types: whole, dairy and non dairy, while feedlot systems only have whole for herd type. 
  mutate(system = case_when(Production_system =="Grassland systems" ~ "grassland",
                            Production_system =="Mixed systems" ~ "mixed",
                            Production_system == "Feedlot operations" ~ "feedlot"),
         
         product = case_when(Herd_type == "Non-dairy" ~ "meat",
                             Herd_type == "Dairy" ~ "milk"),
         product = ifelse(system == "feedlot", "meat", product)) %>% 
  
  ## these NAs are a product of grass or mixed system with a herd type of "whole herd", so we need to get rid of them to avoid double counting
  filter(!is.na(product)) %>% 
  select(iso3c, country = Country, animal, system, product, headcount = Value) %>% 
  left_join(un, by = "iso3c")

```


Calculate the proportions by product only

Here we need to check the countries that report 0 animals total, thus a product proportion of 0. We don't want to loose those countries livestock if the gridded maps in fact have counts. To gapfill these we will need to look at the general continental median for milk and then calculate 1-milk prop for meat.

```{r}

product_proportions <- gleam_ruminant_wrangle %>% 
  group_by(iso3c, country, animal, system) %>% 
  mutate(headcount_system = sum(headcount)) %>% 
  ungroup() %>% 
  rowwise() %>% 
  mutate(product_prop = headcount/headcount_system,
         product_prop = ifelse(headcount== 0 & headcount_system == 0, 0, product_prop)) %>% 
  group_by(iso3c, animal) %>% 
  mutate(animal_rgn_total = sum(headcount)) %>% 
  ungroup() %>% 
  group_by(iso3c, animal, system) %>% 
  mutate(animal_rgn_syst_total = sum(headcount)) %>% 
  ungroup()

# check <- product_proportions %>% 
#   group_by(iso3c, animal, system) %>% 
#   filter(n() <= 1) 

## explore meat vs milk proportions

explore_cows <- product_proportions %>% filter(animal_rgn_total != 0, animal == "cows")
explore_goats <- product_proportions %>% filter(animal_rgn_total != 0, animal == "goats")
explore_sheep <- product_proportions %>% filter(animal_rgn_total != 0, animal == "sheep")

## histograms 
ggplot(explore_cows) +
  geom_histogram(aes(x= product_prop), fill = "gray65") +
  facet_grid(cols = vars(product), rows = vars(system)) +
  labs(title = "Cows") +
  theme_minimal()

ggplot(explore_goats) +
  geom_histogram(aes(x= product_prop), fill = "gray65") +
  facet_grid(cols = vars(product), rows = vars(system)) +
  labs(title = "Goats") +
  theme_minimal()

ggplot(explore_sheep) +
  geom_histogram(aes(x= product_prop), fill = "gray65") +
  facet_grid(cols = vars(product), rows = vars(system)) +
  labs(title = "Sheep") +
  theme_minimal()

##scatter to see differences between regions

## square = mean triangle = median

ggplot(explore_goats) + 
geom_point(aes(y = product_prop, x = Region_Name, color = Region_Name), 
             position = position_jitterdodge(dodge.width = 0.8)) +
  facet_grid(cols = vars(product), rows = vars(system)) +
  theme_light() +
  labs(title = "Goats") +
  stat_summary(mapping = aes(y = product_prop, x = Region_Name),
               fun = "mean", geom = "point", shape = 0, size = 4, color = "black",
               position = position_dodge(width = 0.8)) +
  stat_summary(mapping = aes(y = product_prop, x = Region_Name),
               fun = "median", geom = "point", shape = 2, size = 4, color = "black",
               position = position_dodge(width = 0.8)) + 
  theme(legend.position = "none")

ggplot(explore_cows) + 
geom_point(aes(y = product_prop, x = Region_Name, color = Region_Name), 
             position = position_jitterdodge(dodge.width = 0.8)) +
  facet_grid(cols = vars(product), rows = vars(system)) +
  theme_light() +
  labs(title = "Cows") +
  stat_summary(mapping = aes(y = product_prop, x = Region_Name),
               fun = "mean", geom = "point", shape = 0, size = 4, color = "black",
               position = position_dodge(width = 0.8)) +
  stat_summary(mapping = aes(y = product_prop, x = Region_Name),
               fun = "median", geom = "point", shape = 2, size = 4, color = "black",
               position = position_dodge(width = 0.8)) + 
  theme(legend.position = "none")

ggplot(explore_sheep) + 
geom_point(aes(y = product_prop, x = Region_Name, color = Region_Name), 
             position = position_jitterdodge(dodge.width = 0.8)) +
  facet_grid(cols = vars(product), rows = vars(system)) +
  theme_light() +
  labs(title = "Sheep") +
  stat_summary(mapping = aes(y = product_prop, x = Region_Name),
               fun = "mean", geom = "point", shape = 0, size = 4, color = "black",
               position = position_dodge(width = 0.8)) +
  stat_summary(mapping = aes(y = product_prop, x = Region_Name),
               fun = "median", geom = "point", shape = 2, size = 4, color = "black",
               position = position_dodge(width = 0.8)) + 
  theme(legend.position = "none")



```

Using the graphs above we created product_prop.csv with proportions for milk/meat wihtin each animal and system category by UN Regions (basically continents). 

Fro gapfiling we will not only gapfill the countries where 0 total animals are recorded in the region, bu also where 0 total animals are recorded in teh system. EX: This is because down the line, the gridded livestock reports counts in grassland and 0 in mixed, but this GLEAM data reports all their livestock in mixed so we loose those animals when allocating for product counts

Now actually gapfill
```{r}

## df with proportions for gapfilling
gf_values <- read_csv(here("animal_farm/farm/data/continent_product_props.csv")) %>% 
  pivot_longer(cols = 4:8, names_to = "Region_Name") %>% 
  rename(gf_prop = value)

## pull out the countries with a total system animal headcount of 0  

to_gapfill <- product_proportions %>% 
  filter(animal_rgn_syst_total == 0) %>% 
  mutate(product_prop = NA)
  
## grab the countries that are in our rgn list but GLEAM does not include; create a line for each of our categories

rgns_missing <- setdiff(food_rgns$iso3c, product_proportions$iso3c)

missing <- as_tibble(rgns_missing) %>% 
  rename(iso3c = value) %>% 
  slice(rep(1:n(), each =3)) %>% 
  mutate(animal = rep(c("goats", "sheep", "cows"), times = 11)) %>% 
  slice(rep(1:n(), each = 2)) %>% 
  mutate(system = rep(c("grassland", "mixed"), times = 33)) %>% 
  slice(rep(1:n(), each = 2)) %>% 
  mutate(product = rep(c("milk", "meat"), times = 66))

missing_feedlot <- as_tibble(rgns_missing) %>% 
  rename(iso3c = value) %>% 
  mutate(animal = "cows",
         system = "feedlot",
         product = "meat")

missing_cat <- rbind(missing, missing_feedlot) %>% 
  left_join(food_rgns, by = "iso3c") %>% 
  rename(country = Country) %>% 
  select(-ID_0) %>% 
  mutate(headcount = NA,
         headcount_system = NA,
         product_prop = NA,
         animal_rgn_total = NA,
         animal_rgn_syst_total = NA) %>% 
  left_join(un, by = "iso3c")


gapfill <- rbind(to_gapfill, missing_cat) %>% 
  mutate(gapfill = "product_prop gapfilled with general region median") %>% 
  left_join(gf_values, by = c("animal", "system", "product", "Region_Name")) %>% 
  mutate(product_prop = gf_prop,
         product_prop = ifelse(is.na(product_prop), 0, product_prop)) %>%  ## these are all feedlots
  select(-Region_Name, -gf_prop)

## add back in the gapfilled values to the main df

product_proportions_gf <- product_proportions %>% 
  select(-Region_Name) %>% 
  filter(animal_rgn_syst_total != 0) %>% 
  mutate(gapfill = NA) %>% 
  rbind(gapfill)

write_csv(product_proportions_gf, here("animal_farm/farm/data/ruminant_product_proportions_gf.csv")) 
```






