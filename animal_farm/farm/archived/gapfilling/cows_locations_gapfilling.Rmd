---
title: "Cows location gapfilling"
author: "Juliette"
date: "8/26/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

1. Check that all the countries that FAO reports data for we have not lost in the process of allocating them to the gridded maps

2. Next, we will look at the gridded livestock maps to see if they report counts where FAO does not. If this is the case we will have lost those chickens. We will pull those countries out, and multiply by the proportional change from 2010 to 2016. Then we will gap fill these countries by applying the counts evenly across the cells of the region.

3. Lastly we will look so see if GLEAM reports counts where our updated maps do not. Currently we are not using these GLEAM values to gapfill because of the apparent discrepancy in their methods versus the way we calculated the differnces in grass/mixed. We had to do it the way we did in order to spatialize distribution

## Load our libraries and read in the maps and data we need
```{r}
library(here)
source(here("_workflow/common.R"))
source(here("_workflow/common_spatial.R"))

'%notin%' <- Negate('%in%')

## our maps
cows_meat_grass <- read_csv(file.path(prep, "animal_farm/farm/ungapfilled/cows_grassland_meat_location_df_ungf.csv"), col_type = "ddcccccnnnnnn") ## check the col types
cows_milk_grass <- read_csv(file.path(prep, "animal_farm/farm/ungapfilled/cows_grassland_milk_location_df_ungf.csv"), col_type = "ddcccccnnnnnn")
cows_meat_mix <- read_csv(file.path(prep, "animal_farm/farm/ungapfilled/cows_mixed_meat_location_df_ungf.csv"), col_type = "ddcccccnnnnnn")
cows_milk_mix <- read_csv(file.path(prep, "animal_farm/farm/ungapfilled/cows_mixed_milk_location_df_ungf.csv"), col_type = "ddcccccnnnnnn")

## FAO stat data
fao_cows_milk <- read_csv(here("animal_farm/farm/data/fao_livestock_headcount.csv")) %>% 
  filter(animal == "cows",
         product == "milk")

fao_cows_meat <- read_csv(here("animal_farm/farm/data/fao_livestock_headcount.csv")) %>% 
  filter(animal == "cows",
         product == "meat")

# un gapfilling regions
un <- read_csv(here("_spatial/_output/UNSD_Methodology.csv")) %>% 
  dplyr::select(iso3c, Global_Name, Region_Name, Sub_region_Name, Intermediate_Region_Name, Region_Name)

```


## 1. Check that we didn't loose FAO stat data along the way 
We will need to summarize the cows at the milk and meat level since FAO doens't distinguish any of our categories further

```{r}

## milk cows
cows_milk_grass_sum <- cows_milk_grass %>% 
  group_by(iso3c) %>% 
  dplyr::summarise(total = sum(current_count, na.rm = TRUE)) %>% 
  ungroup() %>% 
  na.omit()

cows_milk_mix_sum <- cows_milk_mix %>% 
  group_by(iso3c) %>% 
  dplyr::summarise(total = sum(current_count, na.rm = TRUE)) %>% 
  ungroup() %>% 
  na.omit()

## meat cows
cows_meat_grass_sum <- cows_meat_grass %>% 
  group_by(iso3c) %>% 
  dplyr::summarise(total = sum(current_count, na.rm = TRUE)) %>% 
  ungroup() %>% 
  na.omit()

cows_meat_mix_sum <- cows_meat_mix %>% 
  group_by(iso3c) %>% 
  dplyr::summarise(total = sum(current_count, na.rm = TRUE)) %>% 
  ungroup() %>% 
  na.omit()

our_cows_milk <- rbind(cows_milk_grass_sum, cows_milk_mix_sum) %>% 
  group_by(iso3c) %>% 
  dplyr::summarise(our_count = sum(total))

our_cows_meat <- rbind(cows_meat_grass_sum, cows_meat_mix_sum) %>% 
  group_by(iso3c) %>% 
  dplyr::summarise(our_count = sum(total))

##compare with FAO
milk_fao_lost <- left_join(our_cows_milk, fao_cows_milk, by = "iso3c") %>% 
  filter(our_count == 0 & fao_headcount > 0) %>% 
  select(iso3c, fao_headcount)
## 9 countries
milk_fao_lost_list <- milk_fao_lost$iso3c

meat_fao_lost <- left_join(our_cows_meat, fao_cows_meat, by = "iso3c") %>% 
  filter(our_count == 0 & fao_headcount > 0)%>% 
  select(iso3c, fao_headcount)
## 9 countries 
meat_fao_lost_list <- meat_fao_lost$iso3c

```
For the countries where FAO reports headcounts that are not included in the gridded maps we will evenly distribute them across each region's mixed or grassland (depending on which )

Grab the livestock production raster df
```{r}

lps_raster <- raster(file.path(raw, "FAO_livestock_maps/d2019/ruminant_production_systems/no_landless_production_maps/2_GlobalRuminantLPS_GIS/glps_gleam_61113_10km.tif"))
      ## the extent is a little bit off, so we will use the raster_df function. It might make things a little off, unsure how much that will influence the allocation of mixed vs grassland critters

source(here("_spatial/template_raster.R"))

lps_df <- lps_raster %>% 
  raster_df() %>% 
  select(x,y, cellindex, CLASSNAME) %>% 
  rename(glps_name = CLASSNAME) %>%
  mutate(system = case_when(glps_name == "LGA" | glps_name == "LGH" | glps_name =="LGT" | glps_name =="LGY" ~ "grassland",
                            glps_name == "MRY" | glps_name =="MIY" | glps_name =="MRA" | glps_name =="MIA" | glps_name =="MRT" | glps_name =="MRH" | glps_name =="MIT" | glps_name =="MIH" ~ "mixed")) %>% 
  select(cellindex, cell_system = system)

```

Now that we have a map with the mixed and grassland areas identified, we will need to use the system proportion df
Read in the system proportions for cows calculated from the gridded data and gapfilled with the general continent median 

```{r}
syst_prop <- read_csv(here("animal_farm/farm/data/rum_system_prop.csv")) %>% 
  select(-gapfill) %>% 
  filter(animal == "cows")

# prod_prop <- read_csv(here("animal_farm/farm/data/ruminant_product_proportions_gf.csv"), col_types = "cccccnnnnc" ) %>% 
#   select(iso3c, animal, system, product, product_prop) %>% 
#   filter(animal != "cows")

# category_prop <- prod_prop %>% 
#   left_join(syst_prop, by = c("iso3c", "animal", "system")) %>% 
#   mutate(cat_prop = product_prop*system_prop) %>% 
#   select(iso3c, animal, system, product, cat_prop)

```

Now we will evenly distribute the milk/meat cows across the LPS map


Dairy cows first
milk Mixed
```{r}
food_rgns_xy_short <- food_rgns_xy %>% select(x,y, cellindex)

cows_milk_mix_missing <- cows_milk_mix %>% 
  left_join(food_rgns_xy_short, by = c("x", "y")) %>%  ## just need the cell ID here
  left_join(lps_df, by = "cellindex") %>% 
  dplyr::filter(iso3c %in% milk_fao_lost_list) %>%   
  left_join(syst_prop, by = c("iso3c", "animal", "system")) %>% 
  mutate(system_math = case_when(cell_system == "mixed" ~ 1, 
                                 cell_system == "grassland" ~ 0,
                                 T ~ system_prop)) %>%
  group_by(iso3c) %>% 
  mutate(cell_total = n()) %>% 
  ungroup() %>%
  mutate(current_count = (fao_headcount/cell_total)*system_math*system_prop) %>% 
  select(-cell_total) %>% 
  mutate(gapfill = "fao stat values evenly distributed among cells in region") %>% 
  select(-cellindex, -cell_system, -system_math, -system_prop) 

## add
cows_milk_mix_gf1 <- cows_milk_mix  %>% 
  filter(iso3c %notin% milk_fao_lost_list) %>% 
  mutate(gapfill = NA) %>% 
  rbind(cows_milk_mix_missing)
  
```

Meat Mix
```{r}

cows_meat_mix_missing <- cows_meat_mix %>% 
  left_join(food_rgns_xy_short, by = c("x", "y")) %>%  ## just need the cell ID here
  left_join(lps_df, by = "cellindex") %>% 
  dplyr::filter(iso3c %in% meat_fao_lost_list) %>%   
  left_join(syst_prop, by = c("iso3c", "animal", "system")) %>% 
  mutate(system_math = case_when(cell_system == "mixed" ~ 1, 
                                 cell_system == "grassland" ~ 0,
                                 T ~ system_prop)) %>%
  group_by(iso3c) %>% 
  mutate(cell_total = n()) %>% 
  ungroup() %>%
  mutate(current_count = (fao_headcount/cell_total)*system_math*system_prop) %>% 
  select(-cell_total) %>% 
  mutate(gapfill = "fao stat values evenly distributed among cells in region") %>% 
  select(-cellindex, -cell_system, -system_math, -system_prop) 

## add
cows_meat_mix_gf1 <- cows_meat_mix  %>% 
  filter(iso3c %notin% meat_fao_lost_list) %>% 
  mutate(gapfill = NA) %>% 
  rbind(cows_meat_mix_missing)

```

Milk Grass
```{r}

cows_milk_grass_missing <- cows_milk_grass %>% 
  left_join(food_rgns_xy_short, by = c("x", "y")) %>%  ## just need the cell ID here
  left_join(lps_df, by = "cellindex") %>% 
  dplyr::filter(iso3c %in% milk_fao_lost_list) %>%   
  left_join(syst_prop, by = c("iso3c", "animal", "system")) %>% 
  mutate(system_math = case_when(cell_system == "grassland" ~ 1,
                                 cell_system == "mixed" ~ 0,
                                 T ~ system_prop)) %>%
  group_by(iso3c) %>% 
  mutate(cell_total = n()) %>% 
  ungroup() %>%
  mutate(current_count = (fao_headcount/cell_total)*system_math*system_prop) %>% 
  select(-cell_total) %>% 
  mutate(gapfill = "fao stat values evenly distributed among cells in region") %>% 
  select(-cellindex, -cell_system, -system_math, -system_prop) 

## add
cows_milk_grass_gf1 <- cows_milk_grass  %>% 
  filter(iso3c %notin% milk_fao_lost_list) %>% 
  mutate(gapfill = NA) %>% 
  rbind(cows_milk_grass_missing)

```

Meat Grass
```{r}

cows_meat_grass_missing <- cows_meat_grass %>% 
  left_join(food_rgns_xy_short, by = c("x", "y")) %>%  ## just need the cell ID here
  left_join(lps_df, by = "cellindex") %>% 
  dplyr::filter(iso3c %in% meat_fao_lost_list) %>%   
  left_join(syst_prop, by = c("iso3c", "animal", "system")) %>% 
  mutate(system_math = case_when(cell_system == "grassland" ~ 1,
                                 cell_system == "mixed" ~ 0,
                                 T ~ system_prop)) %>%
  group_by(iso3c) %>% 
  mutate(cell_total = n()) %>% 
  ungroup() %>%
  mutate(current_count = ((fao_headcount*system_prop)*system_math)/cell_total) %>% 
  select(-cell_total) %>% 
  mutate(gapfill = "fao stat values evenly distributed among cells in region") %>% 
  select(-cellindex, -cell_system, -system_math, -system_prop) 

## add
cows_meat_grass_gf1 <- cows_meat_grass  %>% 
  filter(iso3c %notin% meat_fao_lost_list) %>% 
  mutate(gapfill = NA) %>% 
  rbind(cows_meat_grass_missing)
  
```


Now we want to compare the countries that have sheep/goats in the gridded maps. But that we dont have in FAO

We are going to want to sum up the total animals in our new gapfilled maps and check to see if there are countries where gridded reports values but FAO does not. For these will we be able to gapfil with cell_count_category and just scale from 2010 to 2016

sum of our goats/sheep

```{r}

cows_milk_grass_sum <- cows_milk_grass_gf1 %>% 
  group_by(iso3c) %>% 
  dplyr::summarise(total = sum(current_count, na.rm = TRUE)) %>% 
  ungroup() %>% 
  na.omit()

cows_milk_mix_sum <- cows_milk_mix_gf1 %>% 
  group_by(iso3c) %>% 
  dplyr::summarise(total = sum(current_count, na.rm = TRUE)) %>% 
  ungroup() %>% 
  na.omit()

cows_meat_grass_sum <- cows_meat_grass_gf1 %>% 
  group_by(iso3c) %>% 
  dplyr::summarise(total = sum(current_count, na.rm = TRUE)) %>% 
  ungroup() %>% 
  na.omit()

cows_meat_mix_sum <- cows_meat_mix_gf1 %>% 
  group_by(iso3c) %>% 
  dplyr::summarise(total = sum(current_count, na.rm = TRUE)) %>% 
  ungroup() %>% 
  na.omit()

our_cows <- rbind(cows_milk_grass_sum, cows_milk_mix_sum, cows_meat_grass_sum, cows_meat_mix_sum) %>% 
  group_by(iso3c) %>% 
  dplyr::summarise(our_count = sum(total))

```


sum of gridded
```{r}

gridded_cows <- raster(file.path(raw, "FAO_livestock_maps/d2019/cattle/5_Ct_2010_Da.tif")) %>% 
  zonal(food_rgns_tif, fun = "sum") %>% 
  as_tibble() %>% 
  dplyr::rename(ID_0 = zone) %>% 
  left_join(food_rgns, by = "ID_0") %>% 
  rename(gridded_count = sum)


```

Compare our total values with the gridded data.See if there are countries that the gridded maps include by FAO does not 
We have alreadt calculated a headcount by category for each cell in our maps. Now we just need to rescalre it from 2010 to 2016 values
```{r}
##compare with gridded
cows_grid_lost <- left_join(our_cows, gridded_cows, by = "iso3c") %>% 
  filter(our_count == 0 & gridded_count > 0) %>% 
  select(iso3c, gridded_count)
## 19 countries
cows_grid_lost_list <- cows_grid_lost$iso3c
```

Grab the scaling factor for sheep and goats 2010-2016

```{r}
prop_change <- read_csv(here("animal_farm/farm/data/prop_change_2010_2016.csv")) %>% 
  select(iso3c, animal, prop_change) %>% 
  filter(animal %in% c("dairy cow", "meat cow")) %>% 
  mutate(product = case_when(animal == "dairy cow" ~ "milk",
                             animal == "meat cow" ~ "meat"),
         animal = "cows")
```

Meat Mixed
Since we are using the gridded values, we need to add in the product proportions. We haven't needed to do this in any of our analysis to date because we've been working with FAO data which already provides it as dairy/meat
```{r}

product_prop <- read_csv(here("animal_farm/farm/data/ruminant_product_proportions_gf.csv")) %>% 
  select(iso3c, animal, system, product, product_prop)

cows_grid_miss <- cows_meat_mix_gf1  %>% 
  filter(iso3c %in% cows_grid_lost_list) %>% 
  left_join(product_prop, by = c("iso3c", "animal", "system", "product")) %>% 
  left_join(prop_change, by = c("iso3c", "animal", "product")) %>% 
  mutate(gapfill = "gf with gridded values*prop change",
         current_count = cell_headcount_system*product_prop*prop_change) %>% 
  select(-prop_change, -product_prop)

cows_meat_mix_gf2 <- cows_meat_mix_gf1 %>% 
  filter(iso3c %notin% cows_grid_lost_list) %>% 
  rbind(cows_grid_miss)
  
```

Milk Mixed
```{r}
cows_grid_miss <- cows_milk_mix_gf1  %>% 
  filter(iso3c %in% cows_grid_lost_list) %>% 
  left_join(product_prop, by = c("iso3c", "animal", "system", "product")) %>% 
  left_join(prop_change, by = c("iso3c", "animal", "product")) %>% 
  mutate(gapfill = "gf with gridded values*prop change",
         current_count = cell_headcount_system*product_prop*prop_change) %>% 
  select(-prop_change, -product_prop)

cows_milk_mix_gf2 <- cows_milk_mix_gf1 %>% 
  filter(iso3c %notin% cows_grid_lost_list) %>% 
  rbind(cows_grid_miss)
  
```

Meat grass
```{r}
cows_grid_miss <- cows_meat_grass_gf1  %>% 
  filter(iso3c %in% cows_grid_lost_list) %>% 
  left_join(product_prop, by = c("iso3c", "animal", "system", "product")) %>% 
  left_join(prop_change, by = c("iso3c", "animal", "product")) %>% 
  mutate(gapfill = "gf with gridded values*prop change",
         current_count = cell_headcount_system*product_prop*prop_change) %>% 
  select(-prop_change, -product_prop)

cows_meat_grass_gf2 <- cows_meat_grass_gf1 %>% 
  filter(iso3c %notin% cows_grid_lost_list) %>% 
  rbind(cows_grid_miss)
  
```

Milk grass
```{r}
cows_grid_miss <- cows_milk_grass_gf1  %>% 
  filter(iso3c %in% cows_grid_lost_list) %>% 
  left_join(product_prop, by = c("iso3c", "animal", "system", "product")) %>% 
  left_join(prop_change, by = c("iso3c", "animal", "product")) %>% 
  mutate(gapfill = "gf with gridded values*prop change",
         current_count = cell_headcount_system*product_prop*prop_change) %>% 
  select(-prop_change, -product_prop)

cows_milk_grass_gf2 <- cows_milk_grass_gf1 %>% 
  filter(iso3c %notin% cows_grid_lost_list) %>% 
  rbind(cows_grid_miss)
  
```


We have decided to not include these GLEAM values in our gapfilling for goats and sheep because their methods for calucalting are much different than FAO stat or gridded.

Save the files

```{r}
write_csv(cows_meat_mix_gf2, file.path(prep, "animal_farm/farm/cows_mixed_meat_location_df.csv"))
write_csv(cows_meat_grass_gf2, file.path(prep, "animal_farm/farm/cows_grassland_meat_location_df.csv"))
write_csv(cows_milk_mix_gf2, file.path(prep, "animal_farm/farm/cows_mixed_milk_location_df.csv"))
write_csv(cows_milk_grass_gf2, file.path(prep, "animal_farm/farm/cows_grassland_milk_location_df.csv"))

```


