---
title: "Create raster of disturbance for all marine fisheries"
author: "Melanie Frazier (UCSB, NCEAS, OHI)"
date: "May 21, 2019"
output: html_document
editor_options: 
  chunk_output_type: console
---

The goal of this is to determine how destructive marine fisheries are.

The first step is to estimate the destructiveness of all fisheries.  From this we will subset different categories, such as the pelagic fisheries.

```{r}
#load relevant packages, etc.

library(here)
library(raster)
library(tidyverse)
library(doParallel)
library(foreach)
library(parallel)

# raster template
r <- raster::raster(ncol=720, nrow=360, vals=c(1:259200))
food_raster <- raster(nrows=2160, ncols=4320, xmn=-180, xmx=180, ymn=-90, ymx=90)
hab_raster <- raster("/home/shares/food-systems/Food_footprint/_raw_data/Halpern_chi/habitats/coral_reef.tif")
```


## Step 1: Classify catch into demersal destructive/nondestructive
Get all the data together...
```{r}

catch <- read_csv("/home/shares/food-systems/Food_footprint/_raw_data/watson_data/v5.0/Catch2015_2019.csv")

# event_index <- read_csv("/home/shares/food-systems/Food_footprint/_raw_data/watson_data/v3.0/IndexInd.csv") %>%
#   dplyr::select(ID, IYear, CNumber, TaxonKey=Taxonkey, Gear)

taxa_index <- read_csv("/home/shares/food-systems/Food_footprint/_raw_data/watson_data/v5.0/Codes_taxa.csv")
gear_index <- read_csv("/home/shares/food-systems/Food_footprint/_raw_data/watson_data/v5.0/Codes_gear.csv") %>%
  dplyr::select(Gear, FleetGearName) %>%
  unique()

taxa_gear_types <- read_csv(here("fisheries/marine/marine_fisheries_old/data/taxa_gear_types.csv"))

head(taxa_gear_types)

#catch_full <- left_join(catch, event_index, by="ID")
catch_full <- left_join(catch, taxa_index, by="Taxonkey")
dim(catch_full)
catch_full <- left_join(catch_full, gear_index, by="Gear")
dim(catch_full)
catch_full <- left_join(catch_full, taxa_gear_types, by=c("TaxonName", "Taxonkey"="TaxonKey", "CommonName", "FleetGearName")) 
dim(catch_full)


```

Some NAs to gapfill in our gear type data.

```{r}

check <- catch_full %>%
  mutate(category = paste(destruction, fish_type, sep="-"))

# explore ones with no category
check %>%
  mutate(total_tonnes = ReportedIND + IUUIND + DiscardsIND + ReportedNIND + IUUNIND + DiscardsNIND) %>%
  group_by(category) %>%
  summarize(total_tonnes = sum(total_tonnes))
  
19798225/(13346437+19798225+44630581+196014280) # 7% of catch not assigned to a category..this isn't too bad...but some of the species seem important.  Will work on gapfilling these!

tmp <- filter(check, category == "NA-NA") 

```


Make the taxa gear types more general to gapfill missing data.
```{r}
## most fisheries are pelagic, so I am going to assume duplicates are more likely to be pelagic fish
taxa_gear_types_general <- taxa_gear_types %>%
  dplyr::select(FleetGearName, bycatch, destruction, fish_type) %>%
  unique()
dups <- taxa_gear_types_general$FleetGearName[duplicated(taxa_gear_types_general$FleetGearName)]

taxa_gear_types_general <- taxa_gear_types_general %>%
  mutate(fish_type = ifelse(FleetGearName %in% dups, "pelagic", fish_type)) %>%
  unique()

# should be none...when done:
taxa_gear_types_general$FleetGearName[duplicated(taxa_gear_types_general$FleetGearName)]

catch_full_gf <- left_join(catch_full, taxa_gear_types_general, by=c("FleetGearName")) %>%
  mutate(destruction = ifelse(is.na(destruction.x), destruction.y, destruction.x)) %>%
  mutate(fish_type = ifelse(is.na(fish_type.x), fish_type.y, fish_type.x)) %>%
  mutate(category = paste(destruction, fish_type, sep="-"))

## check no NAs
table(catch_full_gf$category)

## This file will be used in a subsequent Rmd to isolate the pelagic fisheries
save_file <- catch_full_gf %>%
  dplyr::select(Cell, ReportedIND, IUUIND, DiscardsIND, ReportedNIND, IUUNIND, DiscardsNIND, IYear, CNumber, Taxonkey, Gear, TaxonName, CommonName, Descript, TaxLevel, ISSCAAP, ISSCAAPName, foragefish, FleetGearName, destruction, fish_type, category)

write_csv(save_file, "/home/shares/food-systems/Food_footprint/all_food_systems/dataprep/fisheries/marine/disturbance/catch_with_gear_cats.csv")


```


## Fishery categories

## get the gapfilled NPP raster
Plus some weighting factors to describe the proportional disturbance of the three fishing categories: demersal destructive, non-destructive demersal, non-destructive pelagic.

And the weighting of catch categories: reported, iuu, discards

The NPP raster was gapfilled here: STEP2_NPP_prep.Rmd
```{r}

npp <- raster("/home/shares/food-systems/Food_footprint/_raw_data/CHI_data/annal_mean_npp_2015_gf_wgs.tif")

```

#### Benthic destructive catch
```{r}

## destructive (catch weighted 4x nondestructive)
benthic_destructive_tonnes <- catch_full_gf %>%
  mutate(total_tonnes = ReportedIND + IUUIND + DiscardsIND + ReportedNIND + IUUNIND + DiscardsNIND) %>%
  mutate(multiplier = ifelse(category == "destructive-demersal", 1, 0)) %>%
  mutate(total_tonnes = total_tonnes*multiplier) %>%
  group_by(Cell) %>%
  summarize(total_tonnes = sum(total_tonnes, na.rm=TRUE)) 

benthic_destructive_tonnes_raster <- raster::subs(r, benthic_destructive_tonnes, by = "Cell", which = "total_tonnes", subsWithNA=TRUE)
plot(benthic_destructive_tonnes_raster)

#this is used to determine the proportion of feed fish catch relative to total catch
writeRaster(benthic_destructive_tonnes_raster, "/home/shares/food-systems/Food_footprint/all_food_systems/dataprep/fisheries/marine/disturbance/benthic_destructive_tonnes_v2.tif",
    overwrite=TRUE)

benthic_destructive_tonnes_npp <- benthic_destructive_tonnes_raster/npp
plot(benthic_destructive_tonnes_npp)

benthic_destructive_tonnes_npp_km2 <- benthic_destructive_tonnes_npp/area(benthic_destructive_tonnes_npp)

projectRaster(benthic_destructive_tonnes_npp_km2, hab_raster, filename = "/home/shares/food-systems/Food_footprint/all_food_systems/dataprep/fisheries/marine/disturbance/dem_dest_mol_per_km2.tif", method="ngb",
    overwrite=TRUE, progress="text")

ben_dest <- raster("/home/shares/food-systems/Food_footprint/all_food_systems/dataprep/fisheries/marine/disturbance/dem_dest_mol_per_km2.tif")

ben_dest <- ben_dest * 0.9344789 * 0.9344789
# these should be similar
cellStats(ben_dest, "sum", na.rm=TRUE)
cellStats(benthic_destructive_tonnes_npp, "sum", na.rm=TRUE)
writeRaster(ben_dest, "/home/shares/food-systems/Food_footprint/all_food_systems/dataprep/fisheries/marine/disturbance/dem_dest.tif", overwrite=TRUE)

```

#### Benthic nondestructive catch
```{r}

## Nondestructive benthic catch
benthic_nondest_tonnes <- catch_full_gf %>%
  mutate(total_tonnes = Reported + IUU + Discards) %>%
  mutate(multiplier = ifelse(category == "non-destructive-demersal", 1, 0)) %>%
  mutate(total_tonnes = total_tonnes*multiplier) %>%
  group_by(Cell) %>%
  summarize(total_tonnes = sum(total_tonnes, na.rm=TRUE)) 

summary(benthic_nondest_tonnes)
benthic_nondest_tonnes_raster <- raster::subs(r, benthic_nondest_tonnes, by = "Cell", which = "total_tonnes", subsWithNA=TRUE)

writeRaster(benthic_nondest_tonnes_raster, "/home/shares/food-systems/Food_footprint/dataprep/marine_fisheries/benthic_nondestructive_tonnes_v2.tif",
    overwrite=TRUE)
plot(benthic_nondest_tonnes_raster)

benthic_nondest_tonnes_npp <- benthic_nondest_tonnes_raster/npp
plot(benthic_nondest_tonnes_npp)

benthic_nondest_tonnes_npp_km2 <- benthic_nondest_tonnes_npp/area(benthic_nondest_tonnes_npp)

projectRaster(benthic_nondest_tonnes_npp_km2, hab_raster, filename = "/home/shares/food-systems/Food_footprint/dataprep/marine_fisheries/dem_nondest_mol_per_km2.tif", method="ngb",
    overwrite=TRUE, progress="text")

ben_nondest <- raster("/home/shares/food-systems/Food_footprint/dataprep/marine_fisheries/dem_nondest_mol_per_km2.tif")
ben_nondest <- ben_nondest * 0.9344789 * 0.9344789
# these should be similar
cellStats(ben_nondest, "sum", na.rm=TRUE)
cellStats(benthic_nondest_tonnes_npp, "sum", na.rm=TRUE)

writeRaster(ben_nondest, "/home/shares/food-systems/Food_footprint/dataprep/marine_fisheries/pressures/dem_nondest_lb.tif", overwrite=TRUE)

```


#### Pelagic catch
```{r}

pelagic_tonnes <- catch_full_gf %>%
  mutate(total_tonnes = Reported + IUU + Discards) %>%
  mutate(multiplier = ifelse(category == "non-destructive-pelagic", 1, 0)) %>%
  mutate(total_tonnes = total_tonnes*multiplier) %>%
  group_by(Cell) %>%
  summarize(total_tonnes = sum(total_tonnes, na.rm=TRUE)) 

pelagic_tonnes_raster <- raster::subs(r, pelagic_tonnes, by = "Cell", which = "total_tonnes", subsWithNA=TRUE)

plot(pelagic_tonnes_raster)

writeRaster(pelagic_tonnes_raster, "/home/shares/food-systems/Food_footprint/dataprep/marine_fisheries/pelagic_tonnes_v2.tif",
    overwrite=TRUE)

pelagic_tonnes_npp <- pelagic_tonnes_raster/npp
plot(pelagic_tonnes_npp)

pelagic_tonnes_npp_km2 <- pelagic_tonnes_npp/area(pelagic_tonnes_npp)

projectRaster(pelagic_tonnes_npp_km2, hab_raster, filename = "/home/shares/food-systems/Food_footprint/dataprep/marine_fisheries/pel_mol_per_km2.tif", method="ngb",
    overwrite=TRUE, progress="text")

pel <- raster("/home/shares/food-systems/Food_footprint/dataprep/marine_fisheries/pel_mol_per_km2.tif")
pel <- pel * 0.9344789 * 0.9344789
# these should be similar
cellStats(pel, "sum", na.rm=TRUE)
cellStats(pelagic_tonnes_npp, "sum", na.rm=TRUE)
writeRaster(pel, "/home/shares/food-systems/Food_footprint/dataprep/marine_fisheries/pressures/pel_lb.tif", overwrite=TRUE)

```

```{r}
# Vulnerability matrix
vulnerability <- read.csv(here("marine_fisheries/data/vulnerability_weighting_matrix.csv")) %>%
  filter(pressure != "pressure")

# List of habitat rasters
habs <- list.files(file.path("/home/shares/food-systems/Food_footprint/_raw_data/Halpern_chi/habitats"))
habs <- habs[-(grep(".vat.dbf|.xml|.ovr|README", habs))]

# The following should be zero
# The habitat rasters should all be in the vulnerability matrix
setdiff(habs, paste0(names(vulnerability), '.tif'))

# there are a couple habitats in the vulnerability table that we do not have raster habitat data for:
# "vent"        "Soft.Canyon" "Hard.Canyon"
xtra_vul_habs <- setdiff(paste0(names(vulnerability), '.tif'), habs) 
xtra_vul_habs <- xtra_vul_habs[-which(xtra_vul_habs=="pressure.tif")]
xtra_vul_habs <- gsub(".tif", "", xtra_vul_habs)
xtra_vul_habs

######### Clean vulnerability table
vulnerability_clean <- vulnerability %>%
  dplyr::select(-one_of(xtra_vul_habs)) %>%  # cut habitats we do not have raster data for
  dplyr::filter(pressure %in% c("dem_dest", "dem_nondest_lb", "pel_lb")) %>%  # cut stressors we do not have raster data for
  tidyr::gather("habitat", "vulnerability", -1) %>%
  dplyr::mutate(stress_loc = NA) %>%
  mutate(output = NA)
```


## Create raster of each habitat x stressor x vulnerability combo

```{r}
stress_files <- list.files("/home/shares/food-systems/Food_footprint/dataprep/marine_fisheries/pressures", 
                           pattern = ".tif", full="TRUE")

registerDoParallel(5)
foreach(row = 1:dim(vulnerability_clean)[1], .packages="dplyr") %dopar%{ # row=1

  combo_data <- vulnerability_clean[row, ]
  
  #obtain stressor raster location
  pxy <- combo_data$pressure
  stress_rast <- grep(pxy, stress_files, value=TRUE)
  
  #obtain habitat raster location
  hab_rast <- sprintf("/home/shares/food-systems/Food_footprint/_raw_data/Halpern_chi/habitats/%s.tif", combo_data$habitat)
  
  #vulnerability
  vuln <- as.numeric(combo_data$vulnerability)
  
  # multiply stressor * habitat * vulnerability:
  combo_stack <- raster::stack(stress_rast, hab_rast)
  raster::overlay(combo_stack, fun=function(x,y){(x*y*vuln)}, 
          filename = sprintf("/home/shares/food-systems/Food_footprint/dataprep/marine_fisheries/hab_stressor_combo/%s__%s.tif", 
                               combo_data$pressure, combo_data$habitat), overwrite=TRUE)
  }

```


# sum all the vuln x pressure x habitat files
```{r}

vuln <- list.files("/home/shares/food-systems/Food_footprint/dataprep/marine_fisheries/hab_stressor_combo", full=TRUE)

vuln_stack <- stack(vuln)

calc(vuln_stack, fun=sum, na.rm=TRUE, filename="/home/shares/food-systems/Food_footprint/dataprep/marine_fisheries/summed_hab_stressor_combo/sum_hab_stressors_combo.tif", progress="text")

```


## Divide by number of habitats in each cell
```{r}

vuln <- raster("/home/shares/food-systems/Food_footprint/dataprep/marine_fisheries/summed_hab_stressor_combo/sum_hab_stressors_combo.tif")
plot(vuln)

hab_num <- raster("/home/shares/food-systems/Food_footprint/_raw_data/Halpern_chi/habitat_num.tif")
plot(hab_num)

vuln_avg <- vuln/hab_num

```

## scale between 0-1
```{r}
# figure out aggregation factor:
sqrt(745366050/9331200)

vuln_avg_agg <- aggregate(vuln_avg, fact=9, fun=sum, na.rm=TRUE)
# new number of cells: 9202050
cellStats(vuln_avg_agg, stat=sum, na.rm=TRUE)
cellStats(vuln_avg, stat=sum, na.rm=TRUE)
plot(vuln_avg_agg)

quant_95 <- quantile(vuln_avg_agg, c(0.999))
# 324.5578 

vuln_rescaled <- vuln_avg_agg %>%
  raster::calc(fun=function(x){ifelse(x<0, 0,
                                      ifelse(x>quant_95, 1, x/quant_95))})

vuln_rescaled_latlon <- projectRaster(vuln_rescaled, food_raster, method="ngb")

writeRaster(vuln_rescaled_latlon,  "/home/shares/food-systems/Food_footprint/dataprep/marine_fisheries/all_marine_fisheries_disturbance_v2.tif", overwrite=TRUE)

```