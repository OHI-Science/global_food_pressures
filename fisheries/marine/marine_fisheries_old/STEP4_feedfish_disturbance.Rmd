---
title: "Create raster of Distrubance of pelagic forage fisheries"
author: "Melanie Frazier (UCSB, NCEAS, OHI)"
date: "May 21, 2019"
output: html_document
editor_options: 
  chunk_output_type: console
---

The goal of this is to determine how destructive FMFO fisheries are.


```{r}
#load relevant packages, etc.

library(here)
library(raster)
library(tidyverse)

# raster template
r <- raster::raster(ncol=720, nrow=360, vals=c(1:259200))
food_raster <- raster(nrows=2160, ncols=4320, xmn=-180, xmx=180, ymn=-90, ymx=90)

```


# catch data
This file has been upated to include information about gear type and whether the species is primarily benthic or pelagic.  This will be subset to include only the fish used in feed.

```{r}

catch <- read_csv("/home/shares/food-systems/Food_footprint/dataprep/marine_fisheries/catch_with_gear_cats.csv")

forage_fish_list <- read_csv(here("marine_fisheries/data/master_taxa_list.csv"))

forage_fish_summary <- catch %>%
  mutate(total_tonnes = Reported + IUU + Discards) %>%
  mutate(forage_fish = ifelse(TaxonName %in% forage_fish_list$forage_fish, 1, 0)) %>%
  mutate(total_forage_tonnes = total_tonnes * forage_fish) 

sum(forage_fish_summary$total_forage_tonnes, na.rm=TRUE)
# this should equal a bit greater than 26 billion (which is the sum of Reported and IUU in 2015, 
# from STEP1_forage_fish_id.Rmd, and 3 categories of catch are equally weighted) 
```

The NPP raster was gapfilled here: STEP2_NPP_prep.Rmd
```{r}

npp <- raster("/home/shares/food-systems/Food_footprint/_raw_data/CHI_data/annal_mean_npp_2015_gf_wgs.tif")

```



#### Deal with benthic destructive catch first.
```{r}

benthic_dest_tonnes_forage <- forage_fish_summary %>%
  mutate(multiplier = ifelse(category == "destructive-demersal", 1, 0)) %>%
  mutate(total_forage_tonnes = total_forage_tonnes*multiplier) %>%
  group_by(Cell) %>%
  summarize(total_forage_tonnes = sum(total_forage_tonnes, na.rm=TRUE)) %>%
  ungroup()

sum(benthic_dest_tonnes_forage$total_forage_tonnes)
4064660/27939777

benthic_dest_tonnes_forage_raster <- raster::subs(r, benthic_dest_tonnes_forage, by = "Cell", which = "total_forage_tonnes", subsWithNA=TRUE)
plot(benthic_dest_tonnes_forage_raster)

benthic_dest_tonnes_forage_npp <- benthic_dest_tonnes_forage_raster/npp
plot(benthic_dest_tonnes_forage_npp)

benthic_dest_tonnes_forage_npp_km2 <- benthic_dest_tonnes_forage_npp/area(benthic_dest_tonnes_forage_npp)

projectRaster(benthic_dest_tonnes_forage_npp_km2, hab_raster, filename = "/home/shares/food-systems/Food_footprint/dataprep/marine_fisheries/FOFM_fisheries/dem_dest_mol_per_km2.tif", method="ngb",
    overwrite=TRUE, progress="text")

ben_dest <- raster("/home/shares/food-systems/Food_footprint/dataprep/marine_fisheries/FOFM_fisheries/dem_dest_mol_per_km2.tif")
ben_dest <- ben_dest * 0.9344789 * 0.9344789
# these should be similar
cellStats(ben_dest, "sum", na.rm=TRUE)
cellStats(benthic_dest_tonnes_forage_npp, "sum", na.rm=TRUE)
writeRaster(ben_dest, "/home/shares/food-systems/Food_footprint/dataprep/marine_fisheries/FOFM_fisheries/pressures/dem_dest.tif", overwrite=TRUE)

```


#### Deal with benthic nondestructive catch
```{r}

benthic_nondest_tonnes_forage <- forage_fish_summary %>%
  mutate(multiplier = ifelse(category == "non-destructive-demersal", 1, 0)) %>%
  mutate(total_forage_tonnes = total_forage_tonnes*multiplier) %>%
  group_by(Cell) %>%
  summarize(total_forage_tonnes = sum(total_forage_tonnes, na.rm=TRUE)) %>%
  ungroup()

sum(benthic_nondest_tonnes_forage$total_forage_tonnes)
86288.31/27939777

benthic_nondest_tonnes_forage_raster <- raster::subs(r, benthic_nondest_tonnes_forage, by = "Cell", which = "total_forage_tonnes", subsWithNA=TRUE)
plot(benthic_nondest_tonnes_forage_raster)


benthic_nondest_tonnes_forage_npp <- benthic_nondest_tonnes_forage_raster/npp
plot(benthic_dest_tonnes_forage_npp)

benthic_nondest_tonnes_forage_npp_km2 <- benthic_nondest_tonnes_forage_npp/area(benthic_nondest_tonnes_forage_npp)

projectRaster(benthic_nondest_tonnes_forage_npp_km2, hab_raster, filename = "/home/shares/food-systems/Food_footprint/dataprep/marine_fisheries/FOFM_fisheries/dem_nondest_mol_per_km2.tif", method="ngb",
    overwrite=TRUE, progress="text")

ben_nondest <- raster("/home/shares/food-systems/Food_footprint/dataprep/marine_fisheries/FOFM_fisheries/dem_nondest_mol_per_km2.tif")
ben_nondest <- ben_nondest * 0.9344789 * 0.9344789
# these should be similar
cellStats(ben_nondest, "sum", na.rm=TRUE)
cellStats(benthic_nondest_tonnes_forage_npp, "sum", na.rm=TRUE)
writeRaster(ben_nondest, "/home/shares/food-systems/Food_footprint/dataprep/marine_fisheries/FOFM_fisheries/pressures/dem_nondest_lb.tif", overwrite=TRUE)


```


#### Pelagic
```{r}

pelagic_tonnes_forage <- forage_fish_summary %>%
  mutate(multiplier = ifelse(category == "non-destructive-pelagic", 1, 0)) %>%
  mutate(total_forage_tonnes = total_forage_tonnes*multiplier) %>%
  group_by(Cell) %>%
  summarize(total_forage_tonnes = sum(total_forage_tonnes, na.rm=TRUE)) %>%
  ungroup()

sum(pelagic_tonnes_forage$total_forage_tonnes)
23788829/27939777 # ~85 should be correct!

pelagic_tonnes_forage_raster <- raster::subs(r, pelagic_tonnes_forage, by = "Cell", which = "total_forage_tonnes", subsWithNA=TRUE)
plot(pelagic_tonnes_forage_raster)


pelagic_tonnes_forage_npp <- pelagic_tonnes_forage_raster/npp
plot(pelagic_tonnes_forage_npp)

pelagic_tonnes_forage_npp_km2 <- pelagic_tonnes_forage_npp/area(pelagic_tonnes_forage_npp)

projectRaster(pelagic_tonnes_forage_npp_km2, hab_raster, filename = "/home/shares/food-systems/Food_footprint/dataprep/marine_fisheries/FOFM_fisheries/pelagic_mol_per_km2.tif", method="ngb",
    overwrite=TRUE, progress="text")

pelagic <- raster("/home/shares/food-systems/Food_footprint/dataprep/marine_fisheries/FOFM_fisheries/pelagic_mol_per_km2.tif")
pelagic <- pelagic * 0.9344789 * 0.9344789
# these should be similar
cellStats(pelagic, "sum", na.rm=TRUE)
cellStats(pelagic_tonnes_forage_npp, "sum", na.rm=TRUE)
writeRaster(pelagic, "/home/shares/food-systems/Food_footprint/dataprep/marine_fisheries/FOFM_fisheries/pressures/pel_lb.tif", overwrite=TRUE)

```


## fisheries vs. vulnerability
```{r}
# Vulnerability matrix
vulnerability <- read.csv(here("marine_fisheries/data/vulnerability_weighting_matrix.csv")) %>%
  filter(pressure != "pressure")

# List of habitat rasters
habs <- list.files(file.path("/home/shares/food-systems/Food_footprint/_raw_data/Halpern_chi/habitats"))
habs <- habs[-(grep(".vat.dbf|.xml|.ovr|README", habs))]

# The following should be zero
# The habitat rasters should all be in the vulnerability matrix
setdiff(habs, paste0(names(vulnerability), '.tif'))

# there are a couple habitats in the vulnerability table that we do not have raster habitat data for:
# "vent"        "Soft.Canyon" "Hard.Canyon"
xtra_vul_habs <- setdiff(paste0(names(vulnerability), '.tif'), habs) 
xtra_vul_habs <- xtra_vul_habs[-which(xtra_vul_habs=="pressure.tif")]
xtra_vul_habs <- gsub(".tif", "", xtra_vul_habs)
xtra_vul_habs

######### Clean vulnerability table
vulnerability_clean <- vulnerability %>%
  dplyr::select(-one_of(xtra_vul_habs)) %>%  # cut habitats we do not have raster data for
  dplyr::filter(pressure %in% c("dem_dest", "dem_nondest_lb", "pel_lb")) %>%  # cut stressors we do not have raster data for
  tidyr::gather("habitat", "vulnerability", -1) %>%
  dplyr::mutate(stress_loc = NA) %>%
  mutate(output = NA)
```


## Create raster of each habitat x stressor x vulnerability combo

```{r}
stress_files <- list.files("/home/shares/food-systems/Food_footprint/dataprep/marine_fisheries/FOFM_fisheries/pressures", 
                           pattern = ".tif", full="TRUE")

registerDoParallel(5)
foreach(row = 1:dim(vulnerability_clean)[1], .packages="dplyr") %dopar%{ # row=1

  combo_data <- vulnerability_clean[row, ]
  
  #obtain stressor raster location
  pxy <- combo_data$pressure
  stress_rast <- grep(pxy, stress_files, value=TRUE)
  
  #obtain habitat raster location
  hab_rast <- sprintf("/home/shares/food-systems/Food_footprint/_raw_data/Halpern_chi/habitats/%s.tif", combo_data$habitat)
  
  #vulnerability
  vuln <- as.numeric(combo_data$vulnerability)
  
  # multiply stressor * habitat * vulnerability:
  combo_stack <- raster::stack(stress_rast, hab_rast)
  raster::overlay(combo_stack, fun=function(x,y){(x*y*vuln)}, 
          filename = sprintf("/home/shares/food-systems/Food_footprint/dataprep/marine_fisheries/FOFM_fisheries/hab_stressor_combo/%s__%s.tif", 
                               combo_data$pressure, combo_data$habitat), overwrite=TRUE)
  }

```


# sum all the vuln x pressure x habitat files
```{r}

vuln <- list.files("/home/shares/food-systems/Food_footprint/dataprep/marine_fisheries/FOFM_fisheries/hab_stressor_combo", full=TRUE)

vuln_stack <- stack(vuln)

calc(vuln_stack, fun=sum, na.rm=TRUE, filename="/home/shares/food-systems/Food_footprint/dataprep/marine_fisheries/FOFM_fisheries/summed_hab_stressor_combo/sum_hab_stressors_combo.tif", progress="text", overwrite=TRUE)

```


## Divide by number of habitats in each cell
```{r}

vuln <- raster("/home/shares/food-systems/Food_footprint/dataprep/marine_fisheries/FOFM_fisheries/summed_hab_stressor_combo/sum_hab_stressors_combo.tif")
plot(vuln)

hab_num <- raster("/home/shares/food-systems/Food_footprint/_raw_data/Halpern_chi/habitat_num.tif")
plot(hab_num)

vuln_avg <- vuln/hab_num

```

## scale between 0-1
```{r}
# figure out aggregation factor:
sqrt(745366050/9331200)

vuln_avg_agg <- aggregate(vuln_avg, fact=9, fun=sum, na.rm=TRUE)
# new number of cells: 9202050
cellStats(vuln_avg_agg, stat=sum, na.rm=TRUE)
cellStats(vuln_avg, stat=sum, na.rm=TRUE)
plot(vuln_avg_agg)

quantile(vuln_avg_agg, 0.999)
quant_95 <- 324.5578  # calculated from all fisheries in STEP3 

vuln_rescaled <- vuln_avg_agg %>%
  raster::calc(fun=function(x){ifelse(x<0, 0,
                                      ifelse(x>quant_95, 1, x/quant_95))})

vuln_rescaled_latlon <- projectRaster(vuln_rescaled, food_raster, method="ngb")
plot(vuln_rescaled_latlon)

writeRaster(vuln_rescaled_latlon,  "/home/shares/food-systems/Food_footprint/dataprep/marine_fisheries/FOFM_fisheries/marinefisheries_feedfish_disturbance.tif", overwrite=TRUE)

pelagic_disturbance_df <- as.data.frame(vuln_rescaled_latlon, xy=TRUE)
names(pelagic_disturbance_df)[3] <- "marinefisheries_feedfish_disturbance_prop"
  
write_csv(pelagic_disturbance_df, "/home/shares/food-systems/Food_footprint/final_data/marinefisheries_feedfish_disturbance.csv")
test <- read_csv("/home/shares/food-systems/Food_footprint/final_data/marinefisheries_feedfish_disturbance.csv", col_types = "ddd")
check <- rasterFromXYZ(test)
plot(check)
```