---
title: "Create raster of disturbance for all marine fisheries"
author: "Gage Clawson (UCSB, NCEAS, OHI)"
date: "October 2, 2020"
output: html_document
editor_options: 
  chunk_output_type: console
---

The goal of this is to determine how destructive marine fisheries are.

The first step is to estimate the destructiveness of all fisheries.  From this we will subset different categories, such as the pelagic fisheries or FOFM fisheries.

```{r, eval = FALSE}
#load relevant packages, etc.

library(here)
library(raster)
library(tidyverse)
library(doParallel)
library(foreach)
library(parallel)

# raster template
r <- raster::raster(ncol=720, nrow=360, vals=c(1:259200))
food_raster <- raster(nrows=2160, ncols=4320, xmn=-180, xmx=180, ymn=-90, ymx=90)
hab_raster <- raster("/home/shares/food-systems/Food_footprint/_raw_data/Halpern_chi/habitats/coral_reef.tif")
```


## Step 1: Classify catch into demersal destructive/nondestructive
Get all the data together...
```{r, eval = FALSE}
## read in catch data
catch <- read_csv("/home/shares/food-systems/Food_footprint/_raw_data/watson_data/v5.0/Catch2015_2019.csv")

## read in taxa index 
taxa_index <- read_csv("/home/shares/food-systems/Food_footprint/_raw_data/watson_data/v5.0/Codes_taxa.csv")

## read in gear index 
gear_index <- read_csv("/home/shares/food-systems/Food_footprint/_raw_data/watson_data/v5.0/Codes_gear.csv") %>%
  dplyr::select(Gear, GearName = VBDesc) %>%
  unique()

taxa_gear_types <- read_csv(here("fisheries/marine/disturbance/int/taxa_gear_types.csv"))

head(taxa_gear_types)

## join datasets together
catch_full <- left_join(catch, taxa_index, by="Taxonkey")
dim(catch_full)
catch_full <- left_join(catch_full, gear_index, by="Gear")
dim(catch_full)
catch_full <- left_join(catch_full, taxa_gear_types, by=c("TaxonName", "Taxonkey", "CommonName", "Descript","GearName", "Gear")) 
dim(catch_full)


forage_fish_list <- read_csv(here("fisheries/marine/ghg/data/master_taxa_list.csv"))


catch_full <- catch_full %>%
  mutate(forage_fish = ifelse(TaxonName %in% forage_fish_list$forage_fish, 1, 0)) %>%
  mutate(forage_fish = ifelse(Descript == "krill", 1, forage_fish)) %>%
  dplyr::select(-foragefish)

```

Check to see if there are any NAs to gapfill in our gear type data.

```{r, eval = FALSE}

check <- catch_full %>%
  mutate(category = paste(destruction, type, sep="-"))

# explore ones with no category
check %>%
  mutate(total_tonnes = ReportedIND + IUUIND + DiscardsIND + ReportedNIND + IUUNIND + DiscardsNIND) %>%
  group_by(category) %>%
  summarize(total_tonnes = sum(total_tonnes))


# # A tibble: 4 x 2
#   category                 total_tonnes
#   <chr>                           <dbl>
# 1 destructive-demersal       102286775.
# 2 destructive-pelagic         21463146.
# 3 non-destructive-demersal    96149597.
# 4 non-destructive-pelagic    153890005.

check2 <- catch_full %>%
  mutate(total_tonnes = ReportedIND + IUUIND + DiscardsIND + ReportedNIND + IUUNIND + DiscardsNIND) %>%
  filter(forage_fish == 0, IYear == 2017)
sum(check2$total_tonnes) # 84562955 tonnes of non-forage fish (IUU, Reported, Discards)

check3 <- catch_full %>%
  mutate(total_tonnes = ReportedIND + IUUIND + ReportedNIND + IUUNIND) %>%
  filter(forage_fish == 0, IYear == 2017)
sum(check3$total_tonnes) # 72172118 tonnes of non-forage fish (IUU, Reported)



check4 <- catch_full %>%
  mutate(total_tonnes = ReportedIND + IUUIND + DiscardsIND + ReportedNIND + IUUNIND + DiscardsNIND) %>%
  filter(forage_fish == 1, IYear == 2017)
sum(check4$total_tonnes) # 41693559 tonnes of forage fish (IUU, Reported, Discards)

check5 <- catch_full %>%
  mutate(total_tonnes = ReportedIND + IUUIND + ReportedNIND + IUUNIND) %>%
  filter(forage_fish == 1, IYear == 2017)
sum(check5$total_tonnes) # 39054068 tonnes of forage fish (IUU, Reported, Discards)
```

For intermediate and final rasters, we need to split our species into coarser groups: 

Intermediate categories
 - Benthic
 - Small Demersal or Small bentho-pelagic
 - Medium Demersal or Medium bentho-pelagic
 - Large Demersal or Large bentho-pelagic
 - Large Pelagics (>90cm)
 - Medium Pelagic (30-60cm)
 - Small pelagics (<30cm)
 - Small Reef-associated
 - Medium Reef-associated
 - Large Reef-associated
 - FOFM - includes krill
 
 Conversions: 
 - pelagic >=90 cm : Large pelagics **
 - demersal <30cm : Small Demersal **
 - shark >=90cm : Large Demersal **
 - pelagic <30cm : Small Pelagics **
 - demersal 30 - 90 cm : Medium Demersal **
 - bathydemersal <30 cm : Small Demersal **
 - bathydemersal >= 90cm : Large Demersal **
 - pelagic 30 - 90cm : Medium pelagics **
 - reef-associated 30 - 90 cm : Medium Reef associated **
 - flatfish <90 cm : Medium Demersal **
 - cephalopods : See below
 - demersal >=90 cm : Large Demersal **
 - benthopelagic >=90 cm : Large Demersal **
 - reef-associated >=90 cm : Large Reef associated **
 - flatfish >=90 cm : Large Demersal **
 - shrimp : Small demersal **
 - demersal mollusc : Small Demersal **
 - rays <90 cm : Medium Demersal **
 - lobsters crab : Benthic **
 - shark <90 cm : Medium Demersal **
 - benthopelagic 30 - 90 cm : Medium Demersal **
 - benthopelagic <30 cm : Small Demersal **
 - reef-associated <30 cm : Small Reef associated **
 - rays >=90 cm : Large Demersal **
 - bathypelagic <30 cm : Small Pelagics **
 - bathypelagic 30 - 90 cm : Medium Pelagics **
 - bathypelagic >=90 cm : Large Pelagic **
 - bathydemersal 30 - 90 cm : Medium Demersal **
 - krill : FOFM 

Final raster categories:
 - Benthic
 - Demersal or bentho-pelagic
 - Large Pelagics (>90cm)
 - Medium Pelagic (30-60cm) 
 - Small pelagics (<30cm)
 - Reef-associated
 - FOFM

Conversions: 
 - pelagic >=90 cm : Large pelagics
 - demersal <30cm : Demersal
 - shark >=90cm : Demersal
 - pelagic <30cm : Small Pelagics
 - demersal 30 - 90 cm : Demersal
 - bathydemersal <30 cm : Demersal
 - bathydemersal >= 90cm : Demersal
 - pelagic 30 - 90cm : Medium pelagics
 - reef-associated 30 - 90 cm : Reef associated
 - flatfish <90 cm : Demersal
 - cephalopods : species dependent, see below 
 - demersal >=90 cm : Demersal
 - benthopelagic >=90 cm : Demersal
 - reef-associated >=90 cm : Reef associated
 - flatfish >=90 cm : Demersal
 - shrimp : Demersal
 - demersal mollusc : Demersal
 - rays <90 cm : Demersal
 - lobsters crab : Benthic
 - shark <90 cm : Demersal
 - benthopelagic 30 - 90 cm : Demersal
 - benthopelagic <30 cm : Demersal
 - reef-associated <30 cm : Reef associated
 - rays >=90 cm : Demersal
 - bathypelagic <30 cm : Small Pelagics
 - bathypelagic 30 - 90 cm : Medium Pelagics
 - bathypelagic >=90 cm : Large Pelagic 
 - bathydemersal 30 - 90 cm : Demersal
 - krill : FOFM 


Reclassify the Watson species classes to intermediate supplementary classes:
```{r, eval = FALSE}
catch_species_class_int <- catch_full %>%
  dplyr::mutate(species_class_int =
                  case_when(
                    str_detect(Descript, "demersal mollusc|demersal <30 cm|bathydemersal <30 cm|shrimp|benthopelagic <30 cm") ~ "Small demersal",
                    str_detect(Descript, "shark >=90 cm|bathydemersal >= 90cm|demersal >=90 cm|benthopelagic >=90 cm|flatfish >=90 cm|rays >=90 cm") ~ "Large demersal",
                    str_detect(Descript, "demersal 30 - 90 cm|flatfish <90 cm|rays <90 cm|shark <90 cm|benthopelagic 30 - 90 cm|bathydemersal 30 - 90 cm") ~ "Medium demersal",
                    str_detect(Descript, "lobsters crab") ~ "Benthic",
                    str_detect(Descript, "pelagic >=90 cm|bathypelagic >=90 cm") ~ "Large pelagic",
                    str_detect(Descript, "pelagic 30 - 90 cm|bathypelagic 30 - 90 cm") ~ "Medium pelagic",
                    str_detect(Descript, "pelagic <30 cm|bathypelagic <30 cm|krill") ~ "Small pelagic",
                    str_detect(Descript, "reef-associated >=90 cm") ~ "Large reef-associated",
                    str_detect(Descript, "reef-associated 30 - 90 cm") ~ "Medium reef-associated",
                    str_detect(Descript, "reef-associated <30 cm") ~ "Small reef-associated",
                    str_detect(CommonName, "uttlefish") & str_detect(Descript, "cephalopods") ~ "Small reef-associated",
                    str_detect(CommonName, "Horned") & str_detect(Descript, "cephalopods") ~ "Medium reef-associated",
                    str_detect(CommonName, "Common octopus|Octopuses") & str_detect(Descript, "cephalopods") ~ "Large reef-associated", 
                    str_detect(CommonName, "Argentine shortfin squid|Patagonian squid|Northern shortfin squid|California market squid|Cape Hope squid|Longfin squid|Sevenstar flying squid") & str_detect(Descript, "cephalopods") ~ "Small pelagic", 
                    str_detect(CommonName, "Jumbo flying squid|Broadtail shortfin squid|European flying squid|Japanese flying squid|Wellington flying squid|Neon flying squid|Veined Squid|Squids|Common squids|Cephalopods") & str_detect(Descript, "cephalopods") ~ "Medium pelagic", 
                    str_detect(CommonName, "Arrow squids") & str_detect(Descript, "cephalopods") ~ "Large pelagic"
                  )) 

## take a look to see if we caught all the cases... we did
unique(catch_species_class_int$species_class_int)

test <- catch_species_class_int %>%
  filter(Descript == "krill")

unique(test$forage_fish)
```


Reclassify the Watson species classes to final raster classes:

```{r, eval = FALSE}
catch_species_class_fin <- catch_species_class_int %>%
  dplyr::mutate(species_class_fin =
                  case_when(
                    str_detect(species_class_int, "demersal") ~ "Demersal",
                    str_detect(species_class_int, "reef-associated") ~ "Reef-associated",
                    TRUE  ~ species_class_int
                  ))

## take a look to see if we caught all the cases... we did
catch_species_class_summary <- catch_species_class_fin %>%
  filter(forage_fish == 0, IYear == 2017) %>%
  mutate(catch_total = ReportedIND + IUUIND + DiscardsIND + ReportedNIND + IUUNIND + DiscardsNIND) %>%
  group_by(species_class_fin) %>%
  summarise(catch_sum = sum(catch_total))
sum(catch_species_class_summary$catch_sum) # 84562955

catch_species_class_summary_2 <- catch_species_class_fin %>%
  filter(forage_fish == 1, IYear == 2017) %>%
   mutate(catch = ReportedIND + IUUIND + DiscardsIND + ReportedNIND + IUUNIND + DiscardsNIND) %>%
  group_by(species_class_fin) %>%
  summarise(catch_sum = sum(catch))
sum(catch_species_class_summary_2$catch_sum) # 41693559

```

Save the dataset
```{r, eval = FALSE}

catch_full_final <- catch_species_class_fin %>%
  mutate(category = paste(destruction, type, sep="-"))

## check no NAs
table(catch_full_final$category)

## This file will be used in a subsequent Rmd to isolate the pelagic fisheries
save_file <- catch_full_final %>%
  dplyr::select(Cell, ReportedIND, IUUIND, DiscardsIND, ReportedNIND, IUUNIND, DiscardsNIND, IYear, CNumber, Taxonkey, Gear, TaxonName, CommonName, Descript, species_class_int, species_class_fin, TaxLevel, ISSCAAP, ISSCAAPName, forage_fish, GearName, destruction, fish_type = type, category)

write_csv(save_file, "/home/shares/food-systems/Food_footprint/all_food_systems/dataprep/fisheries/marine/disturbance/catch_with_gear_cats.csv")


# catch_summary <- read_csv(file.path("/home/shares/food-systems/Food_footprint/all_food_systems/dataprep/fisheries/marine/disturbance/catch_with_gear_cats.csv"))
# 
# catch_summary_table <- catch_summary %>%
#   dplyr::filter(IYear == 2017) %>%
#   dplyr::mutate(tonnes_catch = ReportedIND + IUUIND + DiscardsIND + ReportedNIND + IUUNIND + DiscardsNIND) %>%
#   mutate(species_class_fin = ifelse(forage_fish == 1, "fofm", species_class_fin)) %>%
#   dplyr::group_by(species_class_fin) %>%
#   dplyr::summarise(total_tonnes = sum(tonnes_catch)) %>%
#   dplyr::ungroup()

# test <- read_csv("/home/shares/food-systems/Food_footprint/all_food_systems/dataprep/fisheries/marine/catch_for_juliette.csv")

```



## Fishery categories

## get the gapfilled NPP raster
Plus some weighting factors to describe the proportional disturbance of the three fishing categories: demersal destructive, non-destructive demersal, non-destructive pelagic.

And the weighting of catch categories: reported, iuu, discards

The NPP raster was gapfilled here: STEP2_NPP_prep.Rmd
```{r, eval = FALSE}

npp <- raster("/home/shares/food-systems/Food_footprint/_raw_data/CHI_data/annal_mean_npp_2015_gf_wgs.tif")

```

#### Benthic destructive catch
```{r, eval = FALSE}
## filter this for 2017... our assessment year 
catch_full_final <- read_csv("/home/shares/food-systems/Food_footprint/all_food_systems/dataprep/fisheries/marine/disturbance/catch_with_gear_cats.csv") %>%
  dplyr::filter(IYear == 2017)

## destructive (catch weighted same as nondestructive)
benthic_destructive_tonnes <- catch_full_final %>%
  mutate(total_tonnes = ReportedIND + IUUIND + DiscardsIND + ReportedNIND + IUUNIND + DiscardsNIND) %>%
  mutate(multiplier = ifelse(category == "destructive-demersal", 1, 0)) %>%
  mutate(total_tonnes = total_tonnes*multiplier) %>%
  group_by(Cell) %>%
  summarize(total_tonnes = sum(total_tonnes, na.rm=TRUE)) 

benthic_destructive_tonnes_raster <- raster::subs(r, benthic_destructive_tonnes, by = "Cell", which = "total_tonnes", subsWithNA=TRUE)
plot(benthic_destructive_tonnes_raster)

#this is used to determine the proportion of feed fish catch relative to total catch
writeRaster(benthic_destructive_tonnes_raster, "/home/shares/food-systems/Food_footprint/all_food_systems/dataprep/fisheries/marine/disturbance/benthic_destructive_tonnes.tif",
    overwrite=TRUE)

## divide tonnes by npp to adjust for high vs low productive zones
benthic_destructive_tonnes_npp <- benthic_destructive_tonnes_raster/npp
plot(benthic_destructive_tonnes_npp)

## divide by area to get disturbance
benthic_destructive_tonnes_npp_km2 <- benthic_destructive_tonnes_npp/area(benthic_destructive_tonnes_npp)

projectRaster(benthic_destructive_tonnes_npp_km2, hab_raster, filename = "/home/shares/food-systems/Food_footprint/all_food_systems/dataprep/fisheries/marine/disturbance/dem_dest_mol_per_km2.tif", method="ngb",
    overwrite=TRUE, progress="text")

ben_dest <- raster("/home/shares/food-systems/Food_footprint/all_food_systems/dataprep/fisheries/marine/disturbance/dem_dest_mol_per_km2.tif")

ben_dest <- ben_dest * 0.9344789 * 0.9344789 ## adjust for cell size

# these should be similar
cellStats(ben_dest, "sum", na.rm=TRUE) # 11600155
cellStats(benthic_destructive_tonnes_npp, "sum", na.rm=TRUE) # 11532886

writeRaster(ben_dest, "/home/shares/food-systems/Food_footprint/all_food_systems/dataprep/fisheries/marine/disturbance/pressures/dem_dest.tif", overwrite=TRUE)

```


#### Benthic nondestructive catch
```{r, eval = FALSE}

## Nondestructive benthic catch
benthic_nondest_tonnes <- catch_full_final %>%
  mutate(total_tonnes = ReportedIND + IUUIND + DiscardsIND + ReportedNIND + IUUNIND + DiscardsNIND) %>%
  mutate(multiplier = ifelse(category == "non-destructive-demersal", 1, 0)) %>%
  mutate(total_tonnes = total_tonnes*multiplier) %>%
  group_by(Cell) %>%
  summarize(total_tonnes = sum(total_tonnes, na.rm=TRUE)) 

summary(benthic_nondest_tonnes)

benthic_nondest_tonnes_raster <- raster::subs(r, benthic_nondest_tonnes, by = "Cell", which = "total_tonnes", subsWithNA=TRUE)

writeRaster(benthic_nondest_tonnes_raster, "/home/shares/food-systems/Food_footprint/all_food_systems/dataprep/fisheries/marine/disturbance/benthic_nondestructive_tonnes.tif",
    overwrite=TRUE)

plot(benthic_nondest_tonnes_raster)

benthic_nondest_tonnes_npp <- benthic_nondest_tonnes_raster/npp
plot(benthic_nondest_tonnes_npp)

benthic_nondest_tonnes_npp_km2 <- benthic_nondest_tonnes_npp/area(benthic_nondest_tonnes_npp)

projectRaster(benthic_nondest_tonnes_npp_km2, hab_raster, filename = "/home/shares/food-systems/Food_footprint/all_food_systems/dataprep/fisheries/marine/disturbance/dem_nondest_mol_per_km2.tif", method="ngb",
    overwrite=TRUE, progress="text")

ben_nondest <- raster("/home/shares/food-systems/Food_footprint/all_food_systems/dataprep/fisheries/marine/disturbance/dem_nondest_mol_per_km2.tif")

ben_nondest <- ben_nondest * 0.9344789 * 0.9344789

# these should be similar
cellStats(ben_nondest, "sum", na.rm=TRUE) # 10726940
cellStats(benthic_nondest_tonnes_npp, "sum", na.rm=TRUE) # 10669690

writeRaster(ben_nondest, "/home/shares/food-systems/Food_footprint/all_food_systems/dataprep/fisheries/marine/disturbance/pressures/dem_nondest_lb.tif", overwrite=TRUE)

```


#### Pelagic low bycatch
```{r, eval = FALSE}

pelagic_tonnes <- catch_full_final %>%
  mutate(total_tonnes = ReportedIND + IUUIND + DiscardsIND + ReportedNIND + IUUNIND + DiscardsNIND) %>%
  mutate(multiplier = ifelse(category == "non-destructive-pelagic", 1, 0)) %>%
  mutate(total_tonnes = total_tonnes*multiplier) %>%
  group_by(Cell) %>%
  summarize(total_tonnes = sum(total_tonnes, na.rm=TRUE)) 

pelagic_tonnes_raster <- raster::subs(r, pelagic_tonnes, by = "Cell", which = "total_tonnes", subsWithNA=TRUE)

plot(pelagic_tonnes_raster)

writeRaster(pelagic_tonnes_raster, "/home/shares/food-systems/Food_footprint/all_food_systems/dataprep/fisheries/marine/disturbance/pelagic_tonnes.tif",
    overwrite=TRUE)

pelagic_tonnes_npp <- pelagic_tonnes_raster/npp
plot(pelagic_tonnes_npp)

pelagic_tonnes_npp_km2 <- pelagic_tonnes_npp/area(pelagic_tonnes_npp)

projectRaster(pelagic_tonnes_npp_km2, hab_raster, filename = "/home/shares/food-systems/Food_footprint/all_food_systems/dataprep/fisheries/marine/disturbance/pel_mol_per_km2.tif", method="ngb",
    overwrite=TRUE, progress="text")

pel <- raster("/home/shares/food-systems/Food_footprint/all_food_systems/dataprep/fisheries/marine/disturbance/pel_mol_per_km2.tif")

pel <- pel * 0.9344789 * 0.9344789

# these should be similar
cellStats(pel, "sum", na.rm=TRUE) # 17736201
cellStats(pelagic_tonnes_npp, "sum", na.rm=TRUE) # 17627813

writeRaster(pel, "/home/shares/food-systems/Food_footprint/all_food_systems/dataprep/fisheries/marine/disturbance/pressures/pel_lb.tif", overwrite=TRUE)

```

#### Pelagic high bycatch
```{r, eval = FALSE}

pelagic_tonnes <- catch_full_final %>%
  mutate(total_tonnes = ReportedIND + IUUIND + DiscardsIND + ReportedNIND + IUUNIND + DiscardsNIND) %>%
  mutate(multiplier = ifelse(category == "destructive-pelagic", 1, 0)) %>%
  mutate(total_tonnes = total_tonnes*multiplier) %>%
  group_by(Cell) %>%
  summarize(total_tonnes = sum(total_tonnes, na.rm=TRUE)) 

pelagic_tonnes_raster <- raster::subs(r, pelagic_tonnes, by = "Cell", which = "total_tonnes", subsWithNA=TRUE)

plot(pelagic_tonnes_raster)

writeRaster(pelagic_tonnes_raster, "/home/shares/food-systems/Food_footprint/all_food_systems/dataprep/fisheries/marine/disturbance/dest_pelagic_tonnes.tif",
    overwrite=TRUE)

pelagic_tonnes_npp <- pelagic_tonnes_raster/npp
plot(pelagic_tonnes_npp)

pelagic_tonnes_npp_km2 <- pelagic_tonnes_npp/area(pelagic_tonnes_npp)

projectRaster(pelagic_tonnes_npp_km2, hab_raster, filename = "/home/shares/food-systems/Food_footprint/all_food_systems/dataprep/fisheries/marine/disturbance/dest_pel_mol_per_km2.tif", method="ngb",
    overwrite=TRUE, progress="text")

pel <- raster("/home/shares/food-systems/Food_footprint/all_food_systems/dataprep/fisheries/marine/disturbance/dest_pel_mol_per_km2.tif")

pel <- pel * 0.9344789 * 0.9344789

# these should be similar
cellStats(pel, "sum", na.rm=TRUE) # 2319037
cellStats(pelagic_tonnes_npp, "sum", na.rm=TRUE) # 2305636

writeRaster(pel, "/home/shares/food-systems/Food_footprint/all_food_systems/dataprep/fisheries/marine/disturbance/pressures/pel_hb.tif", overwrite=TRUE)

```


```{r, eval = FALSE}
# Vulnerability matrix - from CHI paper 
vulnerability <- read.csv(here("fisheries/marine/disturbance/data/vulnerability_weighting_matrix.csv")) %>%
  filter(pressure != "pressure")

# List of habitat rasters
habs <- list.files(file.path("/home/shares/food-systems/Food_footprint/_raw_data/Halpern_chi/habitats"))
habs <- habs[-(grep(".vat.dbf|.xml|.ovr|README", habs))]

# The following should be zero
# The habitat rasters should all be in the vulnerability matrix
setdiff(habs, paste0(names(vulnerability), '.tif'))


# there are a couple habitats in the vulnerability table that we do not have raster habitat data for:
# "vent"        "Soft.Canyon" "Hard.Canyon"
xtra_vul_habs <- setdiff(paste0(names(vulnerability), '.tif'), habs) 
xtra_vul_habs <- xtra_vul_habs[-which(xtra_vul_habs=="pressure.tif")]
xtra_vul_habs <- gsub(".tif", "", xtra_vul_habs)
xtra_vul_habs

######### Clean vulnerability table
vulnerability_clean <- vulnerability %>%
  dplyr::select(-one_of(xtra_vul_habs)) %>%  # cut habitats we do not have raster data for
  dplyr::filter(pressure %in% c("dem_dest", "dem_nondest_lb", "pel_lb", "pel_hb")) %>%  # cut stressors we do not have raster data for
  tidyr::gather("habitat", "vulnerability", -1) %>%
  dplyr::mutate(stress_loc = NA) %>%
  mutate(output = NA)
```


## Create raster of each habitat x stressor x vulnerability combo
 - This will take awhile.
```{r, eval = FALSE}
stress_files <- list.files("/home/shares/food-systems/Food_footprint/all_food_systems/dataprep/fisheries/marine/disturbance/pressures", 
                           pattern = ".tif", full="TRUE")

registerDoParallel(5)
foreach(row = 1:dim(vulnerability_clean)[1], .packages="dplyr") %dopar%{ # row=1

  combo_data <- vulnerability_clean[row, ]
  
  #obtain stressor raster location
  pxy <- combo_data$pressure
  stress_rast <- grep(pxy, stress_files, value=TRUE)
  
  #obtain habitat raster location
  hab_rast <- sprintf("/home/shares/food-systems/Food_footprint/_raw_data/Halpern_chi/habitats/%s.tif", combo_data$habitat)
  
  #vulnerability
  vuln <- as.numeric(combo_data$vulnerability)
  
  # multiply stressor * habitat * vulnerability:
  combo_stack <- raster::stack(stress_rast, hab_rast)
  raster::overlay(combo_stack, fun=function(x,y){(x*y*vuln)}, 
          filename = sprintf("/home/shares/food-systems/Food_footprint/all_food_systems/dataprep/fisheries/marine/disturbance/hab_stressor_combo/%s__%s.tif", 
                               combo_data$pressure, combo_data$habitat), overwrite=TRUE)
  }

# plot(combo_stack)

# test <- raster(file.path("/home/shares/food-systems/Food_footprint/dataprep/marine_fisheries/hab_stressor_combo/dem_dest__rky_intidal.tif"))
# plot(test)
```


# sum all the vuln x pressure x habitat files
```{r, eval = FALSE}

vuln <- list.files("/home/shares/food-systems/Food_footprint/all_food_systems/dataprep/fisheries/marine/disturbance/hab_stressor_combo", full=TRUE)

vuln_stack <- stack(vuln)

calc(vuln_stack, fun=sum, na.rm=TRUE, filename="/home/shares/food-systems/Food_footprint/all_food_systems/dataprep/fisheries/marine/disturbance/summed_hab_stressor_combo/sum_hab_stressors_combo.tif", progress="text", overwrite = TRUE)

```

## Divide by number of habitats in each cell
```{r, eval = FALSE}

vuln <- raster("/home/shares/food-systems/Food_footprint/all_food_systems/dataprep/fisheries/marine/disturbance/summed_hab_stressor_combo/sum_hab_stressors_combo.tif")
plot(vuln)

hab_num <- raster("/home/shares/food-systems/Food_footprint/_raw_data/Halpern_chi/habitat_num.tif")
plot(hab_num)

vuln_avg <- vuln/hab_num
plot(vuln_avg)
```

## scale between 0-1
```{r, eval = FALSE}
# figure out aggregation factor:
## 745366050 cells in vuln
## 9331200 cells in food raster

sqrt(745366050/9331200) # 8.9 ~ 9

## aggregate cells
vuln_avg_agg <- aggregate(vuln_avg, fact=9, fun=sum, na.rm=TRUE)
# new number of cells: 9202050
cellStats(vuln_avg_agg, stat=sum, na.rm=TRUE) # 43813620
cellStats(vuln_avg, stat=sum, na.rm=TRUE) # 43813620
plot(vuln_avg_agg)

quant_99 <- quantile(vuln_avg_agg, c(0.999))
# 640.4062 

## divide by reference point (99th quantile)
vuln_rescaled <- vuln_avg_agg %>%
  raster::calc(fun=function(x){ifelse(x<0, 0,
                                      ifelse(x>quant_99, 1, x/quant_99))})

plot(vuln_rescaled)

vuln_rescaled_latlon <- projectRaster(vuln_rescaled, food_raster, method="ngb")

plot(vuln_rescaled_latlon)


### MULTIPLY BY AREA HERE
area(vuln_rescaled_latlon)

vuln_rescaled_latlon_area <- vuln_rescaled_latlon*area(vuln_rescaled_latlon)
plot(vuln_rescaled_latlon_area)

cellStats(vuln_rescaled_latlon_area, "sum") # 4572328

## save all layer
writeRaster(vuln_rescaled_latlon_area,  "/home/shares/food-systems/Food_footprint/all_food_systems/dataprep/fisheries/marine/disturbance/all_marine_fisheries_disturbance.tif", overwrite=TRUE)


## make csv
disturbance_all_df <- as.data.frame(vuln_rescaled_latlon, xy = TRUE)
names(disturbance_all_df)[3] <- "all_disturbance_km2"

 write_csv(disturbance_all_df, "/home/shares/food-systems/Food_footprint/all_food_systems/dataprep/fisheries/marine/disturbance/all_marine_fisheries_disturbance.csv")


```

Datacheck:
This should be conducted after all of the categories are done. 

We will sum the all of the disturbance from each of the categories and compare to the total from calculating the disturbance not split into groups (aggregated)... 

```{r}
check_dist <- raster(file.path("/home/shares/food-systems/Food_footprint/all_food_systems/dataprep/fisheries/marine/disturbance/all_marine_fisheries_disturbance.tif"))
plot(check_dist)
cellStats(check_dist, "sum") # 4572328 

check_dist_lp <- raster(file.path("/home/shares/food-systems/Food_footprint/all_food_systems/datalayers/marine_large-pelagic_fisheries_meat_disturbance.tif"))
lp <- cellStats(check_dist_lp, "sum") # 348975 

check_dist_mp <- raster(file.path("/home/shares/food-systems/Food_footprint/all_food_systems/datalayers/marine_medium-pelagic_fisheries_meat_disturbance.tif"))
mp <- cellStats(check_dist_mp, "sum") # 284745.1 

check_dist_sp <- raster(file.path("/home/shares/food-systems/Food_footprint/all_food_systems/datalayers/marine_small-pelagic_fisheries_meat_disturbance.tif"))
sp <- cellStats(check_dist_sp, "sum") # 63560.52 

check_dist_dem <- raster(file.path("/home/shares/food-systems/Food_footprint/all_food_systems/datalayers/marine_demersal_fisheries_meat_disturbance.tif"))
dem <- cellStats(check_dist_dem, "sum") # 2234153 

check_dist_ben <- raster(file.path("/home/shares/food-systems/Food_footprint/all_food_systems/datalayers/marine_benthic_fisheries_meat_disturbance.tif"))
ben <- cellStats(check_dist_ben, "sum") # 187290.2 

check_dist_rf <- raster(file.path("/home/shares/food-systems/Food_footprint/all_food_systems/datalayers/marine_reef_fisheries_meat_disturbance.tif"))
rf <- cellStats(check_dist_rf, "sum") # 388243.5 

check_dist_fofm <- raster(file.path("/home/shares/food-systems/Food_footprint/all_food_systems/datalayers/marine_fofm_fisheries_meat_disturbance.tif"))
fofm <- cellStats(check_dist_fofm, "sum") # 1310652 

lp + mp + sp + dem + ben + rf + fofm

# 4817619 vs 4572328... 

## this makes sense... i was expecting it to be a bit off given the reprojections that occur
```
