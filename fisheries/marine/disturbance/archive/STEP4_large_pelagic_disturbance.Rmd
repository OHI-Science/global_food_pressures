---
title: "Create raster of Distrubance of pelagic fisheries"
author: "Gage Clawson (UCSB, NCEAS, OHI)"
date: "October 5, 2020"
output: html_document
editor_options: 
  chunk_output_type: console
---

The goal of this is to determine how destructive FOFM fisheries are.

```{r, eval = FALSE}
#load relevant packages, etc.

library(here)
library(raster)
library(tidyverse)

# raster template
r <- raster::raster(ncol=720, nrow=360, vals=c(1:259200))
food_raster <- raster(nrows=2160, ncols=4320, xmn=-180, xmx=180, ymn=-90, ymx=90)
hab_raster <- raster("/home/shares/food-systems/Food_footprint/_raw_data/Halpern_chi/habitats/coral_reef.tif")
```


# catch data
This file has been upated to include information about gear type and whether the species is primarily benthic or pelagic.  This will be subset to include only the fish used in feed.

```{r, eval = FALSE}
## read in catch datas
catch <- read_csv("/home/shares/food-systems/Food_footprint/all_food_systems/dataprep/fisheries/marine/disturbance/catch_with_gear_cats.csv") ## From STEP3_marinefisheries_disturbance

## combine calculate the tonnes of pelagic cath
pel_catch_summary <- catch %>%
  dplyr::filter(IYear == 2017, species_class_fin == "Large pelagic", forage_fish == 0) %>%
  mutate(total_tonnes = ReportedIND + IUUIND + DiscardsIND + ReportedNIND + IUUNIND + DiscardsNIND) 

```

The NPP raster was gapfilled here: STEP2_NPP_prep.Rmd
```{r, eval = FALSE}

npp <- raster("/home/shares/food-systems/Food_footprint/_raw_data/CHI_data/annal_mean_npp_2015_gf_wgs.tif")

```



#### Deal with benthic destructive catch first.
```{r, eval = FALSE}

benthic_dest_tonnes <- pel_catch_summary %>%
  mutate(multiplier = ifelse(category == "destructive-demersal", 1, 0)) %>%
  mutate(total_tonnes = total_tonnes*multiplier) %>%
  group_by(Cell) %>%
  summarize(total_tonnes = sum(total_tonnes, na.rm=TRUE)) %>%
  ungroup()

sum(benthic_dest_tonnes$total_tonnes) ## should be 0 since we are doing large pelagic


benthic_dest_tonnes_raster <- raster::subs(r, benthic_dest_tonnes, by = "Cell", which = "total_tonnes", subsWithNA=TRUE)
plot(benthic_dest_tonnes_raster)

benthic_dest_tonnes_npp <- benthic_dest_tonnes_raster/npp
plot(benthic_dest_tonnes_npp)

benthic_dest_tonnes_npp_km2 <- benthic_dest_tonnes_npp/area(benthic_dest_tonnes_npp)

projectRaster(benthic_dest_tonnes_npp_km2, hab_raster, filename = "/home/shares/food-systems/Food_footprint/all_food_systems/dataprep/fisheries/marine/disturbance/large_pelagic/dem_dest_mol_per_km2.tif", method="ngb",
    overwrite=TRUE, progress="text")

ben_dest <- raster("/home/shares/food-systems/Food_footprint/all_food_systems/dataprep/fisheries/marine/disturbance/large_pelagic/dem_dest_mol_per_km2.tif")
plot(ben_dest)

ben_dest <- ben_dest * 0.9344789 * 0.9344789
# these should be similar
cellStats(ben_dest, "sum", na.rm=TRUE)
cellStats(benthic_dest_tonnes_npp, "sum", na.rm=TRUE)
writeRaster(ben_dest, "/home/shares/food-systems/Food_footprint/all_food_systems/dataprep/fisheries/marine/disturbance/large_pelagic/pressures/dem_dest.tif", overwrite=TRUE)

```


#### Deal with benthic nondestructive catch
```{r, eval = FALSE}

benthic_nondest_tonnes <- pel_catch_summary %>%
  mutate(multiplier = ifelse(category == "non-destructive-demersal", 1, 0)) %>%
  mutate(total_tonnes = total_tonnes*multiplier) %>%
  group_by(Cell) %>%
  summarize(total_tonnes = sum(total_tonnes, na.rm=TRUE)) %>%
  ungroup()

sum(benthic_nondest_tonnes$total_tonnes) # should be 0 since we are doing pelagic 


benthic_nondest_tonnes_raster <- raster::subs(r, benthic_nondest_tonnes, by = "Cell", which = "total_tonnes", subsWithNA=TRUE)
plot(benthic_nondest_tonnes_raster)


benthic_nondest_tonnes_npp <- benthic_nondest_tonnes_raster/npp
plot(benthic_dest_tonnes_npp)

benthic_nondest_tonnes_npp_km2 <- benthic_nondest_tonnes_npp/area(benthic_nondest_tonnes_npp)

projectRaster(benthic_nondest_tonnes_npp_km2, hab_raster, filename = "/home/shares/food-systems/Food_footprint/all_food_systems/dataprep/fisheries/marine/disturbance/large_pelagic/dem_nondest_mol_per_km2.tif", method="ngb",
    overwrite=TRUE, progress="text")

ben_nondest <- raster("/home/shares/food-systems/Food_footprint/all_food_systems/dataprep/fisheries/marine/disturbance/large_pelagic/dem_nondest_mol_per_km2.tif")
ben_nondest <- ben_nondest * 0.9344789 * 0.9344789
# these should be similar
cellStats(ben_nondest, "sum", na.rm=TRUE)
cellStats(benthic_nondest_tonnes_npp, "sum", na.rm=TRUE)
writeRaster(ben_nondest, "/home/shares/food-systems/Food_footprint/all_food_systems/dataprep/fisheries/marine/disturbance/large_pelagic/pressures/dem_nondest_lb.tif", overwrite=TRUE)


```


#### Pelagic lowbycatch
```{r, eval = FALSE}

pelagic_tonnes <- pel_catch_summary %>%
  mutate(multiplier = ifelse(category == "non-destructive-pelagic", 1, 0)) %>%
  mutate(total_tonnes = total_tonnes*multiplier) %>%
  group_by(Cell) %>%
  summarize(total_tonnes = sum(total_tonnes, na.rm=TRUE)) %>%
  ungroup()

sum(pelagic_tonnes$total_tonnes) #8749949 


pelagic_tonnes_raster <- raster::subs(r, pelagic_tonnes, by = "Cell", which = "total_tonnes", subsWithNA=TRUE)
plot(pelagic_tonnes_raster)


pelagic_tonnes_npp <- pelagic_tonnes_raster/npp
plot(pelagic_tonnes_npp)

pelagic_tonnes_npp_km2 <- pelagic_tonnes_npp/area(pelagic_tonnes_npp)

projectRaster(pelagic_tonnes_npp_km2, hab_raster, filename = "/home/shares/food-systems/Food_footprint/all_food_systems/dataprep/fisheries/marine/disturbance/large_pelagic/pelagic_mol_per_km2.tif", method="ngb",
    overwrite=TRUE, progress="text")

pelagic <- raster("/home/shares/food-systems/Food_footprint/all_food_systems/dataprep/fisheries/marine/disturbance/large_pelagic/pelagic_mol_per_km2.tif")
pelagic <- pelagic * 0.9344789 * 0.9344789
# these should be similar
cellStats(pelagic, "sum", na.rm=TRUE) # 3281108
cellStats(pelagic_tonnes_npp, "sum", na.rm=TRUE) # 3260361
writeRaster(pelagic, "/home/shares/food-systems/Food_footprint/all_food_systems/dataprep/fisheries/marine/disturbance/large_pelagic/pressures/pel_lb.tif", overwrite=TRUE)

```

#### Pelagic high bycatch
```{r, eval = FALSE}

pelagic_tonnes <- pel_catch_summary %>%
  mutate(multiplier = ifelse(category == "destructive-pelagic", 1, 0)) %>%
  mutate(total_tonnes = total_tonnes*multiplier) %>%
  group_by(Cell) %>%
  summarize(total_tonnes = sum(total_tonnes, na.rm=TRUE)) %>%
  ungroup()

sum(pelagic_tonnes$total_tonnes) # 2668.823


pelagic_tonnes_raster <- raster::subs(r, pelagic_tonnes, by = "Cell", which = "total_tonnes", subsWithNA=TRUE)
plot(pelagic_tonnes_raster)


pelagic_tonnes_npp <- pelagic_tonnes_raster/npp
plot(pelagic_tonnes_npp)

pelagic_tonnes_npp_km2 <- pelagic_tonnes_npp/area(pelagic_tonnes_npp)

projectRaster(pelagic_tonnes_npp_km2, hab_raster, filename = "/home/shares/food-systems/Food_footprint/all_food_systems/dataprep/fisheries/marine/disturbance/large_pelagic/dest_pelagic_mol_per_km2.tif", method="ngb",
    overwrite=TRUE, progress="text")

pelagic <- raster("/home/shares/food-systems/Food_footprint/all_food_systems/dataprep/fisheries/marine/disturbance/large_pelagic/dest_pelagic_mol_per_km2.tif")
pelagic <- pelagic * 0.9344789 * 0.9344789
# these should be similar
cellStats(pelagic, "sum", na.rm=TRUE) # 873.0812
cellStats(pelagic_tonnes_npp, "sum", na.rm=TRUE) # 868.7875
writeRaster(pelagic, "/home/shares/food-systems/Food_footprint/all_food_systems/dataprep/fisheries/marine/disturbance/large_pelagic/pressures/pel_hb.tif", overwrite=TRUE)

```


## fisheries vs. vulnerability
```{r, eval = FALSE}
# Vulnerability matrix - from CHI paper
vulnerability <- read.csv(here("fisheries/marine/disturbance/data/vulnerability_weighting_matrix.csv")) %>%
  filter(pressure != "pressure")

# List of habitat rasters
habs <- list.files(file.path("/home/shares/food-systems/Food_footprint/_raw_data/Halpern_chi/habitats"))
habs <- habs[-(grep(".vat.dbf|.xml|.ovr|README", habs))]

# The following should be zero
# The habitat rasters should all be in the vulnerability matrix
setdiff(habs, paste0(names(vulnerability), '.tif'))

# there are a couple habitats in the vulnerability table that we do not have raster habitat data for:
# "vent"        "Soft.Canyon" "Hard.Canyon"
xtra_vul_habs <- setdiff(paste0(names(vulnerability), '.tif'), habs) 
xtra_vul_habs <- xtra_vul_habs[-which(xtra_vul_habs=="pressure.tif")]
xtra_vul_habs <- gsub(".tif", "", xtra_vul_habs)
xtra_vul_habs

######### Clean vulnerability table
vulnerability_clean <- vulnerability %>%
  dplyr::select(-one_of(xtra_vul_habs)) %>%  # cut habitats we do not have raster data for
  dplyr::filter(pressure %in% c("dem_dest", "dem_nondest_lb", "pel_lb", "pel_hb")) %>%  # cut stressors we do not have raster data for
  tidyr::gather("habitat", "vulnerability", -1) %>%
  dplyr::mutate(stress_loc = NA) %>%
  mutate(output = NA)
```


## Create raster of each habitat x stressor x vulnerability combo

```{r, eval = FALSE}
stress_files <- list.files("/home/shares/food-systems/Food_footprint/all_food_systems/dataprep/fisheries/marine/disturbance/large_pelagic/pressures", 
                           pattern = ".tif", full="TRUE")

registerDoParallel(5)
foreach(row = 1:dim(vulnerability_clean)[1], .packages="dplyr") %dopar%{ # row=1

  combo_data <- vulnerability_clean[row, ]
  
  #obtain stressor raster location
  pxy <- combo_data$pressure
  stress_rast <- grep(pxy, stress_files, value=TRUE)
  
  #obtain habitat raster location
  hab_rast <- sprintf("/home/shares/food-systems/Food_footprint/_raw_data/Halpern_chi/habitats/%s.tif", combo_data$habitat)
  
  #vulnerability
  vuln <- as.numeric(combo_data$vulnerability)
  
  # multiply stressor * habitat * vulnerability:
  combo_stack <- raster::stack(stress_rast, hab_rast)
  raster::overlay(combo_stack, fun=function(x,y){(x*y*vuln)}, 
          filename = sprintf("/home/shares/food-systems/Food_footprint/all_food_systems/dataprep/fisheries/marine/disturbance/large_pelagic/hab_stressor_combo/%s__%s.tif", 
                               combo_data$pressure, combo_data$habitat), overwrite=TRUE)
  }

```


# sum all the vuln x pressure x habitat files
```{r, eval = FALSE}

vuln <- list.files("/home/shares/food-systems/Food_footprint/all_food_systems/dataprep/fisheries/marine/disturbance/large_pelagic/hab_stressor_combo", full=TRUE)

vuln_stack <- stack(vuln)

calc(vuln_stack, fun=sum, na.rm=TRUE, filename="/home/shares/food-systems/Food_footprint/all_food_systems/dataprep/fisheries/marine/disturbance/large_pelagic/summed_hab_stressor_combo/sum_hab_stressors_combo.tif", progress="text", overwrite=TRUE)

```


## Divide by number of habitats in each cell
```{r, eval = FALSE}

vuln <- raster("/home/shares/food-systems/Food_footprint/all_food_systems/dataprep/fisheries/marine/disturbance/large_pelagic/summed_hab_stressor_combo/sum_hab_stressors_combo.tif")
plot(vuln)

hab_num <- raster("/home/shares/food-systems/Food_footprint/_raw_data/Halpern_chi/habitat_num.tif")
plot(hab_num)

vuln_avg <- vuln/hab_num

```

## scale between 0-1
```{r, eval = FALSE}
# figure out aggregation factor:
sqrt(745366050/9331200)

vuln_avg_agg <- aggregate(vuln_avg, fact=9, fun=sum, na.rm=TRUE)

# new number of cells: 9202050
cellStats(vuln_avg_agg, stat=sum, na.rm=TRUE) # 3180646
cellStats(vuln_avg, stat=sum, na.rm=TRUE) # 3180646
plot(vuln_avg_agg)

#quantile(vuln_avg_agg, 0.999)
quant_99 <- 640.4062  # calculated from all fisheries in STEP3

vuln_rescaled <- vuln_avg_agg %>%
  raster::calc(fun=function(x){ifelse(x<0, 0,
                                      ifelse(x>quant_99, 1, x/quant_99))})

cellStats(vuln_rescaled, "sum", na.rm=TRUE) # 4966.607

vuln_rescaled_latlon <- projectRaster(vuln_rescaled, food_raster, method="ngb")
plot(vuln_rescaled_latlon, main = "Large Pelagic disturbance")
cellStats(vuln_rescaled_latlon, "sum", na.rm = TRUE) # 4339.239


### MULTIPLY BY AREA HERE
vuln_rescaled_latlon_area <- vuln_rescaled_latlon*raster::area(vuln_rescaled_latlon)
plot(vuln_rescaled_latlon_area)
cellStats(vuln_rescaled_latlon_area, "sum", na.rm = TRUE) # 348975

## save large pelagic layer
writeRaster(vuln_rescaled_latlon_area,  "/home/shares/food-systems/Food_footprint/all_food_systems/datalayers/marine_large-pelagic_fisheries_meat_disturbance.tif", overwrite=TRUE)


## take a look at large pelagic csv
disturbance_large_pel_df <- as.data.frame(vuln_rescaled_latlon, xy = TRUE)
names(disturbance_large_pel_df)[3] <- "large_pel_disturbance_km2"

 write_csv(disturbance_large_pel_df, "/home/shares/food-systems/Food_footprint/all_food_systems/dataprep/fisheries/marine/disturbance/large_pelagic/marine_large-pelagic_fisheries_disturbance.csv")


```

Datacheck: 

```{r}
check_dist <- raster(file.path("/home/shares/food-systems/Food_footprint/all_food_systems/datalayers/marine_large-pelagic_fisheries_meat_disturbance.tif"))
plot(check_dist)
cellStats(check_dist, "sum") # 348975 - matches what is above... 

disturbance_large_pel_df <- as.data.frame(check_dist, xy = TRUE)

test <- read_csv(file.path("/home/shares/food-systems/Food_footprint/all_food_systems/dataprep/fisheries/marine/disturbance/large_pelagic/marine_large_pelagic_fisheries_disturbance.csv"))
sum(test$prop_large_pel, na.rm = TRUE)
```

