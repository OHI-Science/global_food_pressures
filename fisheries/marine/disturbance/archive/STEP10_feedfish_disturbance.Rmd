---
title: "Create raster of Distrubance of pelagic forage fisheries"
author: "Gage Clawson (UCSB, NCEAS, OHI)"
date: "October 5, 2020"
output: html_document
editor_options: 
  chunk_output_type: console
---

The goal of this is to determine how destructive FOFM fisheries are.

```{r, eval = FALSE}
#load relevant packages, etc.

library(here)
library(raster)
library(tidyverse)

# raster template
r <- raster::raster(ncol=720, nrow=360, vals=c(1:259200))
food_raster <- raster(nrows=2160, ncols=4320, xmn=-180, xmx=180, ymn=-90, ymx=90)
hab_raster <- raster("/home/shares/food-systems/Food_footprint/_raw_data/Halpern_chi/habitats/coral_reef.tif")
```


# catch data
This file has been upated to include information about gear type and whether the species is primarily benthic or pelagic.  This will be subset to include only the fish used in feed.

```{r, eval = FALSE}
## read in catch datas
catch <- read_csv("/home/shares/food-systems/Food_footprint/all_food_systems/dataprep/fisheries/marine/disturbance/catch_with_gear_cats.csv") ## From STEP4_marinefisheries_disturbance

## read in forage fish list 
forage_fish_list <- read_csv(here("fisheries/marine/ghg/data/master_taxa_list.csv")) ## From ghg prep

## combine calculate the tonnes of forage fish catch
forage_fish_summary <- catch %>%
  dplyr::filter(IYear == 2017) %>%
  mutate(total_tonnes = ReportedIND + IUUIND + DiscardsIND + ReportedNIND + IUUNIND + DiscardsNIND) %>%
  dplyr::filter(forage_fish == 1) 

sum(forage_fish_summary$total_tonnes, na.rm=TRUE) # 41693559
# this should equal to a bit greater than 38746897 (which is the sum of Reported and IUU in 2017
```

The NPP raster was gapfilled here: STEP2_NPP_prep.Rmd
```{r, eval = FALSE}

npp <- raster("/home/shares/food-systems/Food_footprint/_raw_data/CHI_data/annal_mean_npp_2015_gf_wgs.tif")

```



#### Deal with benthic destructive catch first.
```{r, eval = FALSE}

benthic_dest_tonnes_forage <- forage_fish_summary %>%
  mutate(multiplier = ifelse(category == "destructive-demersal", 1, 0)) %>%
  mutate(total_forage_tonnes = total_tonnes*multiplier) %>%
  group_by(Cell) %>%
  summarize(total_forage_tonnes = sum(total_forage_tonnes, na.rm=TRUE)) %>%
  ungroup()

sum(benthic_dest_tonnes_forage$total_forage_tonnes) # 3150786


benthic_dest_tonnes_forage_raster <- raster::subs(r, benthic_dest_tonnes_forage, by = "Cell", which = "total_forage_tonnes", subsWithNA=TRUE)
plot(benthic_dest_tonnes_forage_raster)

benthic_dest_tonnes_forage_npp <- benthic_dest_tonnes_forage_raster/npp
plot(benthic_dest_tonnes_forage_npp)

benthic_dest_tonnes_forage_npp_km2 <- benthic_dest_tonnes_forage_npp/area(benthic_dest_tonnes_forage_npp)

projectRaster(benthic_dest_tonnes_forage_npp_km2, hab_raster, filename = "/home/shares/food-systems/Food_footprint/all_food_systems/dataprep/fisheries/marine/disturbance/FOFM_fisheries/dem_dest_mol_per_km2.tif", method="ngb",
    overwrite=TRUE, progress="text")

ben_dest <- raster("/home/shares/food-systems/Food_footprint/all_food_systems/dataprep/fisheries/marine/disturbance/FOFM_fisheries/dem_dest_mol_per_km2.tif")
plot(ben_dest)

ben_dest <- ben_dest * 0.9344789 * 0.9344789

# these should be similar
cellStats(ben_dest, "sum", na.rm=TRUE) # 1035467
cellStats(benthic_dest_tonnes_forage_npp, "sum", na.rm=TRUE) # 1029082

writeRaster(ben_dest, "/home/shares/food-systems/Food_footprint/all_food_systems/dataprep/fisheries/marine/disturbance/FOFM_fisheries/pressures/dem_dest.tif", overwrite=TRUE)

```


#### Deal with benthic nondestructive catch
```{r, eval = FALSE}

benthic_nondest_tonnes_forage <- forage_fish_summary %>%
  mutate(multiplier = ifelse(category == "non-destructive-demersal", 1, 0)) %>%
  mutate(total_forage_tonnes = total_tonnes*multiplier) %>%
  group_by(Cell) %>%
  summarize(total_forage_tonnes = sum(total_forage_tonnes, na.rm=TRUE)) %>%
  ungroup()

sum(benthic_nondest_tonnes_forage$total_forage_tonnes) # 4634159

benthic_nondest_tonnes_forage_raster <- raster::subs(r, benthic_nondest_tonnes_forage, by = "Cell", which = "total_forage_tonnes", subsWithNA=TRUE)
plot(benthic_nondest_tonnes_forage_raster)


benthic_nondest_tonnes_forage_npp <- benthic_nondest_tonnes_forage_raster/npp
plot(benthic_dest_tonnes_forage_npp)

benthic_nondest_tonnes_forage_npp_km2 <- benthic_nondest_tonnes_forage_npp/area(benthic_nondest_tonnes_forage_npp)

projectRaster(benthic_nondest_tonnes_forage_npp_km2, hab_raster, filename = "/home/shares/food-systems/Food_footprint/all_food_systems/dataprep/fisheries/marine/disturbance/FOFM_fisheries/dem_nondest_mol_per_km2.tif", method="ngb",
    overwrite=TRUE, progress="text")

ben_nondest <- raster("/home/shares/food-systems/Food_footprint/all_food_systems/dataprep/fisheries/marine/disturbance/FOFM_fisheries/dem_nondest_mol_per_km2.tif")

ben_nondest <- ben_nondest * 0.9344789 * 0.9344789

# these should be similar
cellStats(ben_nondest, "sum", na.rm=TRUE) # 1536083
cellStats(benthic_nondest_tonnes_forage_npp, "sum", na.rm=TRUE) # 1528244

writeRaster(ben_nondest, "/home/shares/food-systems/Food_footprint/all_food_systems/dataprep/fisheries/marine/disturbance/FOFM_fisheries/pressures/dem_nondest_lb.tif", overwrite=TRUE)


```


#### Pelagic low bycatch
```{r, eval = FALSE}

pelagic_tonnes_forage <- forage_fish_summary %>%
  mutate(multiplier = ifelse(category == "non-destructive-pelagic", 1, 0)) %>%
  mutate(total_forage_tonnes = total_tonnes*multiplier) %>%
  group_by(Cell) %>%
  summarize(total_forage_tonnes = sum(total_forage_tonnes, na.rm=TRUE)) %>%
  ungroup()

sum(pelagic_tonnes_forage$total_forage_tonnes) # 30590718


pelagic_tonnes_forage_raster <- raster::subs(r, pelagic_tonnes_forage, by = "Cell", which = "total_forage_tonnes", subsWithNA=TRUE)
plot(pelagic_tonnes_forage_raster)


pelagic_tonnes_forage_npp <- pelagic_tonnes_forage_raster/npp
plot(pelagic_tonnes_forage_npp)

pelagic_tonnes_forage_npp_km2 <- pelagic_tonnes_forage_npp/area(pelagic_tonnes_forage_npp)

projectRaster(pelagic_tonnes_forage_npp_km2, hab_raster, filename = "/home/shares/food-systems/Food_footprint/all_food_systems/dataprep/fisheries/marine/disturbance/FOFM_fisheries/pelagic_mol_per_km2.tif", method="ngb",
    overwrite=TRUE, progress="text")

pelagic <- raster("/home/shares/food-systems/Food_footprint/all_food_systems/dataprep/fisheries/marine/disturbance/FOFM_fisheries/pelagic_mol_per_km2.tif")

pelagic <- pelagic * 0.9344789 * 0.9344789

# these should be similar
cellStats(pelagic, "sum", na.rm=TRUE) # 10052185
cellStats(pelagic_tonnes_forage_npp, "sum", na.rm=TRUE) # 9992456

writeRaster(pelagic, "/home/shares/food-systems/Food_footprint/all_food_systems/dataprep/fisheries/marine/disturbance/FOFM_fisheries/pressures/pel_lb.tif", overwrite=TRUE)

```


#### Pelagic high bycatch
```{r, eval = FALSE}

pelagic_tonnes_forage <- forage_fish_summary %>%
  mutate(multiplier = ifelse(category == "destructive-pelagic", 1, 0)) %>%
  mutate(total_forage_tonnes = total_tonnes*multiplier) %>%
  group_by(Cell) %>%
  summarize(total_forage_tonnes = sum(total_forage_tonnes, na.rm=TRUE)) %>%
  ungroup()

sum(pelagic_tonnes_forage$total_forage_tonnes) # 3317896

pelagic_tonnes_forage_raster <- raster::subs(r, pelagic_tonnes_forage, by = "Cell", which = "total_forage_tonnes", subsWithNA=TRUE)
plot(pelagic_tonnes_forage_raster)


pelagic_tonnes_forage_npp <- pelagic_tonnes_forage_raster/npp
plot(pelagic_tonnes_forage_npp)

pelagic_tonnes_forage_npp_km2 <- pelagic_tonnes_forage_npp/area(pelagic_tonnes_forage_npp)

projectRaster(pelagic_tonnes_forage_npp_km2, hab_raster, filename = "/home/shares/food-systems/Food_footprint/all_food_systems/dataprep/fisheries/marine/disturbance/FOFM_fisheries/dest_pelagic_mol_per_km2.tif", method="ngb",
    overwrite=TRUE, progress="text")

pelagic <- raster("/home/shares/food-systems/Food_footprint/all_food_systems/dataprep/fisheries/marine/disturbance/FOFM_fisheries/dest_pelagic_mol_per_km2.tif")

pelagic <- pelagic * 0.9344789 * 0.9344789

# these should be similar
cellStats(pelagic, "sum", na.rm=TRUE) # 1094961
cellStats(pelagic_tonnes_forage_npp, "sum", na.rm=TRUE) # 1088780

writeRaster(pelagic, "/home/shares/food-systems/Food_footprint/all_food_systems/dataprep/fisheries/marine/disturbance/FOFM_fisheries/pressures/pel_hb.tif", overwrite=TRUE)

```

## fisheries vs. vulnerability
```{r, eval = FALSE}
# Vulnerability matrix - from CHI paper
vulnerability <- read.csv(here("fisheries/marine/disturbance/data/vulnerability_weighting_matrix.csv")) %>%
  filter(pressure != "pressure")

# List of habitat rasters
habs <- list.files(file.path("/home/shares/food-systems/Food_footprint/_raw_data/Halpern_chi/habitats"))
habs <- habs[-(grep(".vat.dbf|.xml|.ovr|README", habs))]

# The following should be zero
# The habitat rasters should all be in the vulnerability matrix
setdiff(habs, paste0(names(vulnerability), '.tif'))

# there are a couple habitats in the vulnerability table that we do not have raster habitat data for:
# "vent"        "Soft.Canyon" "Hard.Canyon"
xtra_vul_habs <- setdiff(paste0(names(vulnerability), '.tif'), habs) 
xtra_vul_habs <- xtra_vul_habs[-which(xtra_vul_habs=="pressure.tif")]
xtra_vul_habs <- gsub(".tif", "", xtra_vul_habs)
xtra_vul_habs

######### Clean vulnerability table
vulnerability_clean <- vulnerability %>%
  dplyr::select(-one_of(xtra_vul_habs)) %>%  # cut habitats we do not have raster data for
  dplyr::filter(pressure %in% c("dem_dest", "dem_nondest_lb", "pel_lb", "pel_hb")) %>%  # cut stressors we do not have raster data for
  tidyr::gather("habitat", "vulnerability", -1) %>%
  dplyr::mutate(stress_loc = NA) %>%
  mutate(output = NA)
```


## Create raster of each habitat x stressor x vulnerability combo

```{r, eval = FALSE}
stress_files <- list.files("/home/shares/food-systems/Food_footprint/all_food_systems/dataprep/fisheries/marine/disturbance/FOFM_fisheries/pressures", 
                           pattern = ".tif", full="TRUE")

registerDoParallel(5)
foreach(row = 1:dim(vulnerability_clean)[1], .packages="dplyr") %dopar%{ # row=1

  combo_data <- vulnerability_clean[row, ]
  
  #obtain stressor raster location
  pxy <- combo_data$pressure
  stress_rast <- grep(pxy, stress_files, value=TRUE)
  
  #obtain habitat raster location
  hab_rast <- sprintf("/home/shares/food-systems/Food_footprint/_raw_data/Halpern_chi/habitats/%s.tif", combo_data$habitat)
  
  #vulnerability
  vuln <- as.numeric(combo_data$vulnerability)
  
  # multiply stressor * habitat * vulnerability:
  combo_stack <- raster::stack(stress_rast, hab_rast)
  raster::overlay(combo_stack, fun=function(x,y){(x*y*vuln)}, 
          filename = sprintf("/home/shares/food-systems/Food_footprint/all_food_systems/dataprep/fisheries/marine/disturbance/FOFM_fisheries/hab_stressor_combo/%s__%s.tif", 
                               combo_data$pressure, combo_data$habitat), overwrite=TRUE)
  }

```


# sum all the vuln x pressure x habitat files
```{r, eval = FALSE}

vuln <- list.files("/home/shares/food-systems/Food_footprint/all_food_systems/dataprep/fisheries/marine/disturbance/FOFM_fisheries/hab_stressor_combo", full=TRUE)

vuln_stack <- stack(vuln)

calc(vuln_stack, fun=sum, na.rm=TRUE, filename="/home/shares/food-systems/Food_footprint/all_food_systems/dataprep/fisheries/marine/disturbance/FOFM_fisheries/summed_hab_stressor_combo/sum_hab_stressors_combo.tif", progress="text", overwrite=TRUE)

```


## Divide by number of habitats in each cell
```{r, eval = FALSE}

vuln <- raster("/home/shares/food-systems/Food_footprint/all_food_systems/dataprep/fisheries/marine/disturbance/FOFM_fisheries/summed_hab_stressor_combo/sum_hab_stressors_combo.tif")
plot(vuln)

hab_num <- raster("/home/shares/food-systems/Food_footprint/_raw_data/Halpern_chi/habitat_num.tif")


vuln_avg <- vuln/hab_num

```

## scale between 0-1
```{r, eval = FALSE}
# figure out aggregation factor:
sqrt(745366050/9331200)

vuln_avg_agg <- aggregate(vuln_avg, fact=9, fun=sum, na.rm=TRUE)

cellStats(vuln_avg_agg, stat=sum, na.rm=TRUE) # 11978702
cellStats(vuln_avg, stat=sum, na.rm=TRUE) # 11978702

plot(vuln_avg_agg)

#quantile(vuln_avg_agg, 0.999)
quant_99 <- 640.4062  # calculated from all fisheries in STEP3

vuln_rescaled <- vuln_avg_agg %>%
  raster::calc(fun=function(x){ifelse(x<0, 0,
                                      ifelse(x>quant_99, 1, x/quant_99))})

vuln_rescaled_latlon <- projectRaster(vuln_rescaled, food_raster, method="ngb")
plot(vuln_rescaled_latlon, main = "FOFM disturbance")

area(vuln_rescaled_latlon)

vuln_rescaled_latlon_area <- vuln_rescaled_latlon*area(vuln_rescaled_latlon)

plot(vuln_rescaled_latlon_area)

## save FOFM layer
writeRaster(vuln_rescaled_latlon_area,  "/home/shares/food-systems/Food_footprint/all_food_systems/datalayers/marine_fofm_fisheries_meat_disturbance.tif", overwrite=TRUE)

 test <- raster(file.path("/home/shares/food-systems/Food_footprint/all_food_systems/datalayers/marine_fofm_fisheries_meat_disturbance.tif"))
cellStats(test, "sum")  # 1310652

```


Datacheck: 
```{r}
check_dist <- raster(file.path("/home/shares/food-systems/Food_footprint/all_food_systems/datalayers/marine_fofm_fisheries_meat_disturbance.tif"))
plot(check_dist)
cellStats(check_dist, "sum") # 1310652 

disturbance_fofm_df <- as.data.frame(check_dist, xy = TRUE)
names(disturbance_fofm_df)[3] <- "disturbance_fofm_km2"

write.csv(disturbance_fofm_df, file.path("/home/shares/food-systems/Food_footprint/all_food_systems/dataprep/fisheries/marine/disturbance/FOFM_fisheries/marine_fofm_fisheries_meat_disturbance.csv"), row.names = FALSE)


```

