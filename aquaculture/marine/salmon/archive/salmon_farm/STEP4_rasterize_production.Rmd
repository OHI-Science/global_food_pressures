---
title: "Rasterizing prodution per each region"
author: "Gage Clawson (UCSB, NCEAS, OHI)"
date: "10/09/2020"
output: html_document
editor_options: 
  chunk_output_type: console
---


In this script we allocated the production per farm (equally if there is no subregional production estimates). 

```{r}

library(here)
library(dplyr)
library(sf)
library(raster)
library(mapview)

source(here("_spatial/template_raster.R"))


```


# Global regions

```{r}

# this file includes ocean regions:
gadm <- raster("/home/shares/food-systems/Food_footprint/_raw_data/Country_regions/gadm36mol_pyfill_10km.tif")

gadm_latlon <- raster::projectRaster(gadm, food_raster, method="ngb", over=TRUE)
plot(gadm_latlon)

gadm_codes <- read.csv("/home/shares/food-systems/Food_footprint/_raw_data/Country_regions/gadm_reg_codes.csv") %>% 
  mutate(reg_id = as.numeric(reg_id))

```

# read in points and converted to spatial dataframe
```{r}

farms <- read.csv(here("aquaculture/marine/salmon/salmon_farm/data/global_salmon_farm_lat_lon.csv"))

farms_sf <-  st_as_sf(farms, coords = c("lon", "lat"), 
                 crs = crs(gadm_latlon), agr = "constant")

```


# determine subregions where points are located

```{r}

farms_sf$reg_id <- raster::extract(gadm_latlon, farms_sf) 

farms_sf <- farms_sf %>%
  left_join(gadm_codes, by="reg_id") %>%
    dplyr::mutate(subregion = as.character(subregion)) %>%
  dplyr::mutate(NAME_1 = as.character(NAME_1)) %>%
  dplyr::mutate(NAME_1 = ifelse(is.na(subregion), NAME_1, subregion))

farms_sf$check <-  paste(farms_sf$iso3c, farms_sf$GID_0, sep=":")
table(farms_sf$check)
mapview(filter(farms_sf, check=="CAN:USA"))
mapview(filter(farms_sf, check=="USA:CAN"))
mapview(filter(farms_sf, check =="SWE:SWE"))
mapview(filter(farms_sf, check == "FIN:ALA"))
mapview(filter(farms_sf, check == "FIN:RUS"))

mapview(filter(farms_sf, check == "RUS:RUS"))
mapview(farms_sf)
# some annoying mismatches due to raster resolution. Fix these

unique(farms_sf$NAME_1)

farms_sf_correct <- farms_sf %>%
  mutate(GID_0 = as.character(GID_0)) %>%
  mutate(NAME_0 = as.character(NAME_0)) %>%
  mutate(NAME_1 = as.character(NAME_1)) %>%
  mutate(GID_0 = ifelse(check %in% "CAN:USA", "CAN", GID_0)) %>%
  mutate(NAME_0 = ifelse(check %in% "CAN:USA", "Canada", NAME_0)) %>%
  mutate(NAME_1 = ifelse(check %in% "CAN:USA", "New Brunswick", NAME_1)) %>%
  mutate(GID_0 = ifelse(check %in% "USA:CAN", "USA", GID_0)) %>%
  mutate(NAME_0 = ifelse(check %in% "USA:CAN", "United States", NAME_0)) %>%
  mutate(NAME_1 = ifelse(check %in% "USA:CAN", "Maine", NAME_1)) %>%
  mutate(GID_0 = ifelse(check %in% "FIN:ALA", "FIN", GID_0)) %>%
  mutate(NAME_0 = ifelse(check %in% "FIN:ALA", "Finland", NAME_0)) %>%
  mutate(GID_0 = ifelse(check %in% "FIN:RUS", "FIN", GID_0)) %>%
  mutate(NAME_0 = ifelse(check %in% "FIN:RUS", "Finland", NAME_0))

farms_sf_correct$check <-  paste(farms_sf_correct$iso3c, farms_sf_correct$GID_0, sep=":")
table(farms_sf_correct$check)




mapview(farms_sf_correct) # this all looks reasonable, no crazy points
```


# FAO salmon production data per country
```{r}

fao <- read.csv(here("aquaculture/marine/salmon/salmon_farm/data/fao_mariculture_salmon.csv")) %>%
  dplyr::filter(year == 2017) %>%
  dplyr::select(iso3c, fao_tonnes_production)

```


# join country production to farms by iso3c

```{r}

farms_sf_correct <- farms_sf_correct %>%
  left_join(fao, by="iso3c")

summary(farms_sf_correct) # make sure no production NA values

```

# get areas with regional production data and calculate production per farm
```{r}

rgn_prod <- read_csv(here("aquaculture/marine/salmon/salmon_farm/data/proportional_regional_production.csv")) %>%
  dplyr::select(iso3c, NAME_1 = region, prop_production)

rgn_prod_country <- unique(rgn_prod$iso3c)

farms_rgn_prod <- farms_sf_correct %>%
  dplyr::filter(GID_0 %in% rgn_prod_country) 


# make sure region names match
no_match <- setdiff(rgn_prod$NAME_1, farms_rgn_prod$NAME_1)
no_match

setdiff(farms_rgn_prod$NAME_1, rgn_prod$NAME_1)

#this is ok: little or no production in these regions
test <- filter(rgn_prod, NAME_1 %in% no_match)

## calculate farm production
farms_rgn_prod <- farms_rgn_prod %>%
  left_join(rgn_prod) %>%
  mutate(regional_prod = fao_tonnes_production*prop_production) %>%
  group_by(NAME_1) %>%
  add_tally() %>%
  ungroup() %>%
  mutate(tonnes_per_farm = regional_prod/n) %>%
  dplyr::select(iso3c, tonnes_per_farm, geometry)

test <- farms_rgn_prod %>%
  dplyr::filter(iso3c == "NOR")

sum(test$tonnes_per_farm) # 1299663

test2 <- fao %>%
  dplyr::filter(iso3c == "NOR")

sum(test2$fao_tonnes_production) # 1303255
```


# get areas with no regional production data and calculate production per farm

```{r}

rgn_prod <- read_csv(here("aquaculture/marine/salmon/salmon_farm/data/proportional_regional_production.csv")) %>%
  dplyr::select(iso3c, NAME_1 = region, prop_production)
rgn_prod_country <- unique(rgn_prod$iso3c)

farms_prod <- farms_sf_correct %>%
  dplyr::filter(!(GID_0 %in% rgn_prod_country)) 


## calculate farm production
farms_prod <- farms_prod %>%
  group_by(NAME_0) %>%
  add_tally() %>%
  ungroup() %>%
  mutate(tonnes_per_farm = fao_tonnes_production/n) %>%
  dplyr::select(iso3c, tonnes_per_farm, geometry)

```

# combine and check it all matches ok

```{r}

farm_production <- rbind(farms_prod, farms_rgn_prod)

test <- farm_production %>%
  group_by(iso3c) %>%
  summarize(total_tonnes = sum(tonnes_per_farm, na.rm=TRUE)) %>%
  left_join(fao) %>%
  mutate(difference = fao_tonnes_production - total_tonnes)


```

## convert to raster, with the value of each cell equalling the sum tonnes per farm for all farms landing in cell.

```{r}

farms_sf <- st_as_sf(farm_production)
mapview(farms_sf)

salmon_raster_check <- rasterize(farms_sf, food_raster, field = "tonnes_per_farm", fun=sum)
mapview(salmon_raster_check)

salmon_raster <- rasterize(farms_sf, food_raster, field = "tonnes_per_farm", fun=sum, background=0)
plot(log(salmon_raster + 1))

salmon_raster_df <- as.data.frame(salmon_raster, xy=TRUE) %>%
  dplyr::select(x,y, tonnes_production=layer)

cellStats(salmon_raster, stat = "sum") # 2746086
sum(salmon_raster_df$tonnes_production) # 2746086
sum(farms_sf$tonnes_per_farm, na.rm = TRUE) # 2746086
sum(fao$fao_tonnes_production) #2753752

write_csv(salmon_raster_df, "/home/shares/food-systems/Food_footprint/all_food_systems/dataprep/aquaculture/marine/salmon/salmon_farm.csv")

```
