---
title: "Explore grassland and mixed diet comp"
author: "Juliette"
date: "11/12/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(here)
source(here("_workflow/common.R"))
source(here("_workflow/common_spatial.R"))

```


# 1. Weirdness with grassland and mixed diets

"Weirdness about feed for grazers. The fact that mixed/grazed have the same diet really doesn't make sense given that our proportions of mixed/grazed are so different from GLEAM. I think we need to figure out some way of differentiating these diets. Can you take a look at this and see if there are any easy-ish solutions that reveal themselves to you?"

My first thought is to see if our proportions for grassland and mixed are consistently less or more than GLEAM. If our grassland proportion is higher, we can assume that the cows GLEAM assigned as mixed that were on the cusp (so they eat a lot fo grass) we assigned and grassland and change the diet percentage accordingly.

Code below does this:
Grab the total numbers of mixed and grassland animals (start with cows) from GLEAM and our maps and calculate their proportion (grass+ mixed, this will not include feedlots). Do for each country. Map GLEAM prop of 1 vs our prop and draw 1/1 line. Our the counts from our maps consistently over or under?

GLEAM data
```{r}
gleam<- read_csv(here("animal_farm/farm/data/ruminants_GLEAMi_v2.csv")) %>% 
filter(Species == "Cattle",
       Production_system %in% c("Grassland systems", "Mixed systems"),
       Variable == "HERD: total number of animals",
       Herd_type == "Whole herd") %>% 
  select(iso3c, Production_system, Value) %>% 
  group_by(iso3c) %>% 
  mutate(sum = sum(Value)) %>% 
  ungroup() %>% 
  rowwise() %>% 
  mutate(prop = Value/sum,
         prop = ifelse(Value == 0, 0, prop),
         Production_system = case_when(Production_system == "Grassland systems" ~ "grassland",
                                       Production_system == "Mixed systems" ~ "mixed")) %>% 
  select(iso3c, system = Production_system, gleam_prop = prop)
  
```

Our data

```{r}
mixed_meat <- read_csv(file.path(prep, "animal_farm/farm/rgn_df/region_counts_cows_mixed_meat.csv"))
mixed_milk <- read_csv(file.path(prep, "animal_farm/farm/rgn_df/region_counts_cows_mixed_milk.csv"))

grass_meat <- read_csv(file.path(prep, "animal_farm/farm/rgn_df/region_counts_cows_grassland_meat.csv"))
grass_milk <- read_csv(file.path(prep, "animal_farm/farm/rgn_df/region_counts_cows_grassland_milk.csv"))

ours <- rbind(mixed_meat, mixed_milk, grass_meat, grass_milk) %>% 
  group_by(iso3c, system) %>% 
  dplyr::summarise(count = sum(rgn_count)) %>% 
  ungroup() %>% 
  group_by(iso3c) %>% 
  mutate(sum = sum(count)) %>% 
  ungroup() %>% 
  rowwise() %>% 
  mutate(prop = count/sum,
         prop = ifelse(count == 0, 0, prop)) %>% 
  select(iso3c, system, our_prop = prop)

```

Combine and compare
```{r}
all <- left_join(gleam, ours) %>% 
  filter(system == "grassland")

ggplot(all) +
  geom_point(aes(x = our_prop, y = gleam_prop, color = iso3c)) +
  theme_classic() +
  theme(legend.position = "none") +
  geom_abline(intercept=0, slope=1, color="red")

```

Okkkayyy maybe not. What I think we should do: Since we are using the npp maps to help designate where grassland and mixed areas are, i dont think its crazy to just downgrade the fresh grass and other fresh plant things to like 10% or something close. Mixed animals aren't in any areas that have npp of  >10 so there's no way that the ruminants in our maps can have a diet with 50% fresh grass

**************

# 2. Checking our fodder consumption estimates to the estiamtes of fodder production

"We have estimates of fodder consumption for each country (although this will change with changes above). Will you compare this to our estimates of country fodder production? Basically, I want to make sure that the there is some relationship between these data. (data located here: feed/data/livestock_country_fodder_consumption.csv)"

```{r}
consumption <- read_csv(here("feed/data/livestock_country_fodder_consumption.csv")) %>% 
  rename(consumed_tonnes = tonnes_fodder)

production_raster <- sum(stack(raster(file.path(prep, "crop/farm/scaled_maps_2017/crop_fodd_I_scaled.tif")), raster(file.path(prep, "crop/farm/scaled_maps_2017/crop_fodd_H_scaled.tif"))))


production_raster[is.na(production_raster)] <- 0

#plot(log(1+production_raster))

production <- zonal(production_raster, food_rgns_tif, fun = 'sum') %>% 
  as_tibble() %>% 
  rename(ID_0 = zone, production_kg = sum) %>% 
  left_join(food_rgns) %>% 
  mutate(production_tonnes = production_kg*1000) %>% 
  select(iso3c, production_tonnes) 

combine <- left_join(consumption,production)
ggplot(combine) +
  geom_point(aes(x = production_tonnes, y = consumed_tonnes, color = iso3c)) +
  theme_classic() +
  theme(legend.position = "none") +
  geom_abline(intercept=0, slope=1, color="red")

## which counties have 0 production of fodder but do have consumption?
check <- combine %>% 
  filter(production_tonnes == 0 & consumed_tonnes > 0)

check_spatial <- left_join(food_rgns_xy, check) %>% 
  select(x, y, consumed_tonnes) %>% 
  rasterFromXYZ(crs = food_crs)
#plot(check_spatial)

## check global consumption and production
consumed_total <- sum(consumption$consumed_tonnes)
## 1,157,533,844 tonnes
produced_total <- sum(production$production_tonnes)
# 2,293,877,345 tonnes

#2801461331 in the OG 2015 gaza maps

```

## look at grazing intensity, try and see where >1 (or maybe 0.9), is that a lot? is there a way to calcualte the total amount of dry matter consumed that is grass and then determine total dry matter needed? the percentages can be 

```{r}

GI <- raster(file.path(prep, "animal_farm/disturbance/grazing_intensity_unmodified.tif"))
GI_ed <- calc(GI, fun = function(x) {ifelse(x > 0.8, 1, 0)})
plot(GI_ed)
```

