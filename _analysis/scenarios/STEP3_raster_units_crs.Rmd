---
title: "Make tiff files per km2"
output: html_document
editor_options: 
  chunk_output_type: console
---

The goal of this script is to create rasters from the raw values to rasters where the values are divided by the area of the raster cell, km2

The outputs are tif files located on Aurora in the final_data folder: 

_tif_version_per_km2

Time to run: 
~9 hour (longest part is converting to galls peter, ~1.2 minutes per raster which is about 7 hours) 

```{r}
library(rgdal)
library(sp)
library(raster)
library(tidyverse)
library(here)

```

# clear out listed files in tif folders. Want to make sure we have a clean start.
```{r}

do.call(file.remove, list(list.files("/home/shares/food-systems/Food_footprint/all_food_systems/scenarios/scenarios_analysis/scenarios_tif_latlong_per_km2", full.names = TRUE)))

do.call(file.remove, list(list.files("/home/shares/food-systems/Food_footprint/all_food_systems/scenarios/scenarios_analysis/scenarios_tif_equal_area_proj_per_km2", full.names=TRUE)))

do.call(file.remove, list(list.files("/home/shares/food-systems/Food_footprint/all_food_systems/scenarios/scenarios_analysis/scenarios_tif_equal_area_proj_per_cell", full.names=TRUE)))

```


Control for differences in raster cells area.  

```{r}

files_to_adjust <- list.files("/home/shares/food-systems/Food_footprint/all_food_systems/scenarios/scenarios_analysis/scenarios_raw", full=TRUE, pattern = ".tif")

for(file in files_to_adjust){ # 
  
  # file = files_to_adjust[1] 
  
  stressor_raster <- raster(file)
  
  name <- basename(file)
  name <- gsub(".tif", "", name)
  
  raster_area <- area(stressor_raster)
  #plot(raster_area)
  
if(grepl("disturbance", file)){
  
   stressor_area_adjust <-  stressor_raster/raster_area
   stressor_area_adjust[stressor_area_adjust >1] <- 1

   writeRaster(stressor_area_adjust,
               sprintf("/home/shares/food-systems/Food_footprint/all_food_systems/scenarios/scenarios_analysis/scenarios_tif_latlong_per_km2/%s_per_area.tif", name),
               overwrite=TRUE)

} else {
  
   stressor_area_adjust <- stressor_raster/raster_area
   
   writeRaster(stressor_area_adjust,
               sprintf("/home/shares/food-systems/Food_footprint/all_food_systems/scenarios/scenarios_analysis/scenarios_tif_latlong_per_km2/%s_per_area.tif", name),
               overwrite=TRUE)

  }
}

```


Next: project rasters to equal area gall peters so we can more easily scale data and such.
```{r}

gall_peters <- "+proj=cea +lon_0=0 +x_0=0 +y_0=0 +lat_ts=45 +ellps=WGS84 +datum=WGS84 +units=m +no_defs"
#raster template 
template_eq_area <- raster(res=0.083333333333333333)
extent(template_eq_area) <- c(-180, 180, -90, 90)
template_eq_area <- projectRaster(template_eq_area, crs=gall_peters, res=3000) 


```


```{r}

rasters_to_new_crs <- list.files("/home/shares/food-systems/Food_footprint/all_food_systems/scenarios/scenarios_analysis/scenarios_tif_latlong_per_km2", pattern=".tif", full=TRUE)

for(rast in rasters_to_new_crs){ # rast <- rasters_to_new_crs[1]
  
rast_name <- basename(rast)
 getraster <- raster(rast)
 highres_raster <- disaggregate(getraster, fact=2)
 projectRaster(highres_raster, template_eq_area, method="ngb", over=TRUE, progress="text",
                       filename=sprintf("/home/shares/food-systems/Food_footprint/all_food_systems/scenarios/scenarios_analysis/scenarios_tif_equal_area_proj_per_km2/hi_res_gall_peter_%s", rast_name), overwrite=TRUE)

 gp_raster <- raster(sprintf("/home/shares/food-systems/Food_footprint/all_food_systems/scenarios/scenarios_analysis/scenarios_tif_equal_area_proj_per_km2/hi_res_gall_peter_%s", rast_name))
#plot(gp_raster)
 
 aggregate(gp_raster, fact=2, fun=mean, filename=sprintf("/home/shares/food-systems/Food_footprint/all_food_systems/scenarios/scenarios_analysis/scenarios_tif_equal_area_proj_per_km2/gall_peter_%s", rast_name), overwrite=TRUE)
}
    
```


Delete the hi_res version which is just a temp file.
```{r}
remove <- list.files(file.path("/home/shares/food-systems/Food_footprint/all_food_systems/scenarios/scenarios_analysis/scenarios_tif_equal_area_proj_per_km2"), full=TRUE, pattern="hi_res")
file.remove(remove)
```


## convert to total per cell
```{r}
per_km_rasts <- list.files("/home/shares/food-systems/Food_footprint/all_food_systems/scenarios/scenarios_analysis/scenarios_tif_equal_area_proj_per_km2", full=TRUE)

for(rast in per_km_rasts){ # rast = per_km_rasts[1]
 save_name <- basename(rast)
 save_name <- gsub("_per_area", "_per_cell", save_name)
    new_raster <- raster(rast)
  per_cell_rast <- new_raster*6000*6000/1000000
writeRaster(per_cell_rast, sprintf("/home/shares/food-systems/Food_footprint/all_food_systems/scenarios/scenarios_analysis/scenarios_tif_equal_area_proj_per_cell/%s", save_name), overwrite=TRUE)
#check <- raster(sprintf("/home/shares/food-systems/Food_footprint/final_data/_tif_equal_area_proj_per_cell/%s", save_name))
#cellStats(check, "sum", na.rm=TRUE)
}
