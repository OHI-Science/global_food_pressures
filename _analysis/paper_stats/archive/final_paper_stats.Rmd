---
title: "Overall paper stats"
output: html_document
---

This script contains code and data to fill out the various statistics requested for the final paper. Above each chunk is either an excerpt from the paper, or a specific request for a statistic.

```{r setup, include=FALSE, eval = FALSE, eval = FALSE}
knitr::opts_chunk$set(eval = TRUE)

library(here)
library(tidyverse)

food_raster <- raster::raster(nrows=2160, ncols=4320, xmn=-180, xmx=180, ymn=-90, ymx=90)

library(scales)
library(rnaturalearth)
library(rnaturalearthdata)
library(raster)
library(sf)
library(mapview)

source(here("_workflow/common.R"))
source(here("_workflow/common_spatial.R"))

### save the gall peters projection
gall_peters <- "+proj=cea +lon_0=0 +x_0=0 +y_0=0 +lat_ts=45 +ellps=WGS84 +datum=WGS84 +units=m +no_defs"

### create a water raster
water <- readOGR(dsn = here("_analysis/raw/rgn_all_gcs_med_res.shp"))
water <- water[!water$rgn_nam == "Antarctica",]
proj4string(water) <- CRS("+proj=longlat +datum=WGS84")
water <- spTransform(water, CRS("+proj=cea +lon_0=0 +x_0=0 +y_0=0 +lat_ts=45 +ellps=WGS84 +datum=WGS84 +units=m +no_defs"))
#plot(water)

### create a land raster
land <- ne_countries(scale = "medium", returnclass = "sp") 
land <- land[!land$sov_a3 == "ATA",]
land <- st_as_sf(land)
land <- st_transform(land, crs=gall_peters)
land <- as(land, "Spatial")

rgn_raw <- read_csv(file.path("/home/shares/food-systems/Food_footprint/all_food_systems/analysis/raw_df_summary/rgn_raw_summary.csv"))

```

### What % of the land and the ocean (separately) has a food that dominates (>50%) or really dominates (>80%)? This is derived from Fig. 3.**
      - Rasters are created in food_systems/_analysis/figures/FIGS_dominant_stressor_food.Rmd
      
      
Answer: 


| Type     | Percent |
| ----------- | ----------- |
| Ocean >50% dominated      |    79.24%    |
| Ocean >80% dominated   |   61.14%     |
| Land >50% dominated | 73.18% | 
| Land >80% dominated | 32.9% |


**What percent of ocean has a food that dominates (>50%)?**

```{r, eval = FALSE}
ocean_area <- 361044342.581 ### km2
cell_area <- 36 #km2

### Marine (only use top 4 in plot)
dem_fish_low <- raster("/home/shares/food-systems/Food_footprint/all_food_systems/analysis/figures/animal_product/prop_cpi_threshold/thresh50_prop_cpi_demersal_fisheries.tif")

fofm_fish_low <- raster("/home/shares/food-systems/Food_footprint/all_food_systems/analysis/figures/animal_product/prop_cpi_threshold/thresh50_prop_cpi_fofm_fisheries.tif")

pell_fish_low <- raster("/home/shares/food-systems/Food_footprint/all_food_systems/analysis/figures/animal_product/prop_cpi_threshold/thresh50_prop_cpi_large-pelagic_fisheries.tif")

pelm_fish_low <- raster("/home/shares/food-systems/Food_footprint/all_food_systems/analysis/figures/animal_product/prop_cpi_threshold/thresh50_prop_cpi_medium-pelagic_fisheries.tif")

pels_fish_low <- raster("/home/shares/food-systems/Food_footprint/all_food_systems/analysis/figures/animal_product/prop_cpi_threshold/thresh50_prop_cpi_small-pelagic_fisheries.tif")

ben_fish_low <- raster("/home/shares/food-systems/Food_footprint/all_food_systems/analysis/figures/animal_product/prop_cpi_threshold/thresh50_prop_cpi_benthic_fisheries.tif")

rf_fish_low <- raster("/home/shares/food-systems/Food_footprint/all_food_systems/analysis/figures/animal_product/prop_cpi_threshold/thresh50_prop_cpi_reef_fisheries.tif")

mar_low <- raster("/home/shares/food-systems/Food_footprint/all_food_systems/analysis/figures/animal_product/prop_cpi_threshold/thresh50_prop_cpi_aquaculture_marine.tif")



raster_list_ocean_low <- c(dem_fish_low, fofm_fish_low, pell_fish_low, pelm_fish_low, pels_fish_low, ben_fish_low, rf_fish_low, mar_low)

raster_stack_ocean_low <- stack(raster_list_ocean_low)

### calculate the proportions of land dominated per each food group
props_ocean_low <- (cellStats(raster_stack_ocean_low, stat = "sum", na.rm = TRUE)*cell_area)/ocean_area

ocean_props_df <- data.frame(props = props_ocean_low)

sum(ocean_props_df$props) # 0.7923691 = 79% of the ocean has a food that dominates (>50%). 
round(sum(ocean_props_df$props)*100,2) # 79.24%
```

**What percent of land has a food that dominates (>50%)?**

```{r, eval = FALSE}
cell_area <- 36 #km2
land_area <- 148940000 # 148.94 million sq km

### Land (only plot top 4)
cows_meat_milk_low <- raster("/home/shares/food-systems/Food_footprint/all_food_systems/analysis/figures/animal_product/prop_cpi_threshold/thresh50_prop_cpi_cows_meat&milk.tif")

crops_low <- raster("/home/shares/food-systems/Food_footprint/all_food_systems/analysis/figures/animal_product/prop_cpi_threshold/thresh50_prop_cpi_farm_crop.tif")

shoats_low <- raster("/home/shares/food-systems/Food_footprint/all_food_systems/analysis/figures/animal_product/prop_cpi_threshold/thresh50_prop_cpi_shoats_meat&milk.tif")

chickens_low <- raster("/home/shares/food-systems/Food_footprint/all_food_systems/analysis/figures/animal_product/prop_cpi_threshold/thresh50_prop_cpi_chickens_eggs&meat.tif")

buffaloes_milk_low <- raster("/home/shares/food-systems/Food_footprint/all_food_systems/analysis/figures/animal_product/prop_cpi_threshold/thresh50_prop_cpi_buffaloes_milk.tif")

pigs_meat_low <- raster("/home/shares/food-systems/Food_footprint/all_food_systems/analysis/figures/animal_product/prop_cpi_threshold/thresh50_prop_cpi_pigs_meat.tif")

fw_low <- raster("/home/shares/food-systems/Food_footprint/all_food_systems/analysis/figures/animal_product/prop_cpi_threshold/thresh50_prop_cpi_wildcaught_freshwater.tif")

raster_list_land_low <- c(cows_meat_milk_low, crops_low, shoats_low, chickens_low, buffaloes_milk_low, pigs_meat_low, fw_low)

raster_stack_land_low <- stack(raster_list_land_low)

### calculate the proportions of land dominated per each food group
props_land_low <- (cellStats(raster_stack_land_low, stat = "sum", na.rm = TRUE)*cell_area)/land_area

land_low_props_df <- data.frame(props = props_land_low) 

sum(land_low_props_df$props) # 0.7318031 = 73% of the land has a food that dominates (>50%).
sum(land_low_props_df$props)*100 # 73.18031%
```


**What percent of ocean has a food that really dominates (>80%)?**

```{r, eval = FALSE}
ocean_area <- 361044342.581 ### km2
cell_area <- 36 #km2

### Marine (only use top 4 in plot)
dem_fish_high <- raster("/home/shares/food-systems/Food_footprint/all_food_systems/analysis/figures/animal_product/prop_cpi_threshold/thresh80_prop_cpi_demersal_fisheries.tif")

fofm_fish_high <- raster("/home/shares/food-systems/Food_footprint/all_food_systems/analysis/figures/animal_product/prop_cpi_threshold/thresh80_prop_cpi_fofm_fisheries.tif")

pell_fish_high <- raster("/home/shares/food-systems/Food_footprint/all_food_systems/analysis/figures/animal_product/prop_cpi_threshold/thresh80_prop_cpi_large-pelagic_fisheries.tif")

pelm_fish_high <- raster("/home/shares/food-systems/Food_footprint/all_food_systems/analysis/figures/animal_product/prop_cpi_threshold/thresh80_prop_cpi_medium-pelagic_fisheries.tif")

pels_fish_high <- raster("/home/shares/food-systems/Food_footprint/all_food_systems/analysis/figures/animal_product/prop_cpi_threshold/thresh80_prop_cpi_small-pelagic_fisheries.tif")

ben_fish_high <- raster("/home/shares/food-systems/Food_footprint/all_food_systems/analysis/figures/animal_product/prop_cpi_threshold/thresh80_prop_cpi_benthic_fisheries.tif")

rf_fish_high <- raster("/home/shares/food-systems/Food_footprint/all_food_systems/analysis/figures/animal_product/prop_cpi_threshold/thresh80_prop_cpi_reef_fisheries.tif")

mar_high <- raster("/home/shares/food-systems/Food_footprint/all_food_systems/analysis/figures/animal_product/prop_cpi_threshold/thresh80_prop_cpi_aquaculture_marine.tif")


raster_list_ocean_high <- c(dem_fish_high, fofm_fish_high, pell_fish_high, pelm_fish_high, pels_fish_high, ben_fish_high, rf_fish_high, mar_high)

raster_stack_ocean_high <- stack(raster_list_ocean_high)

### calculate the proportions of land dominated per each food group
props_ocean_high <- (cellStats(raster_stack_ocean_high, stat = "sum", na.rm = TRUE)*cell_area)/ocean_area

ocean_high_props_df <- data.frame(props = props_ocean_high)

sum(ocean_high_props_df$props_ocean_high) # 0.6114335 = 61.14% of the ocean has a food that dominates (>80%). 
round(sum(ocean_high_props_df$props_ocean_high)*100,2) # 61.14%
```

**What percent of land has a food that really dominates (>80%)?**

```{r, eval = FALSE}
cell_area <- 36 #km2
land_area <- 148940000 # 148.94 million sq km

### Land (only plot top 4)
cows_meat_milk_high <- raster("/home/shares/food-systems/Food_footprint/all_food_systems/analysis/figures/animal_product/prop_cpi_threshold/thresh80_prop_cpi_cows_meat&milk.tif")

crops_high <- raster("/home/shares/food-systems/Food_footprint/all_food_systems/analysis/figures/animal_product/prop_cpi_threshold/thresh80_prop_cpi_farm_crop.tif")

shoats_high <- raster("/home/shares/food-systems/Food_footprint/all_food_systems/analysis/figures/animal_product/prop_cpi_threshold/thresh80_prop_cpi_shoats_meat&milk.tif")

chickens_high <- raster("/home/shares/food-systems/Food_footprint/all_food_systems/analysis/figures/animal_product/prop_cpi_threshold/thresh80_prop_cpi_chickens_eggs&meat.tif")

buffaloes_milk_high <- raster("/home/shares/food-systems/Food_footprint/all_food_systems/analysis/figures/animal_product/prop_cpi_threshold/thresh80_prop_cpi_buffaloes_milk.tif")

pigs_meat_high <- raster("/home/shares/food-systems/Food_footprint/all_food_systems/analysis/figures/animal_product/prop_cpi_threshold/thresh80_prop_cpi_pigs_meat.tif")

fw_high <- raster("/home/shares/food-systems/Food_footprint/all_food_systems/analysis/figures/animal_product/prop_cpi_threshold/thresh80_prop_cpi_wildcaught_freshwater.tif")

raster_list_land_high <- c(cows_meat_milk_high, crops_high, shoats_high, chickens_high, buffaloes_milk_high, pigs_meat_high, fw_high)

raster_stack_land_high <- stack(raster_list_land_high)

### calculate the proportions of land dominated per each food group
props_land_high <- (cellStats(raster_stack_land_high, stat = "sum", na.rm = TRUE)*cell_area)/land_area

land_high_props_df <- data.frame(props = props_land_high) 

sum(land_high_props_df$props_land_high) # 0.3290072 = 32.9% of the land has a food that dominates (>80%).
round(sum(land_high_props_df$props_land_high)*100,2) # 32.9%
```

```{r, eval = FALSE}
all_domination_props <- data.frame(rbind(land_high_props_df, ocean_high_props_df, land_low_props_df, ocean_props_df))

write.csv(all_domination_props, "output/land_ocean_domination_props.csv") ### I formatted this a bit in excel and reuploaded to supp_tables folder
```


### Proportion dominated global numbers for each of the 4 pressures
    
Can rerun this: 
**Through the lens of individual pressures (combined across all foods), each pressure plays a majority (>50%) role in overall cumulative footprint over substantial areas of land, with disturbance dominant primarily in nearshore marine areas, nutrient emissions in XX% of the land, water use in XX%, and GHG in XX% (Fig. 3c). In the ocean, the dominant pressure across XX% of cells is area disturbance (Fig. SX); water use and nutrient emissions have extremely limited input and the proportional contribution of GHG from aquatic foods is tiny compared to land-based production.**

NOTE: This takes a little while to run..

Answer:

**OLD**:
| Stressor     |>50% dominated | >80% dominated | 
| ----------- | ----------- | ----------- |
| disturbance | 62.21% | 55.22% | 
| ghg | 3.10% | 0.63% | 
| nutrient | 10.32% | 0.2% | 
| water | 1.69% | 0.02% | 

**NEW**:
| Stressor     |>50% dominated | >80% dominated | 
| ----------- | ----------- | ----------- |
| disturbance | 62.55% | 46.91% | 
| ghg | 6.01% | 0.14% | 
| nutrient | 7.96% | 0.50% | 
| water | 1.77% | 0.07% | 


**OLD**:
| Stressor     |Land >50% dominated | Land >80% dominated | Ocean >50% dominated | Ocean >80% dominated |
| ----------- | ----------- | ----------- | ------------ | ------------ | 
| disturbance | 2.77% | 0.36% | 86.62% | 77.78%  | 
| ghg | 8.94% | 0.76% | 0.47% | 0.37% |
| nutrient | 35.22% | 0.67% | 0.05% | 0.01%  | 
| water | 5.41% | 0.02 | 0.14% | 0.00% | 

**NEW**:
| Stressor     |Land >50% dominated | Land >80% dominated | Ocean >50% dominated | Ocean >80% dominated |
| ----------- | ----------- | ----------- | ------------ | ------------ | 
| disturbance | 3.59% | 0.89% | 86.59% | 65.74%  | 
| ghg | 20.38% | 0.47% | 0.09% | 0.01% |
| nutrient | 27.20% | 1.72% | 0.03% | 0.00%  | 
| water | 5.68% | 0.23 | 0.14% | 0.00% | 

```{r, eval = FALSE}
stressor_stack <- stack(list.files("/home/shares/food-systems/Food_footprint/all_food_systems/analysis/stressor_summary/equal_area/rescaled/stressors", full=TRUE))

### find the domination combining both land and ocean
stressor_df <- as.data.frame(stressor_stack, xy=TRUE)

stressor_df_prop <- stressor_df %>%
  rowwise() %>%
  mutate(total = sum(c(disturbance, ghg, nutrient, water), na.rm=TRUE))

stressor_df_prop2 <- stressor_df_prop %>%
  rowwise() %>%
  mutate(disturbance_prop = disturbance/total,
         ghg_prop = ghg/total,
         nutrient_prop = nutrient/total,
         water_prop = water/total)

stressor_df_prop3 <- stressor_df_prop2 %>%
  rowwise() %>%
  mutate(dominant_stressor = ifelse(disturbance_prop >= 0.5, 1, NA),
         dominant_stressor = ifelse(ghg_prop >= 0.5, 2, dominant_stressor),
         dominant_stressor = ifelse(nutrient_prop >= 0.5, 3, dominant_stressor),
         dominant_stressor = ifelse(water_prop >= 0.5, 4, dominant_stressor))

stressor_df_prop80 <- stressor_df_prop2 %>% 
  rowwise() %>%
  mutate(dominant_stressor80 = ifelse(disturbance_prop >= 0.8, 1, NA),
         dominant_stressor80 = ifelse(ghg_prop >= 0.8, 2, dominant_stressor80),
         dominant_stressor80 = ifelse(nutrient_prop >= 0.8, 3, dominant_stressor80),
         dominant_stressor80 = ifelse(water_prop >= 0.8, 4, dominant_stressor80))

counts <- table(stressor_df_prop3$dominant_stressor)
counts*36/1000000/510.1
round((counts*36/510100000)*100,2)

counts80 <- table(stressor_df_prop80$dominant_stressor80)
round((counts80*36/510100000)*100,2)


### now lets find the domination of only land per each pressure
land_rgns_1 <- raster(file.path("/home/shares/food-systems/Food_footprint/all_food_systems/dataprep/spatial/gall_peters/food_rgns_gall_peters.tif")) 

### set all land to be 1 and everything else 0 
land_rgns_1[land_rgns_1 > 0 ] <- 1 
plot(land_rgns_1)

### now multiply our stressor stack by this, to get only stressors on land
stressor_stack_land <- stressor_stack*land_rgns_1

stressor_df_land <- as.data.frame(stressor_stack_land, xy=TRUE) %>%
  rename("disturbance" = "layer.1", "ghg" = "layer.2", "nutrient" = "layer.3", "water" = "layer.4")

sum(stressor_df$disturbance) # 997071.9
sum(stressor_df_land$disturbance, na.rm = TRUE) # 755020
755020/997071.9 ### i think this makes sense. There will be a lot more disturbance on land than there is in the ocean. 

## old was 79%
## new is 75.7%


stressor_df_prop_land <- stressor_df_land %>%
  rowwise() %>%
  mutate(total = sum(c(disturbance, ghg, nutrient, water), na.rm=TRUE))

stressor_df_prop2_land <- stressor_df_prop_land %>%
  rowwise() %>%
  mutate(disturbance_prop = disturbance/total,
         ghg_prop = ghg/total,
         nutrient_prop = nutrient/total,
         water_prop = water/total)

stressor_df_prop3_land <- stressor_df_prop2_land %>%
  rowwise() %>%
  mutate(dominant_stressor = ifelse(disturbance_prop >= 0.5, 1, NA),
         dominant_stressor = ifelse(ghg_prop >= 0.5, 2, dominant_stressor),
         dominant_stressor = ifelse(nutrient_prop >= 0.5, 3, dominant_stressor),
         dominant_stressor = ifelse(water_prop >= 0.5, 4, dominant_stressor))

stressor_df_prop80_land <- stressor_df_prop2_land %>% 
  rowwise() %>%
  mutate(dominant_stressor80 = ifelse(disturbance_prop >= 0.8, 1, NA),
         dominant_stressor80 = ifelse(ghg_prop >= 0.8, 2, dominant_stressor80),
         dominant_stressor80 = ifelse(nutrient_prop >= 0.8, 3, dominant_stressor80),
         dominant_stressor80 = ifelse(water_prop >= 0.8, 4, dominant_stressor80))

counts <- table(stressor_df_prop3_land$dominant_stressor)
land_area <- 148940000 # 148.94 million sq km

round((counts*36/land_area)*100,2)

counts_df <- data.frame(counts)

write.csv(counts_df, "int/land_50_dom.csv")

prop_land_pressure_50 <- read_csv("int/land_50_dom.csv") %>%
  dplyr::select(-X1) %>%
  rename("pressure" = "Var1") %>%
  mutate(pressure = case_when(pressure == 1 ~ "disturbance", 
                              pressure == 2 ~ "ghg", 
                              pressure == 3 ~ "nutrient", 
                              pressure == 4 ~ "water")) %>%
  mutate(area = "land") %>%
  mutate(domination_threshold = "50%") %>%
  mutate(proportion_dominated = (Freq*36)/land_area)

 #    1     2     3     4 
 # 2.77  8.94 35.22  5.41 
 
counts80 <- table(stressor_df_prop80_land$dominant_stressor80)
round((counts80*36/land_area)*100,2)
#    1    2    3    4 
# 0.36 0.76 0.67 0.07 

counts80_df <- data.frame(counts80)
write.csv(counts80_df, "int/land_80_dom.csv")


prop_land_pressure_80 <- read_csv("int/land_80_dom.csv") %>%
  dplyr::select(-X1) %>%
  rename("pressure" = "Var1") %>%
  mutate(pressure = case_when(pressure == 1 ~ "disturbance", 
                              pressure == 2 ~ "ghg", 
                              pressure == 3 ~ "nutrient", 
                              pressure == 4 ~ "water")) %>%
  mutate(area = "land") %>%
  mutate(domination_threshold = "80%") %>%
  mutate(proportion_dominated = (Freq*36)/land_area)


### now lets find the domination of only ocean per each pressure
eez_rgns_1 <- raster(file.path("/home/shares/food-systems/Food_footprint/all_food_systems/dataprep/spatial/gall_peters/eez_rgns_gall_peters.tif"))

eez_rgns_1[eez_rgns_1 > 0] <- 1
plot(eez_rgns_1)

### now multiply our stressor stack by this, to get only stressors on land
stressor_stack_ocean <- stressor_stack*eez_rgns_1

stressor_df_ocean <- as.data.frame(stressor_stack_ocean, xy=TRUE) %>%
  rename("disturbance" = "layer.1", "ghg" = "layer.2", "nutrient" = "layer.3", "water" = "layer.4")

sum(stressor_df$disturbance) # 997071.9
sum(stressor_df_ocean$disturbance, na.rm = TRUE) # 242519
242519/997071.9 ### 0.2432312 - i think this makes sense. There will be a lot more disturbance on land than there is in the ocean.


stressor_df_prop_ocean <- stressor_df_ocean %>%
  rowwise() %>%
  mutate(total = sum(c(disturbance, ghg, nutrient, water), na.rm=TRUE))

stressor_df_prop2_ocean <- stressor_df_prop_ocean %>%
  rowwise() %>%
  mutate(disturbance_prop = disturbance/total,
         ghg_prop = ghg/total,
         nutrient_prop = nutrient/total,
         water_prop = water/total)

stressor_df_prop3_ocean <- stressor_df_prop2_ocean %>%
  rowwise() %>%
  mutate(dominant_stressor = ifelse(disturbance_prop >= 0.5, 1, NA),
         dominant_stressor = ifelse(ghg_prop >= 0.5, 2, dominant_stressor),
         dominant_stressor = ifelse(nutrient_prop >= 0.5, 3, dominant_stressor),
         dominant_stressor = ifelse(water_prop >= 0.5, 4, dominant_stressor))

stressor_df_prop80_ocean <- stressor_df_prop2_ocean %>% 
  rowwise() %>%
  mutate(dominant_stressor80 = ifelse(disturbance_prop >= 0.8, 1, NA),
         dominant_stressor80 = ifelse(ghg_prop >= 0.8, 2, dominant_stressor80),
         dominant_stressor80 = ifelse(nutrient_prop >= 0.8, 3, dominant_stressor80),
         dominant_stressor80 = ifelse(water_prop >= 0.8, 4, dominant_stressor80))

counts <- table(stressor_df_prop3_ocean$dominant_stressor)

ocean_area <- 361044342.581 ### km2
round((counts*36/ocean_area)*100,2)

counts_df <- data.frame(counts)

write.csv(counts_df, "int/ocean_50_dom.csv")

prop_ocean_pressure_50 <- read_csv("int/ocean_50_dom.csv") %>%
  dplyr::select(-X1) %>%
  rename("pressure" = "Var1") %>%
  mutate(pressure = case_when(pressure == 1 ~ "disturbance", 
                              pressure == 2 ~ "ghg", 
                              pressure == 3 ~ "nutrient", 
                              pressure == 4 ~ "water")) %>%
  mutate(area = "ocean") %>%
  mutate(domination_threshold = "50%") %>%
  mutate(proportion_dominated = (Freq*36)/ocean_area)

counts80 <- table(stressor_df_prop80_ocean$dominant_stressor80)
round((counts80*36/ocean_area)*100,2)

counts80_df <- data.frame(counts80)

write.csv(counts80_df, "int/ocean_80_dom.csv")

prop_ocean_pressure_80 <- read_csv("int/ocean_80_dom.csv") %>%
  dplyr::select(-X1) %>%
  rename("pressure" = "Var1") %>%
  mutate(pressure = case_when(pressure == 1 ~ "disturbance", 
                              pressure == 2 ~ "ghg", 
                              pressure == 3 ~ "nutrient", 
                              pressure == 4 ~ "water")) %>%
  mutate(area = "ocean") %>%
  mutate(domination_threshold = "80%") %>%
  mutate(proportion_dominated = (Freq*36)/ocean_area)

```

```{r, eval = FALSE}
all_pressure_domination_props <- rbind(prop_ocean_pressure_50, prop_ocean_pressure_80, prop_land_pressure_50, prop_land_pressure_80)

write.csv(all_pressure_domination_props, "supp_tables/land_ocean_pressure_dominations_props.csv", row.names = FALSE)
write.csv(all_pressure_domination_props, "output/land_ocean_pressure_dominations_props.csv", row.names = FALSE)

test <- all_pressure_domination_props %>%
  mutate(perc = round(proportion_dominated*100,2))
```


 
### Related, these numbers per dominant food group per country, i.e. How much of each of the four foods identified dominates in each country

```{r, eval = FALSE}
raster_stack_ocean_low
### Read in region raster:
land_eez_rgns_gp <- raster(file.path("/home/shares/food-systems/Food_footprint/all_food_systems/dataprep/spatial/gall_peters/land_eez_rgns_gall_peters.tif"))
plot(land_eez_rgns_gp)

land_extended_rgns <- raster(file.path("/home/shares/food-systems/Food_footprint/all_food_systems/dataprep/spatial/gall_peters/food_rgns_extended_gall_peters.tif"))

### fix food_rgns to include high seas
food_rgns <- rbind(food_rgns, data.frame(iso3c = "high_seas", ID_0 = 500, Country = "High Seas"))


############ Do ocean 50% domination per country and food group ############
### test to see if it will work... it does, it matches what was done above
# test <- as.data.frame((zonal(dem_fish_low, land_eez_rgns_gp, fun="sum", na.rm = TRUE))) %>%
#   mutate(prop = sum*cell_area/ocean_area) %>%
#   mutate(percent = round(prop*100,2))
# 
# 
# test2 <- as.data.frame((zonal(pell_fish_low, land_eez_rgns_gp, fun="sum", na.rm = TRUE))) %>%
#   mutate(prop = sum*cell_area/ocean_area) 

ocean_50_final_df <- as.data.frame(zonal(raster_stack_ocean_low, land_eez_rgns_gp, fun = "sum", na.rm = TRUE)) %>%
  pivot_longer(cols = starts_with("thresh50"),
               names_to = "food_group",
               values_to = "n_cells_dom_50%") %>%
  mutate(food_group = gsub(".*cpi_", "", food_group),
         proportion_dominated = (`n_cells_dom_50%`*cell_area)/ocean_area) %>%
  left_join(food_rgns, by = c("zone" = "ID_0"))

write.csv(ocean_50_final_df, "output/ocean_country_food_domination_50.csv", row.names = FALSE) 

ocean_50_final_df <- read_csv("output/ocean_country_food_domination_50.csv") %>%
  rename("rgn_id" = "zone") %>%
  mutate(area = "ocean") %>%
  mutate(domination_threshold = "50%") %>%
  rename("n_cells_dom" = "n_cells_dom_50%") %>%
  rename("proportion_area_dominated" = "proportion_dominated")


############ Do land 50% domination per country and food group ############
land_50_final_df <- as.data.frame(zonal(raster_stack_land_low, land_extended_rgns, fun = "sum", na.rm = TRUE)) %>%
  pivot_longer(cols = starts_with("thresh50"),
               names_to = "food_group",
               values_to = "n_cells_dom_50%") %>%
  mutate(food_group = gsub(".*cpi_", "", food_group),
         proportion_dominated = (`n_cells_dom_50%`*cell_area)/land_area) %>%
  left_join(food_rgns, by = c("zone" = "ID_0"))

sum(land_50_final_df$`n_cells_dom_50%`) # 3026233

test <- land_50_final_df %>%
  filter(food_group == "cows_meat.milk")
sum(test$`n_cells_dom_50%`) # 1652060

write.csv(land_50_final_df, "output/land_country_food_domination_50.csv", row.names = FALSE) 

land_50_final_df <- read_csv("output/land_country_food_domination_50.csv") %>%
  rename("rgn_id" = "zone") %>%
  mutate(area = "land") %>%
  mutate(domination_threshold = "50%") %>%
  rename("n_cells_dom" = "n_cells_dom_50%") %>%
  rename("proportion_area_dominated" = "proportion_dominated")


############ Do ocean 80% domination per country and food group ############

ocean_80_final_df <- as.data.frame(zonal(raster_stack_ocean_high, land_eez_rgns_gp, fun = "sum", na.rm = TRUE)) %>%
  pivot_longer(cols = starts_with("thresh80"),
               names_to = "food_group",
               values_to = "n_cells_dom_80%") %>%
  mutate(food_group = gsub(".*cpi_", "", food_group),
         proportion_dominated = (`n_cells_dom_80%`*cell_area)/ocean_area) %>%
  left_join(food_rgns, by = c("zone" = "ID_0"))

sum(ocean_80_final_df$proportion_dominated) # 0.610867 - close enough

write.csv(ocean_80_final_df, "output/ocean_country_food_domination_80.csv", row.names = FALSE) 


ocean_80_final_df <- read_csv("output/ocean_country_food_domination_80.csv") %>%
  rename("rgn_id" = "zone") %>%
  mutate(area = "ocean") %>%
  mutate(domination_threshold = "80%") %>%
  rename("n_cells_dom" = "n_cells_dom_80%") %>%
  rename("proportion_area_dominated" = "proportion_dominated")


############ Do land 80% domination per country and food group ############
land_80_final_df <- as.data.frame(zonal(raster_stack_land_high, land_extended_rgns, fun = "sum", na.rm = TRUE)) %>%
  pivot_longer(cols = starts_with("thresh80"),
               names_to = "food_group",
               values_to = "n_cells_dom_80%") %>%
  mutate(food_group = gsub(".*cpi_", "", food_group),
         proportion_dominated = (`n_cells_dom_80%`*cell_area)/land_area) %>%
  left_join(food_rgns, by = c("zone" = "ID_0"))

sum(land_80_final_df$proportion_dominated) # 0.3289758 - perfect

write.csv(land_80_final_df, "output/land_country_food_domination_80.csv", row.names = FALSE)


land_80_final_df <- read_csv("output/land_country_food_domination_80.csv") %>%
  rename("rgn_id" = "zone") %>%
  mutate(area = "land") %>%
  mutate(domination_threshold = "80%") %>%
  rename("n_cells_dom" = "n_cells_dom_80%") %>%
  rename("proportion_area_dominated" = "proportion_dominated")



```
Save a table with all of the per country food group domination stats
```{r, eval = FALSE}
all_countries_ocean_land_dominations <- rbind(ocean_50_final_df, ocean_80_final_df, land_50_final_df, land_80_final_df)

write.csv(all_countries_ocean_land_dominations, "supp_tables/country_land_ocean_food_dominations.csv", row.names = FALSE)

all_dom <- read_csv("supp_tables/country_land_ocean_food_dominations.csv") %>%
  group_by(area, food_group, domination_threshold) %>%
  summarise(prop_dom = sum(proportion_area_dominated))

write.csv(all_dom, "supp_tables/land_ocean_food_dominations_props.csv", row.names = FALSE)

test <- read_csv("supp_tables/land_ocean_food_dominations_props.csv") %>%
  filter(area == "ocean") %>%
  filter(domination_threshold == "50%") # %>%
  # filter(food_group != "aquaculture_marine")

# 0.7852539 from wild caught fisheries 
```



### What % of total reported global food production is included in our assessment.
 - 85.7%
  
```{r, eval = FALSE}

###### Mariculture production included: 
mar_prep <- "/home/shares/food-systems/Food_footprint/all_food_systems/dataprep/aquaculture/marine"

marine_fish <- read_csv(file.path(mar_prep, "marine_fish_general/marine_fish_general_farm.csv")) %>%
  mutate(type = "marine_fish_general")

bivalve <- read_csv(file.path(mar_prep, "bivalve/bivalve_farm.csv")) %>%
  mutate(type = "bivalve")

crustaceans <- read_csv(file.path(mar_prep, "crustaceans/crustaceans_farm.csv")) %>%
  mutate(type = "crustaceans")

salmon <- read_csv(file.path(mar_prep, "salmon/salmon_farm.csv")) %>%
  mutate(type = "salmon")

tuna <- read_csv(file.path(mar_prep, "tuna/tuna_farm.csv")) %>%
  mutate(type = "tuna")

shrimp <- read_csv(file.path(mar_prep, "shrimp/shrimp_farm.csv")) %>%
  mutate(type = "shrimp")


all_mar <- rbind(marine_fish, bivalve, crustaceans, salmon, tuna, shrimp) %>%
  group_by(type) %>%
  summarise(production = sum(tonnes_production))

data.table(all_mar)

sum(all_mar$production) # 29615848/30991774 animal mariculture production included
# 0/32560138 seaweed mariculture included

###### Marine fisheries production included (Reported + IUU, since discards are unlikely to be consumed by humans): 
# We include all from Watson
# 72172118/72172118 million tonnes of non-FOFM
# 39054068/39054068 million tonnes of FOFM

###### Freshwater aquaculture: 
# 0/48671218 freshwater aquaculture included

###### Freshwater wild-caught fish:
# 7134914/12700000 freshwater wildcaught fisheries included


fis_aq_categories <- data.frame(tonnes_included = c(29615848, 0, 72172118, 39054068, 0, 7134914),
                             tonnes_total = c(30991774, 32560138, 72172118, 39054068, 48671218, 12700000),
                             type = c("animal_mariculture", "seaweed_mariculture", "non-fofm_fis", "fofm-fis", "freshwater_aquaculture", "freshwater_fis")) %>%
  mutate(percent = tonnes_included/tonnes_total)

############# Crops
crop_translate<- read_csv(here("feed/data/MapSPAM_to_FAO.csv")) %>%
  select(SPAM_short_name, SPAM_super, FAO_item_code) %>%
  unique()

crop_super_cats <- read_csv(here("feed/data/MapSPAM_crop_info.csv"))
Mapspam_prod <- read_csv(here("feed/data/MAPSPAMcrop_production.csv"))
fao_crop_prod <- read_csv(here("_analysis/checking_data/data/FAOSTAT_data_12-21-2020_crops.csv")) %>%
  select(Area, FAO_item_code=`Item Code`, Item, Unit, Value)

### ID crop categories not counted in Mapspam but in FAO:
fao_extra <- left_join(fao_crop_prod, crop_translate, by="FAO_item_code")
filter(fao_extra, is.na(SPAM_super))
fao_tonnes <- left_join(fao_extra, crop_super_cats, by="SPAM_super") %>%
  dplyr::filter(!(is.na(food_group))) %>%
  dplyr::filter(food_group != "exclude") %>%
  group_by(food_group) %>%
  summarize(tonnes_fao = sum(Value, na.rm=TRUE))

spam_tonnes <- left_join(Mapspam_prod, crop_super_cats, by="SPAM_super") %>%
  group_by(food_group) %>%
  summarize(tonnes_mapspam = sum(tonnes_producing_crop, na.rm=TRUE))

compare <- left_join(spam_tonnes, fao_tonnes) %>%
  mutate(spam_percent = tonnes_mapspam/tonnes_fao)
plot(compare$tonnes_mapspam, compare$tonnes_fao)
abline(0,1, col="red")


compare_crops <- compare %>%
  rename("type" = "food_group", "tonnes_included" = "tonnes_mapspam", "tonnes_total" = "tonnes_fao", "percent" = "spam_percent") %>%
  dplyr::filter(!is.na(tonnes_total))


###### Livestock animals: 
livestock_cats <- read_csv(here("_analysis/paper_stats/data/FAO_livestock_categories.csv")) %>%
  filter(is.na(non_food_exclude))

livestock <- read_csv(here("_analysis/paper_stats/data/FAOSTAT_data_12-18-2020_livestock_primary.csv")) %>%
  filter(Area != "China") %>%
  filter(!(is.na(Value))) %>%
  filter(Item %in% livestock_cats$Item) %>%
  left_join(livestock_cats, by="Item") %>%
  group_by(included_for_us, category) %>%
  summarize(tonnes = sum(Value)) 

livestock_compare <- livestock %>%
  spread(included_for_us, tonnes) %>%
  mutate(yes = ifelse(is.na(yes), 0, yes)) %>%
  rowwise() %>%
  mutate(total = no+yes) %>%
  mutate(percent_counted = yes/(yes + no)) %>%
  dplyr::select("type" = "category", "tonnes_included" = "yes", "tonnes_total" = "total") %>%
  dplyr::mutate(percent = tonnes_included/tonnes_total)


###### Combine together 
all_food_groups <- rbind(livestock_compare, compare_crops, fis_aq_categories)

sum(all_food_groups$tonnes_included)/sum(all_food_groups$tonnes_total) # 0.8569468

```
  

### Related, what % of global production comes from the ocean (fisheries, aquaculture, FOFM)?

```{r, eval = FALSE}
### Crops and meat comparisons
### What we include 

included <- as.data.frame(all_food_groups) %>%
  dplyr::filter(type %in% c("animal_mariculture", "seaweed_mariculture", "non-fofm_fis", "fofm-fis")) %>%
  dplyr::select(type, tonnes_included)

sum(included$tonnes_included)
sum(all_food_groups$tonnes_included)
### 140842034/13318958545 = 0.01057455


### Overall
overall <- included <- as.data.frame(all_food_groups) %>%
  dplyr::filter(type %in% c("animal_mariculture", "seaweed_mariculture", "non-fofm_fis", "fofm-fis")) %>%
  dplyr::select(type, tonnes_total)

sum(overall$tonnes_total)
sum(all_food_groups$tonnes_total)

### 174778098/15542340143 = 0.01124529


### Marine fish to meat (no eggs or milk) comparison
fish_meat <- as.data.frame(all_food_groups) %>%
  dplyr::filter(type %in% c("animal_mariculture", "non-fofm_fis", "fofm-fis", "meat"))

sum(fish_meat$tonnes_total) # 512155040

fish <- as.data.frame(all_food_groups) %>%
  dplyr::filter(type %in% c("animal_mariculture", "non-fofm_fis", "fofm-fis"))

sum(fish$tonnes_total) # 142217960

# 142217960/512155040 = 0.2776854

```



### How much of the land and the sea (separately) is affected by the disturbance pressure layer? 
 - Not using this in the paper...
 
```{r, eval = FALSE}
### use rgn raw data set for km2
# sum freshwater and land together
# sum marine 

### calculate km2 for each (percentages?)

disturbance_ocean_fw_land <- rgn_raw %>%
  dplyr::filter(pressure == "disturbance") %>%
  group_by(origin) %>%
  summarise(disturbance_km2 = sum(sum)) %>%
  ungroup()
  
data.table(disturbance_ocean_fw_land)
fw_and_land <- 13424651.5+111231.3

fw_land <- data.frame(origin = "land", disturbance_km2 = fw_and_land)

### combine land and sea 
disturbance_ocean_land <- disturbance_ocean_fw_land %>%
  filter(origin == "marine") %>%
  rbind(fw_land)

disturbance_ocean_land
# marine	5395563			
# land	13535883	
   
### check
5395563/ocean_area # 0.01494432 = 1.5% of the ocean is affected by disturbance?? I feel like this doesn't make sense given the new majority pressure map.......
13535883/land_area # 0.09088145 = 9% of the land is affected by disturbance



### Check this, the land seems low: 
# Will you do a quick analysis and see what the original data has for area for crops?
# The rasters are here:
# / home/shares/food-systems/Food_footprint/_raw_data/map_spam_crop_data/mapspam_2010v2.0/spam2010v2r0_global_phys_area.geotiffit

# check only the ones with “_A”
# (which stands for all crop production)

# So: this should be the amount of area for each crop (excluding ofib, acof, rcof, teas from the total).  I think you will need to sum the area for each crop and then add it up.. .we should see if this basically matches our stuff.

# hopefully this will be similar to our crop disturbance.  This one is easy because the disruption is 100% so the area should be equal to disturbance

files <- list.files("/home/shares/food-systems/Food_footprint/_raw_data/map_spam_crop_data/mapspam_2010v2.0/spam2010v2r0_global_phys_area.geotiff", full = TRUE, pattern = "\\_A.tif")
  
stack_files <- stack(files)


for(i in 1:42){
# print(stack_files[[i]])
print(cellStats(stack_files[[i]], "sum", na.rm = TRUE))
  
}


 # 5917830 - ACOF
 5162791  + # - bana
 49238339 + # - barl
 27350593 + # - bean
 19027202 + # - cass
 11515253 + # - chic
 11605313 + # cnut
 9767624 +  # coco
 31047736 + # cott 
 8885459 +  # cowp
 24373558 + # grou
 3945968 +  # lent
 151344327 + # maiz
 26332153 +  # ocer
 # 3107640  - OFIB
 15594313 + # oilp
 17109946 + # ooil
 14617363 + # opul
 2331949 +  # orts 
 4864260 +  # pige
 4007944 +  # plnt
 26318403 + # pmil
 18608068 + # pota
 33133524 + # rape
 # 4267727  - RCOF
 26332617 +  # rest
 113831515 + # rice
 8005424 +   # sesa
 4147470+    # smil
 39260951 +  # sorg
 97906831 +  # soyb
 4682821 +  # sugb
 24219661 + # sugc
 24195081  + # sunf
 7765573 +  # swpo
 # 3197546 - TEAS
 24192611 + # temf
 4028251 +  # toba
 25771176 + # trof
48550597 +  # vege
199497739 + # whea
 5020052  # yams
  
# sum = [1] 1173590456
 1173590456*0.01 # 11735905
 
 crops <- rgn_raw %>%
   filter(system == "crop"|category == "feedcrop",
          pressure == "disturbance") %>%
   group_by(organism) %>%
   summarise(area = sum(sum))
 
 sum(crops$area) # 12274469

 ### 11.7 vs 12.2 (12.2 is a little more due to gapfilling... makes sense!!) 

 
```


### % of each country’s total cumulative pressure that is in the ocean


New text: 
**Country-level cumulative pressure derives almost entirely from land-based food production, with the exception of island nations and some countries with extensive marine coasts, such as Norway (87% ocean), Chile (40%), Japan (36%), the U.K. (29%), Vietnam (31%), and Indonesia (27%) (Fig. 4; Supplemental Figure XX).**
  
```{r, eval = FALSE}
unique(rgn_raw$origin)
# [1] "land"       "marine"     "freshwater"

test <- rgn_raw %>%
  filter(organism == "fofm")

rescale <- read_csv("../rescale_values.csv")


percent_pressure_ocean <- rgn_raw %>%
  left_join(rescale, by = "pressure") %>%
  mutate(global_pressure_prop = sum/global_total) %>%
  group_by(iso3c, country, origin) %>%
  summarise(cum_pressure_prop_rescaled = sum(global_pressure_prop),
            cum_pressure = sum(sum)) %>%
  ungroup()

### sum freshwater and land 

fw_land <- percent_pressure_ocean %>%
  dplyr::filter(origin %in% c("freshwater", "land")) %>%
  group_by(iso3c, country) %>%
  summarise(cum_pressure_prop_rescaled = sum(cum_pressure_prop_rescaled)) %>%
  ungroup() %>%
  mutate(origin = "land")

percent_pressure_origin_countries <- percent_pressure_ocean %>%
  dplyr::filter(origin == "marine") %>%
  select(-cum_pressure) %>%
  rbind(fw_land) %>%
  group_by(iso3c, country) %>%
  mutate(total_cum_prop = sum(cum_pressure_prop_rescaled)) %>%
  ungroup() %>%
  mutate(cum_pressure_prop_final = cum_pressure_prop_rescaled/total_cum_prop) %>%
  mutate(cum_pressure_percent_final = round(cum_pressure_prop_final*100,2)) %>%
  arrange(iso3c) %>%
  dplyr::select(iso3c, country, origin, cum_pressure_prop_final, cum_pressure_percent_final)

sum(percent_pressure_ocean$cum_pressure_prop_rescaled) # 4 - perfect 
sum(percent_pressure_origin_countries$cum_pressure_prop_final) # 245 - perfect

write.csv(percent_pressure_origin_countries, "output/percent_cum_pressure_country_origin.csv", row.names = FALSE)

write.csv(percent_pressure_origin_countries, "supp_tables/percent_cum_pressure_country_origin.csv", row.names = FALSE)


### now save one that also splits it by fw
percent_pressure_origin_countries <- percent_pressure_ocean %>%
  select(-cum_pressure) %>%
  group_by(iso3c, country) %>%
  mutate(total_cum_prop = sum(cum_pressure_prop_rescaled)) %>%
  ungroup() %>%
  mutate(cum_pressure_prop_final = cum_pressure_prop_rescaled/total_cum_prop) %>%
  mutate(cum_pressure_percent_final = round(cum_pressure_prop_final*100,2)) %>%
  arrange(iso3c) %>%
  dplyr::select(iso3c, country, origin, cum_pressure_prop_final, cum_pressure_percent_final)


write.csv(percent_pressure_origin_countries, "output/percent_cum_pressure_country_origin_fw.csv", row.names = FALSE)

write.csv(percent_pressure_origin_countries, "supp_tables/percent_cum_pressure_country_origin_fw.csv", row.names = FALSE)

test <- read_csv("supp_tables/percent_cum_pressure_country_origin_fw.csv")

```


**Beef alone accounted for 25.5% of the total cumulative footprint of all food** 

```{r, eval = FALSE}

land_dom <- read_csv("output/land_country_food_domination_50.csv") 

cows_dom <- land_dom %>%
  dplyr::filter(food_group == "cows_meat.milk")

sum(cows_dom$proportion_dominated) # 0.3993469 ~ cows dominated (>50%) 40% of land 

rescale <- read_csv("../rescale_values.csv")


test <- rgn_raw %>%
  filter(organism == "cows") %>%
  filter(iso3c == "USA")

### rescale pressures 
percent_pressure_rescale <- rgn_raw %>%
  left_join(rescale, by = "pressure") %>%
  mutate(global_pressure_prop = sum/global_total) %>%
  group_by(organism) %>%
  summarise(cum_pressure_prop_rescaled = sum(global_pressure_prop),
            cum_pressure = sum(sum)) %>%
  ungroup()

### group by food group
percent_pressure_organsims <- percent_pressure_rescale %>%
  mutate(total_cum_prop = sum(cum_pressure_prop_rescaled)) %>%
  mutate(cum_pressure_prop_final = cum_pressure_prop_rescaled/total_cum_prop) %>%
  group_by(organism) %>%
  summarise(prop_final = sum(cum_pressure_prop_final)) %>%
  ungroup() %>%
  mutate(percent_final = round(prop_final*100,1))

write.csv(percent_pressure_organsims, "output/percent_cum_pressure_organism.csv", row.names = FALSE)
write.csv(percent_pressure_organsims, "supp_tables/percent_cum_pressure_organism.csv", row.names = FALSE)


### how much do cows dominate >80%?

cows_meat_milk_high <- raster("/home/shares/food-systems/Food_footprint/all_food_systems/analysis/figures/animal_product/prop_cpi_threshold/thresh80_prop_cpi_cows_meat&milk.tif")

# raster("/home/shares/food-systems/Food_footprint/all_food_systems/analysis/figures/animal_product/prop_cpi_threshold/thresh80_prop_cpi_cows_milk.tif")

land_rgns <- raster("/home/shares/food-systems/Food_footprint/all_food_systems/dataprep/spatial/gall_peters/food_rgns_gall_peters.tif")

cellStats(cows_meat_milk_high, "sum") # 930838

930838*36 # 17169084 km2
33510168/land_area # 0.2249911 ~ cows dominate (>80%) 22.5% of land

```

**The cumulative footprint of food in terrestrial areas (90.7% of global cumulative pressure) vastly outweighs that on the ocean (9.1%) or freshwater systems (0.15%), largely because relatively little (1.1%, by tonnes) of global food and feed comes from the sea (Froehlich et al. 2018, FAO 2020)**

**Cumulative pressures are far more concentrated than previously believed, with the vast majority (90.7%) on land**

**Although only 1.1% of food comes from aquatic systems, 9.1% of cumulative pressures occur there.**

New text: 
**Contributions from land (90.72% of global cumulative pressure) vastly outweigh those from oceans (9.13%) or freshwater ecosystems (0.15%), yet these ocean pressures are non-trivial given that relatively little (1.1%, by tonnes) food and feed for fed animals comes from the sea.**

```{r, eval = FALSE}
rescale <- read_csv("../rescale_values.csv")


test <- rgn_raw %>%
  filter(category %in% c("wildcaught", "farm"))

test2 <- test %>%
  filter(consumed == "freshwater")

### do overall, including feed and fodder
percent_pressure_rescale <- rgn_raw %>%
  left_join(rescale, by = "pressure") %>%
  mutate(global_pressure_prop = sum/global_total) %>%
  group_by(origin) %>%
  summarise(cum_pressure_prop_rescaled = sum(global_pressure_prop),
            cum_pressure = sum(sum)) %>%
  ungroup()

percent_pressure_origin <- percent_pressure_rescale %>%
  mutate(total_cum_prop = sum(cum_pressure_prop_rescaled)) %>%
  mutate(cum_pressure_prop_final = cum_pressure_prop_rescaled/total_cum_prop) %>%
  group_by(origin) %>%
  summarise(prop_final = sum(cum_pressure_prop_final)) %>%
  ungroup() %>%
  mutate(percent_final = round(prop_final*100,2))


write.csv(percent_pressure_origin, "output/percent_cum_pressure_origin.csv")
write.csv(percent_pressure_origin, "supp_tables/percent_cum_pressure_origin.csv")


```

**Proportion of global GHG from food that comes from oceans versus land?**
```{r, eval = FALSE}
rescale <- read_csv("../rescale_values.csv")


test <- rgn_raw %>%
  filter(category %in% c("wildcaught", "farm"))

test2 <- test %>%
  filter(consumed == "freshwater")

### do overall, including feed and fodder
percent_pressure_ocean <- rgn_raw %>%
  left_join(rescale, by = "pressure") %>%
  mutate(global_pressure_prop = sum/global_total) %>%
  group_by(origin, pressure) %>%
  summarise(cum_pressure_prop_rescaled = sum(global_pressure_prop)) %>%
  ungroup() %>%
  group_by(pressure) %>%
  mutate(total_cum_prop = sum(cum_pressure_prop_rescaled)) %>%
  ungroup()

### filter for ghg
test <- percent_pressure_ocean %>%
  filter(pressure == "ghg") %>%
  mutate(percent = cum_pressure_prop_rescaled*100)

```


New text: 
**For example, the ruminant digestive system of cows makes their GHG emissions noteworthy (X% of their cumulative pressures), along with nutrient emissions from their wastes and feed production (Y%). In contrast, the footprint of chicken and pig meat more strongly reflects water use (A%, B%, of their cumulative pressures) and land area disturbed from the feed (C%, D%) for these animals that is driven in particular by their very large production levels (Fig. 5). **

 - lets take code from fig 4
 
 
**Importantly, food types often rank differently in their global cumulative pressure compared to ratings derived from per-unit assessments of individual classes of pressure. For example, we find that rice engenders higher cumulative pressure than pig meat, and the cumulative footprint of catching demersal fishes is 2x that of raising sheep for meat, both of which are counter to common generalisations.**


 
 
```{r}

library(here)
library(hrbrthemes)
library(RColorBrewer)
library(colorspace)
library(scales)
library(colorspace)
library(patchwork)
source(here("_workflow/common.R"))

'%!in%' <- function(x,y)!('%in%'(x,y))

summary_df_raw <- read_csv(file.path("/home/shares/food-systems/Food_footprint/all_food_systems/analysis/raw_df_summary/rgn_raw_summary.csv")) 

rescaling_values <- read_csv(here("_analysis/rescale_values.csv"))

food_groupings <- read_csv(here("_analysis/figures/paper/data/grouping_naming_structure.csv")) 

mapspam_names <- read_csv(here("crop/farm/data/MapSPAM_names.csv"))%>% 
  select(sub_tier = SPAM_short_name, SPAM_full_name) %>% unique()


summary_df_int <-summary_df_raw %>% 
  mutate(feed_item = case_when(category == "feedcrop"|category =="feedfodd"|category =="feedfofm" ~ "feed",
                               T ~ " ")) %>% 
  unite(product, c("product", "feed_item"), sep = " ") %>% 
  mutate(product = str_trim(product, side = c("right"))) %>% 
  select(organism, product, pressure, sum) %>% 
  ## fresh water fisheries is listed as fish and there is still salmon instead of salmonids so we will change that here 
  mutate(organism = ifelse(organism == "fish", "river fish", 
                           ifelse(organism == "salmon", "salmonids", organism))) %>% 
  group_by(organism, product, pressure) %>% 
  dplyr::summarise(sum = sum(sum)) %>% 
  unite(tier_5, c("organism", "product"), sep = " ") %>% 
  ungroup() 

## need to split the back yard chickens eggs&meat
fix_chickens_1 <- summary_df_int %>% 
  filter(tier_5 == "chickens eggs&meat") 
fix_chickens_1 <- rbind(fix_chickens_1, fix_chickens_1) %>% 
  arrange(pressure) %>% 
  mutate(tier_5 = rep(c("chickens meat", "chickens eggs"), times = 4, each = 1))

fix_chickens_2 <- summary_df_int %>% 
  filter(tier_5 == "chickens eggs&meat feed") 
fix_chickens_2 <- rbind(fix_chickens_2, fix_chickens_2) %>% 
  arrange(pressure) %>% 
  mutate(tier_5 = rep(c("chickens meat", "chickens eggs"), times = 4, each = 1))

## add back
summary_df <- summary_df_int %>% 
  filter(tier_5 != "chickens eggs&meat",
         tier_5 != "chickens eggs&meat feed") %>% 
  rbind(fix_chickens_1, fix_chickens_2) %>% 
  group_by(tier_5, pressure) %>% 
  dplyr::summarise(sum = sum(sum)) %>% 
  left_join(rescaling_values, by = "pressure") %>% 
  ungroup() %>% 
  rowwise() %>% 
  mutate(prop_of_global = sum/global_total,
         prop_of_global = ifelse(tier_5 == "fofm meat", prop_of_global*0.1, prop_of_global)) %>% 
  left_join(food_groupings, by = "tier_5")

## quick check
sum(summary_df$prop_of_global) #  3.996062 looks good!



bar_df_int <- summary_df %>% 
  select(tier_2, tier_5, pressure, prop_of_global) %>% 
  mutate(sub_tier = str_remove(tier_5, " feed"),
         pressure_bar = ifelse(str_detect(tier_5, "feed"), paste(pressure, "_feed", sep = ""), pressure)) %>%
  group_by(tier_2, sub_tier) %>% 
  mutate(food_cat_sum = sum(prop_of_global)) %>% 
  ungroup()  %>% 
  
  mutate(facet_tier = ifelse(str_detect(tier_2, "fisheries"), "fisheries", tier_2),
         facet_tier = case_when(facet_tier == "livestock" ~ "Livestock",
                                facet_tier == "crop human consumption" ~ "Human Crop Consumption",
                                facet_tier == "fisheries" ~ "Marine and Freshwater Fisheries",
                                facet_tier == "mariculture" ~ "Mariculture")) %>% 
  mutate(prop_of_global = prop_of_global/4)

## make naming changes to make it look better
bar_df <- bar_df_int%>% 
  mutate(sub_tier = ifelse(facet_tier ==  "Human Crop Consumption", str_remove(tier_5, " produce"), sub_tier)) %>% 
  left_join(mapspam_names, by = "sub_tier") %>% 
  mutate(SPAM_full_name = ifelse(sub_tier == "xfru", "other fruits",
                                 ifelse(sub_tier == "xmil", "millet",
                                        ifelse(sub_tier == "xoil", "other oil crops",
                                               ifelse(sub_tier == "xpul", "pulses", SPAM_full_name))))) %>% 
  mutate(sub_tier = ifelse(tier_2 == "crop human consumption", SPAM_full_name, sub_tier)) %>% 
  select(-SPAM_full_name) %>% 
  mutate(sub_tier = ifelse(tier_2 == "marine fisheries", str_replace(sub_tier, "meat", "fish"), sub_tier),
         sub_tier = ifelse(tier_2 == "freshwater fisheries", "river fish*", sub_tier),
         sub_tier = ifelse(sub_tier == "fofm fish", "FOFM", sub_tier),
         sub_tier = ifelse(tier_2 == "mariculture", str_replace(sub_tier, "meat", ""), sub_tier)) %>% 
  mutate(tier_5 = str_replace(tier_5, "bivalve", "bivalves"),
         sub_tier = str_replace(sub_tier, "bivalve", "bivalves**"),
         sub_tier = ifelse(sub_tier == "FOFM", "forage fish", sub_tier),
         tier_5 = str_replace(tier_5, "fofm", "forage fish"))


bar_df$sub_tier <- factor(bar_df$sub_tier)

final_df <- bar_df %>%
  group_by(sub_tier) %>%
  mutate(total_prop = sum(prop_of_global)) %>%
  ungroup() %>%
  mutate(final_prop = prop_of_global/total_prop)

# the ruminant digestive system of cows makes their GHG emissions noteworthy (X% of their cumulative pressures), along with nutrient emissions from their wastes and feed production (Y%).

cows_meat <- final_df %>%
  filter(sub_tier == "cows meat")

## cows ghg emissions are 0.540744984 or ~54% of their cumulative pressures
## cows nutrient emissions are 0.2753061 or ~ 28% of their cumulative pressures

# In contrast, the footprint of chicken and pig meat more strongly reflects water use (A% of their cumulative pressures) and land area disturbed from the feed (B%) for these animals that is driven in particular by their very large production levels

chickens_meat <- final_df %>%
  filter(sub_tier == "chickens meat")

## chickens meat water use from feed is 0.30547609 or ~31% of their cumulative pressure
## chickens meat disturbance from feed is 0.22724607 or ~23% of their cumulative pressure


pigs_meat <- final_df %>%
  filter(sub_tier == "pigs meat")

## pigs meat water use from feed is 0.230849356 or ~23% of their cumulative pressure
## pigs meat disturbance from feed is 0.205803874 or ~21% of their cumulative pressure


######## From response to reviewers
# In this figure, pigs have a total cumulative pressure of 0.7X (i.e. 7% of the total pressure of all foods globally), while rice is 7.8%. The reason rice is higher is because its pressure from water use is higher than for pigs (2.5% of the total pressure of all foods globally, versus 2%) and its GHG emissions are higher (3% versus 1%). Disturbance is about the same (X% for rice; Y% for pigs) and excess nutrients is slightly higher for rice (X% for rice; Y% for pigs). These kinds of comparisons are a key reason we did our study and are only possible with our approach, i.e. this is the first time such comparisons have been possible.


by_organisms <- final_df %>%
  group_by(sub_tier) %>%
  summarise(total_prop = sum(prop_of_global)) %>%
  ungroup()

## look at pigs: 0.08158349 or pigs represent ~8% of total pressures
## look at rice: 0.1040971 or rice represents ~10% of total pressures

by_organisms_pressures <- final_df %>%
  group_by(sub_tier, pressure_bar) %>%
  summarise(total_prop = sum(prop_of_global)) %>%
  ungroup() %>%
  filter(sub_tier %in% c("pigs meat", "rice"))

#### water
## 2.8% of global pressure comes from rice water
## 1.9% of global pressure comes from pig water 

#### ghg
## 3.1% of global pressure comes from rice ghg
## 1.7% of global pressire comes from pig ghg

#### disturbance 
## 1.5% rice
## 1.7% pigs

#### nutrients 
## 3% rice
## 2.8% pigs 

```

**In some cases these differences are driven by the scale of production, for example rice is Xx greater production than pigs, so even though per-unit pigs are less efficient, rice exerts overall more cumulative pressure.**

```{r}
all_prod <- read_csv("output/all_production.csv")

by_product <- all_prod %>%
  group_by(category1_production) %>%
  summarise(total_tonnes = sum(tonnes, na.rm = TRUE))

# rice prod: 7.195111e+08
# pigs meat prod: 1.272183e+08

7.195111e+08/1.272183e+08 # 5.65572
```



can rerun this: 

**OLD**:
**The spatial distribution of cumulative footprints is highly skewed, with the top 1% of raster cell scores (5,114,880km2 total) concentrated in India, China, the U.S., Brazil, and Southeast Asia (Fig. 1a), and nearly entirely on land (only 43,056km2 in the ocean, and none of the top 1% in the high seas). Indeed, 34.4% of food’s global cumulative footprint comes from this 1% of the planet, with remarkably nearly all (92.7%) from just 10% of raster cells.**

**NEW**:
**The spatial distribution of cumulative footprints is highly skewed, with the top 1% of raster cell scores (5,114,880km2 total) concentrated in India, China, the U.S., Brazil, and Southeast Asia (Fig. 1a), and nearly entirely on land (only 61,452km2 in the ocean, and none of the top 1% in the high seas). Indeed, 32.6% of food’s global cumulative footprint comes from this 1% of the planet, with remarkably nearly all (92.3%) from just 10% of raster cells.**


New text: 
**The top 1% of pixels with respect to cumulative pressures (5,114,880km2 total) fall nearly entirely on land (only 43,056km2, or 0.8% of this top 1%, fall in the ocean, and none in the high seas), produce a third (34.4%) of food’s global cumulative pressure and XX% of assessed food, and occur primarily in India, China, the U.S., Brazil, and Indonesia (Fig. 2a). Nearly all pressures (92.7%) are exerted in just 10% of pixels.**

 - to get the XX% of assessed food probably need to read in production rasters, stack together, and then multiply by a 1/0 raster for the top 1% and sum up. Then divide by total production.

```{r, eval = FALSE}
# Find out what the top 1% of raster cells scores are and get the area of those.

cum_stress <- raster(file.path("/home/shares/food-systems/Food_footprint/all_food_systems/analysis/stressor_summary/equal_area/rescaled/cumulative_stress/all_systems_cumulative_stress.tif"))
plot(cum_stress)
cellStats(cum_stress, "sum", na.rm = TRUE) # old: 4003217
# new: 4076811

cum_stress_df <- as.data.frame(cum_stress, xy= TRUE)

top_1_per <- quantile(cum_stress, 0.99)  

top_1_perc <- cum_stress_df[cum_stress_df$all_systems_cumulative_stress > top_1_per,] ### 142080 cells in the top 1%

cum_stress2 <- cum_stress
cum_stress2[cum_stress2 < top_1_per] <- NA ### assign anything not in the top 1% an NA 
plot(cum_stress2) ### looks similar to the dark figures on figure 1

cellStats(cum_stress2, "sum", na.rm = TRUE) # old: 1375751
# new: 1327840

# OLD : 1375751/4003217 # 0.3436614 - prop of footprint in top 1%
1327840/4076811 # 0.3257056 - prop of footprint in the top 1%

cum_stress3 <- cum_stress
cum_stress3[cum_stress3 < top_1_per] <- NA ### assign anything not in the top 1% an NA 
cum_stress3[!is.na(cum_stress3)] <- 1
plot(cum_stress3) ### matches exactly the figure

### area in km2 should be:
# there are 142080 cells in the top 1%
142080*36 # 5114880 km2


### now extract the values from this which are in the ocean
eez_rgns <- raster("/home/shares/food-systems/Food_footprint/all_food_systems/dataprep/spatial/gall_peters/eez_rgns_gall_peters.tif")
plot(eez_rgns)

ocean_stress <- data.frame(zonal(cum_stress2, eez_rgns, fun = "sum")) ### ok so some of the cumulative stressors are in the ocean... 

eez_rgns[eez_rgns > 0 ] <- 1
plot(eez_rgns)

land_footprint <- eez_rgns*cum_stress3

plot(land_footprint)
cellStats(land_footprint, "sum") # OLD: 1196 ### so the ocean area is 1196*36 = 43056 km2 
# NEW: 1707 ### so the ocean area is 1707*36 = 61452 km2 


### top 10% calculations for paper 
top_10_per <- quantile(cum_stress, 0.90)
chi_10 <- raster("/home/shares/food-systems/Food_footprint/all_food_systems/analysis/stressor_summary/equal_area/rescaled/cumulative_stress/all_systems_cumulative_stress.tif")
chi_10[chi_10 < top_10_per ] <- 0
cellStats(chi_10, stat = 'sum')

## OLD:
# 3712137
3712137/4003217
### 92.7%

## NEW: 
# 3761621
3761621/4076811
# 0.9226871
# 92.3%
```

**Cow production for meat and milk is the single most influential sector, dominating (>50%) cumulative pressure across 40% of terrestrial pixels (of which 7.1% globally is from Russia, 5.2% from Canada, 4.2% from the United States, 3.7% from Brazil, and 3.1% from Australia). Crop production is the second most impactful, dominating across 12.8% of terrestrial pixels (largely in central Africa, Southeast Asia, and Russia), primarily from rice, sugarcane, wheat, and vegetable crops. Sheep and goats also affect large areas, being the dominant food type for 12.7% of terrestrial pixels (including in Northern Africa, Central Asia, and Greenland) (Fig. 3a), while large pelagic and forage fisheries drive pressures in offshore areas (68% of ocean pixels), and fisheries for demersal fish and medium pelagics drive pressures in coastal areas (10% of ocean pixels) (Fig. 3b).**

 - Most of these stats (aside from the country specific numbers), are embedded in the first 4 code chunks of this script too.

```{r, eval = FALSE}
land_dom <- read_csv("output/land_country_food_domination_50.csv") 

land_extended_rgns <- raster("/home/shares/food-systems/Food_footprint/all_food_systems/dataprep/spatial/gall_peters/food_rgns_extended_gall_peters.tif")

### crops
crops_low <- raster("/home/shares/food-systems/Food_footprint/all_food_systems/analysis/figures/animal_product/prop_cpi_threshold/thresh50_prop_cpi_farm_crop.tif")

cellStats(crops_low, "sum") # 529070

529070*36 # 19046520 km2
19046520/land_area # 0.1278805

### lets look at biggest contributing countries 
crops_dom <- land_dom %>%
  filter(food_group == "farm_crop") ### china, russia, central africa...


crops_rgn <- rgn_raw %>%
  filter(system == "crop")


rescale <- read_csv("../rescale_values.csv")


percent_pressure_crops <- rgn_raw %>%
  left_join(rescale, by = "pressure") %>%
  mutate(global_pressure_prop = sum/global_total) %>%
  group_by(iso3c, system, organism, origin) %>%
  summarise(cum_pressure_prop_rescaled = sum(global_pressure_prop),
            cum_pressure = sum(sum)) %>%
  ungroup() %>%
  filter(system == "crop")

### cows 
cows_meat_milk_low <- raster("/home/shares/food-systems/Food_footprint/all_food_systems/analysis/figures/animal_product/prop_cpi_threshold/thresh50_prop_cpi_cows_meat&milk.tif")

cellStats(cows_meat_milk_low, "sum") # 1652201 number of cells 50% dominated by cows milk


cows_dom <- land_dom %>%
  dplyr::filter(food_group == "cows_meat.milk") # 1652060 cells dominated... lose a tiny bit, but its ok.

sum(cows_dom$`n_cells_dom_50%`)

1652060*36 # 59474160 km2
59474160/land_area # 0.3993162


### shoats 
shoats_dom <- land_dom %>%
  filter(food_group == "shoats_meat.milk")

sum(shoats_dom$proportion_dominated) # 12.7%

shoats_low <- raster("/home/shares/food-systems/Food_footprint/all_food_systems/analysis/figures/animal_product/prop_cpi_threshold/thresh50_prop_cpi_shoats_meat&milk.tif")

cellStats(shoats_low, "sum")

525648*36/land_area #  0.1270534


ocean_dom <- read_csv("output/ocean_country_food_domination_50.csv")
large_pel_fofm <- ocean_dom %>%
  filter(food_group %in% c("large.pelagic_fisheries", "fofm_fisheries"))

ocean_area <- 361044342.581

sum(large_pel_fofm$proportion_dominated) # 0.683044
sum(large_pel_fofm$`n_cells_dom_50%`) # 6850255
6850255*36/ocean_area # 0.683044

med_pel_dem <- ocean_dom %>%
  filter(food_group %in% c("medium.pelagic_fisheries", "demersal_fisheries"))

ocean_area <- 361044342.581

sum(med_pel_dem$proportion_dominated) # 0.09897019
sum(med_pel_dem$`n_cells_dom_50%`) # 992573
992573*36/ocean_area # 0.09897019

```

**Marine fisheries play a modest role (>25% of total pressures) in 82 countries, primarily (63) in island nations.**

New text: 
**Marine fisheries and aquaculture contribute >25% of total pressures in 82 countries, primarily in island nations (63 countries).**

```{r, eval = FALSE}
rescale <- read_csv("../rescale_values.csv")

test <- rgn_raw %>%
  filter(system == "fisheries",
         origin == "marine")

percent_pressure_fisheries <- rgn_raw %>%
  left_join(rescale, by = "pressure") %>%
  mutate(global_pressure_prop = sum/global_total) %>%
  group_by(iso3c, system, origin) %>%
  summarise(cum_pressure_prop_rescaled = sum(global_pressure_prop)) %>%
  ungroup()

percent_pressure_fisheries_2 <- percent_pressure_fisheries %>%
  group_by(iso3c) %>%
  mutate(total_cum_prop = sum(cum_pressure_prop_rescaled)) %>%
  ungroup() %>%
  mutate(cum_pressure_prop_final = cum_pressure_prop_rescaled/total_cum_prop) %>%
  mutate(percent_final = round(cum_pressure_prop_final*100,1))
  # group_by(organism) %>%
  # summarise(prop_final = sum(cum_pressure_prop_final)) %>%
  # ungroup() %>%
  # mutate(percent_final = round(prop_final*100,1))

write.csv(percent_pressure_fisheries_2, "output/percent_cum_pressure_country_fisheries.csv", row.names = FALSE)


marine_fisheries_pressures <- percent_pressure_fisheries_2 %>%
  left_join(food_rgns, by = "iso3c") %>%
  filter(system == "fisheries", origin == "marine") %>%
  filter(percent_final >= 25)
count(marine_fisheries_pressures) ### 82 countries (83 with high seas)
82/245 ### about 1/3 of countries have marine fisheries accounting for >25% of their pressures

islands <- read_csv("data/island_nations.csv")
islands_vec <- islands$country

marine_fis_islands <- marine_fisheries_pressures %>% 
  filter(Country %in% islands_vec) ### at least 29... there are a lot of name mismatches though

setdiff(marine_fisheries_pressures$Country, islands_vec)

marine_fis_islands2 <- marine_fisheries_pressures %>%
  filter(!(Country %in% islands_vec)) %>%
  filter(str_detect(Country, "Island|island")) ### 11 


marine_fis_islands3 <- marine_fisheries_pressures %>%
  filter(!(Country %in% islands_vec)) %>%
    filter(!str_detect(Country, "Island|island")) # 23

29+11+23 # 63

# 63 of them are island nations... 
```

### Extract data on how much of freshwater aquaculture comes from Asia (should be something like 80%) and how much of the global total comes from just China.

 
```{r, eval = FALSE}
fao_mariculture_fw <- read_csv("../../aquaculture/data/fao_mariculture_clean.csv") %>%
  dplyr::filter(year == 2017, 
                environment == "Freshwater")
sum(fao_mariculture_fw$value, na.rm = TRUE) #48.7 mil

fw_asia <- fao_mariculture_fw %>%
  dplyr::filter(fao_major_area == "Asia - Inland waters") %>%
  dplyr::filter(!(country %in% c("Afghanistan", "Armenia", "Azerbaijan", "Cyprus", "Georgia", "Iran (Islamic Rep. of)", "Iraq", "Israel", "Jordan", "Kazakhstan", "Kyrgyzstan", "Lebanon", "Oman", "Pakistan", "Palestine", "Qatar", "Saudi Arabia", "Syrian Arab Republic", "Tajikistan", "Turkey", "Turkmenistan", "United Arab Emirates", "Uzbekistan", "Bhutan", "Bangladesh", "India", "Nepal", "Sri Lanka")))

fw_china <- fao_mariculture_fw %>%
  dplyr::filter(country == "China")

### Total tonnes fw 
sum(fao_mariculture_fw$value, na.rm = TRUE) # 48671218

### Total asia fw tonnes 
sum(fw_asia$value, na.rm = TRUE) # 37746079

### Total china fw tonnes 
sum(fw_china$value, na.rm = TRUE) # 29117696

# Percent fw aquaculture from Asia: 37746079/48671218 = 0.7755318

# Percent fw aquaculture from China: 29117696/48671218 = 0.5982529

unique(fw_asia$country)

```
 
 
Can rerun this: this changed A LOT
### Find out what the maximum cumulative pressure score (across all foods) for a pixel was and what country it was in. 

```{r, eval = FALSE}
# Find out what the maximum cumulative pressure score (across all foods) for a pixel was and what country it was in. 

cum_stress <- raster(file.path("/home/shares/food-systems/Food_footprint/all_food_systems/analysis/stressor_summary/equal_area/rescaled/cumulative_stress/all_systems_cumulative_stress.tif"))
plot(cum_stress)

maxValue(cum_stress) 
# OLD: 1758.35
# NEW: 105.8691

land_eez_rgns_gp <- raster(file.path("/home/shares/food-systems/Food_footprint/all_food_systems/dataprep/spatial/gall_peters/land_eez_rgns_gall_peters.tif"))
plot(land_eez_rgns_gp)

### fix food_rgns to include high seas
food_rgns <- rbind(food_rgns, data.frame(iso3c = "high_seas", ID_0 = 500, Country = "High Seas"))

test_df <- as.data.frame(zonal(cum_stress, land_eez_rgns_gp, "max")) %>%
   left_join(food_rgns, by = c("zone" = "ID_0"))

test2 <- as.data.frame(cum_stress, xy= TRUE)

# the max value is 1758.35 in China, and has x = 9459570, y = 4010818.1... not sure exactly what kind of coordinates these area.. lets reproject 

extent(cum_stress) <- c(xmin= -14207430, xmax= 14208570, ymin= 0.95*(-9000182), ymax= 0.95*(8999818)) ### cut the extent a little bit so that the reprojection will work.. 

test4 <- projectRaster(cum_stress, food_raster, method = "ngb")

maxValue(test4) 
#OLD: 1758.35 ### good the max area is the same 
#NEW: 86.41932... this changed....

test5 <- as.data.frame(test4, xy = TRUE)
# this says max value is x = 119.958330, y = 25.208333... but that isnt a point on a map... however if you flip the two, then it is a point in the south china sea

# test4[test4 < 1700] <- NA

test4[test4 < 80] <- NA

test55 <- rasterToPoints(test4, spatial = TRUE, centroids = TRUE)
mapview(test55) ### this matches above point

# OLD:
# I think this is the point....? 
# 25°12'30.0"N 119°57'30.0"E
# 25.208333, 119.958330

#NEW: 
# 11.95833333, -8.041667 - in Mali


# cum_stress[cum_stress < 1700] <- NA
# cum_stress[cum_stress > 1700] <- 1

cum_stress[cum_stress < 80] <- NA
cum_stress[cum_stress > 80] <- 1

maxValue(cum_stress) # 1 

#; check that there is only 1 point (can’t remember function offhand, but I can look up); convert the raster to a spatial points dataframe; plot the point over the map so you can see it.

mapview(cum_stress)
plot(cum_stress)

test <- rasterToPoints(cum_stress, spatial = TRUE)
mapview(test) ### close to the above point - using this point, since there was no reprojection done on this: 26.61557, 119.97399

colMeans(xyFromCell(cum_stress, which(cum_stress[]==1)))
```

Can rerun this

**OLD**:
**Despite the disparities in magnitude of cumulative pressure, almost the entire surface of land (XX%) and sea (XX%) alike has area disturbed from food production (Fig. 1b).** 

**NEW**:
**Despite the disparities in magnitude of cumulative pressure, almost the entire surface of land (XX%) and sea (XX%) alike has area disturbed from food production (Fig. 1b).** 

```{r, eval = FALSE}

  stressor = "disturbance"
  ### get the max value
  ### chi

  chi <- raster(list.files("/home/shares/food-systems/Food_footprint/all_food_systems/analysis/stressor_summary/equal_area/stressor_per_km2/stressor", pattern = stressor, full=TRUE))
  
cellStats(chi, "sum") # 516197.6

chi_dist <- chi

chi_dist[chi_dist > 0 ] <- 1 
cellStats(chi_dist, "sum") # 12481907 - this is how many cells are covered 
plot(chi_dist)

12481907/14208000 # 0.8785126 = ~88% of all cells have disturbance in them 

### now lets get these stats per ocean 
eez_rgns <- raster("/home/shares/food-systems/Food_footprint/all_food_systems/dataprep/spatial/gall_peters/eez_rgns_gall_peters.tif")
plot(eez_rgns)

eez_rgns[eez_rgns > 0 ] <- 1
plot(eez_rgns)

dist_ocean <- chi_dist*eez_rgns
plot(dist_ocean)

cellStats(dist_ocean, "sum") # 8732460

cellStats(eez_rgns, "sum") # 10076477

8732460/10076477 # 0.8666184 = ~87% of ocean cells have disturbance 

ocean_area <- 361044342.581

(8732460*36)/ocean_area # 0.8707201 - matches up. Use 87% 


### now lets get these stats per land 
land_rgns_1 <- raster(file.path("/home/shares/food-systems/Food_footprint/all_food_systems/dataprep/spatial/gall_peters/food_rgns_extended_gall_peters.tif")) 

land_rgns_1[land_rgns_1 > 0] <- 1
plot(land_rgns_1)

dist_land <- chi_dist*land_rgns_1
plot(dist_land)
cellStats(dist_land, "sum") # 3951146
cellStats(land_rgns_1, "sum") # 3972474

3951146/3972474 # 0.9946311 ... wow 99% of cells have atleast some disturbance 

land_area <- 148940000

3951146*36/land_area # 0.9550239... 96%... i feel better about using this number. Stay consistent with using the areas taken from google. 

plot(chi_dist)


```


New text:
**The cumulative pressure imposed by food production is greatest in India, China, Brazil, the U.S., and Indonesia (Fig. 4). These 5 countries alone contribute nearly half (47.5%) of global cumulative pressure.**

 
```{r}

library(here)
source(here("_workflow/common.R"))
source(here("_workflow/common_spatial.R"))

summary_df_raw <- read_csv(file.path("/home/shares/food-systems/Food_footprint/all_food_systems/analysis/raw_df_summary/rgn_raw_summary.csv"))

rescaling_values <- read_csv(here("_analysis/rescale_values.csv"))

un_geopolitical <- read_csv(here("_spatial/_output/UNSD_Methodology.csv")) %>%
  dplyr::select(iso3c, georegion=Region_Name)

summary_df <- summary_df_raw %>% 
  mutate(origin = ifelse(category == "feedfofm", "marine", origin)) %>% 
  mutate(land_ocean = case_when(origin %in% c("land", "freshwater") ~ "land",
                                origin == "marine" ~ "ocean")) %>% 
  mutate(sum = ifelse(iso3c == "HSX" & category == "feedfodd", 0, sum)) %>% 
  group_by(country, iso3c, land_ocean, pressure) %>% 
  dplyr::summarise(pressure_sum = sum(sum)) %>% 
  left_join(rescaling_values, by = "pressure") %>% 
  ungroup() %>% 
  rowwise() %>% 
  mutate(prop_of_global = pressure_sum/global_total)  %>% 
  unite(source, c("land_ocean", "pressure"), sep = "-", remove = FALSE) %>% 
  left_join(un_geopolitical, by = "iso3c") %>% 
  mutate(georegion = ifelse(country == "High Seas", "High Seas", georegion))


test <- summary_df %>%
  group_by(country) %>%
  summarise(sum = sum(prop_of_global)/4) %>%
  arrange(-sum) %>%
  head(5) # 0.4521266

```


New text: 
**Feed creates widespread footprints for fed animals. For example, because on average forage fish comprise ~0.15% of chicken and ~0.02% of pig feed, these livestock have X% (chickens) and X% (pigs) of their cumulative footprint in the ocean, while fed mariculture species, whose feed increasingly includes crops, have X-X% of their footprint on land (Suppl. Table XX)**


 - compare magnitudes of pigs/chickens cumulative pressures on land to that of mariculture species 
    - pigs cumulative pressure is similar to that of crustaceans, salmon, and marine fish general in water. 
    - chickens cumulative pressure is similar to that of tuna in water.

```{r}
rescale <- read_csv("../rescale_values.csv")

### rescale pressures 
percent_pressure_rescale <- rgn_raw %>%
  left_join(rescale, by = "pressure") %>%
  mutate(global_pressure_prop = sum/global_total) %>%
  group_by(organism, origin) %>%
  summarise(cum_pressure = sum(sum)) %>%
  ungroup()

### group by food group
percent_pressure_organisms_origin <- percent_pressure_rescale %>%
  group_by(organism) %>%
  mutate(total_organism_pressure = sum(cum_pressure)) %>%
  ungroup() %>%
  mutate(proportion_final = cum_pressure/total_organism_pressure) %>%
  filter(organism %in% c("chickens", "pigs", "crustaceans", "marine-fish-general", "bivalve", "salmon", "shrimp", "tuna"))
  


```

**More broadly, use of feed for livestock displaces on average X% of a country’s cumulative footprint to other countries (range: X-X%; Suppl. Table XX).**

 - not sure how to figure this out
 
 
 
