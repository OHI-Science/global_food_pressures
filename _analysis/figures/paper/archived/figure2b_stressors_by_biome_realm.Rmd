---
title: 'Figure 2b: Bar plot by biomes and realms'
author: "Juliette"
date: "12/16/2020"
output: html_document
---

change the x axis to be average cumulative pressure per km2

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(here)
library(hrbrthemes)
library(RColorBrewer)
library(colorspace)
library(patchwork)
source(here("_workflow/common.R"))

## load in the rasters, and add in the high seas to meow
meow_raster <- raster(file.path("/home/shares/food-systems/Food_footprint/all_food_systems/analysis/ecoregions_rasters/meow_raster.tif"))
teow_raster <- raster(file.path("/home/shares/food-systems/Food_footprint/all_food_systems/analysis/ecoregions_rasters/teow_raster.tif"))

high_seas <- sum(teow_raster, meow_raster, na.rm = TRUE)
freq(high_seas)
high_seas <- calc(high_seas, fun = function(x){ifelse(x == 0, -99, NA)})
plot(high_seas)

meow_raster <- sum(meow_raster, high_seas, na.rm = TRUE)
meow_raster <- calc(meow_raster, fun = function(x){ifelse(x == 0, NA, x)})
plot(meow_raster)
freq(meow_raster)

## load in the keys and add in the high seas in meow
hs_presence_rast <- calc(high_seas, fun = function(x){ifelse(is.na(x), 0, 1)})
hs_area_rast <- hs_presence_rast*raster::area(high_seas)
hs_area <- cellStats(hs_area_rast, stat = 'sum')

meow_key <- read_csv(file.path("/home/shares/food-systems/Food_footprint/all_food_systems/analysis/ecoregions_rasters/meow_key.csv")) %>% 
  add_row(REALM = "High Seas", RLM_CODE = -99, type = "ocean", realm_area_km2 = hs_area)

teow_key <- read_csv(file.path("/home/shares/food-systems/Food_footprint/all_food_systems/analysis/ecoregions_rasters/teow_key.csv"))

teow_area <- read_csv(file.path("/home/shares/food-systems/Food_footprint/all_food_systems/analysis/ecoregions_rasters/teow_area.csv")) %>% 
  select(-type) %>% 
  rename(biome_ID = BIOME)

```


Stack all the rasters that are marine related for each stressor and summarize

NEED TO GO BACK OVER THIS AND MAKE SURE THE LAND ORIGIN AND MARINE ORIGIN LAYERS ARE GETTING ACCOUNTED FOR
```{r}

realm_pressures <- data.frame(realm=NA, stressor=NA, total = NA, realm_area_km2 = NA)

stressor_list <- c("disturbance", "ghg", "water", "nutrient")

for(stres in stressor_list) {
  
 # stres <- stressor_list[3]
  
marine_list_1 <- list.files(file.path("/home/shares/food-systems/Food_footprint/all_food_systems/analysis/_tif_equal_area_proj_per_cell_rescaled"), full.names = TRUE, pattern = "marine")

marine_list_2 <- list.files(file.path("/home/shares/food-systems/Food_footprint/all_food_systems/analysis/_tif_equal_area_proj_per_cell_rescaled"), full.names = TRUE, pattern = "feedfofm_land")

marine_list <- c(marine_list_1, marine_list_2)
marine_list <- grep(stres, marine_list, value = TRUE)

marine_stack <- stack(lapply(marine_list, raster))
marine_sum <- sum(marine_stack, na.rm = TRUE)
realm_summary <- zonal(marine_sum, meow_raster, fun = 'sum') %>% 
  as_tibble() %>% 
  rename(RLM_CODE = zone) %>% 
  left_join(meow_key, by = "RLM_CODE") %>% 
  mutate(stressor = stres) %>% 
  select(realm = REALM, stressor, total = sum, realm_area_km2) 

# realm_summary <- realm_summary %>% 
#   mutate(total = ifelse(pressure == "water", 0, total)) ### this number is suppperrr small and an artifact of the coastline rasters. removing it here because you can see a teeny tiny sliver in the bar chart, which makes no sense because there is no water use stressor in the ocean

realm_pressures <- rbind(realm_pressures,realm_summary ) %>% filter(!is.na(realm))

}

realm_pressures_adju <- realm_pressures %>% 
  mutate(total = total/1000000,
         origin = "ocean",
         prop_stressor_per_1000km2 = (total/realm_area_km2)*1000) %>% 
  rename(realm_biome = realm,
         strssor_total = total)

```


Stack all the rasters that are land related for each stressor and summarize
```{r}

biome_pressures <- data.frame(biome=NA, stressor=NA, total = NA, realm_area_km2 = NA)

stressor_list <- c("disturbance", "ghg", "water", "nutrient")

for(stress in stressor_list) {
  
 # stressor <- stressor_list[1]
  
land_list <- list.files(file.path("/home/shares/food-systems/Food_footprint/all_food_systems/analysis/_tif_equal_area_proj_per_cell_rescaled"), full.names = TRUE)
land_list <- grep(land_list, pattern='marine', invert=TRUE, value=TRUE)
land_list <- grep(land_list, pattern='feedfofm_land', invert=TRUE, value=TRUE)


land_list <- grep(stress, land_list, value = TRUE)

land_stack <- stack(lapply(land_list, raster))
land_sum <- sum(land_stack, na.rm = TRUE)
biome_summary <- zonal(land_sum, teow_raster, fun = 'sum') %>% 
  as_tibble() %>% 
  rename(biome_ID = zone) %>% 
  left_join(teow_key, by = "biome_ID") %>% 
  mutate(stressor = stress) %>% 
  left_join(teow_area, by = "biome_ID") %>% 
  select(biome = biome_description, stressor, total = sum, realm_area_km2) 

biome_pressures <- rbind(biome_pressures,biome_summary) %>% filter(!is.na(biome))

}

biome_pressures_adju <- biome_pressures %>% 
  mutate(total = total/1000000,
         origin = "land",
         prop_stressor_per_1000_km2 = (total/realm_area_km2)*1000) %>% 
  rename(realm_biome = biome,
         stressor_total = total)
```

colors
```{r}
library(scales)

### disturbance, GHG, nutrient, water
## dark to light 
land_col <- c("#304818", "#5A7F3C", "#87B062", "#CACA91")
show_col(land_col)

marine_col <- c("#375277", "#4C6FA1", "#6592D6", "#A1CAF6")
show_col(marine_col)

```

```{r}

#disturbance
orange <- "#DB9941"
orange_land <- colorspace::lighten(orange, amount = -0.2)
orange_marine <- colorspace::lighten(orange, amount = 0.4)

# nutrient
green <- "#8DAE87"
green_land <- colorspace::lighten(green, amount = -0.2)
green_marine <- colorspace::lighten(green, amount = 0.4)

# GHG
purple <- "#985A71"
purple_land <- colorspace::lighten(purple, amount = -0.2)
purple_marine <- colorspace::lighten(purple, amount = 0.4)

#Water
blue <- "#5B7CA7"
blue_land <- colorspace::lighten(blue, amount = -0.2)
blue_marine <- colorspace::lighten(blue, amount = 0.4)

biome_pressures_adju <- biome_pressures_adju %>% 
  mutate(fill_color = case_when(stressor == "disturbance" ~ orange_land,
                                stressor == "ghg" ~ purple_land,
                                stressor == "water" ~ blue_land,
                                stressor == "nutrient" ~ green_land))

realm_pressures_adju <- realm_pressures_adju %>% 
  mutate(fill_color = case_when(stressor == "disturbance" ~ orange_marine,
                                stressor == "ghg" ~ purple_marine,
                                stressor == "water" ~ blue_marine,
                                stressor == "nutrient" ~ green_marine))


```





Create the two bar plots for the terrestrial biomes and marine realms 
```{r}
# ocean
ocean <- realm_pressures_adju %>% 
  rename(prop_stressor_per_1000_km2 = prop_stressor_per_1000km2) %>% 
  group_by(realm_biome) %>% 
  mutate(r_b_total = sum(prop_stressor_per_1000_km2)) %>% 
  ungroup() %>% 
  arrange(-r_b_total) 

ocean_order <- ocean %>% 
  select(realm_biome) %>% 
  unique() 

ocean$realm_biome <- factor(ocean$realm_biome, levels=rev(ocean_order$realm_biome))

ocean_plot <- ggplot(data=ocean, aes(x=prop_stressor_per_1000_km2, y=realm_biome, fill= fill_color)) + ##fill= fill_value
  geom_bar(stat="identity") +
  labs(y = "Marine Relams", 
       x = "Average Contribution to Global Cummulative Pressure per 1000 km2") +
  scale_fill_identity() +
  theme_minimal()+
  theme(plot.margin=unit(c(1,1,1.5,1.2),"cm"))
   #theme(panel.background = element_rect(fill = 'lightcyan'))

# land
land <- biome_pressures_adju %>% 
  group_by(realm_biome) %>% 
  mutate(r_b_total = sum(prop_stressor_per_1000_km2)) %>% 
  ungroup() %>% 
  arrange(-r_b_total) 

land_order <- land %>% 
  select(realm_biome) %>% 
  unique() 

land$realm_biome <- factor(land$realm_biome, levels=rev(land_order$realm_biome))

land_plot <- ggplot(data=land, aes(x=prop_stressor_per_1000_km2, y=realm_biome, fill= fill_color)) + ##fill= fill_value
  geom_bar(stat="identity") +
  labs(y = "Terrestrial Biomes", 
       x = " ")  +
  scale_fill_identity() +
  theme_minimal() +
  theme(plot.margin=unit(c(1,1,1.5,1.2),"cm"))
  # theme(panel.background = element_rect(fill = 'darkseagreen2'))

separate_plot <- land_plot/ocean_plot

ggsave(here("_analysis/figures/paper/output/fig_2b_biome_realm_bars.png"), height=7, width=15, units=c("in"))


## combine and facet with free scales so that the bars are the same size


```



