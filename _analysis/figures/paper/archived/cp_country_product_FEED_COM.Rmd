---
title: "Cost per food item per country"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}

library(ggplot2)
library(tidyverse)
library(here)
library(countrycode)
library(cowplot)

source(here("_workflow/common.R"))

```

Get production data for each group.

### Livestock
```{r}
## Livestock animal products
livestock_cats <- read_csv(here("_analysis/paper_stats/data/FAO_livestock_categories.csv")) %>%
  filter(!is.na(category1_production))
table(livestock_cats$category1_production)
table(livestock_cats$category2_production)

livestock <- read_csv(here("_analysis/paper_stats/data/FAOSTAT_data_12-18-2020_livestock_primary.csv")) %>%
  filter(Area != "China") %>%
  filter(!(is.na(Value))) %>%
  filter(Item %in% livestock_cats$Item) %>%
  left_join(livestock_cats, by="Item") %>%
  group_by(Area, category1_production, category2_production) %>%
  summarize(tonnes = sum(Value)) %>%
  ungroup()

livestock_iso3c <- livestock %>%
    mutate(Area = iconv(Area, "UTF-8", "UTF-8",sub=''),
         Area = ifelse(Area == "Eswatini", "Swaziland", Area),
         Area = ifelse(Area == "Netherlands Antilles (former)", "Bonaire, Sint Eustatius and Saba", Area),
         Area = ifelse(Area == "French Guyana", "French Guiana", Area),
         Area = ifelse(Area == "China, mainland", "China", Area))

## add standardized country names
livestock_iso3c$iso3c<- countrycode(as.character(livestock_iso3c$Area), origin="country.name", destination = "iso3c")

## make sure all countries have an iso3c code
check <- filter(livestock_iso3c, is.na(iso3c))
unique(check$Area) # these are all higher level area, safe to delete NAs

livestock_iso3c <- livestock_iso3c %>%
  select(iso3c, category1_production, category2_production, tonnes)

```

## Marine fisheries

```{r}

marine_fish <- read_csv("/home/shares/food-systems/Food_footprint/all_food_systems/dataprep/fisheries/marine/catch_by_rgn_spp_class.csv") %>%
  mutate(category1_production = recode(species_class, "Benthic" = "benthic_meat",
             "Demersal" = "demersal_meat",
             "forage_fish" = "fofm_meat",
             "Large pelagic" = "large-pelagic_meat",
             "Medium pelagic" = "medium-pelagic_meat",
             "Reef-associated" = "reef_meat",
             "Small pelagic" = "small-pelagic_meat")) %>%
#  group_by(country_corrected, iso3c) %>%
#  summarize(tonnes = sum(catch_tonnes, na.rm=TRUE)) %>%
  mutate(category2_production = "marine_fisheries") %>%
  select(iso3c, category1_production, category2_production, tonnes=catch_tonnes)

```

### crops for humans
```{r}
fao_prod <- read_csv(here("feed/data/MAPSPAMcrop_production.csv"))
human_crop_prop <- read_csv("feed/data/human_crop_prop_consume.csv")

crop_tonnes <- left_join(human_crop_prop, fao_prod, by=c("iso3c_producing", "SPAM_super")) %>%
  rowwise() %>%
  mutate(tonnes = human_feed_prop*tonnes_producing_crop) %>%
  #group_by(iso3c_producing) %>%
  #summarize(tonnes = sum(tonnes, na.rm=TRUE)) %>%
  mutate(category2_production = "human_crop") %>%
  mutate(category1_production = paste(SPAM_super, "produce", sep = "_")) %>%
  select(iso3c = iso3c_producing, category1_production, category2_production, tonnes)


```

### Feed: Crops
```{r}

livestock_cats <- read_csv(here("_analysis/paper_stats/data/raster_livestock_cats.csv"))
table(livestock_cats$category2_production, livestock_cats$category1_production)

livestock_mapspam_feed <- read_csv(here("feed/data/tonnes_feedproduced_per_country_system.csv")) %>% left_join(livestock_cats, by="animal_system") %>%
  filter(!(is.na(category2_production))) %>%
    mutate(feed_source = "crops") %>%
  group_by(iso3c_producing, feed_source, category1_production, category2_production) %>%
  summarize(tonnes = sum(consumed_tonnes, na.rm=TRUE)) %>%
  dplyr::select(iso3c=iso3c_producing, category1_production, category2_production, feed_source, tonnes) %>%
  ungroup()

```

### Feed: fodder
```{r}

# remove old files in folder that are created here
do.call(file.remove, list(list.files("/home/shares/food-systems/Food_footprint/all_food_systems/analysis/figures/fodder_tonnes", full.names = TRUE)))

fodder_prod <- sum(stack(raster(file.path(prep, "crop/farm/scaled_maps_2017/crop_fodd_I_scaled.tif")), raster(file.path(prep, "crop/farm/scaled_maps_2017/crop_fodd_H_scaled.tif"))), na.rm=TRUE)

fodder_props <- list.files("/home/shares/food-systems/Food_footprint/all_food_systems/datalayers", pattern="_x_land_fodd", full=TRUE)

for(fodder_prop in fodder_props){ #fodder_prop = fodder_props[1]
  fodder_raster <- raster(fodder_prop)
  saveName <- basename(fodder_prop)
  saveName <- gsub("_x_land_fodd_crop_feed", "", saveName)
  saveName <- gsub("_land_", "", saveName)
  fodder_tonnes <- fodder_raster * fodder_prod
  writeRaster(fodder_tonnes, sprintf("/home/shares/food-systems/Food_footprint/all_food_systems/analysis/figures/fodder_tonnes/%s", saveName), overwrite=TRUE)
}

fodd_tonnes_stack <- stack(list.files("/home/shares/food-systems/Food_footprint/all_food_systems/analysis/figures/fodder_tonnes", full=TRUE))

rgns_eez_land <- raster(file.path(prep, "spatial/land_eez_rgns.tif"))
plot(rgns_eez_land)

country_sum <- zonal(fodd_tonnes_stack, rgns_eez_land, fun="sum", progress="text", na.rm=TRUE) %>% 
    data.frame() %>%
    rename(ID_0 = zone) %>%
    left_join(food_rgns, by="ID_0") %>%
    select(-ID_0)

country_fodder <- country_sum %>%
   pivot_longer(cols=c(-Country, -iso3c), "animal_system") %>%
   mutate(animal_system = gsub("^land_", "", animal_system)) %>%
     mutate(animal_system = gsub("eggs.meat", "eggs&meat", animal_system)) %>%
   left_join(livestock_cats, by="animal_system") %>%
  mutate(feed_source = "fodder") %>%
  select(iso3c, category1_production, category2_production, feed_source, tonnes=value)


```


Feed: FOFM

```{r}

fofm <- read.csv(here("feed/data/FMFO_bySource.csv")) %>%
  mutate(feed_source = "fofm") %>%
  rename(animal_system = system) %>%
  left_join(livestock_cats, by="animal_system") %>%
  filter(!is.na(category2_production)) %>%
  select(iso3c, category1_production, category2_production, feed_source, tonnes)
```

Calculate total tonnes of feed per country for each animal group:
```{r}

total_feed <- rbind(country_fodder, fofm, livestock_mapspam_feed) %>%
  group_by(iso3c, category1_production, category2_production) %>%
  summarize(tonnes = sum(tonnes, na.rm=TRUE)) %>%
  mutate(category1_production = paste("feed_", category1_production, sep="")) %>%
    mutate(category2_production = paste("feed_", category2_production, sep=""))

```


Freshwater fish: 
```{r}
fresh_fish <- read_csv(here("fisheries/freshwater/data/fw_catch_per_iso3c.csv")) %>% 
  select(-ID_0, - Country) %>% 
  rename(tonnes = fw_catch_tonnes) %>% 
  mutate(category1_production  = "fish_meat",
         category2_production = "freshwater_fisheries")

setdiff(food_rgns$iso3c, fresh_fish$iso3c)
setdiff(fresh_fish$iso3c, food_rgns$iso3c)
```

Mariculture: 
```{r}
library(countrycode)

mariculture <- read_csv(here("aquaculture/marine/STEP1_species_groups/int/tonnes_per_country_group.csv")) %>%
  filter(!(aq_group %in% "bivalves")) %>%
  mutate(aq_group = ifelse(aq_group=="marine_fish_general", "marine-fish-general", aq_group),
         aq_group = ifelse(aq_group=="salmonids", "salmon", aq_group),
         aq_group = ifelse(aq_group=="shrimps_prawns", "shrimp", aq_group)) %>%
  select(country, species = aq_group, tonnes=total_tonnes) %>% 
  mutate(iso3c = countrycode(country, origin="country.name", destination = "iso3c")) %>% 
  mutate(category1_production = paste(species, "_meat", sep = ""),
         category2_production = "mariculture") %>% 
  select(-country, -species)

```


## Join products
```{r}

product_tonnes <- rbind(livestock_iso3c, marine_fish, total_feed, crop_tonnes, fresh_fish, mariculture)

# get global conversion rates (not sure I need anymore):
conversion <- product_tonnes %>%
  filter(category2_production != "marine_fisheries") %>%
  group_by(category2_production) %>%
  summarize(total = sum(tonnes, na.rm=TRUE)) %>%
  mutate(product = ifelse(grepl("feed", category2_production), "feed", "animal_product")) %>%
  mutate(category2_production = gsub("feed_", "", category2_production)) %>%
  spread(product, total) %>%
  mutate(cr = feed/animal_product) %>%
  mutate(category2_production = paste("feed_", category2_production, sep="")) %>%
  select(category2_production, cr)


```


### Get costs

### livestock, marine fisheries, livestock feed
```{r}

pressures <- read_csv("/home/shares/food-systems/Food_footprint/all_food_systems/analysis/raw_df_summary/rgn_raw_summary.csv")
filter(pressures, organism=="cows", product=="meat", iso3c=="USA") %>% data.frame()

pressures <- pressures %>%
  group_by(iso3c, organism, product, pressure) %>%
  summarize(pressure_value = sum(sum, na.rm=TRUE)) %>%
  mutate(category1_production = paste(organism, product, sep="_")) 
 # filter(!(category1_production %in% c("fish_meat", "salmon_meat"))) %>%
 # filter(category1_production != "fofm_meat")
  

## divide backyard chicken pressures equally between meat/eggs. 
pressures_chickens <- pressures %>%
  filter(category1_production == "chickens_eggs&meat") %>%
  mutate(pressure_value = pressure_value/2) 

pressures_chickens_eggs <- pressures_chickens %>%
  mutate(product = "eggs",
         category1_production = "chickens_eggs")
pressures_chickens_meat <- pressures_chickens %>%
  mutate(product = "meat",
         category1_production = "chickens_meat")

## update the backyards:
pressures_chicken_update <- pressures %>%
  filter(category1_production != "chickens_eggs&meat") %>%
  rbind(pressures_chickens_meat) %>%
  rbind(pressures_chickens_eggs)


setdiff(pressures_chicken_update$category1_production, product_tonnes$category1_production) # 
setdiff(product_tonnes$category1_production, pressures_chicken_update$category1_production) # no feed with current method of summarizing

```

## combine and rescale pressures
```{r}

category_list <- product_tonnes %>%
  select(category1_production, category2_production) %>%
  unique()

rescaling_values <- read_csv(here("_analysis/rescale_values.csv")) 

pressures_summary <- pressures_chicken_update %>%
  left_join(rescaling_values, by="pressure") %>%
  rowwise() %>%
  mutate(pressure_rescaled = pressure_value/global_total) %>%
  left_join(category_list, by="category1_production") 

```


### Summarize pressures at lower resolution and compare production vs. pressures

```{r}

pressures_summary_lowres <- pressures_summary %>%
  group_by(iso3c, category2_production) %>%
  summarize(cumulative_pressure = sum(pressure_rescaled, na.rm=TRUE)) %>%
  ungroup()

tmp <- filter(pressures_summary_lowres, iso3c=="USA") %>% data.frame()
sum(tmp$cumulative_pressure)/4

product_lowres <- product_tonnes %>%
  group_by(iso3c, category2_production) %>%
  summarize(tonnes = sum(tonnes, na.rm=TRUE)) %>%
  ungroup()
tmp <- filter(product_lowres, iso3c=="USA") %>% data.frame()

cp_rate <- left_join(pressures_summary_lowres, product_lowres, by=c("iso3c", "category2_production")) %>%
  filter(!is.na(tonnes)) %>%
    filter(!is.na(cumulative_pressure)) %>%
  filter(cumulative_pressure>0) %>%
    filter(tonnes>2000) %>%
  rowwise() %>%
  mutate(pressure_per_tonne = cumulative_pressure/tonnes * 1000000)

cp_rate %>%
group_by(category2_production) %>%
  summarize(mean = mean(pressure_per_tonne),
            sd = sd(pressure_per_tonne))

tmp <- filter(cp_rate, pressure_per_tonne>=0.05) %>%data.frame()

ggplot(filter(cp_rate, pressure_per_tonne<0.05), aes(x=category2_production, y=pressure_per_tonne)) +
  geom_boxplot(outlier.fill=NA, outlier.colour = NA) +
  geom_jitter(alpha=0.2) +
  theme_cowplot() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) 

ggplot(cp_rate, aes(x=category2_production, y=pressure_per_tonne)) +
  geom_boxplot(outlier.fill=NA, outlier.colour = NA) +
  geom_jitter(alpha=0.2) +
  theme_cowplot() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) 

```


### Look at crop pressures

```{r}

pressures_summary_crops <- pressures_summary %>%
  group_by(iso3c, category1_production) %>%
  summarize(cumulative_pressure = sum(pressure_rescaled, na.rm=TRUE)) %>%
  ungroup() %>%
  separate(col=category1_production, c("organism", "product"), sep="_") %>%
  filter(product == "produce")

tmp <- filter(pressures_summary_crops, iso3c=="USA") %>% data.frame()

product_crops <- product_tonnes %>%
  group_by(iso3c, category1_production) %>%
  summarize(tonnes = sum(tonnes, na.rm=TRUE)) %>%
  ungroup() %>%
  filter(., !grepl("feed",category1_production)) %>%
  separate(col=category1_production, c("organism", "product"), sep="_") %>%
  filter(product == "produce")

tmp <- filter(product_crops, iso3c=="USA") %>% data.frame()

cp_rate_crops <- left_join(pressures_summary_crops, product_crops, by=c("iso3c", "organism", "product")) %>%
  filter(!is.na(tonnes)) %>%
    filter(!is.na(cumulative_pressure)) %>%
  filter(cumulative_pressure>0) %>%
    filter(tonnes>0) %>%
  rowwise() %>%
  mutate(pressure_per_tonne = cumulative_pressure/tonnes * 1000000)

cp_rate_crops %>%
group_by(organism) %>%
  summarize(mean = mean(pressure_per_tonne),
            sd = sd(pressure_per_tonne))

tmp <- filter(cp_rate_crops, pressure_per_tonne>=0.005) %>%data.frame()

ggplot(cp_rate_crops, aes(x=organism, y=pressure_per_tonne)) +
  geom_boxplot(outlier.fill=NA, outlier.colour = NA) +
  geom_jitter(alpha=0.2) +
  theme_cowplot() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) 
```

Analyze cuttoff values
```{r}
crops_quant <- quantile(cp_rate_crops$pressure_per_tonne,
         c(0.9, 0.95, 0.97, 0.99) )
crops_quant_99 <- crops_quant[4]

## 0.9 = 0.001201986
## 0.95 = 0.001649889 
## 0.97 = 0.002101525
## 0.99 = 0.003342047 
  
order_crop <- cp_rate_crops %>%
  filter(pressure_per_tonne <= crops_quant_99) %>% 
  group_by(organism) %>%
  summarize(mean = mean(pressure_per_tonne)) %>% 
  arrange(mean)

cp_rate_crops$organism <- factor(cp_rate_crops$organism, levels = order_crop$organism)

crop_box <- ggplot(filter(cp_rate_crops, pressure_per_tonne<=crops_quant_99), aes(x=organism, y=pressure_per_tonne)) +
  geom_boxplot(outlier.fill=NA, outlier.colour = NA) +
  geom_jitter(alpha=0.2, width = 0.2) +
  theme_minimal() +
  coord_flip() +
  labs(x = "", y = "")

out_crops <-cp_rate_crops %>% 
  filter(pressure_per_tonne > crops_quant_99)

add_in <- setdiff(cp_rate_crops$organism, out_crops$organism) %>% 
  as_tibble() %>% 
  rename(organism = value) %>% 
  mutate(iso3c = NA, product = "produce", cumulative_pressure = NA, tonnes = NA, pressure_per_tonne = NA)

out_crops <- rbind(out_crops, add_in)
out_crops$organism <- factor(out_crops$organism, levels = order_crop$organism)

crop_out <- ggplot(out_crops, aes(x=organism, y=pressure_per_tonne)) +
 # geom_point()+
  geom_jitter(alpha=0.2, width = 0.1) +
  theme_minimal() +
  coord_flip() +
  labs(x = "", y = "")+
  theme(axis.text.y = element_blank())

```


### Look at fisheries

the mean pressure per ton for freshwater fisheries seems oddly high...

```{r}

fisheries_list <- c("fish", "demersal", "reef", "large-pelagic", "small-pelagic", "medium-pelagic", "benthic", "fofm")

pressures_summary_fisheries <- pressures_summary %>%
  group_by(iso3c, category1_production) %>%
  summarize(cumulative_pressure = sum(pressure_rescaled, na.rm=TRUE)) %>%
  ungroup() %>%
  separate(col=category1_production, c("organism", "product"), sep="_") %>%
  filter(organism %in% fisheries_list)

tmp <- filter(pressures_summary_fisheries, iso3c=="USA") %>% data.frame()

product_fisheries <- product_tonnes %>%
  group_by(iso3c, category1_production) %>%
  summarize(tonnes = sum(tonnes, na.rm=TRUE)) %>%
  ungroup() %>%
  filter(., !grepl("feed",category1_production)) %>%
  separate(col=category1_production, c("organism", "product"), sep="_") %>%
  filter(organism %in% fisheries_list)

tmp <- filter(product_fisheries, iso3c=="USA") %>% data.frame()

cp_rate_fisheries <- left_join(pressures_summary_fisheries, product_fisheries, by=c("iso3c", "organism", "product")) %>%
  filter(!is.na(tonnes)) %>%
    filter(!is.na(cumulative_pressure)) %>%
  filter(cumulative_pressure>0) %>%
    filter(tonnes>0) %>%
  rowwise() %>%
  mutate(pressure_per_tonne = cumulative_pressure/tonnes * 1000000)

cp_rate_fisheries %>%
group_by(organism) %>%
  summarize(mean = mean(pressure_per_tonne),
            sd = sd(pressure_per_tonne))

tmp <- filter(cp_rate_fisheries, pressure_per_tonne>=0.005) %>% data.frame()

ggplot(cp_rate_fisheries, aes(x=organism, y=pressure_per_tonne)) +
  geom_boxplot(outlier.fill=NA, outlier.colour = NA) +
  geom_jitter(alpha=0.2) +
  theme_cowplot() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) 

```


```{r}
fisheries_quant <- quantile(cp_rate_fisheries$pressure_per_tonne,
         c(0.9, 0.95, 0.97, 0.99) )
fish_quant_9 <- fisheries_quant[1]

## 0.9 = 0.03993758
## 0.95 =  0.13658155
## 0.97 = 0.31093058 
## 0.99 = 5.05997525 

cp_rate_fisheries <- cp_rate_fisheries %>% 
  mutate(organism = ifelse(organism == "fofm", "forage fish", 
                           ifelse(organism == "fish", "river fish", organism)))
  
order_fish <- cp_rate_fisheries %>%
  filter(pressure_per_tonne <= fish_quant_9) %>% 
  group_by(organism) %>%
  summarize(mean = mean(pressure_per_tonne)) %>% 
  arrange(mean)

tidy_fish <- cp_rate_fisheries %>% 
  filter(pressure_per_tonne<= fish_quant_9)

tidy_fish$organism <- factor(tidy_fish$organism, levels = order_fish$organism)

fish_box <- ggplot(tidy_fish, aes(x=organism, y=pressure_per_tonne)) +
  geom_boxplot(outlier.fill=NA, outlier.colour = NA) +
  geom_jitter(alpha=0.2, width = 0.2) +
  theme_minimal() +
  coord_flip() +
  labs(x = "", y = "")

fish_out <- ggplot(filter(cp_rate_fisheries, pressure_per_tonne>fish_quant_9 & pressure_per_tonne < 10), aes(x=organism, y=pressure_per_tonne)) +
 # geom_point()+
  geom_jitter(alpha=0.2, width = 0.1) +
  theme_minimal() +
  coord_flip() +
  labs(x = "", y = "") +
  theme(axis.text.y = element_blank())

```


### Look at mariculture 

```{r}

mariculture_list <- c("salmon", "shrimp")

pressures_summary_mariculture <- pressures_summary %>%
  group_by(iso3c, category1_production) %>%
  summarize(cumulative_pressure = sum(pressure_rescaled, na.rm=TRUE)) %>%
  ungroup() %>%
  separate(col=category1_production, c("organism", "product"), sep="_") %>%
  filter(organism %in% mariculture_list)

tmp <- filter(pressures_summary_mariculture, iso3c=="USA") %>% data.frame()

product_mariculture <- product_tonnes %>%
  group_by(iso3c, category1_production) %>%
  summarize(tonnes = sum(tonnes, na.rm=TRUE)) %>%
  ungroup() %>%
  filter(., !grepl("feed",category1_production)) %>%
  separate(col=category1_production, c("organism", "product"), sep="_") %>%
  filter(organism %in% mariculture_list)

tmp <- filter(product_mariculture, iso3c=="USA") %>% data.frame()

cp_rate_mariculture <- left_join(pressures_summary_mariculture, product_mariculture, by=c("iso3c", "organism", "product")) %>%
  filter(!is.na(tonnes)) %>%
    filter(!is.na(cumulative_pressure)) %>%
  filter(cumulative_pressure>0) %>%
    filter(tonnes>0) %>%
  rowwise() %>%
  mutate(pressure_per_tonne = cumulative_pressure/tonnes * 1000000)

cp_rate_mariculture %>%
group_by(organism) %>%
  summarize(mean = mean(pressure_per_tonne),
            sd = sd(pressure_per_tonne))

tmp <- filter(cp_rate_mariculture, pressure_per_tonne>=0.005) %>% data.frame()

ggplot(cp_rate_mariculture, aes(x=organism, y=pressure_per_tonne)) +
  geom_boxplot(outlier.fill=NA, outlier.colour = NA) +
  geom_jitter(alpha=0.2) +
  theme_cowplot() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) 

```

```{r}
mariculture_quant <- quantile(cp_rate_mariculture$pressure_per_tonne,
         c(0.9, 0.95, 0.97, 0.99) )
mari_quant_99 <- mariculture_quant[4]

## 0.9 = 0.02032387
## 0.95 = 0.03431528
## 0.97 = 0.03882722 
## 0.99 = 0.04333916 

order_mari <- cp_rate_mariculture %>%
  filter(pressure_per_tonne <= mari_quant_99) %>% 
  group_by(organism) %>%
  summarize(mean = mean(pressure_per_tonne)) %>% 
  arrange(mean)

mari_tidy$organism <- factor(mari_tidy$organism, levels = order_mari$organism)

mari_box <- ggplot(filter(cp_rate_mariculture, pressure_per_tonne <= mari_quant_99), aes(x=organism, y=pressure_per_tonne)) +
  geom_boxplot(outlier.fill=NA, outlier.colour = NA) +
  geom_jitter(alpha=0.2, width = 0.2) +
  theme_minimal() +
  coord_flip() +
  labs(x = "", y = "")

outlier_mari <- cp_rate_mariculture %>% 
  filter(pressure_per_tonne > mari_quant_99) 

outlier_mari$organism <- factor(outlier_mari$organism, levels = order_mari$organism)

mari_out <- ggplot(outlier_mari, aes(x=organism, y=pressure_per_tonne)) +
  geom_jitter(alpha=0.2, width = 0.1) +
  theme_minimal()  +
 # xlim(c(0, 0.05)) +
  coord_flip() +
  labs(x = "", y = "") 
  theme(axis.text.y.left  = element_blank()) 
  
```



### Look at livestock 

groups:  cows_meat, cows_milk, buffalo_milk, goats_milk, goats_meat, sheep_milk, sheep_meat, chickens_eggs, chickens_meat, pigs_meat
```{r}

categories <- read_csv(here("_analysis/figures/paper/data/grouping_naming_structure.csv"))

livestock_list <- c("cows_meat", "cows_milk", "buffaloes_milk", "goats_milk", "goats_meat", "sheep_milk", "sheep_meat", "chickens_eggs", "chickens_meat", "pigs_meat")

pressures_summary_livestock <- pressures_summary %>%
  group_by(iso3c, category1_production) %>%
  summarize(cumulative_pressure = sum(pressure_rescaled, na.rm=TRUE)) %>%
  ungroup() %>%
  filter(category1_production %in% livestock_list) 

tmp <- filter(pressures_summary_livestock, iso3c=="USA") %>% data.frame()

product_livestock <- product_tonnes %>%
  group_by(iso3c, category1_production) %>%
  summarize(tonnes = sum(tonnes, na.rm=TRUE)) %>%
  ungroup() %>%
  filter(., !grepl("feed",category1_production))%>%
  filter(category1_production %in% livestock_list)

tmp <- filter(product_livestock, iso3c=="USA") %>% data.frame()

cp_rate_livestock <- left_join(pressures_summary_livestock, product_livestock, by=c("iso3c", "category1_production")) %>%
  filter(!is.na(tonnes)) %>%
    filter(!is.na(cumulative_pressure)) %>%
  filter(cumulative_pressure>0) %>%
    filter(tonnes>0) %>%
  rowwise() %>%
  mutate(pressure_per_tonne = cumulative_pressure/tonnes * 1000000)

cp_rate_livestock %>%
group_by(category1_production) %>%
  summarize(mean = mean(pressure_per_tonne),
            sd = sd(pressure_per_tonne))

tmp <- filter(cp_rate_livestock, pressure_per_tonne>=0.005) %>% data.frame()

ggplot(cp_rate_livestock, aes(x=category1_production, y=pressure_per_tonne)) +
  geom_boxplot(outlier.fill=NA, outlier.colour = NA) +
  geom_jitter(alpha=0.2) +
  theme_cowplot() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) 

```


Play with cutoffs and how to visualize the box plot and outliers
```{r}
livestock_quant <- quantile(cp_rate_livestock$pressure_per_tonne,
         c(0.9, 0.95, 0.97, 0.99) )
## 0.9 = 0.02154786
## 0.95 = 0.03220418
## 0.97 = 0.04772172 
## 0.99 = 0.09754400 

livestock_quant_99 <- livestock_quant[4]

livestock_tidy <- cp_rate_livestock %>% 
  mutate(category1_production = str_replace(category1_production, "_", " "))

order_live <- cp_rate_livestock %>%
  filter(pressure_per_tonne <= livestock_quant_99) %>% 
  mutate(category1_production = str_replace(category1_production, "_", " ")) %>% 
  group_by(category1_production) %>%
  summarize(mean = mean(pressure_per_tonne)) %>% 
  arrange(mean)

livestock_tidy$category1_production <- factor(livestock_tidy$category1_production, levels = order_live$category1_production)
  
live_box <- ggplot(filter(livestock_tidy, pressure_per_tonne < livestock_quant_99), aes(x=category1_production, y=pressure_per_tonne)) +
  geom_boxplot(outlier.fill=NA, outlier.colour = NA) +
  geom_jitter(alpha=0.2, width = 0.2) +
  theme_minimal() +
  coord_flip() +
  labs(x = "", y = "")

outlier_livestock_tidy <- livestock_tidy %>% 
  filter(pressure_per_tonne >= livestock_quant_99,
         pressure_per_tonne <1) %>% ## cows and buffaloes milk needs to be added back in 
  add_row(iso3c = NA, category1_production = "cows milk", cumulative_pressure = NA, tonnes = NA, pressure_per_tonne = NA) %>% 
  add_row(iso3c = NA, category1_production = "buffaloes milk", cumulative_pressure = NA, tonnes = NA, pressure_per_tonne = NA)

outlier_livestock_tidy$category1_production <- factor(outlier_livestock_tidy$category1_production, levels = order_live$category1_production)

live_out <- ggplot(outlier_livestock_tidy, aes(x=category1_production, y=pressure_per_tonne)) +
  geom_jitter(alpha=0.2, width = 0.1) +
  theme_minimal() +
  coord_flip() +
  labs(x = "", y = "") +
  theme(axis.text.y = element_blank())
  
```

```{r}
library(patchwork)

(live_box + live_out + plot_layout(widths = c(3.5, 1)))  /
(crop_box + crop_out + plot_layout(widths = c(3.5, 1))) /
(fish_box + fish_out + plot_layout(widths = c(3.5, 1))) /
(mari_box + mari_out + plot_layout(widths = c(3.5, 1))) 

ggsave(here("_analysis/figures/paper/output/figure_5_boxplots.png"), height=13, width=9, units=c("in"))

```

