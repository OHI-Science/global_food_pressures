---
title: 'Figure 4: Food efficiencies per cumulative environmental stressors'
author: "Juliette"
date: "11/17/2020"
output: html_document
---

Figure 4. Food efficiencies per cumulative environmental stressors. a) X/Y plot of global production vs. total pressures - each food is a point (color coded by food group), the points above the 1:1 line have higher efficiency per CI; b) similar plot but each country is a point (total production vs. pressures from all foods on land and in EEZ) 


- Need to clean up the FAO livestock products
- summary stats for crops -> will need a df of just the amount that goes towards human consumption right? ask mel for this
- summary stats for aquaculture
- Where are the marine wild fisheries total tonnage wild fisheries?
- freshwater fisheries

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(here)
library(readxl)
source(here("_workflow/common.R"))
source(here("_workflow/common_spatial.R"))

livestock_product_raw <- read_csv(here("_analysis/figures/SI/data/fao_all_production_types.csv"))
```


Clean up the livestock product data
```{r}

livestock_product <- livestock_product_raw %>% 
  filter(Element == "Production") %>% 
  group_by(Item, combo, product, animal) %>% 
  dplyr::summarise(tonnes = sum(Value, na.rm = TRUE)) %>% 
  ungroup() %>% 
  filter(animal %in% c("hen", "chicken", "cattle", "cow", "sheep", "goat", "buffalo", "pig"),
         combo != "buffalo-meat") %>% 
  mutate(combo = ifelse(combo == "hen-eggs", "chicken-eggs",
                         ifelse(combo == "cattle-meat", "cow-meat", combo))) %>% 
  select(product = combo, tonnes)

```

Global summary stats for crops 

```{r}
human_consumed <- read_csv(here("_analysis/figures/paper/data/crop_human_consump_inclusion.csv")) %>% 
  filter(!is.na(Item))
fbs_raw <- read_csv(file.path(raw, "FAO_FoodBalanceSheets/d2020/FoodBalanceSheets_E_All_Data_(Normalized).csv"))

crops <- fbs_raw %>% 
  filter(Element == "Food",
         Year == 2017) %>% #this doesnt include tourist consumption; should we include?
  left_join(human_consumed, by ="Item") %>% 
  filter(Include_consumption == "yes") %>% 
  group_by(food_group_1, food_group_short_1) %>% 
  dplyr::summarise(tonnes_1000 = sum(Value)) %>% 
  ungroup() %>% 
  mutate(tonnes = tonnes_1000*1000) %>% 
  select(product = food_group_1, tonnes) 


```

Global Summary stats for aquaculture

right now we onlyhave shrimp and salmon; will need to change this when we include more (probably this: ~/github/food_systems/aquaculture/marine/salmon/salmon_farm/data/fao_mariculture_clean.csv)
```{r}
shrimp_prod<- read_csv(here("aquaculture/marine/shrimp/shrimp_farms/data/fao_mariculture_shrimp_taxa_production.csv")) %>% 
  dplyr::summarise(tonnes = sum(value)) %>% 
  mutate(product = "mariculture-shrimp") 

salmon_prod <- read_csv(here("aquaculture/marine/salmon/salmon_farm/data/fao_mariculture_salmon.csv")) %>% 
  filter(year == 2017) %>% 
  dplyr::summarise(tonnes = sum(fao_tonnes_production)) %>% 
  mutate(product = "mariculture-salmon")
                       
```

Freshwater fisheries 
```{r}
fresh_fish_raster <- raster(file.path(prep, "fisheries/freshwater/fnl_catch.tif")) 
fresh <- cellStats(fresh_fish_raster, stat = 'sum') %>% 
  as_tibble() %>% 
  rename(tonnes = value) %>% 
  mutate(product = "fisheries-freshwater")
```

Marine Fisheries 
```{r}
marine_fish_raster <- raster(file.path(prep, "fisheries/marine/ghg/watson_v5_emissions/catch_rasters/nofofm_tonnes_2017.tif"))
marine <- cellStats(marine_fish_raster, stat = 'sum')%>% 
  as_tibble() %>% 
  rename(tonnes = value) %>% 
  mutate(product = "fisheries-marine")
```


All production 
```{r}
## production
all_products <- rbind(livestock_product, salmon_prod, shrimp_prod, fresh, marine, crops)
```



## Get the CI country summaries
Now we want to get the CHI for each animal-product combo
```{r}

chi_fish <- data.frame(product=NA, chi=NA)

##will need to add in shrimp when the layers are rerun
fish_cat <- c("wildcaught_marine", "wildcaught_freshwater", "marine_salmon_aquaculture")
fish_files <- list.files(path = file.path("/home/shares/food-systems/Food_footprint/all_food_systems/analysis/_tif_equal_area_proj_per_cell_rescaled"), full.names = TRUE)

fish_files <- grep(paste0(fish_cat, collapse = "|"), fish_files, value=TRUE)

for(f in fish_cat){
  
#  f = fish_cat[3]
  files <- fish_files[fish_files %in% grep(paste0(f, collapse = "|"), fish_files, value = T)]
  
  stack <- stack(lapply(files, raster))
  map_sum <- sum(stack, na.rm = TRUE)
  
  global_total <- cellStats(map_sum, stat = 'sum') %>% 
    as_tibble() %>% 
    rename(chi = value) %>% 
    mutate(product = f)
  
  chi_fish <- rbind(chi_fish, global_total) %>% 
  filter(!is.na(product))
  
}

chi_fish <- chi_fish %>% 
  filter(!is.na(product)) %>% 
  mutate(product = case_when(product == "wildcaught_marine" ~"fisheries-marine",
                             product == "wildcaught_freshwater" ~ "fisheries-freshwater",
                             product == "marine_salmon_aquaculture" ~"mariculture-salmon"))

```


Now lets do livestock

Meat
```{r}

chi_meat <- data.frame(product=NA, chi=NA)

##meat
animal_list <- c("cow", "goat", "sheep", "chicken")

for(animal in animal_list) {
  
 # animal <- animal_list[4]
  
animal_files <- list.files(path = file.path("/home/shares/food-systems/Food_footprint/all_food_systems/analysis/_tif_equal_area_proj_per_cell_rescaled"), full.names = TRUE, pattern = animal)

animal_files <- grep("meat", animal_files, value=TRUE)
 
if(animal == "chicken"){
  
  backyard_files <- grep("eggs&meat", animal_files, value= TRUE)
  backyard_stack <-stack(lapply(backyard_files, raster))
  backyard_sum <- sum(backyard_stack, na.rm = TRUE)/2
  
  rest_files <- grep("eggs&meat", animal_files, value= TRUE, invert = TRUE)
  rest_stack <-stack(lapply(rest_files, raster))
  rest_sum <- sum(rest_stack, na.rm = TRUE)
  
  stack <- stack(backyard_sum, rest_sum)
  map_sum <-sum(stack, na.rm = TRUE)
  
  }else{

  stack <- stack(lapply(animal_files, raster))
  map_sum <- sum(stack, na.rm = TRUE)
  }
  
  global_total <- cellStats(map_sum, stat = 'sum') %>% 
    as_tibble() %>% 
    rename(chi = value) %>% 
    mutate(product = paste(animal, "meat", sep = "-"))
  
  chi_meat <- rbind(chi_meat, global_total) %>% filter(!is.na(product))

}

```

eggs
```{r}

chi_eggs <- data.frame(product=NA, chi=NA)

#eggs
animal_list <- c("chicken")

for(animal in animal_list) {
  
  animal <- animal_list[1]
  
animal_files <- list.files(path = file.path("/home/shares/food-systems/Food_footprint/all_food_systems/analysis/_tif_equal_area_proj_per_cell_rescaled"), full.names = TRUE, pattern = animal)

animal_files <- grep("eggs", animal_files, value=TRUE)
 
backyard_files <- grep("eggs&meat", animal_files, value= TRUE)
  backyard_stack <-stack(lapply(backyard_files, raster))
  backyard_sum <- sum(backyard_stack, na.rm = TRUE)/2
  
  rest_files <- grep("eggs&meat", animal_files, value= TRUE, invert = TRUE)
  rest_stack <-stack(lapply(rest_files, raster))
  rest_sum <- sum(rest_stack, na.rm = TRUE)
  
  stack <- stack(backyard_sum, rest_sum)
  map_sum <-sum(stack, na.rm = TRUE)

  global_total <- cellStats(map_sum, stat = 'sum') %>% 
    as_tibble() %>% 
    rename(chi = value) %>% 
    mutate(product = paste(animal, "eggs", sep = "-"))
  
  chi_eggs <- rbind(chi_eggs, global_total) %>% filter(!is.na(product))

}

```

milk
```{r}

chi_milk <- data.frame(product=NA, chi=NA)

#eggs
animal_list <- c("cow", "goat", "sheep", "buffalo")

for(animal in animal_list) {
  
 # animal <- animal_list[4]
  
animal_files <- list.files(path = file.path("/home/shares/food-systems/Food_footprint/all_food_systems/analysis/_tif_equal_area_proj_per_cell_rescaled"), full.names = TRUE, pattern = animal)
animal_files <- grep("milk", animal_files, value=TRUE)
 

  stack <- stack(lapply(animal_files, raster))
  map_sum <- sum(stack, na.rm = TRUE)
  
  global_total <- cellStats(map_sum, stat = 'sum') %>% 
    as_tibble() %>% 
    rename(chi = value) %>% 
    mutate(product = paste(animal, "milk", sep = "-"))
  
  chi_milk <- rbind(chi_milk, global_total) %>% filter(!is.na(product))

}

```

pigs
```{r}

animal_files <- list.files(path = file.path("/home/shares/food-systems/Food_footprint/all_food_systems/analysis/_tif_equal_area_proj_per_cell_rescaled"), full.names = TRUE, pattern = "pigs")
 
  stack <- stack(lapply(animal_files, raster))
  map_sum <- sum(stack, na.rm = TRUE)
  
  chi_pigs <- cellStats(map_sum, stat = 'sum') %>% 
    as_tibble() %>% 
    rename(chi = value) %>% 
    mutate(product = "pig-meat")


```

crops
```{r}

spam <- read_csv(here("crop/farm/data/MapSPAM_crop_info.csv")) %>% 
  select(SPAM_short_name, SPAM_full_name)

produce_list <- list.files(path = file.path("/home/shares/food-systems/Food_footprint/all_food_systems/analysis/_tif_equal_area_proj_per_cell_rescaled"), full.names = FALSE, pattern = "produce")

produce_list <- str_sub(produce_list, 22,25) 
produce_list <- unique(produce_list)

chi_produce <- data.frame(product=NA, chi=NA)

for(produce in produce_list) {
  
 # produce <- produce_list[25]
  
produce_files <- list.files(path = file.path("/home/shares/food-systems/Food_footprint/all_food_systems/analysis/_tif_equal_area_proj_per_cell_rescaled"), full.names = TRUE, pattern = produce)
 
  stack <- stack(lapply(produce_files, raster))
  map_sum <- sum(stack, na.rm = TRUE)
  
  sum_df <- cellStats(map_sum, stat = 'sum') %>% 
    as_tibble() %>% 
    rename(chi = value) %>% 
    mutate(product = produce) 
  
  chi_produce <- rbind(chi_produce, sum_df) %>% filter(!is.na(product)) 
  
}


mapspam_to_food_grouping <- produce_list %>% 
  as_tibble() %>% 
  rename(product_short = value) %>% 
  mutate(product = case_when(product_short %in% c("bana", "cnut", "plnt", "vege", "xfru", "coco") ~ "Fruits and Vegetables",
                             product_short %in% c("barl", "maiz", "ocer", "sorg", "whea", "xmil") ~ "Cereals and Grains",
                             product_short %in% c("cass", "orts", "pota", "sugb", "swpo", "yams") ~ "Starches and Roots",
                             product_short %in% c("oilp", "xoil") ~ "Oil Crops and Seeds",
                             product_short %in% c("rest") ~ "Rest",
                             product_short %in% c("rice") ~ "Rice",
                             product_short %in% c("soyb") ~ "Soy",
                             product_short %in% c("sugc") ~ "Sugar",
                             product_short %in% c("xpul") ~ "Pulses and Beans"))


chi_produce_group <- chi_produce %>% 
  rename(product_short = product) %>% 
  left_join(mapspam_to_food_grouping, by = "product_short") %>% 
  group_by(product) %>% 
  dplyr::summarise(chi = sum(chi)) %>% 
  ungroup()

```



all chi
```{r}

livestock_chi <- rbind(chi_meat, chi_milk, chi_eggs,chi_fish, chi_pigs, chi_produce_group)

#write_csv(all_chi, here("_analysis/figures/paper/data/combined_all_cummu_press.csv"))

chi_production <- all_products %>% 
  # haven't finished this chi yet, can include it when we do
  filter(product != "mariculture-shrimp") %>% 
  left_join(livestock_chi, by= "product") %>% 
  mutate(sub_type = case_when(product == "chicken-eggs" ~ "Chicken Eggs",
                          product %in% c("cow-meat", "goat-meat", "sheep-meat") ~ "Ruminant Meat",
                          product %in% "mariculture-salmon" ~ "Mariculture",
                          str_detect(product, "milk") ~ "Milk",
                          product %in% c("chicken-meat", "pig-meat") ~ "Non-Ruminant Meat",
                          product == "fisheries-freshwater" ~ "Freshwater Fisheries",
                          product == "fisheries-marine" ~ "Marine Fisheries",
                          T ~ product)) %>% 
  mutate(type = case_when(product %in% c("fisheries-freshwater", "fisheries-marine", "mariculture-salmon") ~ "Fisheries and Mariculture",
                          product %in% c("Cereals and Grains", "Fruits and Vegetables", "Oil Crops and Seeds", "Pulses and Beans", "Rest", "Rice", "Soy", "Sugar", "Starches and Roots") ~ "Human Crop Consumption",
                          T ~ "Livestock")) %>% 
  

write_csv(here("_analysis/figures/paper/data/cummu_pres_prod.csv"))

```

Plot

all on one
```{r}
library(hrbrthemes)

chi_production <- read_csv(here("_analysis/figures/paper/data/cummu_pres_prod.csv"))

ggplot(chi_production, aes(x = tonnes, y = chi, size = chi)) +
  geom_point(aes(color = type))+
  theme_ipsum() +
  geom_smooth(aes(group=type),
              method='lm', formula = y~x, se = FALSE)+
  labs(title = "Figure 4: Food Efficiencies per CI") +
  geom_text(aes(y = chi, x = tonnes, label = product), size = 3) +
  theme(legend.position = "none") +
  facet_wrap(vars(type))

point

#ggsave(here("_analysis/figures/paper/output/figure_4_food_efficiencies_per_CI.jpg"),width = 12, height = 6, dpi=300)

```

```{r}
library(hrbrthemes)
library(patchwork)
library(ggrepel)

chi_production <- read_csv(here("_analysis/figures/paper/data/cummu_pres_prod.csv"))

## fish
fish <- chi_production %>% 
  filter(type == "Fisheries and Mariculure")
fish_plot <- ggplot(fish, aes(x = tonnes, y = chi, color = product)) +
  geom_point() +
  theme_minimal() +
  geom_smooth(method='lm', formula = y~x, se = FALSE)+
  labs( x = "Tonnes Fishery and Mariculture Products") +
  geom_text_repel(aes(y = chi, x = tonnes, label = product, color = product), size = 3) +
  theme(legend.position = "none") + 
  geom_smooth(method = "lm", se = FALSE, color = "gray76", size = 0.5) 

## livestock
livestock <- chi_production %>% 
  filter(type == "Livestock")
livestock_plot <- ggplot(livestock, aes(x = tonnes, y = chi, color = product)) +
   geom_point() +
  theme_minimal() +
  labs(x = "Tonnes Livestock Products",
       y = " ") +
  geom_text_repel(aes(y = chi, x = tonnes, label = product, color = product), size = 3) +
  theme(legend.position = "none") +
  geom_smooth(method = "lm", se = FALSE, color = "gray76", size = 0.5) 

## crop
crop <- chi_production %>% 
  filter(type == "Human Crop Consumption")
crop_plot <- ggplot(crop, aes(x = tonnes, y = chi, color = product)) +
  geom_point() +
  theme_minimal() +
  geom_smooth(method = "lm", se = FALSE, color = "gray76", size = 0.5) +
  labs(y = "Cummulative Stressor",
        x = "Tonnes Human Crop Consumption") +
  geom_text_repel(aes(y = chi, x = tonnes, label = product, color = product), size = 3) +
  theme(legend.position = "none") 

combo <- crop_plot+livestock_plot+fish_plot

ggsave(here("_analysis/figures/paper/output/figure_4_food_efficiencies_per_CI.jpg"),width = 10, height = 7, dpi=300)

```











New plot/table

```{r}
library(gt)
beige <- "#FCF8EB"
blue <- "#D7E0DF"
brown <- "#E3D2B7"

chi_protein_2 <- chi_protein %>% 
  mutate(ratio = round(chi/tonnes_protein, digits = 4),
         numerator = ratio,
         denominator = 1) %>% 
  dplyr::arrange(desc(ratio)) %>% 
  unite(ci_tonnes_protein, c("numerator", "denominator"), sep = " : ")

table_df <- chi_protein_2 %>% 
  select(product, ci_tonnes_protein)

table <- table_df %>% 
  gt() %>% 
  tab_header(title = "Amount of Cummulative Impact for 1 tonne of protein") %>% 
  cols_label(product = "Product and Source",
             ci_tonnes_protein = "CI: Tonnes Protein") %>% 
  cols_align("center") %>% 
   tab_style(
       style = cell_fill(color = brown),
       locations = cells_body(rows = str_detect(product, "meat"))) %>% 
   tab_style(
       style = cell_fill(color = blue),
       locations = cells_body(rows = str_detect(product, "fisheries"))) %>% 
   tab_style(
       style = cell_fill(color = blue),
       locations = cells_body(rows = str_detect(product, "mariculture"))) %>% 
   tab_style(
       style = cell_fill(color = beige),
       locations = cells_body(rows = str_detect(product, "milk"))) %>% 
   tab_style(
       style = cell_fill(color = beige),
       locations = cells_body(rows = str_detect(product, "egg")))  

table

```












