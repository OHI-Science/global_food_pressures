---
title: 'Figure 3: Ranking Foods'
author: "Juliette"
date: "11/17/2020"
output: html_document
---

Figure 2. Ranking foods

a) radial plot of each country, with stacked bars for foods (by CI, so with 4 stressors summed up to CI) 

b) Stacked bar charts of CI by food group (vertical orientation), with component of each pressure as the stacked pieces. (note: this panel is similar to the results that LCAs give but stacking together into CI is new and important to present)


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(here)
library(hrbrthemes)
library(RColorBrewer)
library(colorspace)
library(scales)
library(colorspace)
source(here("_workflow/common.R"))

summary_df_raw <- read_csv(file.path("/home/shares/food-systems/Food_footprint/all_food_systems/analysis/raw_df_summary/rgn_raw_summary.csv")) %>%
  unite(name_long, 3:7, sep = "-", remove = FALSE)

rescaling_values <- read_csv(here("_analysis/rescale_values.csv"))

food_categories <- read_csv(here("_analysis/figures/paper/data/food_categories.csv")) %>%
  unite(name_long, 1:5, sep = "-")

```


Create DF that works for the circle plot
```{r}
summary_df <- summary_df_raw %>% 
  group_by(name_long, pressure) %>% 
  dplyr::summarise(pressure_sum = sum(sum)) %>% 
  left_join(rescaling_values, by = "pressure") %>% 
  ungroup() %>% 
  rowwise() %>% 
  mutate(prop_of_global = pressure_sum/global_total)  %>% 
  left_join(food_categories, by = "name_long") %>% 
  select(food_name_3, food_name_legend_3, food_groups = food_name_1, pressure, pressure_sum, global_total, prop_of_global)

## get georegion ranks
chi <- summary_df %>%
  group_by(food_groups, food_name_3) %>%
  summarize(chi = sum(prop_of_global, na.rm=TRUE)) %>%
  arrange(-chi)

rank_foodgroup <- chi %>%
  group_by(food_name_3) %>%
  summarize(sum_chi = sum(chi), ## we can also do it by mean
            count = length(chi)) %>%
  ungroup() %>%
  data.frame() %>%
  arrange(sum_chi)

rank_foodgroup$food_name_3 <- factor(rank_foodgroup$food_name_3, 
                                         levels=unique(rank_foodgroup$food_name_3))
chi$food_name_3 <- factor(chi$food_name_3, 
                                         levels=unique(rank_foodgroup$food_name_3))
```


``````{r}

### Organize the chi data and add a few extra variables to help plotting
# Including empty spaces to add a y-axes
rank_all_foods <- chi %>%
  arrange(food_name_3, chi) %>%
  data.frame()

#3 source name is now food_name_1
# ran the colors_food_category to get these colors loaded. if we like them we will need to throw that code in
source(here("_analysis/figures/paper/colors_food_category.R"))
jv_palette
scales::show_col(jv_palette)


source_name <- data.frame(source = c("aquaculture-disturbance", "aquaculture-ghg", "aquaculture-water", "aquaculture-nutrient",
                                     "fresh_fish-disturbance", "fresh_fish-ghg", "fresh_fish-water", "fresh_fish-nutrient",
                                     "livestock_second-disturbance", "livestock_second-ghg", "livestock_second-water", "livestock_second-nutrient",
                                     "marine_fishery-disturbance", "marine_fishery-ghg", "marine_fishery-water", "marine_fishery-nutrient",
                                     "livestock_meat-disturbance", "livestock_meat-ghg", "livestock_meat-water", "livestock_meat-nutrient",
                                     "human_crop_consump-disturbance", "human_crop_consump-ghg", "human_crop_consump-water", "human_crop_consump-nutrient",
                                     "animal_feed-disturbance", "animal_feed-ghg", "animal_feed-water", "animal_feed-nutrient"),
                          
                          ## this may be where i remove the part before the source later on
                            source_name = c("Aquaculture: Disturbance", "Aquaculture: GHG", "Aquaculture: Water", "Aquaculture: Nutrient",
                                     "Freshwater Fisheries: Disturbance", "Freshwater Fisheries: GHG", "Freshwater Fisheries: Water", "Freshwater Fisheries: Nutrient",
                                     "Livestock Secondary Products: Disturbance", "Livestock Secondary Products: GHG", "Livestock Secondary Products: Water", "Livestock Secondary Products: Nutrient",
                                     "Marine fisheries: Disturbance", "Marine fisheries: GHG", "Marine fisheries: Water", "Marine fisheries: Nutrient",
                                     "Livestock Meat: Disturbance", "Livestock Meat: GHG", "Livestock Meat: Water", "Livestock Meat: Nutrient",
                                     "Human Consumption Crops: Disturbance", "Human Consumption Crops: GHG", "Human Consumption Crops: Water", "Human Consumption Crops: Nutrient",
                                     "Animal Feed: Disturbance", "Animal Feed: GHG", "Animal Feed: Water", "Animal Feed: Nutrient"))

```

## circle part

```{r}
cutoff_value <-  0.5 # this doesnt actually cut anything off i just dont wanna mess with the code

pressures_adj_circle <- summary_df %>%
  unite(source, c("food_name_3", "pressure"), sep = "-", remove = FALSE) %>% 
  group_by(name_long) %>%
  mutate(chi = sum(prop_of_global, na.rm=TRUE)) %>%
  arrange(chi) %>% 
  ungroup() %>% 
 filter(chi<=cutoff_value)

##grab the highest country to highlight red and id where the circle ends and then side bar chart begins
highest_food_cat<- pressures_adj_circle[dim(pressures_adj_circle)[1], "name_long"]
pressures_highest_food_cat <- filter(pressures_adj_circle, name_long %in% highest_food_cat$name_long) #used below

# adjust the rank_rgn-adjust dataframe to match above
rank_all_foods_adj <- rank_all_foods %>%
  filter(name_long %in% pressures_adj_circle$name_long) 

# add empty space to create space in the circleplot for axes
 empty_bar <- 1
 to_add <- data.frame(matrix(NA, empty_bar, ncol(rank_all_foods_adj)) )
 colnames(to_add) = colnames(rank_all_foods_adj)
 to_add$name_long <- as.character(1:empty_bar)
 rank_all_foods_adj  <- rbind(to_add, rank_all_foods_adj)
 
 # some code to orient the name_long labels
sequence_length = length(unique(rank_all_foods_adj$name_long))
first_sequence = c(1:(sequence_length%/%2)) 
second_sequence = c((sequence_length%/%2+1):sequence_length) 
first_angles = c(90 - 180/length(first_sequence) * first_sequence)
second_angles = c(-90 - 180/length(second_sequence) * second_sequence)
rank_all_foods_adj$angle <- c(first_angles, second_angles)
rank_all_foods_adj$hjust <- c(rep(0, length(first_sequence)), 
                    rep(1, length(second_sequence)))

# color for region labels
rank_all_foods_adj <- rank_all_foods_adj %>%
  mutate(name_long = factor(name_long, unique(name_long))) %>%
  mutate(food_name_1 = factor(food_name_1, unique(food_name_1))) %>%
  mutate(color = "black") %>%
  mutate(color = ifelse(is.na(chi), "white", color))%>%
  mutate(color = ifelse(name_long %in% highest_food_cat$name_long, "red", color))

# get dataframe for food name 1 shift locations
rgn_shift <- rank_all_foods_adj %>%
  mutate(food_name_1 = ifelse(is.na(food_name_1), "tmp", food_name_1)) %>%
  mutate(food_name_1 = as.factor(food_name_1)) %>%
  mutate(region_shift = as.numeric(food_name_1) - lag(as.numeric(food_name_1)), default=first(as.numeric(food_name_1)))

rgn_shift <- which(rgn_shift$region_shift > 0)
rgn_shift <- c(1, rgn_shift) -0.5
rgn_shift <- data.frame(rgn_shift_x=rgn_shift,
                         food_name_1 = rank_foodgroup$food_name_1,
                         name_x= c(2, 15, 29, 38, 48, 63, 75), # 140; will proabbly need to go back and fix the location of these. there are 5 in the county ones, and 8 in food grouping
                         name_y=c(55, 55, 55, 55, 55, 55, 55))
rgn_shift <- rgn_shift %>%
   mutate(food_name_1 = as.character(food_name_1))

# # add some blanks rows to match the master region list
empty_bar2 <-10
to_add <-  data.frame( matrix(NA, empty_bar2*nlevels(as.factor(pressures_adj_circle$food_name_1)), ncol(pressures_adj_circle)) )
  colnames(to_add) <- colnames(pressures_adj_circle)
  to_add$food_name_1 <- rep(levels(as.factor(pressures_adj_circle$food_name_1)), each=empty_bar2)
  to_add$chi<-  0
  to_add$name_long <- as.character(rep(1:empty_bar2, nlevels(as.factor(pressures_adj_circle$food_name_1))))
  pressures_adj_circle <- rbind(to_add, pressures_adj_circle, to_add)

  pressures_adj_circle %>%
  group_by(food_name_1) %>%
  summarize(mean = mean(prop_of_global, na.rm=TRUE)) %>%
  arrange(mean)
  
  pressures_adj_circle <- pressures_adj_circle %>%
  left_join(source_name, by = "source")

pressures_adj_circle$source_name <- factor(pressures_adj_circle$source_name, levels=rev(source_name$source_name))
pressures_adj_circle$name_long <- factor(pressures_adj_circle$name_long, levels=unique(rank_all_foods_adj$name_long))
pressures_adj_circle$food_name_1 <- factor(pressures_adj_circle$food_name_1, 
                                         levels=unique(rank_foodgroup$food_name_1))

```


make the plot
```{r}


circle_theme <- theme(axis.line=element_blank(),
                      axis.text.y=element_blank(),
                      axis.ticks=element_blank(),
                      axis.title.x=element_blank(),
                      axis.title.y=element_blank(),
                      legend.position="none",
                      panel.background=element_blank(),
                      panel.border=element_blank(),
                      panel.grid.major=element_blank(),
                      panel.grid.minor=element_blank(),
                      plot.background=element_blank(),
                      axis.text.x = element_blank())

pressures_adj_circle_remove_unapl <- pressures_adj_circle  %>% 
  filter(chi>0)

ggplot(data=pressures_adj_circle, aes(x=name_long, y=prop_of_global, fill=source_name)) + 
  
  geom_bar(stat="identity") +
  
  # ## this adjust the inner circle size (ymin) and outer circle size (ymax), which can be expanded to include names
   geom_errorbar(aes(
       x     = 1, 
        ymin = -0.02,   # ymin  = -0.03 for when ocean bars stack inwards 
       ymax  = 0.11), 
       alpha = 0) +
      # Country name text placement
    geom_text(
      data = rank_all_foods_adj,
      aes(x     = name_long,
          y     = max(pressures_adj_circle$chi, na.rm=TRUE),
          label = name_long,
          angle = angle,
          hjust = hjust),
      inherit.aes = FALSE,
      fontface = "bold",
      alpha = 0.9,
      size = 4,
      color = rank_all_foods_adj$color) +

  # #georegion names
  # geom_text(
  #   data=rgn_shift,
  #   aes(y = 0.05, x = name_x, label = food_name_1),
  #   # aes(x=name_x,
  #   #     y=name_y,
  #   #     label=georegion),
  #   inherit.aes=FALSE, size=7) +

  # # # Scale bar circles
  # ## This adds the 0 line
      geom_segment(
        x = 0, 
         y = 0, 
         xend = dim(rank_all_foods_adj)[1]+1, 
         yend = 0, 
         fill = NULL,
        alpha = 1, color = "white", size = 0.1) + #color = "black for internal
  #    
  #  # Scale bar annotation, this adds the y-axis numbers
      # annotate("text", 
      #   x     = c(3, 3, 3), 
      #   y     = c(-50, 0, 50),
      #   label = c(50, 0, 50), 
      #   color = "darkgray", angle = -4, size = 6) +
  #     
  scale_color_identity() +
    # scale_fill_identity() +
  scale_fill_manual(values= rev(jv_palette), c("Aquaculture: Disturbance", "Aquaculture: GHG", "Aquaculture: Water", "Aquaculture: Nutrient",
                                     "Freshwater Fisheries: Disturbance", "Freshwater Fisheries: GHG", "Freshwater Fisheries: Water", "Freshwater Fisheries: Nutrient",
                                     "Livestock Secondary Products: Disturbance", "Livestock Secondary Products: GHG", "Livestock Secondary Products: Water", "Livestock Secondary Products: Nutrient",
                                     "Marine fisheries: Disturbance", "Marine fisheries: GHG", "Marine fisheries: Water", "Marine fisheries: Nutrient",
                                     "Livestock Meat: Disturbance", "Livestock Meat: GHG", "Livestock Meat: Water", "Livestock Meat: Nutrient",
                                     "Human Consumption Crops: Disturbance", "Human Consumption Crops: GHG", "Human Consumption Crops: Water", "Human Consumption Crops: Nutrient",
                                     "Animal Feed: Disturbance", "Animal Feed: GHG", "Animal Feed: Water", "Animal Feed: Nutrient")) +
  coord_polar() +
 circle_theme
  
ggsave(here("_analysis/figures/paper/output/fig_3a_circular_foods_stressor_global.png"), height=18, width=18, units=c("in"))
#bg="transparent"


```

