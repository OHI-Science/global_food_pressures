---
title: 'Figure 6: Food footprint equity'
author: "Juliette"
date: "11/17/2020"
output: html_document
---

Figure 6. Food footprint equity. Plot per capita country-level CI, CI vs. nutritional status (indicator), economic development status (or Gini Index?), food security index

NOTE: I have not gapfilled any of these figures yet

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(here)
library(hrbrthemes)
library(naniar)
library(plotly)
library(patchwork)
source(here("_workflow/common.R"))
source(here("_workflow/common_spatial.R"))

rgns <- raster(file.path(prep, "spatial/gall_peters/land_eez_rgns_gall_peters.tif"))
#plot(rgns)

chi <- raster("/home/shares/food-systems/Food_footprint/all_food_systems/analysis/stressor_summary/equal_area/rescaled/cumulative_stress/all_systems_cumulative_stress.tif")
plot(log(1+chi))

country_population <- read_csv(here("_analysis/figures/paper/data/population_region_count_2017.csv"))

```

```{r}

country_summary <- zonal(chi, rgns, fun = 'sum') %>% 
  data.frame() %>%
  rename(ID_0 = zone, chi = sum) %>%
  left_join(food_rgns, by="ID_0")

##rgn 500 and 10 have no iso3 associated with them but have chi

```

Human Development Index
```{r}
hdi_df <- read_csv(here("_analysis/figures/paper/data/hdi_ungf.csv"))

hdi <- left_join(hdi_df, country_summary, by = "iso3c")

label <- hdi %>% 
  arrange(-chi) %>% 
  head(10) %>% 
  pull(Country)

hdi_plot <- ggplot(hdi) +
  geom_point(aes(y = hdi_index, x = chi, color = Country))+
 # geom_miss_point(aes(x = hdi_index, y = chi, color = Country)) +
   theme_ipsum_es() +
  theme(legend.position = "none")+
  labs(title = "Human Development Index",
       subtitle = "jv note: makes more sense if we flip the x and y but  this way was easier to see the differences \n missing 55 countries",
       y = "HDI", x = "Cummulative Impact") +
  geom_text(aes(y = hdi_index, x = chi, label = Country), data = hdi[hdi$Country %in% label,])

#hdi_plot

ggsave(here("_analysis/figures/paper/output/figure_6_hdi.jpg"),width = 10, height = 7, dpi=300)

### per cap
hdi_per_cap <- left_join(hdi_df, country_summary, by = "iso3c") %>% 
  left_join(country_population, by = "iso3c") %>% 
  mutate(ci_per_cap = chi/population,
         ci_per_cap = ifelse(population == 0, 0, ci_per_cap)) %>% 
  filter(!is.na(hdi_index))

label_per_cap<- hdi_per_cap %>% 
  arrange(-ci_per_cap) %>% 
  head(10) %>% 
  pull(Country)

hdi_per_cap_plot <- ggplot(hdi_per_cap) +
  geom_point(aes(y = hdi_index, x = ci_per_cap, color = Country))+
 # geom_miss_point(aes(x = hdi_index, y = chi, color = Country)) +
   theme_ipsum_es() +
  theme(legend.position = "none")+
  labs(title = "Human Development Index",
       subtitle = "jv note: missing 55 countries",
       y = "HDI", x = "Cummulative Impact per capita")+
  geom_text(aes(y = hdi_index, x = ci_per_cap, label = Country), data = hdi_per_cap[hdi_per_cap$Country %in% label_per_cap,])

#hdi_plot

ggsave(here("_analysis/figures/paper/output/figure_6_hdi_per_cap.jpg"),width = 10, height = 7, dpi=300)

```



Social Progress Index
```{r}
spi_df <- read_csv(here("_analysis/figures/paper/data/spi_ungf.csv"))

spi <- left_join(spi_df, country_summary, by = "iso3c")

label <- spi %>% 
  arrange(-chi) %>% 
  head(10) %>% 
  pull(Country)

spi_plot <- ggplot(spi) +
  geom_point(aes(y = spi, x = chi, color = Country))+
 # geom_miss_point(aes(x = hdi_index, y = chi, color = Country)) +
   theme_ipsum_es() +
  theme(legend.position = "none")+
  labs(title = "Social Progress Index",
       subtitle = "jv note: makes more sense if we flip the x and y but  this way was easier to see the differences \n missing 54 countries",
       y = "SPI", x = "Cummulative Impact") +
  geom_text(aes(y = spi, x = chi, label = Country), data = spi[spi$Country %in% label,])

#spi_plot

ggsave(here("_analysis/figures/paper/output/figure_6_spi.jpg"),width = 10, height = 7, dpi=300)

### per cap
spi_per_cap <- left_join(spi, country_population, by = "iso3c") %>% 
  mutate(ci_per_cap = chi/population,
         ci_per_cap = ifelse(population == 0, 0, ci_per_cap)) %>% 
  filter(!is.na(spi))

label_per_cap<- spi_per_cap %>% 
  arrange(-ci_per_cap) %>% 
  head(10) %>% 
  pull(Country)

spi_per_cap_plot <- ggplot(spi_per_cap) +
  geom_point(aes(y = spi, x = ci_per_cap, color = Country))+
 # geom_miss_point(aes(x = hdi_index, y = chi, color = Country)) +
   theme_ipsum_es() +
  theme(legend.position = "none")+
  labs(title = "Social Progress Index",
       subtitle = "jv note: missing 54 countries",
       y = "SPI", x = "Cummulative Impact per capita") +
  geom_text(aes(y = spi, x = ci_per_cap, label = Country), data = spi_per_cap[spi_per_cap$Country %in% label_per_cap,])

#hdi_plot

ggsave(here("_analysis/figures/paper/output/figure_6_spi_per_cap.jpg"),width = 10, height = 7, dpi=300)
```

Food Security Index

```{r}
fsi_df <- read_csv(here("_analysis/figures/paper/data/fsi_ungf.csv"))

fsi <- left_join(fsi_df, country_summary, by = "iso3c")

label <- fsi %>% 
  arrange(-chi) %>% 
  head(10) %>% 
  pull(Country.x)

fsi_plot <- ggplot(fsi) +
  geom_point(aes(y = fsi_score, x = chi, color = Country.x)) +
 # geom_miss_point(aes(x = hdi_index, y = chi, color = Country)) +
   theme_ipsum_es() +
  theme(legend.position = "none")+
  labs(title = "Food Security Index",
       subtitle = "jv note: makes more sense if we flip the x and y but  this way was easier to see the differences \n missing 131 countries",
       y = "FSI", x = "Cummulative Impact") +
  geom_text(aes(y = fsi_score, x = chi, label = Country.x), data = fsi[fsi$Country.x %in% label,])

fsi_plot

ggsave(here("_analysis/figures/paper/output/figure_6_fsi.jpg"),width = 10, height = 7, dpi=300)


### per cap
fsi_per_cap <- left_join(fsi, country_population, by = "iso3c") %>% 
  mutate(ci_per_cap = chi/population,
         ci_per_cap = ifelse(population == 0, 0, ci_per_cap)) %>% 
  filter(!is.na(fsi_score))

label_per_cap<- fsi_per_cap %>% 
  arrange(-ci_per_cap) %>% 
  head(10) %>% 
  pull(Country.x)

fsi_per_cap_plot <- ggplot(fsi_per_cap) +
  geom_point(aes(y = fsi_score, x = ci_per_cap, color = Country.x))+
 # geom_miss_point(aes(x = hdi_index, y = chi, color = Country)) +
   theme_ipsum_es() +
  theme(legend.position = "none")+
  labs(title = "Food Security Index",
       subtitle = "jv note: missing 131 countries",
       y = "FSI", x = "Cummulative Impact per capita")+
  geom_text(aes(y = fsi_score, x = ci_per_cap, label = Country.x), data = fsi_per_cap[fsi_per_cap$Country.x %in% label_per_cap,])

ggsave(here("_analysis/figures/paper/output/figure_6_fsi_per_cap.jpg"),width = 10, height = 7, dpi=300)

```


GINI Index

```{r}
gini_df <- read_csv(here("_analysis/figures/paper/data/gini_ungf.csv"))

gini <- left_join(gini_df, country_summary, by = "iso3c")

label <- gini %>% 
  arrange(-chi) %>% 
  head(10) %>% 
  pull(Country)

gini_plot <- ggplot(gini) +
  geom_point(aes(y = gini_index, x = chi, color = Country)) +
 # geom_miss_point(aes(x = hdi_index, y = chi, color = Country)) +
   theme_ipsum_es() +
  theme(legend.position = "none")+
  labs(title = "Gini Index",
       subtitle = "jv note: makes more sense if we flip the x and y but  this way was easier to see the differences \n missing 97 countries",
       y = "Gini", x = "Cummulative Impact") +
  geom_text(aes(y = gini_index, x = chi, label = Country), data = gini[gini$Country%in% label,])

#ggplotly(gini_plot)

ggsave(here("_analysis/figures/paper/output/figure_6_gini.jpg"),width = 10, height = 7, dpi=300)

### per cap
gini_per_cap <- left_join(gini, country_population, by = "iso3c") %>% 
  mutate(ci_per_cap = chi/population,
         ci_per_cap = ifelse(population == 0, 0, ci_per_cap)) %>% 
  filter(!is.na(gini_index))

label_per_cap<- gini_per_cap %>% 
  arrange(-ci_per_cap) %>% 
  head(10) %>% 
  pull(Country)

gini_per_cap_plot <- ggplot(gini_per_cap) +
  geom_point(aes(y = gini_index, x = ci_per_cap, color = Country))+
 # geom_miss_point(aes(x = hdi_index, y = chi, color = Country)) +
   theme_ipsum_es() +
  theme(legend.position = "none")+
  labs(title = "GINI Index",
       subtitle = "jv note: missing 97 countries",
       y = "GINI", x = "Cummulative Impact per capita") +
  geom_text(aes(y = gini_index, x = ci_per_cap, label = Country), data = gini_per_cap[gini_per_cap$Country %in% label_per_cap,])

ggsave(here("_analysis/figures/paper/output/figure_6_gini_per_cap.jpg"),width = 10, height = 7, dpi=300)

```


Beal et al Micronutrient Indices

    * Prevalence of Inadequate Micronutrient Intake Index (PIMII)
    * Micronutrient Density Index (MDI)
    * Per capita daily energy availability (PCDEA)
    
```{r}
beal_df <- read_csv(here("_analysis/figures/paper/data/beal_ungf.csv")) %>% 
  rename(iso3c = ISO3)

beal <- left_join(beal_df, country_summary, by = "iso3c")

fortified_beal <- beal %>% filter(Fortification == 1)
non_fortified_beal <- beal %>% filter(Fortification == 0)
```

Fortified
```{r}
##pimii
beal_fort_pimii_plot <- ggplot(fortified_beal) +
  geom_point(aes(y = PIMII, x = chi, color = Country.x)) +
 # geom_miss_point(aes(x = hdi_index, y = chi, color = Country)) +
   theme_ipsum_es() +
  theme(legend.position = "none") +
  labs(title = "Prevalence of Inadequate Micronutrient Intake Index (PIMII): \nIncluding fortification",
       subtitle = "jv note: data from 2011 \nmissing 77 countries",
       y = "PIMII (fortified)", x = "Cummulative Impact")

beal_fort_pimii_plot

ggsave(here("_analysis/figures/paper/output/figure_6_beal_fort_pimii.jpg"),width = 10, height = 7, dpi=300)

#Micronutrient Density Index (MDI)
beal_fort_mdi_plot <- ggplot(fortified_beal) +
  geom_point(aes(y = MDI, x = chi, color = Country.x),
             position = position_jitterdodge(jitter.height = 0.01)) +
 # geom_miss_point(aes(x = hdi_index, y = chi, color = Country)) +
   theme_ipsum_es() +
  theme(legend.position = "none") +
  labs(title = "Micronutrient Density Index (MDI): \nIncluding fortification",
       subtitle = "jv note: data from 2011 \nmissing 77 countries",
       y = "MDI (fortified)", x = "Cummulative Impact")

beal_fort_mdi_plot

ggsave(here("_analysis/figures/paper/output/figure_6_beal_fort_mdi.jpg"),width = 10, height = 7, dpi=300)

```

Non fortified
```{r}

##pimii
beal_non_fort_pimii_plot <- ggplot(non_fortified_beal) +
  geom_point(aes(y = PIMII, x = chi, color = Country.x)) +
 # geom_miss_point(aes(x = hdi_index, y = chi, color = Country)) +
   theme_ipsum_es() +
  theme(legend.position = "none") +
  labs(title = "Prevalence of Inadequate Micronutrient Intake Index (PIMII): \nNo fortification",
       subtitle = "jv note: data from 2011 \nmissing 77 countries",
       y = "PIMII (not fortified)", x = "Cummulative Impact")

beal_non_fort_pimii_plot

ggsave(here("_analysis/figures/paper/output/figure_6_beal_nonfort_pimii.jpg"),width = 10, height = 7, dpi=300)

#Micronutrient Density Index (MDI)
beal_nonfort_mdi_plot <- ggplot(non_fortified_beal) +
  geom_point(aes(y = MDI, x = chi, color = Country.x),
             position = position_jitterdodge(jitter.height = 0.01)) +
 # geom_miss_point(aes(x = hdi_index, y = chi, color = Country)) +
   theme_ipsum_es() +
  theme(legend.position = "none") +
  labs(title = "Micronutrient Density Index (MDI): \nNo fortification",
       subtitle = "jv note: data from 2011 \nmissing 77 countries",
       y = "MDI (not fortified)", x = "Cummulative Impact")

beal_nonfort_mdi_plot

ggsave(here("_analysis/figures/paper/output/figure_6_beal_nonfort_mdi.jpg"),width = 10, height = 7, dpi=300)

```

Plotly to look at all the plots
```{r}

library(plotly)

ggplotly(hdi_per_cap_plot)
ggplotly(spi_per_cap_plot)
ggplotly(fsi_per_cap_plot)
ggplotly(gini_per_cap_plot)


```

