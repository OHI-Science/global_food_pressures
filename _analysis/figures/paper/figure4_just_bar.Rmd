---
title: "figure_2_just_bar"
author: "Juliette"
date: "1/5/2021"
output: html_document
editor_options: 
  chunk_output_type: console
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(here)
library(hrbrthemes)
library(RColorBrewer)
library(colorspace)
source(here("_workflow/common.R"))
source(here("_workflow/common_spatial.R"))

summary_df_raw <- read_csv(file.path("/home/shares/food-systems/Food_footprint/all_food_systems/analysis/raw_df_summary/rgn_raw_summary.csv"))

rescaling_values <- read_csv(here("_analysis/rescale_values.csv"))

un_geopolitical <- read_csv(here("_spatial/_output/UNSD_Methodology.csv")) %>%
  dplyr::select(iso3c, georegion=Region_Name)

```


Create DF that works for the circle plot
```{r}
summary_df <- summary_df_raw %>% 
  mutate(origin = ifelse(category == "feedfofm", "marine", origin)) %>% 
  mutate(land_ocean = case_when(origin %in% c("land", "freshwater") ~ "land",
                                origin == "marine" ~ "ocean")) %>% 
  mutate(sum = ifelse(iso3c == "HSX" & category == "feedfodd", 0, sum)) %>% 
  group_by(country, iso3c, land_ocean, pressure) %>% 
  dplyr::summarise(pressure_sum = sum(sum)) %>% 
  left_join(rescaling_values, by = "pressure") %>% 
  ungroup() %>% 
  rowwise() %>% 
  mutate(prop_of_global = pressure_sum/global_total)  %>% 
  unite(source, c("land_ocean", "pressure"), sep = "-", remove = FALSE) %>% 
  left_join(un_geopolitical, by = "iso3c") %>% 
  mutate(georegion = ifelse(country == "High Seas", "High Seas", georegion))

## get georegion ranks
chi <- summary_df %>%
  group_by(georegion, country, iso3c) %>%
  summarize(chi = sum(prop_of_global, na.rm=TRUE)) %>%
  arrange(-chi)

rank_georgn <- chi %>%
  group_by(georegion) %>%
  summarize(sum_chi = sum(chi), ## we can also do it by mean
            count = length(chi)) %>%
  ungroup() %>%
  data.frame() %>%
  arrange(sum_chi)

rank_georgn$georegion <- factor(rank_georgn$georegion, 
                                         levels=unique(rank_georgn$georegion))
chi$georegion <- factor(chi$georegion, 
                                         levels=unique(rank_georgn$georegion))

### Organize the chi data and add a few extra variables to help plotting
# Including empty spaces to add a y-axes
rank_rgn <- chi %>%
  arrange(georegion, chi) %>%
  data.frame()
 
```

 
## Stuff for both plots
i think that this would look better with each stressor having its own color that is paired with ocean/land

pick 4 distinct colors and then create a pair with one being more brown or green and the other being more blue
```{r}

source_name <- data.frame(source = c("land-disturbance", "land-ghg", "land-water", "land-nutrient",
                                     "ocean-disturbance", "ocean-ghg", "ocean-water", "ocean-nutrient"),
                          ## this may be where i remove the part before the source later on
                            source_name = c("Land: Disturbance", "Land: GHG", "Land: Water", "Land: Nutrient",
                                     "Ocean: Disturbance", "Ocean: GHG", "Ocean: Water", "Ocean: Nutrient"))

dist_1 <- "#D5BD75"
dist_1 <- lighten(dist_1, amount = -0.05)
dist_2 <- "#FFEAB1"
dist_2 <- lighten(dist_2, amount = -0.05)

ghg_1 <- "#DA6098"
ghg_1 <- lighten(ghg_1, amount = -0.05)
ghg_2 <- "#FFCEE0"
ghg_2 <- lighten(ghg_2, amount = -0.05)

nut_1 <- "#795B48"
nut_2 <- "#E7C7B5"

wat_1 <- "#3E638E"
wat_2 <- "#C5F0FF"

jv_palette <- c(dist_1, ghg_1, nut_1, wat_1,
                dist_2, ghg_2, nut_2, wat_2)
scales::show_col(jv_palette, n = 4)
#dist, ghg, water, nut

pal_df <- as_tibble(jv_palette) %>% 
  rename(fill_value = value) %>% 
  mutate(source = case_when(fill_value == dist_1 ~ "land-disturbance",
                            fill_value == dist_2 ~ "ocean-disturbance",
                            fill_value == wat_1 ~ "land-water",
                            fill_value == wat_2 ~ "ocean-water",
                            fill_value == nut_1 ~ "land-nutrient",
                            fill_value == nut_2 ~ "ocean-nutrient",
                            fill_value == ghg_1 ~ "land-ghg",
                            fill_value == ghg_2 ~ "ocean-ghg")) 


```



```{r}
 ## modifiy region names to be shorter
 rank_rgn <- rank_rgn %>% 
   mutate(rgn_name_short = country, 
         rgn_name_short = gsub("Islands", "Isl", rgn_name_short),
         rgn_name_short = gsub("Island", "Isl", rgn_name_short),
         rgn_name_short = gsub("Democratic", "Dem", rgn_name_short),
         rgn_name_short = gsub("Republic", "Rep", rgn_name_short),
         rgn_name_short = gsub("South", "S", rgn_name_short),
         rgn_name_short = gsub("American", "Am", rgn_name_short),
         rgn_name_short = gsub("the United States", "US", rgn_name_short),
         rgn_name_short = gsub("Territory", "Terr", rgn_name_short),
         rgn_name_short = gsub("Saint", "St", rgn_name_short),
         rgn_name_short = gsub(" and ", " & ", rgn_name_short),
         rgn_name_short = gsub("Republique", "Rep", rgn_name_short),
         rgn_name_short = gsub("Dem Rep of the", "Dem Rep of", rgn_name_short),
         rgn_name_short = gsub("Georgia and the", "Georgia and", rgn_name_short),
         rgn_name_short = gsub("St Vincent and the", "St Vincent and", rgn_name_short),
         rgn_name_short = gsub("Howland Isl & Baker Isl", "Howland & Baker Isl", rgn_name_short),
         rgn_name_short = gsub("Northern", "N", rgn_name_short), 
         rgn_name_short = gsub("Reunion", "Reunion", rgn_name_short)) %>%
  arrange(-chi) %>%
  mutate(cumuluative_sum = cumsum(chi)/4)
```

The old version had 23 regions including the highseas
we will need to include 32 regions now for the high seas to make the cut. i am keeping it was 23 for this round

```{r}
cutoff_value <-  	0.040 # this is just the value that corresponds with the top 23 countries 

pressures_adj_circle <- summary_df %>%
  group_by(country, iso3c) %>%
  mutate(chi = sum(prop_of_global, na.rm=TRUE)) %>%
  ungroup() %>%
  arrange(chi) %>% 
 filter(chi<=cutoff_value)

##grab the highest country to highlight red and id where the circle ends and then side bar chart begins
highest_country <- pressures_adj_circle[dim(pressures_adj_circle)[1], "iso3c"]
pressures_highest_country <- filter(pressures_adj_circle, iso3c %in% highest_country$iso3c) #used below

# adjust the rank_rgn-adjust dataframe to match above
rank_rgn_adj <- rank_rgn %>%
  filter(iso3c %in% pressures_adj_circle$iso3c) 

# add empty space to create space in the circleplot for axes
 empty_bar <- 5
 to_add <- data.frame(matrix(NA, empty_bar, ncol(rank_rgn_adj)) )
 colnames(to_add) = colnames(rank_rgn_adj)
 to_add$country <- as.character(1:empty_bar)
 rank_rgn_adj  <- rbind(to_add, rank_rgn_adj)
 
```


Data for the points
```{r}
## protein and kcals
protein_cal <- read_csv(here::here("_efficiency/data/all_food_pressures_human_crop_consume.csv")) %>% 
  group_by(iso3c) %>% 
  dplyr::summarise(percent_prod_tonnes = sum(percent_tonnes),
                   percent_kcal = sum(percent_kcal),
                   percent_protein = sum(percent_protein)) %>% 
  ungroup()

```

Make the side bar chart
```{r}
pressures_adj_bar <- summary_df %>%
  group_by(country, iso3c) %>%
  mutate(chi = sum(prop_of_global, na.rm=TRUE)) %>%
  ungroup() %>%
  filter(chi>cutoff_value) %>%
  rbind(pressures_highest_country) %>%
  arrange(chi) %>% 
  left_join(pal_df, by = "source")

rank_rgn_adj_bar <- rank_rgn %>%
  filter(iso3c %in% pressures_adj_bar$iso3c)

# color for region labels
rank_rgn_adj_bar <- rank_rgn_adj_bar %>%
  mutate(country = factor(country, unique(country))) %>%
  mutate(georegion = factor(georegion, unique(georegion))) %>%
  mutate(color = "black") %>%
  mutate(color = ifelse(is.na(chi), "white", color))%>%
  mutate(color = ifelse(iso3c %in% highest_country$iso3c, "black", color)) %>%
  arrange(-chi) 

pressures_adj_bar <- pressures_adj_bar %>%
  left_join(source_name, by = "source")

pressures_adj_bar$source_name <- factor(pressures_adj_bar$source_name, levels=rev(source_name$source_name))
pressures_adj_bar$country <- factor(pressures_adj_bar$country, levels=unique(rank_rgn_adj_bar$country))


## some theme stuff to make the plot look nice
bar_theme <- theme(axis.line=element_blank(),
                      axis.text.y=element_blank(),
                      axis.ticks.y=element_blank(),
                 # axis.title.x=element_blank(),
                      axis.title.y=element_blank(),
              #        legend.position="none",
                      panel.background=element_blank(),
                      panel.border=element_blank(),
                      panel.grid.major=element_blank(),
                      panel.grid.minor=element_blank(),
                      plot.background=element_blank(),
                      legend.title = element_blank())
                     # axis.text.x = element_blank())

pressures_adj_bar <- pressures_adj_bar %>% 
  mutate(prop_of_global = prop_of_global/4) %>% 
  left_join(protein_cal, by = "iso3c")
  
fig2_bar_1 <- ggplot(data=pressures_adj_bar, aes(x=country, y=prop_of_global, fill= fill_value)) + ##fill= fill_values
  
  geom_bar(stat="identity") +
 # ylab(bquote(bold("Proportion of Global Environmental Pressures"))) +
   labs(y = "") +
  ## this adjust the plot dimensions, which can be expanded to include names
 geom_errorbar(aes(
      x     = 0,
        ymin  = -0.1,
        ymax  = 0),
        alpha = 0) +
  
      # Country name text placement
   geom_text(
      data = rank_rgn_adj_bar,
      aes(y = -0.01,
          x = 1:length(country),
          label = rgn_name_short),
      inherit.aes = FALSE,
  #    fontface = “bold”,
      alpha = 0.9,
      size = 3,
      color = rank_rgn_adj_bar$color,
      hjust = 1) +
  coord_flip() +
   # Scale bar annotation, this adds the y-axis numbers
      # annotate(
      #   "text",
      #   x     = c(-0.025, -0.025, -0.025),
      #   y     = c(0, 500, 1000),
      #   label = c(0, 500, 1000),
      #   color = "darkgray", size = 3) +
  scale_colour_identity() +
   scale_fill_identity() +
  bar_theme +
  geom_point(aes(x = country, y = percent_kcal), shape = 0, size = 2.5, color = "grey16")+
geom_point(aes(x = country, y = percent_protein), shape = 2 , size = 2.5, color = "grey16")+
    geom_point(aes(x = country, y = percent_prod_tonnes), shape = 1, size = 2.5, color = "grey16") +
  scale_y_continuous(breaks = c(0, 0.05, 0.10, 0.15),
                     labels = c(0, 0.05, 0.10, 0.15))

## 15 = squares, 16 = circles, 17 = triangle
## 0 = squares, 1 = circles, 2 = triangle

```




## now lets do the second bar chart
```{r}
summary_df_raw <- read_csv(file.path("/home/shares/food-systems/Food_footprint/all_food_systems/analysis/raw_df_summary/rgn_raw_summary.csv")) %>%
  unite(name_long, 3:7, sep = "-", remove = FALSE)

rescaling_values <- read_csv(here("_analysis/rescale_values.csv"))

food_categories_raw <- read_csv(here("_analysis/figures/paper/data/food_categories.csv"), col_names = TRUE) %>%
  unite(name_long, 1:5, sep = "-") 

food_categories <- food_categories_raw %>% 
  mutate(food_name_legend_2 = ifelse(food_name_legend_2 == "Chickens & Pigs Livestock Meat" & food_name_legend_3 == "Chicken", "Chicken Meat",
                                     ifelse(food_name_legend_2 == "Chickens & Pigs Livestock Meat" & food_name_legend_3 == "Pig", "Pig Meat",
                                            ifelse( food_name_legend_2 == "Ruminants Livestock Meat", "Ruminant Meat", food_name_legend_2)))) %>% 
  
  mutate(food_name_2 = ifelse(food_name_2 == "non_rum_livestock_meat" & food_name_legend_3 == "Chicken", "chicken_meat",
                                     ifelse(food_name_2 == "non_rum_livestock_meat" & food_name_legend_3 == "Pig", "pig_meat", food_name_2)))

un_geopolitical <- read_csv(here("_spatial/_output/UNSD_Methodology.csv")) %>%
  dplyr::select(iso3c, georegion=Region_Name)
```

```{r}
summary_df <- summary_df_raw %>%
    mutate(land_ocean = case_when(origin %in% c("land", "freshwater") ~ "land",
                                origin == "marine" ~ "ocean")) %>% 
  ##this is some weird artifact, very small value but impossible
 ## mutate(sum = ifelse(iso3c == "HSX" & category == "feedfodd", 0, sum)) %>% 
  left_join(food_categories, by = "name_long") %>% 
  group_by(iso3c, country, food_name_legend_2, food_name_2, pressure) %>%
    dplyr::summarise(pressure_sum = sum(sum)) %>% 
  left_join(rescaling_values, by = "pressure") %>% 
  ungroup() %>% 
  rowwise() %>% 
  mutate(prop_of_global = pressure_sum/global_total)  %>% 
  group_by(iso3c,country, food_name_legend_2, food_name_2) %>%
  dplyr::summarise(food_category_prop = sum(prop_of_global)) %>% 
  ungroup() %>% 
  left_join(un_geopolitical, by = "iso3c") %>% 
  mutate(georegion = ifelse(country == "High Seas", "High Seas", georegion))

## get georegion ranks
chi <- summary_df %>%
  group_by(georegion, country, iso3c) %>%
  summarize(chi = sum(food_category_prop, na.rm=TRUE)) %>%
  arrange(-chi)

rank_georgn <- chi %>%
  group_by(georegion) %>%
  summarize(sum_chi = sum(chi), ## we can also do it by mean
            count = length(chi)) %>%
  ungroup() %>%
  data.frame() %>%
  arrange(sum_chi)

rank_georgn$georegion <- factor(rank_georgn$georegion, 
                                         levels=unique(rank_georgn$georegion))
chi$georegion <- factor(chi$georegion, 
                                         levels=unique(rank_georgn$georegion))

### Organize the chi data and add a few extra variables to help plotting
# Including empty spaces to add a y-axes
rank_rgn <- chi %>%
  arrange(georegion, chi) %>%
  data.frame()
 
```



## Stuff for both plots
```{r}


## pick the colors
light_blue <- c("#3CC8C0")

dark_green <- c("#2B5F3D")
dark_green_grad <- lighten("#2B5F3D", amount = 0.4)

dark_blue <- c("#485178")

red <- c("#CB1C24")
red <- colorspace::lighten(red, amount = -0.2)
red_1 <- colorspace::lighten(red, amount = 0.4)
scales::show_col(red)
scales::show_col(red_1)

purple <- c("#72224F")
purple_1 <- colorspace::lighten(purple, amount = 0.9)
purple_2 <- colorspace::lighten(purple, amount = -0.2)
scales::show_col(c(purple,purple_1, purple_2))
purple_grad <- colorRampPalette(c(purple_1, purple_2))(4)
scales::show_col(purple_grad)

orange <- c("#CE512D")
yellow <- c("#EAB33B")

food_categories_colors <- food_categories %>% 
  select(food_name_legend_2, food_name_2) %>% 
  unique() %>% 
  mutate(fill_color = case_when(food_name_legend_2 == "Freshwater Fishery" ~ light_blue,
                                food_name_legend_2 == "Marine Fishery" ~dark_blue,
                                food_name_legend_2 == "Mariculture" ~ yellow,
                                food_name_legend_2 == "Mariculture Feed" ~ "#719F7F",
                                food_name_legend_2 == "Livestock Feed" ~ "#2B5F3D",
                                food_name_legend_2 == "Eggs" ~ red,
                                food_name_legend_2 == "Milk" ~ red_1,
                                food_name_legend_2 == "Chicken Meat" ~ "#98537C",
                                food_name_legend_2 == "Pig Meat" ~ "#CB9BB5",
                                food_name_legend_2 == "Ruminant Meat" ~ "#660C43",
                                food_name_legend_2 == "Human Crop Consumption" ~ orange))

fill_order <- rev(c(dark_blue, light_blue, yellow,  "#719F7F", "#2B5F3D", red, red_1, "#CB9BB5", "#98537C", "#660C43", orange))

jv_palette <- c(dark_blue, light_blue, yellow,  "#719F7F", "#2B5F3D", red, red_1, "#CB9BB5", "#98537C", "#660C43", orange)
scales::show_col(jv_palette)

```


```{r}
#filter to include only countries in circle
cutoff_value <- 0.040 ## this is just the value that corresponds with the top 23 countries 

pressures_adj_circle <- summary_df %>%
  group_by(country, iso3c) %>%
  mutate(chi = sum(food_category_prop, na.rm=TRUE)) %>%
  ungroup() %>%
  arrange(chi) %>% 
 filter(chi<=cutoff_value)

##grab the highest country to highlight red and id where the circle ends and then side bar chart begins
highest_country <- pressures_adj_circle[dim(pressures_adj_circle)[1], "iso3c"]
pressures_highest_country <- filter(pressures_adj_circle, iso3c %in% highest_country$iso3c) #used below

# adjust the rank_rgn-adjust dataframe to match above
rank_rgn_adj <- rank_rgn %>%
  filter(iso3c %in% pressures_adj_circle$iso3c) 

# add empty space to create space in the circleplot for axes
 empty_bar <- 5
 to_add <- data.frame(matrix(NA, empty_bar, ncol(rank_rgn_adj)) )
 colnames(to_add) = colnames(rank_rgn_adj)
 to_add$country <- as.character(1:empty_bar)
 rank_rgn_adj  <- rbind(to_add, rank_rgn_adj)
 
 # some code to orient the country labels
sequence_length = length(unique(rank_rgn_adj$country))
first_sequence = c(1:(sequence_length%/%2)) 
second_sequence = c((sequence_length%/%2+1):sequence_length) 
first_angles = c(90 - 180/length(first_sequence) * first_sequence)
second_angles = c(-90 - 180/length(second_sequence) * second_sequence)
rank_rgn_adj$angle <- c(first_angles, second_angles)
rank_rgn_adj$hjust <- c(rep(0, length(first_sequence)), 
                    rep(1, length(second_sequence)))

# color for region labels
rank_rgn_adj <- rank_rgn_adj %>%
  mutate(country = factor(country, unique(country))) %>%
  mutate(georegion = factor(georegion, unique(georegion))) %>%
  mutate(color = "black") %>%
  mutate(color = ifelse(is.na(chi), "white", color)) %>%
  mutate(color = ifelse(iso3c %in% highest_country$iso3c, "black", color))

# get dataframe for georegion shift locations
rgn_shift <- rank_rgn_adj %>%
  mutate(georegion = ifelse(is.na(georegion), "tmp", georegion)) %>%
  mutate(georegion = as.factor(georegion)) %>%
  mutate(region_shift = as.numeric(georegion) - lag(as.numeric(georegion)), default=first(as.numeric(georegion)))
rgn_shift <- which(rgn_shift$region_shift > 0)
rgn_shift <- c(1, rgn_shift) -0.5
rgn_shift <- data.frame(rgn_shift_x=rgn_shift,
                         georegion = rank_georgn$georegion,
                         name_x= c(4, 10, 40, 90, 180, 200), #
                         name_y=c(55, 55, 55, 55, 55, 55))

rgn_shift <- rgn_shift %>%
   mutate(georegion = as.character(georegion))

# # add some blanks rows to match the master region list
empty_bar2 <-10
to_add <-  data.frame( matrix(NA, empty_bar2*nlevels(as.factor(pressures_adj_circle$food_name_2)), ncol(pressures_adj_circle)) )
  colnames(to_add) <- colnames(pressures_adj_circle)
  to_add$food_name_2 <- rep(levels(as.factor(pressures_adj_circle$food_name_2)), each=empty_bar2)
  to_add$chi<-  0
  to_add$country <- as.character(rep(1:empty_bar2, nlevels(as.factor(pressures_adj_circle$food_name_2))))
  pressures_adj_circle <- rbind(to_add, pressures_adj_circle, to_add)
  
pressures_adj_circle %>%
  group_by(food_name_2) %>%
  summarize(sum = sum(food_category_prop, na.rm=TRUE)) %>%
  arrange(sum) 

#pressures_adj_circle$food_name_2 <- factor(pressures_adj_circle$food_name_2, levels=rev(food_categories$food_name_2))
pressures_adj_circle$country <- factor(pressures_adj_circle$country, levels=unique(rank_rgn_adj$country))
pressures_adj_circle$georegion <- factor(pressures_adj_circle$georegion, 
                                         levels=unique(rank_georgn$georegion))
```



```{r}
 ## modfiy region names to be shorter
 rank_rgn <- rank_rgn %>% 
   mutate(rgn_name_short = country, 
         rgn_name_short = gsub("Islands", "Isl", rgn_name_short),
         rgn_name_short = gsub("Island", "Isl", rgn_name_short),
         rgn_name_short = gsub("Democratic", "Dem", rgn_name_short),
         rgn_name_short = gsub("Republic", "Rep", rgn_name_short),
         rgn_name_short = gsub("South", "S", rgn_name_short),
         rgn_name_short = gsub("American", "Am", rgn_name_short),
         rgn_name_short = gsub("the United States", "US", rgn_name_short),
         rgn_name_short = gsub("Territory", "Terr", rgn_name_short),
         rgn_name_short = gsub("Saint", "St", rgn_name_short),
         rgn_name_short = gsub(" and ", " & ", rgn_name_short),
         rgn_name_short = gsub("Republique", "Rep", rgn_name_short),
         rgn_name_short = gsub("Dem Rep of the", "Dem Rep of", rgn_name_short),
         rgn_name_short = gsub("Georgia and the", "Georgia and", rgn_name_short),
         rgn_name_short = gsub("St Vincent and the", "St Vincent and", rgn_name_short),
         rgn_name_short = gsub("Howland Isl & Baker Isl", "Howland & Baker Isl", rgn_name_short),
         rgn_name_short = gsub("Northern", "N", rgn_name_short), 
         rgn_name_short = gsub("Reunion", "Reunion", rgn_name_short))
```



Make the side bar chart
```{r}
pressures_adj_bar <- summary_df %>%
  group_by(country, iso3c) %>%
  mutate(chi = sum(food_category_prop, na.rm=TRUE)) %>%
  ungroup() %>%
  filter(chi>cutoff_value) %>%
  rbind(pressures_highest_country) %>%
  arrange(chi) 

rank_rgn_adj_bar <- rank_rgn %>%
  filter(iso3c %in% pressures_adj_bar$iso3c)%>%
  arrange(chi) 

# color for region labels
rank_rgn_adj_bar <- rank_rgn_adj_bar %>%
  mutate(country = factor(country, levels = unique(country))) %>%
 # mutate(georegion = factor(georegion, unique(georegion))) %>%
  mutate(color = "black") %>%
  mutate(color = ifelse(is.na(chi), "white", color))%>%
  mutate(color = ifelse(iso3c %in% highest_country$iso3c, "black", color)) %>%
  arrange(-chi) 

#pressures_adj_bar <- pressures_adj_bar %>%
 # left_join(food_categories, by = c("food_name_2", "food_name_legend_2"))

#pressures_adj_bar$food_name_1 <- factor(pressures_adj_bar$food_name_1, levels=rev(food_categories$food_name_1))
pressures_adj_bar$country <- factor(pressures_adj_bar$country, levels=unique(rank_rgn_adj_bar$country))

## some theme stuff to make the plot look nice
bar_theme <- theme(axis.line=element_blank(),
                      axis.text.y=element_blank(),
                      axis.ticks.y=element_blank(),
                 # axis.title.x=element_blank(),
                      axis.title.y=element_blank(),
              #        legend.position="none",
                      panel.background=element_blank(),
                      panel.border=element_blank(),
                      panel.grid.major=element_blank(),
                      panel.grid.minor=element_blank(),
                      plot.background=element_blank(),
                      legend.title = element_blank())
                     # axis.text.x = element_blank())

pressures_adj_bar_plot <- pressures_adj_bar %>%
  left_join(food_categories_colors, by = "food_name_2") %>%
  mutate(fill_color = factor(fill_color, levels = fill_order),
         food_category_prop = food_category_prop/4) %>%
  filter(!is.na(food_name_2))
  
figure1_bar_2 <- ggplot(data=pressures_adj_bar_plot, aes(x=country, y=food_category_prop, fill= fill_color)) +
  geom_bar(stat="identity") +
  ylab(bquote("proportion of stress")) +
  # ## this adjust the plot dimensions, which can be expanded to include names
    geom_errorbar(aes(
      x     = 0,
        ymin  = -0.1,
        ymax  = 0),
        alpha = 0) +
  # geom_errorbar(aes(
  #      y     = -.01,
  #      xmin  = -0.1,
  #      xmax  = -1),
  #      alpha = 0) +
      # Country name text placement
    geom_text(
      data = rank_rgn_adj_bar,
      aes(y = -0.01,
          x = 1:length(rank_rgn_adj_bar$country),
          label = rgn_name_short),
      inherit.aes = FALSE,
  #    fontface = “bold”,
      alpha = 0.9,
      size = 3,
      color = rank_rgn_adj_bar$color,
      hjust = 1) +
  coord_flip() +
  scale_colour_identity() +
  scale_fill_identity() +
  bar_theme +
  # labs(y = bquote(bold("Proportion of Global Environmental Pressures"))) +
  labs(y = "") +
#  geom_point(aes(x = country, y = prop_prod), color = "grey55") +
  scale_y_continuous(breaks = c(0, 0.05, 0.10, 0.15),
                     labels = c(0, 0.05, 0.10, 0.15))

```



combine and save
```{r}
library(patchwork)
## add labels A and B
figure_2 <- fig2_bar_1 + plot_spacer() + figure1_bar_2 + 
  plot_layout(widths = c(4, -1.1, 4)) +
  plot_annotation(tag_levels = c('A')) &
  theme(plot.tag.position  = c(0.15,1))
figure_2


#theme = theme(axis.title.x  = element_text(size = 20))
ggsave(here(("_analysis/figures/paper/output/fig_4_bars.pdf")), height=6, width=9, units=c("in")) # bg=“transparent
ggsave(here(("_analysis/figures/paper/output/fig_4_bars.png")), height=6, width=9, units=c("in")) # bg=“transparent
```

## Calculate what percentage of total global CI these countries represent

```{r}
bar_total_ci <- pressures_adj_bar_plot %>% 
  dplyr::summarize(sum = sum(food_category_prop))

check <- summary_df%>% 
  dplyr::summarize(sum = sum(food_category_prop))

```

