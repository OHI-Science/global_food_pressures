---
title: "Wrangling Social and Nutritional Data"
author: "Juliette"
date: "11/24/2020"
output: html_document
---

1. UN Population data
2. Human Development Index
3. Social Progress Index
4. Food Security Index
5. Gini Index
6. Micronutrient intake indicators 
    * Prevalence of Inadequate Micronutrient Intake Index (PIMII)
    * Micronutrient Density Index (MDI)
    * Per capita daily energy availability (PCDEA)
    * https://journals.plos.org/plosone/article?id=10.1371/journal.pone.0175554

- Look into more data sets for this: Economic Development Status
- Any FAO stat food security indicators we want? http://www.fao.org/faostat/en/#data/FS

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(here)
library(countrycode)
library(readxl)
source(here("_workflow/common.R"))

```

## 1. UN Population Data
```{r}

# raw data
pop_raw <- read_csv(file.path(raw, "World_Bank/population_data/population_un_2010_2019.csv"))

# wrangle
pop <- pop_raw %>% 
  select(iso3c = 'Country Code', country = 'Country Name', pop_2017 = '2017')
## west bank and gaza are already combined, cool

un_unique_list <- setdiff(pop$iso3c, food_rgns$iso3c)
## there are 49 countries included in the un population data that we dont. look more closely to see what these are
un_unique <- filter(pop, iso3c %in% un_unique_list) ## looks to be different summary stat groupings

missing_list <- setdiff(food_rgns$iso3c, pop$iso3c)
## un is missing 29 countries from our list
missing <- filter(food_rgns, iso3c %in% missing_list)
##a lot of small caribbean islands are missing, probably grouped into "Caribbean small states"

```


## 2. Human Development Index
```{r}

# raw data
hdi_raw <- read_csv(file.path(raw, "UN_HDI/Human_Development_Index_HDI.csv"))

# wrangle
hdi <- hdi_raw %>% 
  select(Country, hdi_index = '2017') %>% 
  mutate(iso3c = countrycode(Country, origin="country.name", destination = "iso3c")) %>% 
  filter(!is.na(hdi_index))

gapfilling_values <- filter(hdi, is.na(iso3c))

setdiff(hdi$iso3c, food_rgns$iso3c)
setdiff(food_rgns$iso3c, hdi$iso3c)
## missing 55 countries

hdi_ungf <- hdi %>% 
  filter(!is.na(iso3c)) %>% 
  select(-Country) %>% 
  right_join(food_rgns, by = "iso3c") %>% 
  select(iso3c, country = Country, hdi_index)

write_csv(hdi_ungf, here("_analysis/figures/paper/data/hdi_ungf.csv"))

```

## 3.Social Progress Index
```{r}

# raw data
spi_raw <- read_excel(file.path(raw, "social_progress_index/2011-2020-Social-Progress-Index.xlsx"), sheet = 2, skip = 2)

# wrangle 
spi <- spi_raw %>% 
  select(iso3c = 'SPI country code', year = 'SPI year', spi = 'Social Progress Index') %>% 
  filter(iso3c != "WWW", year == 2017)

setdiff(spi$iso3c, food_rgns$iso3c)
## this data has info on KSV (Kosovo), WBG (?), VAT (Vatican City State)
length(setdiff(food_rgns$iso3c, spi$iso3c))
## missing data on 54 countries

write_csv(spi, here("_analysis/figures/paper/data/spi_ungf.csv"))

```

## 4.Food Security Index

Unsure how to use this data for the year 2107. the overall values for scores are NA, and I cant calculate it because there are a lot of NA values within so if I multiply it by the weight that wont work.

So I will use 2018 data, since there are no NAs
```{r}
# raw data
fsi_raw <- read_csv(file.path(raw, "food_security_index/GFSI_2018_scores.csv"))

# wrangle
fsi <- fsi_raw %>% 
  filter(Series == "OVERALL") %>% 
  select(-Unit, - Weight, - Series) %>% 
  pivot_longer(cols = 1:113, names_to = "Country", values_to = "fsi_score")%>% 
  mutate(year = 2018,
         ## this is kinda a hacky way of getting rid of weird symbols, its the only country with this score and I don't see it changing any time soon
         Country = ifelse(fsi_score == 51.3, "Cote D'Ivoire", Country),
         iso3c = countrycode(Country, origin="country.name", destination = "iso3c"))

setdiff(fsi$iso3c, food_rgns$iso3c)
length(setdiff(food_rgns$iso3c, fsi$iso3c))
## we are missing 131 countries

write_csv(fsi, here("_analysis/figures/paper/data/fsi_ungf.csv"))
```

## 5.Gini Index (World Bank)

```{r}
# raw data
gini_raw <- read_csv(file.path(raw, "World_Bank/gini_index/gini_1980_2020.csv"))

# wrangle
gini_int <- gini_raw %>% 
  select(iso3c = 'Country Code',  gini_2017 = '2017', gini_2016 ='2016', gini_2015 ='2015', gini_2014 ='2014', gini_2013 ='2013', gini_2012 ='2012', gini_2011 ='2011', gini_2010 ='2010') %>%
  mutate(gini_index = gini_2017,
         gf = ifelse(is.na(gini_index), "gf 2016 values", NA),
         gini_index = ifelse(is.na(gini_index), gini_2016, gini_index),
         gf = ifelse(is.na(gini_index), "gf 2015 values", gf),
         gini_index = ifelse(is.na(gini_index), gini_2015, gini_index),
         gf = ifelse(is.na(gini_index), "gf 2014 values", gf),
         gini_index = ifelse(is.na(gini_index), gini_2014, gini_index),
         gf = ifelse(is.na(gini_index), "gf 2013 values", gf),
         gini_index = ifelse(is.na(gini_index), gini_2013, gini_index),
         gf = ifelse(is.na(gini_index), "gf 2012 values", gf),
         gini_index = ifelse(is.na(gini_index), gini_2012, gini_index),
         gf = ifelse(is.na(gini_index), "gf 2011 values", gf),
         gini_index = ifelse(is.na(gini_index), gini_2011, gini_index),
         gf = ifelse(is.na(gini_index), "gf 2010 values", gf),
         gini_index = ifelse(is.na(gini_index), gini_2010, gini_index),
         gf = ifelse(is.na(gini_index), NA, gf))

gini <- gini_int %>% 
  select(iso3c, gini_index, gf) %>%
  filter(!is.na(gini_index))

setdiff(gini$iso3c, food_rgns$iso3c)
## includes XKX (Kosovo)
length(setdiff(food_rgns$iso3c, gini$iso3c))
## missing 97 countries
  
write_csv(gini, here("_analysis/figures/paper/data/gini_ungf.csv"))

```


## 6. Micronutrient intake indicators
    * Prevalence of Inadequate Micronutrient Intake Index (PIMII)
    * Micronutrient Density Index (MDI)
    * Per capita daily energy availability (PCDEA)
```{r}
# raw
raw_beal <- read_csv(file.path(raw, "Beal_et_al_2017_nutrional_indicators/SI_5.csv"))

# wrangle
beal <- raw_beal %>% 
  filter(Year == 2011)

setdiff(beal$ISO3, food_rgns$iso3c)
## no countries in beal that we dont have
length(setdiff(food_rgns$iso3c, beal$ISO3))
## 77 missing countries

write_csv(beal, here("_analysis/figures/paper/data/beal_ungf.csv"))
```

