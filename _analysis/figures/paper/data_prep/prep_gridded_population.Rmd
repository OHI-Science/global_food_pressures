---
title: "gridded_population_prep"
author: "Juliette"
date: "11/25/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(here)
library(doParallel)
source(here("_workflow/common.R"))
source(here("_workflow/common_spatial.R"))

rgdal::setCPLConfigOption("GDAL_PAM_ENABLED", "FALSE")
# disable aux tif files writing

```


## Import Raw Data
```{r}


## Read in the raw density data to be reprojected and resampled
raw_list <- list.files(file.path(raw, sprintf("CIESEandCIAT_population/d2019")),
                  full.names = TRUE, pattern = "\\.tif$",
                  recursive = TRUE)

raw_list <- raw_list[grep("density", raw_list)]

pop_raw <- read_csv(file.path(raw, "World_Bank/population_data/population_un_2010_2019.csv"))

# wrangle
pop <- pop_raw %>% 
  select(iso3c = 'Country Code', country = 'Country Name', pop_2017 = '2017') %>% 
  filter(iso3c %in% food_rgns$iso3c)

cum_pressure <- raster("/home/shares/food-systems/Food_footprint/all_food_systems/analysis/stressor_summary/equal_area/rescaled/cumulative_stress/all_systems_cumulative_stress.tif") 

```


## Resample

```{r}
grid_pop <- raster(file.path(raw, "CIESEandCIAT_population/d2019/gpw-v4-population-density-adjusted-to-2015-unwpp-country-totals-rev11_2015_2pt5_min_tif/gpw_v4_population_density_adjusted_to_2015_unwpp_country_totals_rev11_2015_2pt5_min.tif"))

cl <- makeCluster(5) # 5 clusters for 5 files being targeted
registerDoParallel(cl)

foreach(i = raw_list, .packages = c("raster", "rgdal", "stringr")) %dopar% {
#  i = raw_list[1] # send this down alone and check to see which file it calls; see if there are any errors in file naming
 
  yr <- as.numeric(as.character(str_sub(i, -17, -14))) # counts backwards by character in file name to grab the year digits
  
  raster::raster(i) %>% # read in file path to raster
  raster::resample(cum_pressure, method = 'bilinear', overwrite = TRUE, filename = file.path(prep,
                                                                                         sprintf("spatial/gridded_population_data/int/cea/human_density_%s.tif", yr)))
} 

```

## Interpolate between years
GWPv4 data is for years 2005, 2010, 2015, and 2020. Data for missing years must be generated by interpolation.

Calculate the yearly change between the 5 year rasters we have
```{r }

## Define and apply function to calculate yearly change in population density
files <- list.files(file.path(prep, "spatial/gridded_population_data/int/cea/"), pattern = "human_density", full = TRUE)

## Create function for average yearly change
yearly_diff <- function(year_min, year_max, density_files = files){
  rast_diff <- stack(density_files[grep(year_max, density_files)], density_files[grep(year_min, density_files)]) %>%
    overlay(fun = function(x, y){(x - y)/5},
            filename = file.path(prep, sprintf("spatial/gridded_population_data/int/cea/yearly_change_%s_to_%s.tif", year_min, year_max)),
            overwrite = TRUE)
}

## Create four rasters for each set of data
yearly_diff(year_min = 2000, year_max = 2005) # this should save 2001, 2002, 2003, etc to estimate intervening years using a linear model - check to make sure it's being saved in the Mazu directory properly
yearly_diff(year_min = 2005, year_max = 2010)
yearly_diff(year_min = 2010, year_max = 2015)
yearly_diff(year_min = 2015, year_max = 2020)

```

Interpolate the years in between
```{r}

## write function
yearly_interpolate <- function(year, start_raster, yearly_change){
    for(i in 1:4){
      # i = 1 send this down to see what the loop produces when i=1 
      raster::overlay(raster::raster(start_raster), raster::raster(yearly_change), fun = function(x, y){(x + i*y)},
              filename = file.path(prep, sprintf("spatial/gridded_population_data/int/human_density_%s.tif", (year+i))),
              overwrite = TRUE)
    }
}

## Interpolate missing years
files <- list.files(file.path(prep, "spatial/gridded_population_data/int"), pattern = ".tif$", full = TRUE)

for(i in c(2000, 2005, 2010, 2015)) {
  
  yearly_interpolate(i, start_raster = files[grep(sprintf("density_%s",i), files)],
                     yearly_change = files[grep(sprintf("change_%s_to_%s", i, i+5), files)])
}

density_2017 <- raster(file.path(prep, "spatial/gridded_population_data/int/human_density_2017.tif"))
plot(log(1+density_2017))
```


## Convert Density to Population Counts

Density data are converted to population by multiplying density times the area of the cell (934.4789 x 934.4789m) and converting to square km from square meters, to get people per square km. GWPv4 provides both densities and population counts. However, we derive population counts from density because the density data is independent of raster scale, so we can reproject/resample and it will still be correct. Change the scale using count data, and it is necessary to correct by dividing by cell area otherwise the values become meaningless; it is easier to just start with density.

```{r}

density_raster <- list.files(file.path(prep, "spatial/gridded_population_data/int/"), pattern = "density", full = TRUE)
density_raster # check to make sure this looks correct; should only have human_density tif files for each interpolated year


foreach(i = density_raster) %dopar% {
  # i <- density_raster[18]  does i generate the 2000 raster?
  nm <- basename(i)
  yr <- stringr::str_sub(nm, -8, -5) # pulls out the year from the file name
  cat(nm)
  
  area <- raster::area(raster::raster(i))
  tmp <- raster::raster(i) # reads in raster
  
  count <- area*tmp*0.000001
  
  #plot(log(1+count))
  
  raster::writeRaster(count, file.path(prep, sprintf("spatial/gridded_population_data/int/human_count_%s.tif", yr)), format = "GTiff", overwrite = TRUE ) 

}


## do it for cea, non interpolated years

density_raster <- list.files(file.path(prep, "spatial/gridded_population_data/int/cea"), pattern = "density", full = TRUE)
density_raster # check to make sure this looks correct; should only have human_density tif files for each interpolated year


foreach(i = density_raster) %dopar% {
  # i <- density_raster[4]  does i generate the 2000 raster?
  nm <- basename(i)
  yr <- stringr::str_sub(nm, -8, -5) # pulls out the year from the file name
  cat(nm)
  
  area <- 36
  tmp <- raster::raster(i) # reads in raster
  
  count <- area*tmp*0.000001
  
  #plot(log(1+count))
  
  cellStats(count, "sum", na.rm = TRUE)
  
  raster::writeRaster(count, file.path(prep, sprintf("spatial/gridded_population_data/int/cea/human_count_%s.tif", yr)), format = "GTiff", overwrite = TRUE ) 

}
```


## Zonal extract for food regions for our year_oi

```{r}
year_oi <- 2015
pop_count <- raster(file.path(prep, sprintf("spatial/gridded_population_data/int/human_count_%s.tif", year_oi)))

cellStats(pop_count, "sum", na.rm = TRUE)

rgn_pop <- zonal(pop_count, food_rgns_tif, fun="sum", progress="text", na.rm=TRUE)

 rgn_pop_df <- data.frame(rgn_pop) %>%
        rename(ID_0 = zone, population = sum) %>%
        left_join(food_rgns, by="ID_0") %>% 
   select(iso3c, country = Country, population)
 
 sum(rgn_pop_df$population)
 
 write_csv(rgn_pop_df, here(sprintf("_analysis/figures/paper/data/region_count_%s.csv", year_oi)))

 
## look at it in a plot to see if anything weird stands out
 
 test <- read.csv(here("_analysis/figures/paper/data/region_count_2017.csv"))

 library(plotly) 
 
 plot <- ggplot(rgn_pop_df) +
   geom_point(aes(y = country, x = population, color = country))+
   theme(legend.position = "none")

 ggplotly(plot)
 ## the two big outliers are India and China. Unsurprising
 
```


