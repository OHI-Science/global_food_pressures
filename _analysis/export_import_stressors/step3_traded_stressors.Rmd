---
title: "Import stressors"
output: html_document
editor_options: 
  chunk_output_type: console
---

This script determines stressors imported from other countries based on FAO Detailed Trade Matrix

```{r}

library(here)
library(tidyverse)
library(countrycode)

focus_year = 2017


```



# Import data
FAO provides a trade matrix showing tonnes of each crop imported into each country.

FAO codes:
```{r}

feed_products_full <- read_csv(here("feed/data/MapSPAM_to_FAO_v2.csv"))

feed_products <- feed_products_full %>%
  dplyr::filter(is.na(non_food)) %>%
  dplyr::select(FAO_Item_Code=FAO_item_code, SPAM_super) %>%
  dplyr::filter(!is.na(FAO_Item_Code)) %>%
  unique()
sum(duplicated(feed_products$FAO_Item_Code))

```

Get FAO import data and convert to MAPSPAM crops:
```{r}

import_data <- read_csv("/home/shares/food-systems/Food_footprint/_raw_data/FAO_detailed_trade/d2020/Trade_DetailedTradeMatrix_E_All_Data_(Normalized).csv")


# cut "Unspecified Area" for exporting countries.  This has the effect of spreading the imports among the countries with existing data
imports <- import_data %>%
  filter(Year == focus_year) %>%
  filter(!(`Partner Countries` %in% c("Unspecified Area"))) %>%
    filter(!(`Partner Countries` %in% c("China"))) %>%                 #combination of all china regions
  dplyr::filter(Element == "Import Quantity") %>%
  dplyr::select(consuming_area_code = `Reporter Country Code`,
                consuming_country = `Reporter Countries`,
                producing_area_code = `Partner Country Code`, 
                producing_country = `Partner Countries`,
                FAO_Item_Code = `Item Code`, Element, Value, Item)


# make sure that all relevant product codes match up
extra_products <- setdiff(feed_products$FAO_Item_Code, imports$FAO_Item_Code) 
extra_products_description <- feed_products_full %>%
  dplyr::filter(FAO_item_code %in% extra_products)
unique(extra_products_description$product_description_FAOSTAT)
# these are in the master list but not in the trade data
extra_imports <- setdiff(imports$FAO_Item_Code, feed_products$FAO_Item_Code)
# These are in the trade data, but not our master list, this is mostly non-crop products:
import_data %>%
  select(Item, `Item Code`) %>%
  filter(`Item Code` %in% extra_imports) %>%
  unique() %>% data.frame()


intersect(imports$FAO_Item_Code, feed_products$FAO_Item_Code)

# convert products to MAPSPAM categories 
imports <- imports %>%
  filter(FAO_Item_Code %in% feed_products$FAO_Item_Code) %>%
  left_join(feed_products, by = "FAO_Item_Code") %>%
  dplyr::group_by(consuming_area_code, consuming_country, producing_area_code, producing_country, SPAM_super) %>%
  summarize(Value = sum(Value)) %>%
  ungroup()

```

Assign iso3c region ids:

```{r}

# not catching Eswatini
imports <- imports %>%
  mutate(producing_country = ifelse(producing_country == "Eswatini", "Swaziland", producing_country),
                producing_country = ifelse(grepl("Ivoire", imports$producing_country), "Ivory Coast", producing_country),
         consuming_country = ifelse(consuming_country == "Eswatini", "Swaziland", consuming_country),
                consuming_country = ifelse(grepl("Ivoire", imports$consuming_country), "Ivory Coast", consuming_country))


## add standardized country names
imports$iso3c_producing <- countrycode(as.character(imports$producing_country), origin="country.name", destination = "iso3c")
imports$iso3c_consuming <- countrycode(as.character(imports$consuming_country), origin="country.name", destination = "iso3c")

imports <- imports %>%
  mutate(iso3c_producing = ifelse(imports$producing_country == "Netherlands Antilles (former)", "BES", iso3c_producing)) %>%
    mutate(iso3c_consuming = ifelse(imports$consuming_country == "Netherlands Antilles (former)", "BES", iso3c_consuming))

## make sure all countries have an iso3c code
filter(imports, is.na(iso3c_consuming))
filter(imports, is.na(iso3c_producing))

## make sure no duplicated regions (should all be one)
tmp <- imports %>%
  mutate(check = paste(consuming_area_code, iso3c_consuming, sep="_")) %>%
  group_by(iso3c_consuming) %>%
  summarize(check_n = length(unique(check)))
data.frame(tmp)
sum(tmp$check_n>1)

```

Clean the imports data
```{r}

imports <- imports %>% 
   dplyr::select(iso3c_consuming, iso3c_producing, SPAM_super, imports_tonnes = Value) %>%   
  filter(iso3c_producing != iso3c_consuming) # A few countries have this, but it seems like they shouldn't, maybe it reflects imports from territories?  cut.

filter(imports, iso3c_consuming=="FJI" & SPAM_super=="xpul")

```

Compare tones imports in trade data to tonnes imports in FBS:
```{r}

import_fbs <- read_csv(here("_analysis/export_import_stressors/data/fbs_imported_tonnes.csv")) %>%                                                                          select(iso3c_consuming = iso3c, SPAM_super, imported_fbs = imported)


compare_imports <- imports %>%
  group_by(iso3c_consuming, SPAM_super) %>%
  summarize(import_tonnes_trade_matrix = sum(imports_tonnes)) %>%
  left_join(import_fbs)
plot(log(compare_imports$import_tonnes_trade_matrix +1), log(compare_imports$imported_fbs+1))
abline(0,1, col="red")

tmp <- filter(compare_imports, is.na(imported_fbs)) %>% data.frame()
table(tmp$iso3c_consuming)


```

Due to mismatches between these datasets, we will use the detailed trade matrix data to determine the *proportion* of crops imported for each country.  We then multiply this by the total import value in the FBS to get the tonnes arriving from each country (vs. just using the tonnes value in the trade matrix data).
Calculate the proportion of crop coming from each country

```{r}

imports_prop <- imports %>%
  group_by(iso3c_consuming, SPAM_super) %>%
  mutate(imports_all_tonnes = sum(imports_tonnes)) %>%
  ungroup() %>%
  mutate(imports_per = ifelse((imports_tonnes + imports_all_tonnes) == 0, 0, imports_tonnes/imports_all_tonnes)) %>%
  dplyr::select(-imports_tonnes, -imports_all_tonnes)

filter(imports_prop, iso3c_consuming == "AFG" & SPAM_super == "sorg")
filter(imports_prop, iso3c_consuming == "ETH" & SPAM_super == "barl")

```

Now combine with total imports data from FBS.
```{r}

import_fbs <- read_csv(here("_analysis/export_import_stressors/data/fbs_imported_tonnes.csv")) %>%                                                                          select(iso3c_consuming = iso3c, SPAM_super, imported_fbs = imported)

standardized_imports <- left_join(imports_prop, import_fbs, by=c("iso3c_consuming", "SPAM_super")) %>%
  filter(!is.na(imported_fbs)) %>%
  mutate(tonnes_imported = imports_per * imported_fbs) %>%
  filter(tonnes_imported > 0) %>%
  select(iso3c_consuming, iso3c_producing, SPAM_super, tonnes_imported)
  

filter(standardized_imports, iso3c_consuming == "AFG" & SPAM_super == "sorg")
filter(standardized_imports, iso3c_consuming == "ETH" & SPAM_super == "barl")

summary(standardized_imports)

check<- standardized_imports %>%
  group_by(iso3c_consuming, SPAM_super) %>%
  summarize(tonnes_imported_check = sum(tonnes_imported)) %>%
  left_join(import_fbs)
plot(check$tonnes_imported_check, check$imported_fbs)
abline(0,1)

write_csv(standardized_imports, here("_analysis/export_import_stressors/data/tons_crops_imported_by_country.csv"))
```

Now link with stressor production per tonne and gapfill:
```{r}

stressor_rates <- read_csv(here("_analysis/export_import_stressors/data/cumulative_stressor_rates.csv")) %>%
  select(iso3c_producing = iso3c, SPAM_super, cumulative_pressure_rate)

import_stressors <- left_join(standardized_imports, stressor_rates, by=c("iso3c_producing", "SPAM_super"))
summary(import_stressors)

## Some import data, where there is no pressure.  Probably because of complex trade relationships.  These are gapfilled with \mean of other countries that provide trade to the importing country weighted by import tonnes.  In some cases, there were no trade countries with non zero data and we gapfilled these with the global average values for a SPAM crop category, weighted by total trade. 
import_stressors_gf <- import_stressors %>%
  group_by(iso3c_consuming, SPAM_super) %>%
  mutate(cumulative_pressure_rate = ifelse(is.na(cumulative_pressure_rate), 0, cumulative_pressure_rate)) %>%
  mutate(cumulative_pressure_rate_gf = weighted.mean(cumulative_pressure_rate[cumulative_pressure_rate>0], tonnes_imported[cumulative_pressure_rate>0])) %>%
  group_by(SPAM_super) %>%
  mutate(cumulative_pressure_rate_gf2 = weighted.mean(cumulative_pressure_rate[cumulative_pressure_rate>0], tonnes_imported[cumulative_pressure_rate>0])) %>%
  ungroup() %>%
  mutate(cumulative_pressure_rate = ifelse(cumulative_pressure_rate==0, cumulative_pressure_rate_gf, cumulative_pressure_rate)) %>%
    mutate(cumulative_pressure_rate = ifelse(is.na(cumulative_pressure_rate), cumulative_pressure_rate_gf2, cumulative_pressure_rate)) %>%
  select(iso3c_consuming, iso3c_producing, SPAM_super, tonnes_imported, cumulative_pressure_rate)

summary(import_stressors_gf)

filter(import_stressors_gf, iso3c_consuming == "ARM", SPAM_super == "maiz")

```

Now determine the imported pressures.
```{r}

bilateral_trade <- import_stressors_gf %>%
  mutate(imported_cumstress = tonnes_imported * cumulative_pressure_rate) 
write_csv(bilateral_trade, here("_analysis/export_import_stressors/data/bilateral_trade_crop.csv"))

bilateral_trade <- import_stressors_gf %>%
  mutate(imported_cumstress = tonnes_imported * cumulative_pressure_rate) %>%
  group_by(iso3c_consuming, iso3c_producing) %>%
  summarize(total_cum_stress = sum(imported_cumstress))
write_csv(bilateral_trade, here("_analysis/export_import_stressors/data/bilateral_trade.csv"))


stressor_imported <- import_stressors_gf %>%
  mutate(imported_cumstress = tonnes_imported * cumulative_pressure_rate) %>%
  group_by(iso3c_consuming, SPAM_super) %>%
  summarize(imported_cumstress = sum(imported_cumstress)) %>%
  rename(iso3c = iso3c_consuming) %>%
  ungroup()

```

The imported stressors can either be used or exported.  This is calculated here:

```{r}

export_prop <- read_csv(here("_analysis/export_import_stressors/data/fbs_export_prop.csv")) %>%
  select(iso3c, SPAM_super, export_prop)

stressor_imported_used_export <- left_join(stressor_imported, export_prop, by = c("iso3c", "SPAM_super")) %>%
  mutate(imported_used_cumstress = imported_cumstress * (1-export_prop)) %>%
  mutate(imported_exported_cumstress = imported_cumstress * export_prop) %>%
  select(iso3c, SPAM_super, imported_used_cumstress, imported_exported_cumstress)


write_csv(stressor_imported_used_export, here("_analysis/export_import_stressors/data/imported_cum_stress.csv"))
```

