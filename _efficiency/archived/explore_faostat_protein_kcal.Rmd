---
title: "Explore faostat protein/kcal data"
author: "Juliette"
date: "2/5/2021"
output: html_document
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(here)
library(countrycode)
source(here("_workflow/common.R"))

livestock_raw <- read_csv(file.path(raw, "FAO_data/v2021/supply_utlilization_accounts/livestock_primary/FAOSTAT_data_2-5-2021.csv"))
crops_raw <- read_csv(file.path(raw, "FAO_data/v2021/supply_utlilization_accounts/crops/FAOSTAT_data_2-5-2021.csv"))

```

# Livestock 

## Wrangle, calculate conversion factors, and calculate tonnes product to tonnes protein and million kcals
```{r}

nutri_contents_livestock <- livestock_raw %>% 
  select(Area, Element, Item, Year, Unit, Value) %>% 
  filter(Year == 2017,
         Element %in% c("Food supply quantity (tonnes)", "Calories/Year", "Proteins/Year")) %>% 
  
  ## wrangle the item names so we can easily choose what we want to keep
  separate(Item, c("product", "animal"), remove = FALSE) %>% 
  mutate(animal = ifelse(product == "Beeswax", "bee", animal),
         animal = ifelse(str_detect(Item, "goat"), "goat", animal),
         animal = ifelse(str_detect(Item, "cow"), "cow", animal),
         animal = ifelse(str_detect(Item, "sheep"), "sheep", animal),
         animal = ifelse(str_detect(Item, "buffalo"), "buffalo", animal),
         animal = ifelse(str_detect(Item, "camel"), "camel", animal),
         animal = ifelse(str_detect(Item, "bird nes"), "bird nes", animal),
         animal = ifelse(str_detect(Item, "other bird"), "other bird", animal),
         animal = ifelse(str_detect(Item, "other rodents"), "other rodents", animal),
         animal = ifelse(str_detect(Item, "goose and guinea"), "goose and guinea", animal),
         animal = ifelse(str_detect(Item, "Snails"), "snails", animal),
         animal = ifelse(str_detect(Item, "other camelids"), "other camelids", animal),
         product = ifelse(str_detect(Item, "Snails"), "Meat", product)) %>% 
  filter(animal %in% c("hen", "cattle", "goat", "sheep", "chicken", "cow", "buffalo", "pig"),
         product %in% c("Milk", "Meat", "Eggs")) %>% 
  mutate(product = tolower(product)) %>% 
  unite(animal_prod, c(animal, product)) %>% 
   
  ## grab the iso3c 
  filter(Area != "China") %>% 
  mutate(Area = ifelse(Area == "Eswatini", "Swaziland", Area),
         Area = ifelse(Area == "Netherlands Antilles (former)", "Bonaire, Sint Eustatius and Saba", Area),
         Area = ifelse(Area == "French Guyana", "French Guiana", Area),
         Area = ifelse(Area == "China, mainland", "China", Area),
         iso3c = countrycode(Area, origin="country.name", destination = "iso3c")) %>% 
  
  ## final wrangling
  select(-Area, -Year, -Unit, -Item) %>% ##units for production are tonnes, protein is tonnes, and calories is million kcals
  pivot_wider(names_from = "Element", values_from = "Value") %>% 
  select(iso3c, animal_prod, production = 'Food supply quantity (tonnes)' , million_kcal_year = 'Calories/Year', tonnes_protein_year = 'Proteins/Year') %>% 
  filter(!is.na(million_kcal_year),
         !is.na(production),
         production > 0) %>% 
  
  ## calculate the mult factor
  mutate(million_kcal_per_prod_tonne = million_kcal_year/production,
         tonne_protein_per_prod_tonne = tonnes_protein_year/production)


```

Lets see what it looks like

```{r}
ggplot(nutri_contents_livestock, aes(x = production, y = million_kcal_year)) +
  geom_point()+
  theme_minimal()+
  geom_smooth(method='lm', formula= y~x) +
  facet_wrap(vars(animal_prod), scales = "free")

ggplot(nutri_contents_livestock, aes(x = production, y = tonnes_protein_year)) +
  geom_point()+
  theme_minimal()+
  geom_smooth(method='lm', formula= y~x) +
  facet_wrap(vars(animal_prod), scales = "free")
```

```{r}

conversion_rates_livestock <- nutri_contents_livestock %>% 
  group_by(animal_prod) %>% 
  dplyr::summarise(product_tonnes_to_mill_kcal = mean(million_kcal_per_prod_tonne, na.rm = TRUE),
                   product_tonnes_to_tonnes_protein = mean(tonne_protein_per_prod_tonne, na.rm = TRUE)) %>% 
  rename(product = animal_prod) %>% 
  mutate(product = ifelse(product == "cattle_meat", "cows_meat",
                          ifelse(product == "cow_milk", "cows_milk",
                                 ifelse(product == "chicken_meat", "chickens_meat",
                                        ifelse(product == "hen_eggs", "chickens_eggs",
                                               ifelse(product == "pig_meat", "pigs_meat", 
                                               ifelse(product == "goat_meat", "goats_meat",
                                                      ifelse(product == "goat_milk", "goats_milk", product)))))))) %>% 
  filter(product != "buffalo_meat")

live_prod_list <- pull(conversion_rates_livestock, product)

```
## Make boxplots of efficiency for protein and kcals
```{r}

livestock_product_tonnes <- read_csv(here("_efficiency/data/product_tonnes.csv")) %>% 
  rename(product = category1_production) %>% 
  filter(product %in% live_prod_list) %>% 
  select(-category2_production) %>% 
  left_join(conversion_rates_livestock) %>% 
  mutate(million_kcal = tonnes*product_tonnes_to_mill_kcal,
         tonnes_protein = tonnes*product_tonnes_to_tonnes_protein)

## remove feed for now until we clean that up
pressures_raw <- read_csv(here("_efficiency/data/pressures_summary.csv")) 

pressures <- pressures_raw %>% 
  unite(product, c(organism, product)) %>% 
  filter(product %in% live_prod_list,
         !str_detect(category1_production, "feed")) %>% 
  group_by(iso3c, product) %>% 
  summarize(cumulative_pressure = sum(pressure_rescaled, na.rm=TRUE)) %>%
  ungroup()

cp_rate_livestock <- left_join(pressures, livestock_product_tonnes) %>%
  filter(!is.na(tonnes)) %>%
  filter(!is.na(cumulative_pressure)) %>%
  filter(cumulative_pressure>0) %>%
  filter(tonnes >= 10) %>% 
  rowwise() %>%
  mutate(pressure_per_tonne_product = cumulative_pressure/tonnes * 1000000,
         pressure_per_tonne_protein = cumulative_pressure/tonnes_protein * 1000000,
         pressure_per_mill_kcal = cumulative_pressure/million_kcal * 1000000)
  

##kcal
 ggplot(cp_rate_livestock, aes(x=product, y=pressure_per_mill_kcal)) +
  geom_boxplot(outlier.fill=NA, outlier.colour = NA) +
  geom_jitter( alpha=0.2, width = 0.2) +
  theme_minimal() +
  coord_flip() +
  labs(title = "Livestock (no feed): kcal",
       y = "Environmental Inefficiency (pressure/million kcal)",
       x = "")
ggsave(here("_efficiency/output/exploratory_plots/livestock_kcal.png"), units=c("in"))
 
 ggplot(filter(cp_rate_livestock, pressure_per_mill_kcal<= 0.1 ), aes(x=product, y=pressure_per_mill_kcal)) +
  geom_boxplot(outlier.fill=NA, outlier.colour = NA) +
  geom_jitter( alpha=0.2, width = 0.2) +
  theme_minimal() +
  coord_flip() +
  labs(title = "Livestock (no feed): kcal",
       subtitle = "Shows pressure/million kcal <=.01; this removes a lot of chicken meat and eggs points",
       y = "Environmental Inefficiency (pressure/million kcal)",
       x = "")
 ggsave(here("_efficiency/output/exploratory_plots/livestock_kcal_remove_outliers.png"), units=c("in"))
 
 ##protein
  ggplot(cp_rate_livestock, aes(x=product, y=pressure_per_tonne_protein)) +
  geom_boxplot(outlier.fill=NA, outlier.colour = NA) +
  geom_jitter( alpha=0.2, width = 0.2) +
  theme_minimal() +
  coord_flip() +
  labs(title = "Livestock (no feed):  protein",
       y = "Environmental Inefficiency (pressure/tonne protein)",
       x = "")
  ggsave(here("_efficiency/output/exploratory_plots/livestock_protien.png"), units=c("in"))

  ##tonnes
 ggplot(filter(cp_rate_livestock, pressure_per_tonne_protein<= 1 ), aes(x=product, y=pressure_per_tonne_protein)) +
  geom_boxplot(outlier.fill=NA, outlier.colour = NA) +
  geom_jitter( alpha=0.2, width = 0.2) +
  theme_minimal() +
  coord_flip() +
  labs(title = "Livestock (no feed): protein",
       subtitle = "Shows pressure/kcal <=.01; this removes a lot of chicken meat and eggs points",
       y = "Environmental Inefficiency (pressure/tonne protein)",
       x = "")
 ggsave(here("_efficiency/output/exploratory_plots/livestock_protein_remove_outliers.png"), units=c("in"))
 
 
  ggplot(cp_rate_livestock, aes(x=product, y=pressure_per_tonne_product)) +
  geom_boxplot(outlier.fill=NA, outlier.colour = NA) +
  geom_jitter( alpha=0.2, width = 0.2) +
  theme_minimal() +
  coord_flip() +
  labs(title = "Livestock (no feed): tonne product",
       y = "Environmental Inefficiency (pressure/tonne product)",
       x = "")
ggsave(here("_efficiency/output/exploratory_plots/livestock_tonnes_product.png"), units=c("in"))

```

************************************

# Crops

## Wrangle, calculate conversion factors, and calculate tonnes product to tonnes protein and million kcals
```{r}

nutri_contents_crops <- crops_raw %>% 
  select(Area, Element, Item, Year, Unit, Value) %>% 
  filter(Year == 2017,
         Element %in% c("Food supply quantity (tonnes)", "Calories/Year", "Proteins/Year")) %>% 
  
  ## country code wrangling
   filter(Area != "China") %>% 
   mutate(Area = ifelse(Area == "Eswatini", "Swaziland", Area),
         Area = ifelse(Area == "Netherlands Antilles (former)", "Bonaire, Sint Eustatius and Saba", Area),
         Area = ifelse(Area == "French Guyana", "French Guiana", Area),
         Area = ifelse(Area == "China, mainland", "China", Area),
         iso3c = countrycode(Area, origin="country.name", destination = "iso3c")) %>% 
  
  ## final wrangling
  select(-Area, -Year, -Unit) %>% ##units for production are tonnes, protein is tonnes, and calories is million kcals
  pivot_wider(names_from = "Element", values_from = "Value") %>% 
  select(iso3c, item = Item, production = 'Food supply quantity (tonnes)' , million_kcal_year = 'Calories/Year', tonnes_protein_year = 'Proteins/Year') %>% 
  filter(!is.na(million_kcal_year),
         !is.na(production)) %>% 
  
  ## calculate the mult factor
  mutate(million_kcal_per_prod_tonne = million_kcal_year/production,
         tonne_protein_per_prod_tonne = tonnes_protein_year/production)

## see how well the fao to mapsam csv works
temp <- nutri_contents_crops %>% 
  select(item) %>% 
  unique()

spam_fao_names <- read_csv(here("feed/data/MapSPAM_to_FAO.csv"))

##doesnt seem very well aligned
setdiff(spam_fao_names$product_description_FAOSTAT, temp$item)
setdiff(temp$item, spam_fao_names$product_description_FAOSTAT) 
## eh not great... so I'm just going to go through and create a file that will work best for this

#write_csv(temp, here("_efficiency/data/temp.csv"))

# names <- pressures_summary %>% 
#   ungroup() %>% 
#   filter(product == "produce") %>% 
#   select(organism) %>% 
#   unique()

```


There are a lot of different items. Lets pull out a couple that are major in our project. There are 16 that match directly, and we have 29 total so still a large chunk that we need to figure out how to calculate conversion rates.

```{r}
## "Beans, dry" there are also 'lentils', 'beans, green', 'chickpeas' etc 

## Maize green?
## there's also oats, wouldn't that go under wheat in our classification?

subset_nutri_contents_crops <- nutri_contents_crops %>% 
  filter(item %in% c("Wheat", "Soybeans", "Bananas" ,"Maize", "Rice, paddy", "Sweet potatoes", "Cassava", "Sugar Beet", "Barley", "Millet", "Sorghum", "Coconut", "Plantains and others", "Potatoes", "Yams", "Sugar cane"))
```


Lets see what it looks like

```{r}
ggplot(subset_nutri_contents_crops, aes(x = production, y = million_kcal_year)) +
  geom_point()+
  theme_minimal()+
  geom_smooth(method='lm', formula= y~x) +
  facet_wrap(vars(item), scales = "free")

ggplot(subset_nutri_contents_crops, aes(x = production, y = tonnes_protein_year)) +
  geom_point()+
  theme_minimal()+
  geom_smooth(method='lm', formula= y~x) +
  facet_wrap(vars(item), scales = "free")
```

## Do the conversion for the crops we have direct links to

Let's grab the products that match exactly to ours

```{r}
item <- c("Wheat", "Soybeans", "Bananas" ,"Maize", "Rice, paddy", "Sweet potatoes", "Cassava", "Sugar Beet", "Barley", "Millet", "Sorghum", "Coconut", "Plantains and others", "Potatoes", "Yams", "Sugar cane")
spam_names <- c("whea", "soyb", "bana", "maiz", "rice", "swpo", "cass", "sugb", "barl", "xmil", "sorg", "cnut", "plnt", "pota", "yams", "sugc")

direct_crops <- cbind(item, spam_names) %>% as.data.frame()

conversion_rates_crops <- subset_nutri_contents_crops %>% 
  filter(production >0) %>% 
  group_by(item) %>% 
  dplyr::summarise(million_kcal_per_prod_tonne = mean(million_kcal_per_prod_tonne, na.rm = TRUE),
                   tonne_protein_per_prod_tonne = mean(tonne_protein_per_prod_tonne, na.rm = TRUE)) %>% 
  left_join(direct_crops) %>% 
  rename(product = spam_names)

```


```{r}
crop_product_tonnes <- read_csv(here("_efficiency/data/product_tonnes.csv")) %>% 
  rename(product = category1_production) %>% 
  separate(product, c("product", "source"), sep = "_") %>% 
  filter(product %in% spam_names) %>% 
  select(-category2_production) %>% 
  left_join(conversion_rates_crops) %>% 
  mutate(million_kcal = tonnes*million_kcal_per_prod_tonne,
         tonnes_protein = tonnes*tonne_protein_per_prod_tonne) %>% 
  select(iso3c, crop_name = item, organism = product, tonnes_prod = tonnes, million_kcal, tonnes_protein) 

pressures_raw <- read_csv(here("_efficiency/data/pressures_summary.csv")) 

pressures_crop <- pressures_raw %>% 
  filter(organism %in% spam_names) %>% 
  group_by(iso3c, organism) %>% 
  summarize(cumulative_pressure = sum(pressure_rescaled, na.rm=TRUE)) %>%
  ungroup()

cp_rate_crops <- left_join(crop_product_tonnes, pressures_crop, by = c("iso3c", "organism")) %>%
  filter(!is.na(tonnes_prod)) %>%
  filter(!is.na(cumulative_pressure)) %>%
  filter(cumulative_pressure>0) %>%
  filter(tonnes_prod >= 10) %>% 
  rowwise() %>%
  mutate(pressure_per_tonne_product = cumulative_pressure/tonnes_prod * 1000000,
         pressure_per_tonne_protein = cumulative_pressure/tonnes_protein * 1000000,
         pressure_per_mill_kcal = cumulative_pressure/million_kcal * 1000000)
  
```

## Make boxplots of efficiency for protein and kcals
```{r}
##kcal
 ggplot(cp_rate_crops, aes(x=organism, y=pressure_per_mill_kcal)) +
  geom_boxplot(outlier.fill=NA, outlier.colour = NA) +
  geom_jitter( alpha=0.2, width = 0.2) +
  theme_minimal() +
  coord_flip() +
  labs(title = "Produce: kcal",
       y = "Environmental Inefficiency (pressure/million kcal)",
       x = "")
ggsave(here("_efficiency/output/exploratory_plots/crops_kcal.png"), units=c("in"))

 ggplot(filter(cp_rate_crops, pressure_per_mill_kcal<= 0.002 ), aes(x=organism, y=pressure_per_mill_kcal)) +
  geom_boxplot(outlier.fill=NA, outlier.colour = NA) +
  geom_jitter( alpha=0.2, width = 0.2) +
  theme_minimal() +
  coord_flip() +
  labs(title = "Produce: kcal",
       subtitle = "Shows pressure/million kcal <= 0.002",
       y = "Environmental Inefficiency (pressure/million kcal)",
       x = "")
 ggsave(here("_efficiency/output/exploratory_plots/crops_kcal_remove_outliers.png"), units=c("in"))
 
 ##protein
  ggplot(cp_rate_crops, aes(x=organism, y=pressure_per_tonne_protein)) +
  geom_boxplot(outlier.fill=NA, outlier.colour = NA) +
  geom_jitter( alpha=0.2, width = 0.2) +
  theme_minimal() +
  coord_flip() +
  labs(title = "Produce:  protein",
       y = "Environmental Inefficiency (pressure/tonne protein)",
       x = "")
  ggsave(here("_efficiency/output/exploratory_plots/crops_protein.png"), units=c("in"))

  ##tonnes
 ggplot(filter(cp_rate_crops, pressure_per_tonne_protein<= 0.2 ), aes(x=organism, y=pressure_per_tonne_protein)) +
  geom_boxplot(outlier.fill=NA, outlier.colour = NA) +
  geom_jitter( alpha=0.2, width = 0.2) +
  theme_minimal() +
  coord_flip() +
  labs(title = "Produce: protein",
       subtitle = "Shows pressure/kcal <=0.2",
       y = "Environmental Inefficiency (pressure/tonne protein)",
       x = "")
 ggsave(here("_efficiency/output/exploratory_plots/crops_protein_remove_outliers.png"), units=c("in"))
 
  ggplot(filter(cp_rate_crops, tonnes_prod >=10), aes(x=organism, y=pressure_per_tonne_product)) +
  geom_boxplot(outlier.fill=NA, outlier.colour = NA) +
  geom_jitter( alpha=0.2, width = 0.2) +
  theme_minimal() +
  coord_flip() +
  labs(title = "Produce: tonne product",
       y = "Environmental Inefficiency (pressure/tonne product)",
       x = "")
  ggsave(here("_efficiency/output/exploratory_plots/crops_tonnes_product.png"), units=c("in"))

```

