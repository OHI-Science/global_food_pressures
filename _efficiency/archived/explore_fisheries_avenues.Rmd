---
title: "Exploring potential fisheries avenues"
author: "Juliette"
date: "3/8/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```



*********************************************************************************************************

# Marine and freshwater products

```{r}
library(readxl)
fish_nutri_raw <- read_xlsx(file.path(raw, "uFiSh/uFiSh1.0.xlsx"), sheet = 4)

marine_fisheries <- read_csv("/home/shares/food-systems/Food_footprint/all_food_systems/dataprep/fisheries/marine/catch_for_juliette.csv")
mariculture <- read_csv("/home/shares/food-systems/Food_footprint/all_food_systems/dataprep/aquaculture/marine/production_for_juliette.csv")

isscaap <- marine_fisheries %>% 
  select(ISSCAAP, ISSCAAPName, species_class_final) %>% 
  unique()

## look at the marine fisheries data we have as a smaller version

marine_fish_sum <- marine_fisheries %>% 
  select(species_class_final, TaxonName, ISSCAAP, ISSCAAPName) %>% 
  unique()

library(rfishbase)

tosave <- marine_fisheries %>% 
  select(species = TaxonName, isscaap = ISSCAAPName, isscaap_num = ISSCAAP, catch) %>% 
  group_by(species, isscaap, isscaap_num) %>% 
  dplyr::summarise(global_catch = sum(catch, na.rm = TRUE)) %>% 
  ungroup()

## grab the taxon onfo and link to the common names using fish base
sci_names <- common_to_sci(tosave$species) %>% 
  unique() %>% 
  rename(species = Species, common_name = ComName) %>% 
  select(species, common_name)

taxa_info_load <- load_taxa(tosave$species) %>% 
  as_tibble() %>% 
  select(-SpecCode) %>% 
  rename(species = Species)

 tosave <- left_join(tosave, sci_names, by = "species") %>% 
   left_join(taxa_info_load)
 
 write_csv(tosave,here("_efficiency/output/all_caught_species.csv"))

all_isscaap <- tosave %>% 
  select(isscaap, isscaap_num) %>% 
  unique()
```

Wrangle Fish Nutrients DF
```{r}
fish_nutri_clean <- fish_nutri_raw %>% 
  select(ISSCAAP,
         food_name = 'Food name in English',
         habitat = Habitat,
         food_state = 'State of food',
         ## edible coefficient here is the whole fish to fillet
         edible_co = 'EDIBLE...8',
         ## kcal/100 g edible portion (EP)
         kcal_per100g = 'ENERC(kcal)',
         ## g protein/100 g edible portion (EP)
         protein_per100g = 'PROTCNT(g)') %>% 
  filter(food_state == "r") %>% 
  separate(food_name, c("common_name", "food_desc"), sep = ",", remove = FALSE) %>% 
  select(-food_desc) %>% 
  mutate(ISSCAAP = ifelse(food_name == "Common sole, wild, fillet, raw", 31, ISSCAAP)) %>% 
  filter(str_detect(food_name, "raw")) %>% 
  mutate(protein_per100g = as.numeric(protein_per100g),
         kcal_per100g = as.numeric(kcal_per100g))

```


The main issue with this is finding a way to summarize the nutritional content of the species we have in a way that can match up with the species we have. I don't think we'll have them all/ will need to do a little more research (ie: missing tuna in the nutritional data stuff), but it'll be a good start.

First step, let's look at a bunch of different ways to group the species and see which one would make the most sense with what we have to work when combining with the catch data. The species level taxonomy is too specific (they do not match up at all), and the final grouping we use in the project is too general.

Groupings to asses:
1. ISSCAAP categories
2. Our final categories (check to look)
2. higher taxonomic levels (genus, family, class, order??)
3. general common names (salmon, trout, cod, shrimp, crab)

ISSCAAP
```{r}
expl_isscaap <- fish_nutri_clean  %>% 
  group_by(ISSCAAP) %>% 
  mutate(isscap_mean_protein = mean(protein_per100g),
         isscap_mean_kcal = mean(kcal_per100g)) %>% 
  ungroup()
  
## check to see if the isscaap category is good enough of a predictor for protein and kcals, or if well need to go deeper

ggplot(expl_isscaap, aes(x = protein_per100g, y = isscap_mean_protein)) +
  geom_point() +
  theme_minimal() +
  facet_wrap(vars(ISSCAAP))
## eh not too great, some categories are not very good like 45 (shrimp category)

```

Our final categories
```{r}

expl_our_cat <- fish_nutri_clean  %>% 
  left_join(isscaap) %>% 
  group_by(species_class_final) %>% 
  mutate(our_cat_mean_protein = mean(protein_per100g),
         our_cat_mean_kcal = mean(kcal_per100g)) %>% 
  ungroup()
  
## check to see if the isscaap category is good enough of a predictor for protein and kcals, or if well need to go deeper

ggplot(expl_our_cat, aes(x = protein_per100g, y = our_cat_mean_protein)) +
  geom_point() +
  theme_minimal() +
  facet_wrap(vars(species_class_final))
## reef associated and small pelagic don't look terrible, but ther rest are too all over the place
```

Higher taxonomic levels: lets look at family first
```{r}

library(rfishbase)

## grab the taxon onfo and link to the common names using fish base
sci_names <- common_to_sci(fish_nutri_clean$common_name) %>% 
  unique() 

taxa_info_load <- load_taxa(fish_nutri_clean$common_name) %>% 
  as_tibble()

taxa_info <- left_join(sci_names, taxa_info_load)

expl_family <- taxa_info %>% 
  select(common_name = ComName, family = Family) %>% 
  right_join(fish_nutri_clean, by = "common_name") %>% 
  group_by(family)  %>% 
  mutate(family_mean_protein = mean(protein_per100g, na.rm = TRUE),
         family_mean_kcal = mean(kcal_per100g, na.rm = TRUE)) %>% 
  ungroup()
  
ggplot(expl_family, aes(x = protein_per100g, y = family_mean_protein)) +
  geom_point() +
  theme_minimal() +
  facet_wrap(vars(family))

## seems a little better, some still look like they have a wider ranfer (salmonoides); but on closer expection bot terrible
## lets look at kcals too
ggplot(expl_family, aes(x = kcal_per100g, y = family_mean_kcal)) +
  geom_point() +
  theme_minimal() +
  facet_wrap(vars(family))

```


general common names (salmon, trout, cod, shrimp, crab)

```{r}
'%!in%' <- function(x,y)!('%in%'(x,y))

unique(fish_nutri_clean$food_name)
length(unique(fish_nutri_clean$food_name)) #134

gen_name_list <- c("tilapia", "catfish", "Catfish", "cod", "sea bass", "trout", "sole", "pike", "salmon", "shrimps", "shrimp","prawn",  "prawns", "mackerel", "mackerels", "Mackerels", "Mackerel", "crabs", "crab", "crayfishes", "Abalones", "abalones", "Abalone", "abalone", "lobster", "lobsters", "conch", "Conch", "Oyster", "Oysters","oyster", "oysters", "mussels", "mussel", "Mussels", "Mussel", "scallop", "scallops", "Scallops", "Scallop", "clam", "clams", "Octopuses", "octopus", "squids", "squid", "cuttlefish", "Cuttlefish", "venus")

 expl_gen_name <- fish_nutri_clean %>% 
   mutate(gen_name = str_extract(fish_nutri_clean$common_name, paste(c(gen_name_list), collapse='|')),
          gen_name = tolower(gen_name),
          gen_name = gsub("s\\b|[^[:alnum:][:blank:]@_]", "", gen_name ),
          gen_name = ifelse(gen_name == "octopu" | gen_name == "octopuse", "octopus",
                            ifelse(gen_name == "venu", "venus",
                                   ifelse(gen_name == "crayfishe", "crayfish",
                                          ifelse(gen_name == "sea bas", "sea bass", gen_name))))) %>% 
   group_by(gen_name)  %>% 
   mutate(gen_name_mean_protein = mean(protein_per100g, na.rm = TRUE),
         gen_name_mean_kcal = mean(kcal_per100g, na.rm = TRUE)) %>% 
  ungroup()
  
ggplot(expl_gen_name, aes(x = protein_per100g, y = gen_name_mean_protein)) +
  geom_point() +
  theme_minimal() +
  facet_wrap(vars(gen_name))

```

Grab the general common name for the fisheries species we had
```{r}

fisheries_gen_name <- marine_fish_sum %>% 
  mutate(gen_name = str_extract(ISSCAAPName, paste(c(gen_name_list), collapse='|'))) %>% 
  ungroup()

pro_included <- sum(!is.na(fisheries_gen_name$gen_name)) /length(fisheries_gen_name$gen_name)
 ##  0.2890688

missing_names <- fisheries_gen_name %>% 
  filter(is.na(gen_name)) %>% 
  select(TaxonName, ISSCAAPName) %>% 
  unique() %>%  ## missing 858 species
  select(ISSCAAPName) %>% 
  unique() ## missing 15 ISSCAAP categories
```
**Will need to find specific nutritional info on these:**
Tunas bonitos billfishes				
Sharks rays skates etc				
Redfishes basses congers				
Jacks mullets sauries				
Herrings sardines anchovies				
Misc Finfishes				
Seacucumbers Echinoderms starfish nei				
Shads				
Sea-squirts and other tunicates				
Krill planktonic crustaceans				
Diadromous fishes nei

**I think we can use averages of specifics that we already have for thes (ie: crusteaceans, milluscs, etc):**
Cods hakes haddocks			
Clams cockles arkshells				
Marine crustaceans nei				
Marine molluscs nei

NOTE: I haven't really delved into the looking at which one of these area freshwater. 
