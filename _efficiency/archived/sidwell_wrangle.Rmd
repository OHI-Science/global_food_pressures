---
title: "Wrangle Sidwell Data"
author: "Juliette"
date: "2/22/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(here)
library(rfishbase)
source(here("_workflow/common.R"))

table_1_raw <- read_csv(file.path(raw, "Sidwell_et_al_1978/Sidwell_et_al_1978_table_1.csv"))

'%!in%' <- function(x,y)!('%in%'(x,y))

```

```{r}

taxa_info <- load_taxa(unique(table_1_raw$scientific_name))%>% 
  as_tibble() 
## this is a little ahrder because the scientic names are species, genus, or sometimes by family


## look to see if going from the common name to family would be better?
from_common <- common_to_sci(unique(table_1_raw$common_name)) %>% 
  unique() %>% 
  rename(species = Species, common_name = ComName) %>% 
  select(species, common_name)

```

Find the family taxon name for each row. The scientific names aren't all the same. We will start with the species first, then the genus only, then family, and then see what is left

```{r}
species_specific <- table_1_raw %>% 
    filter(!str_detect(scientific_name, pattern = "spp")) %>% 
    filter(!str_detect(common_name, pattern = "freshwater"))%>%  ## lets not include freshwater species here
    filter(!str_detect(common_name, pattern = "lake"))%>%
    filter(str_detect(scientific_name, pattern = " ")) %>%  ## keep the species (has genus and sp)
    rename(Species = scientific_name)

species_taxon_info <- load_taxa(unique(species_specific$Species))%>% 
  as_tibble()

species_family <- left_join(species_specific, species_taxon_info, by  = "Species") %>% 
    select(-X13, -SpecCode, -Subfamily, -Order, -Class, -SuperClass)

## there are 23 species missing any family info. these are generally mollusks, but not always. will fill them in by hand here 

to_fix <- filter(species_family, is.na(Genus)) %>% 
    mutate(Family = case_when(Species == "Haliotis kamtschatkana" ~ "Haliotidae",
                              Species == "Venerupis semi decussata"~"Veneridae",
                              Species == "Mya arenaria" ~ "Myidae",
                              Species == "Callinectes sapidus" ~ "Portunidae",
                              Species == "Cancer magister" ~ "Cancridae",
                              Species == "Parahthodes camtschatica" ~ "Lithodidae",
                              Species == "Scylla serrata" ~ "Portunidae",
                              Species == "Coryphaena equisetis" ~ "Coryphaenidae",
                              Species == "Clupea harengus pallasi" ~ "Clupeidae",
                              Species == "Pneumatophorus japonicus" ~ "Scombridae",
                              Species == "Mullus barbatus" ~ "Mullidae",
                              Species == "Crassotrea virginica" ~ "	Ostreidae",
                              Species == "Sardina caerulea" ~ "Clupeidae",
                              Species == "Theragra chalcogramma" ~ "Gadidae",
                              Species == "Sebastes marinus" ~ "Sebastidae",
                              Species == "Ammodytes lancedatus" ~ "Ammodytidae",
                              Species == "Sardinella eba" ~ "Clupeidae",
                              Species == "Pecten irradians" ~ "Pectinidae",
                              Species == "Aequipecten gibbus" ~ "Pectinidae",
                              Species == "Parophys ventulus" ~ "Pleuronectidae",
                              Species == "Esopsetta jordani" ~ "Pleuronectidae",
                              Species == "Clupea sprattus" ~ "Clupeidae",
                              Species == "Salmo gairdneri" ~ "Salmonidae"))


species_family_fixed <- species_family %>% 
    filter(Species %!in% to_fix$Species) %>% 
    rbind(to_fix) %>% 
    select(common_name, family = Family, paper_name = Species, protein_mean, energy_mean)

```

Grab the rows of data that are already by family
```{r}

taxon_info_2 <- species_taxon_info %>% 
    select(Species, Genus, Family)

family_specific <- table_1_raw %>% 
    filter(str_detect(scientific_name, pattern = "spp")) %>%  ## some of these are genus, some are family family usually ends in "ae"
    mutate(scientific_name = str_remove(scientific_name, " spp")) %>% 
    mutate(prob_family = ifelse(str_detect(scientific_name, "ae\\b"), "yes", "no")) 

family_subset <- family_specific %>% 
    filter(prob_family == "yes") %>% 
    mutate(family = scientific_name) %>% 
    select(common_name, paper_name = scientific_name, family, protein_mean, energy_mean)

genus_specific <- family_specific %>% 
    filter(prob_family == "no")  %>% 
    select(-X13, -prob_family)

## I tried to do something similar with Genus, but there can be multipl genus names that are the same in different families. So we will do this by hand. again

genus_specific_fixed<- genus_specific %>% 
    mutate(Family = case_when(common_name == "Amberjacks" ~ "Carangidae",
                              common_name == "Bonita" ~ "Scombridae",
                              common_name == "Bream" ~ "Sparidae",
                              scientific_name == "Barbus" ~ "Cyprinidae",
                              scientific_name == "Labeo" ~ "Cyprinidae",
                              scientific_name == "Gadus" ~ "Gadidae",
                              scientific_name == "Merluccius" ~ "Merlucciidae",
                              scientific_name == "Caranx" ~ "Carangidae",
                              scientific_name == "Menticirrhus" ~ "Sciaenidae",
                              scientific_name == "Panulirus" ~ "Palinuridae",
                              scientific_name == "Scomber" ~ "Scombridae",
                              scientific_name == "Scombermorus" ~ "Scombridae",
                              scientific_name == "Auxis" ~ "Scombridae",
                              scientific_name == "Rastrelliger" ~ "Scombridae",
                              scientific_name == "Mugil" ~ "Mugilidae",
                              scientific_name == "Scaridaw" ~ "Scaridae",
                              scientific_name == "Sardinops" ~ "Clupeidae",
                              scientific_name == "Trachinotus" ~ "Carangidae",
                              scientific_name == "Dentex" ~ "Sparidae",
                              scientific_name == "Sparus" ~ "Sparidae",
                              scientific_name == "Pagrus" ~ "Sparidae",
                              scientific_name == "Sphoeroides" ~ "Tetraodontidae",
                              scientific_name == "Sebastes" ~ "Sebastidae",
                              scientific_name == "Decapterus" ~ "Carangidae",
                              scientific_name == "Limanda" ~ "Pleuronectidae")) %>% 
    select(common_name, family = Family, paper_name = scientific_name, protein_mean, energy_mean)

family_genus_fixed <- rbind(family_subset, genus_specific_fixed) %>% 
  mutate(paper_name = paste(paper_name, "spp", sep = " "))

```

Combine all the dfs with Family columns

```{r}

recalc_means <- rbind(species_family_fixed, family_genus_fixed) %>% 
    group_by(family) %>% 
    mutate(protein_mean = as.numeric(protein_mean)) %>% ## for some reason the protein mean is a character and the energy is numeric. 
    dplyr::summarise(recalc_protein_mean = mean(protein_mean, rm.na = TRUE),
                     recalc_energy_mean = mean(energy_mean, rm.na = TRUE))

## there are some missing still, but we will wait to gapfill until we see if we have fish caught that we ahve missing nutrional data in

write_csv(recal_means, here("_efficiency/data/protein_energy_values.csv"))

#save the way we named the families
naming <- rbind(species_family_fixed, family_genus_fixed) %>% 
  select(common_name, family, paper_name)
```

So some of the species has no info from fishbase. want to calcualte how much that is and if it's negligible or not
```{r}
marine_fisheries <- read_csv("/home/shares/food-systems/Food_footprint/all_food_systems/dataprep/fisheries/marine/catch_for_juliette.csv") %>% 
    select(Species = TaxonName) %>% 
    unique()

marine_fisheries_family <- left_join(marine_fisheries, taxon_info_2, by = "Species")
## 550 NAs. lets see if they are neglible catch amounts

missing <- marine_fisheries_family %>%  filter(is.na(Genus))

catch_from_missing <-  read_csv("/home/shares/food-systems/Food_footprint/all_food_systems/dataprep/fisheries/marine/catch_for_juliette.csv") %>% 
    filter(TaxonName %in% missing) %>% 
    dplyr::summarise(catch_missing = sum(catch, rm.na = TRUE)) %>% 
  pull(catch_missing)

total_catch <- read_csv("/home/shares/food-systems/Food_footprint/all_food_systems/dataprep/fisheries/marine/catch_for_juliette.csv") %>% 
    dplyr::summarise(catch_total = sum(catch, rm.na = TRUE)) %>% 
  pull(catch_total)

prop_missing <-catch_from_missing/total_catch ## super negligible, we can move forward
```

Next we want to see how many species are caught but we dont have family level protein info for. 
```{r}
marine_fisheries_family_2 <- marine_fisheries_family %>%
  filter(!is.na(Genus)) %>% 
  select(species = Species, family = Family) %>% 
  left_join(recalc_means, by = "family")

## how much of the catch do we not have protein values for
missing_check_2 <- marine_fisheries_family_2 %>% 
  filter(is.na(recalc_protein_mean)) %>% 
  pull(species)

catch_from_missing_2 <-  read_csv("/home/shares/food-systems/Food_footprint/all_food_systems/dataprep/fisheries/marine/catch_for_juliette.csv") %>% 
    filter(TaxonName %in% missing_check_2) %>% 
    dplyr::summarise(catch_missing = sum(catch, rm.na = TRUE)) %>% 
  pull(catch_missing)

prop_missing <-catch_from_missing_2/total_catch ## 0.0325363, this is probably fine
```

Next we want to see how many species are caught but we dont have family level protein or calorie info for. 
```{r}
marine_fisheries_family_2 <- marine_fisheries_family %>%
  filter(!is.na(Genus)) %>% 
  select(species = Species, family = Family) %>% 
  left_join(recalc_means, by = "family")

## how much of the catch do we not have protein values for
missing_check_3 <- marine_fisheries_family_2 %>% 
  filter(is.na(recalc_energy_mean)) %>% 
  pull(species)

catch_from_missing_3 <-  read_csv("/home/shares/food-systems/Food_footprint/all_food_systems/dataprep/fisheries/marine/catch_for_juliette.csv") %>% 
    filter(TaxonName %in% missing_check_3) %>% 
    dplyr::summarise(catch_missing = sum(catch, rm.na = TRUE)) %>% 
  pull(catch_missing)

prop_missing <-catch_from_missing_3/total_catch ## 0.4371019, this is probably fine
```




Lets see if there is a relationship between protein and energy. we probably want to use the original non recalcuated values for this
```{r}
library(plotly)

check_relationship <- table_1_raw %>% 
  select(scientific_name, protein_mean, energy_mean) %>% 
  filter(!is.na(energy_mean),
         !is.na(protein_mean)) %>% 
  mutate(protein_mean = as.numeric(protein_mean))
  
check_plot <- ggplot(check_relationship, aes(x = protein_mean, y = energy_mean)) +
  geom_point() +
  geom_smooth(method='lm')

lm(energy_mean~protein_mean, check_relationship)
## b = 59.343
## m = 2.125   

ggplotly(check_plot)

```
Okay so if we want to gapfill using the coefficient from this linear regression, I want to check how much catch that will actually be accounting for. Right now the regression is calculated including those crazy big energy outliers, so the line seems a little linear than the majority of the points, so i worry that we would be overestimating the amount of kcalories available from fishies. We could also discuss calculating the model without the outliers.

```{r}

missing_check_3 <- marine_fisheries_family_2 %>% 
  filter(is.na(recalc_energy_mean)) %>% 
  pull(species)

setdiff(missing_check_3, missing_check_2)

catch_from_missing_3 <-  read_csv("/home/shares/food-systems/Food_footprint/all_food_systems/dataprep/fisheries/marine/catch_for_juliette.csv") %>%
    filter(TaxonName %in% missing_check_3) %>% 
    dplyr::summarise(catch_missing = sum(catch, rm.na = TRUE)) %>% 
  pull(catch_missing)

prop_missing <-catch_from_missing_3/total_catch ## 0.4371019, okay this is a large number
```

The major outlier is an eel species. lets see if families or even order would be better

```{r}
check_relationship_2 <- table_1_raw %>% 
  select(paper_name = scientific_name, protein_mean, energy_mean) %>% 
  filter(!is.na(energy_mean),
         !is.na(protein_mean)) %>% 
  mutate(protein_mean = as.numeric(protein_mean)) %>% 
  left_join(naming) 
  
check_plot_2 <- ggplot(check_relationship_2, aes(x = protein_mean, y = energy_mean, color = family)) +
  geom_point() +
  geom_smooth(method='lm') +
  theme(legend.position = "none")
check_plot_2

lm(energy_mean~protein_mean, check_relationship_2)
## b = 59.343
## m = 2.125   

ggplotly(check_plot_2)

```

Let's look at the relationship for protein and calorie from uFiSh!
```{r}
library(readxl)

ufish <- read_xlsx(file.path(raw, "uFiSh/uFiSh1.0.xlsx"), sheet = 4) %>% 
  select(item = 'Food name in English', state = 'State of food', kcal = 'ENERC(kcal)', protein = 'PROTCNT(g)') %>% 
  filter(!is.na(item),
         state == "r",
         str_detect(item, "fillet")) %>% 
  mutate(protein = as.numeric(protein),
         kcal = as.numeric(kcal))

ufish_plot_1 <- ggplot(ufish, aes(x = protein, y = kcal)) +
  geom_point() +
  geom_smooth(method='lm') +
  theme(legend.position = "none") +
  labs(title = "Filtered by 'fillet' and raw ")
ufish_plot_1
ggplotly(ufish_plot_1)

lm(kcal~protein, ufish)
## b = -153.33
## m = 14.56

## all
ufish2 <- read_xlsx(file.path(raw, "uFiSh/uFiSh1.0.xlsx"), sheet = 4) %>% 
  select(item = 'Food name in English', state = 'State of food', kcal = 'ENERC(kcal)', protein = 'PROTCNT(g)') %>% 
  filter(!is.na(item),
         state == "r") %>% 
  mutate(protein = as.numeric(protein),
         kcal = as.numeric(kcal))

ufish_plot_2 <- ggplot(ufish2, aes(x = protein, y = kcal)) +
  geom_point() +
  geom_smooth(method='lm') +
  theme(legend.position = "none") +
  labs(title = "Filtered by 'fillet' ")
ufish_plot_2
ggplotly(ufish_plot_2)

```

